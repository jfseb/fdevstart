/**
 * maketable.ts
 *
 * @file
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var debug = require("debug");
var debuglog = debug('maketable');
var fdevsta_monmove_1 = require("fdevsta_monmove");
var Utils = require("abot_utils");
var _ = require("lodash");
function makeTable(categories, theModel) {
    //
    debuglog("makeTable for " + JSON.stringify(categories));
    //
    var aFilteredDomains = fdevsta_monmove_1.Model.getDomainsForCategory(theModel, categories[0]);
    categories.forEach(function (category) {
        var catsForDomain = fdevsta_monmove_1.Model.getDomainsForCategory(theModel, category);
        aFilteredDomains = _.intersection(aFilteredDomains, catsForDomain);
    });
    if (aFilteredDomains.length === 0) {
        return {
            text: 'No commxon domains for ' + Utils.listToQuotedCommaAnd(categories),
            action: {}
        };
    }
    var domain = aFilteredDomains[0];
    //
    var columns = fdevsta_monmove_1.Model.getTableColumns(theModel, domain);
    if (columns.length === 0) {
        return {
            text: 'Apologies, but i cannot make a table for domain ' + domain + ' ',
            action: {}
        };
    }
    var indexMap = categories.map(function (category) {
        return columns.indexOf(category);
    }).filter(function (i) {
        return i >= 0;
    });
    if (indexMap.length === 0) {
        return {
            text: 'Apologies, but ' + Utils.listToQuotedCommaAnd(categories) + ' does not represent possible table columns',
            action: {}
        };
    }
    var text = "";
    var missingMap = categories.filter(function (category) {
        return columns.indexOf(category) < 0;
    });
    var usedMap = categories.filter(function (category) {
        return columns.indexOf(category) >= 0;
    });
    if (missingMap.length) {
        text = "I had to drop " + Utils.listToQuotedCommaAnd(missingMap) + ". But here you go ...\n";
    }
    text += "Creating and starting table with " + Utils.listToQuotedCommaAnd(usedMap);
    return {
        text: text,
        action: { url: "table_" + domain.toLowerCase().replace(/[^a-z0-9_]/g, '_') + "?c" + indexMap.join(',') }
    };
}
exports.makeTable = makeTable;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leGVjL21ha2VxYmV0YWJsZS50cyIsImV4ZWMvbWFrZXFiZXRhYmxlLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwiZmRldnN0YV9tb25tb3ZlXzEiLCJVdGlscyIsIl8iLCJtYWtlVGFibGUiLCJjYXRlZ29yaWVzIiwidGhlTW9kZWwiLCJKU09OIiwic3RyaW5naWZ5IiwiYUZpbHRlcmVkRG9tYWlucyIsIk1vZGVsIiwiZ2V0RG9tYWluc0ZvckNhdGVnb3J5IiwiZm9yRWFjaCIsImNhdGVnb3J5IiwiY2F0c0ZvckRvbWFpbiIsImludGVyc2VjdGlvbiIsImxlbmd0aCIsInRleHQiLCJsaXN0VG9RdW90ZWRDb21tYUFuZCIsImFjdGlvbiIsImRvbWFpbiIsImNvbHVtbnMiLCJnZXRUYWJsZUNvbHVtbnMiLCJpbmRleE1hcCIsIm1hcCIsImluZGV4T2YiLCJmaWx0ZXIiLCJpIiwibWlzc2luZ01hcCIsInVzZWRNYXAiLCJ1cmwiLCJ0b0xvd2VyQ2FzZSIsInJlcGxhY2UiLCJqb2luIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQ0E7Ozs7OztBQ0tBOztBREdBLElBQUFBLFFBQUFDLFFBQUEsT0FBQSxDQUFBO0FBRUEsSUFBTUMsV0FBV0YsTUFBTSxXQUFOLENBQWpCO0FBR0EsSUFBQUcsb0JBQUFGLFFBQUEsaUJBQUEsQ0FBQTtBQUdBLElBQUFHLFFBQUFILFFBQUEsWUFBQSxDQUFBO0FBRUEsSUFBQUksSUFBQUosUUFBQSxRQUFBLENBQUE7QUFHQSxTQUFBSyxTQUFBLENBQTBCQyxVQUExQixFQUFpREMsUUFBakQsRUFBeUU7QUFFdkU7QUFDQU4sYUFBUyxtQkFBbUJPLEtBQUtDLFNBQUwsQ0FBZUgsVUFBZixDQUE1QjtBQUNBO0FBQ0EsUUFBSUksbUJBQW1CUixrQkFBQVMsS0FBQSxDQUFNQyxxQkFBTixDQUE0QkwsUUFBNUIsRUFBc0NELFdBQVcsQ0FBWCxDQUF0QyxDQUF2QjtBQUNBQSxlQUFXTyxPQUFYLENBQW1CLFVBQUFDLFFBQUEsRUFBUTtBQUNuQixZQUFJQyxnQkFBZ0JiLGtCQUFBUyxLQUFBLENBQU1DLHFCQUFOLENBQTRCTCxRQUE1QixFQUFxQ08sUUFBckMsQ0FBcEI7QUFDQUosMkJBQW1CTixFQUFFWSxZQUFGLENBQWVOLGdCQUFmLEVBQWdDSyxhQUFoQyxDQUFuQjtBQUNQLEtBSEQ7QUFJQSxRQUFHTCxpQkFBaUJPLE1BQWpCLEtBQTRCLENBQS9CLEVBQWtDO0FBQ2hDLGVBQVE7QUFDTkMsa0JBQVEsNEJBQTRCZixNQUFNZ0Isb0JBQU4sQ0FBMkJiLFVBQTNCLENBRDlCO0FBRU5jLG9CQUFTO0FBRkgsU0FBUjtBQUlEO0FBQ0QsUUFBSUMsU0FBU1gsaUJBQWlCLENBQWpCLENBQWI7QUFDQTtBQUNBLFFBQUlZLFVBQVVwQixrQkFBQVMsS0FBQSxDQUFNWSxlQUFOLENBQXNCaEIsUUFBdEIsRUFBZ0NjLE1BQWhDLENBQWQ7QUFDQSxRQUFHQyxRQUFRTCxNQUFSLEtBQW1CLENBQXRCLEVBQXlCO0FBQ3ZCLGVBQU87QUFDTEMsa0JBQVEscURBQXFERyxNQUFyRCxHQUE4RCxHQURqRTtBQUVMRCxvQkFBUztBQUZKLFNBQVA7QUFJRDtBQUNELFFBQUlJLFdBQVdsQixXQUFXbUIsR0FBWCxDQUFnQixVQUFBWCxRQUFBLEVBQVE7QUFBTSxlQUFBUSxRQUFRSSxPQUFSLENBQWdCWixRQUFoQixDQUFBO0FBQXlCLEtBQXZELEVBQTBEYSxNQUExRCxDQUFpRSxVQUFBQyxDQUFBLEVBQUM7QUFBSSxlQUFBQSxLQUFLLENBQUw7QUFBTSxLQUE1RSxDQUFmO0FBQ0EsUUFBR0osU0FBU1AsTUFBVCxLQUFvQixDQUF2QixFQUEwQjtBQUN4QixlQUFRO0FBQ05DLGtCQUFRLG9CQUFvQmYsTUFBTWdCLG9CQUFOLENBQTJCYixVQUEzQixDQUFwQixHQUE2RCw0Q0FEL0Q7QUFFTmMsb0JBQVM7QUFGSCxTQUFSO0FBSUQ7QUFDRCxRQUFJRixPQUFPLEVBQVg7QUFDQSxRQUFJVyxhQUFhdkIsV0FBV3FCLE1BQVgsQ0FBbUIsVUFBQWIsUUFBQSxFQUFRO0FBQUssZUFBQVEsUUFBUUksT0FBUixDQUFnQlosUUFBaEIsSUFBNEIsQ0FBNUI7QUFBNkIsS0FBN0QsQ0FBakI7QUFDQSxRQUFJZ0IsVUFBVXhCLFdBQVdxQixNQUFYLENBQW1CLFVBQUFiLFFBQUEsRUFBUTtBQUFLLGVBQUFRLFFBQVFJLE9BQVIsQ0FBZ0JaLFFBQWhCLEtBQTZCLENBQTdCO0FBQThCLEtBQTlELENBQWQ7QUFDQSxRQUFHZSxXQUFXWixNQUFkLEVBQXNCO0FBQ3BCQyxlQUFPLG1CQUFtQmYsTUFBTWdCLG9CQUFOLENBQTJCVSxVQUEzQixDQUFuQixHQUE0RCx5QkFBbkU7QUFDRDtBQUNEWCxZQUFRLHNDQUFxQ2YsTUFBTWdCLG9CQUFOLENBQTJCVyxPQUEzQixDQUE3QztBQUNBLFdBQU87QUFDTFosY0FBT0EsSUFERjtBQUVQRSxnQkFBUSxFQUFFVyxLQUFNLFdBQVNWLE9BQU9XLFdBQVAsR0FBcUJDLE9BQXJCLENBQTZCLGFBQTdCLEVBQTJDLEdBQTNDLENBQVQsR0FBd0QsSUFBeEQsR0FBNkRULFNBQVNVLElBQVQsQ0FBYyxHQUFkLENBQXJFO0FBRkQsS0FBUDtBQUlEO0FBM0NEQyxRQUFBOUIsU0FBQSxHQUFBQSxTQUFBIiwiZmlsZSI6ImV4ZWMvbWFrZXFiZXRhYmxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbi8qKlxyXG4gKiBtYWtldGFibGUudHNcclxuICpcclxuICogQGZpbGVcclxuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxyXG4gKi9cclxuXHJcblxyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XHJcblxyXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdtYWtldGFibGUnKVxyXG5cclxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4uL21hdGNoL2lmbWF0Y2gnO1xyXG5pbXBvcnQgeyBNb2RlbCB9IGZyb20gJ2ZkZXZzdGFfbW9ubW92ZSc7XHJcblxyXG5cclxuaW1wb3J0ICogYXMgVXRpbHMgZnJvbSAnYWJvdF91dGlscyc7XHJcblxyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VUYWJsZShjYXRlZ29yaWVzIDogc3RyaW5nW10sIHRoZU1vZGVsOiBJTWF0Y2guSU1vZGVscyApIDogeyB0ZXh0OiBzdHJpbmcsIGFjdGlvbiA6IHsgdXJsPyA6IHN0cmluZyB9IH1cclxue1xyXG4gIC8vXHJcbiAgZGVidWdsb2coXCJtYWtlVGFibGUgZm9yIFwiICsgSlNPTi5zdHJpbmdpZnkoY2F0ZWdvcmllcykpO1xyXG4gIC8vXHJcbiAgdmFyIGFGaWx0ZXJlZERvbWFpbnMgPSBNb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsIGNhdGVnb3JpZXNbMF0pO1xyXG4gIGNhdGVnb3JpZXMuZm9yRWFjaChjYXRlZ29yeSA9PiB7XHJcbiAgICAgICAgICB2YXIgY2F0c0ZvckRvbWFpbiA9IE1vZGVsLmdldERvbWFpbnNGb3JDYXRlZ29yeSh0aGVNb2RlbCxjYXRlZ29yeSk7XHJcbiAgICAgICAgICBhRmlsdGVyZWREb21haW5zID0gXy5pbnRlcnNlY3Rpb24oYUZpbHRlcmVkRG9tYWlucyxjYXRzRm9yRG9tYWluKTtcclxuICB9KTtcclxuICBpZihhRmlsdGVyZWREb21haW5zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgcmV0dXJuICB7XHJcbiAgICAgIHRleHQgOiAgJ05vIGNvbW14b24gZG9tYWlucyBmb3IgJyArIFV0aWxzLmxpc3RUb1F1b3RlZENvbW1hQW5kKGNhdGVnb3JpZXMpLFxyXG4gICAgICBhY3Rpb24gOiB7fVxyXG4gICAgfVxyXG4gIH1cclxuICB2YXIgZG9tYWluID0gYUZpbHRlcmVkRG9tYWluc1swXTtcclxuICAvL1xyXG4gIHZhciBjb2x1bW5zID0gTW9kZWwuZ2V0VGFibGVDb2x1bW5zKHRoZU1vZGVsLCBkb21haW4pO1xyXG4gIGlmKGNvbHVtbnMubGVuZ3RoID09PSAwKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB0ZXh0IDogICdBcG9sb2dpZXMsIGJ1dCBpIGNhbm5vdCBtYWtlIGEgdGFibGUgZm9yIGRvbWFpbiAnICsgZG9tYWluICsgJyAnLFxyXG4gICAgICBhY3Rpb24gOiB7fVxyXG4gICAgfVxyXG4gIH1cclxuICB2YXIgaW5kZXhNYXAgPSBjYXRlZ29yaWVzLm1hcCggY2F0ZWdvcnkgPT4gICBjb2x1bW5zLmluZGV4T2YoY2F0ZWdvcnkpICkuZmlsdGVyKGkgPT4gaSA+PSAwKTtcclxuICBpZihpbmRleE1hcC5sZW5ndGggPT09IDApIHtcclxuICAgIHJldHVybiAge1xyXG4gICAgICB0ZXh0IDogICdBcG9sb2dpZXMsIGJ1dCAnICsgVXRpbHMubGlzdFRvUXVvdGVkQ29tbWFBbmQoY2F0ZWdvcmllcykgKyAnIGRvZXMgbm90IHJlcHJlc2VudCBwb3NzaWJsZSB0YWJsZSBjb2x1bW5zJyxcclxuICAgICAgYWN0aW9uIDoge31cclxuICAgIH1cclxuICB9XHJcbiAgdmFyIHRleHQgPSBcIlwiO1xyXG4gIHZhciBtaXNzaW5nTWFwID0gY2F0ZWdvcmllcy5maWx0ZXIoIGNhdGVnb3J5ID0+ICBjb2x1bW5zLmluZGV4T2YoY2F0ZWdvcnkpIDwgMCApO1xyXG4gIHZhciB1c2VkTWFwID0gY2F0ZWdvcmllcy5maWx0ZXIoIGNhdGVnb3J5ID0+ICBjb2x1bW5zLmluZGV4T2YoY2F0ZWdvcnkpID49IDApO1xyXG4gIGlmKG1pc3NpbmdNYXAubGVuZ3RoKSB7XHJcbiAgICB0ZXh0ID0gXCJJIGhhZCB0byBkcm9wIFwiICsgVXRpbHMubGlzdFRvUXVvdGVkQ29tbWFBbmQobWlzc2luZ01hcCkgKyBcIi4gQnV0IGhlcmUgeW91IGdvIC4uLlxcblwiXHJcbiAgfVxyXG4gIHRleHQgKz0gXCJDcmVhdGluZyBhbmQgc3RhcnRpbmcgdGFibGUgd2l0aCBcIisgVXRpbHMubGlzdFRvUXVvdGVkQ29tbWFBbmQodXNlZE1hcCk7XHJcbiAgcmV0dXJuIHtcclxuICAgIHRleHQgOiB0ZXh0LFxyXG4gIGFjdGlvbiA6eyB1cmwgOiBgdGFibGVfJHtkb21haW4udG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9bXmEtejAtOV9dL2csJ18nKX0/YyR7aW5kZXhNYXAuam9pbignLCcpfWAgfVxyXG4gIH07XHJcbn1cclxuIiwiLyoqXG4gKiBtYWtldGFibGUudHNcbiAqXG4gKiBAZmlsZVxuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdtYWtldGFibGUnKTtcbnZhciBmZGV2c3RhX21vbm1vdmVfMSA9IHJlcXVpcmUoXCJmZGV2c3RhX21vbm1vdmVcIik7XG52YXIgVXRpbHMgPSByZXF1aXJlKFwiYWJvdF91dGlsc1wiKTtcbnZhciBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbmZ1bmN0aW9uIG1ha2VUYWJsZShjYXRlZ29yaWVzLCB0aGVNb2RlbCkge1xuICAgIC8vXG4gICAgZGVidWdsb2coXCJtYWtlVGFibGUgZm9yIFwiICsgSlNPTi5zdHJpbmdpZnkoY2F0ZWdvcmllcykpO1xuICAgIC8vXG4gICAgdmFyIGFGaWx0ZXJlZERvbWFpbnMgPSBmZGV2c3RhX21vbm1vdmVfMS5Nb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsIGNhdGVnb3JpZXNbMF0pO1xuICAgIGNhdGVnb3JpZXMuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgdmFyIGNhdHNGb3JEb21haW4gPSBmZGV2c3RhX21vbm1vdmVfMS5Nb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsIGNhdGVnb3J5KTtcbiAgICAgICAgYUZpbHRlcmVkRG9tYWlucyA9IF8uaW50ZXJzZWN0aW9uKGFGaWx0ZXJlZERvbWFpbnMsIGNhdHNGb3JEb21haW4pO1xuICAgIH0pO1xuICAgIGlmIChhRmlsdGVyZWREb21haW5zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGV4dDogJ05vIGNvbW14b24gZG9tYWlucyBmb3IgJyArIFV0aWxzLmxpc3RUb1F1b3RlZENvbW1hQW5kKGNhdGVnb3JpZXMpLFxuICAgICAgICAgICAgYWN0aW9uOiB7fVxuICAgICAgICB9O1xuICAgIH1cbiAgICB2YXIgZG9tYWluID0gYUZpbHRlcmVkRG9tYWluc1swXTtcbiAgICAvL1xuICAgIHZhciBjb2x1bW5zID0gZmRldnN0YV9tb25tb3ZlXzEuTW9kZWwuZ2V0VGFibGVDb2x1bW5zKHRoZU1vZGVsLCBkb21haW4pO1xuICAgIGlmIChjb2x1bW5zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGV4dDogJ0Fwb2xvZ2llcywgYnV0IGkgY2Fubm90IG1ha2UgYSB0YWJsZSBmb3IgZG9tYWluICcgKyBkb21haW4gKyAnICcsXG4gICAgICAgICAgICBhY3Rpb246IHt9XG4gICAgICAgIH07XG4gICAgfVxuICAgIHZhciBpbmRleE1hcCA9IGNhdGVnb3JpZXMubWFwKGZ1bmN0aW9uIChjYXRlZ29yeSkgeyByZXR1cm4gY29sdW1ucy5pbmRleE9mKGNhdGVnb3J5KTsgfSkuZmlsdGVyKGZ1bmN0aW9uIChpKSB7IHJldHVybiBpID49IDA7IH0pO1xuICAgIGlmIChpbmRleE1hcC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRleHQ6ICdBcG9sb2dpZXMsIGJ1dCAnICsgVXRpbHMubGlzdFRvUXVvdGVkQ29tbWFBbmQoY2F0ZWdvcmllcykgKyAnIGRvZXMgbm90IHJlcHJlc2VudCBwb3NzaWJsZSB0YWJsZSBjb2x1bW5zJyxcbiAgICAgICAgICAgIGFjdGlvbjoge31cbiAgICAgICAgfTtcbiAgICB9XG4gICAgdmFyIHRleHQgPSBcIlwiO1xuICAgIHZhciBtaXNzaW5nTWFwID0gY2F0ZWdvcmllcy5maWx0ZXIoZnVuY3Rpb24gKGNhdGVnb3J5KSB7IHJldHVybiBjb2x1bW5zLmluZGV4T2YoY2F0ZWdvcnkpIDwgMDsgfSk7XG4gICAgdmFyIHVzZWRNYXAgPSBjYXRlZ29yaWVzLmZpbHRlcihmdW5jdGlvbiAoY2F0ZWdvcnkpIHsgcmV0dXJuIGNvbHVtbnMuaW5kZXhPZihjYXRlZ29yeSkgPj0gMDsgfSk7XG4gICAgaWYgKG1pc3NpbmdNYXAubGVuZ3RoKSB7XG4gICAgICAgIHRleHQgPSBcIkkgaGFkIHRvIGRyb3AgXCIgKyBVdGlscy5saXN0VG9RdW90ZWRDb21tYUFuZChtaXNzaW5nTWFwKSArIFwiLiBCdXQgaGVyZSB5b3UgZ28gLi4uXFxuXCI7XG4gICAgfVxuICAgIHRleHQgKz0gXCJDcmVhdGluZyBhbmQgc3RhcnRpbmcgdGFibGUgd2l0aCBcIiArIFV0aWxzLmxpc3RUb1F1b3RlZENvbW1hQW5kKHVzZWRNYXApO1xuICAgIHJldHVybiB7XG4gICAgICAgIHRleHQ6IHRleHQsXG4gICAgICAgIGFjdGlvbjogeyB1cmw6IFwidGFibGVfXCIgKyBkb21haW4udG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9bXmEtejAtOV9dL2csICdfJykgKyBcIj9jXCIgKyBpbmRleE1hcC5qb2luKCcsJykgfVxuICAgIH07XG59XG5leHBvcnRzLm1ha2VUYWJsZSA9IG1ha2VUYWJsZTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
