"use strict";
/**
 * Functionality to execute a certain response on the server,
 * interpreting a general model context
 *
 *
 * via a) commandline (e.g. browser startup)
 * @file
 * @copyright (c) 2016 Gerd Forstmann
 */

Object.defineProperty(exports, "__esModule", { value: true });
var debug = require("debug");
var debuglog = debug('execserver');
var Toolmatch = require("../match/toolmatch");
var Exectemplate = require("./exectemplate");
function noStar(a, b) {
    if (b === '*') {
        return a;
    }
    if (a === '*') {
        return b;
    }
    if (a !== b) {
        throw new Error('Illegal Argument no match ' + a + " " + b);
    }
    return b;
}
exports.noStar = noStar;
function makeGenericText(match, setId, record) {
    var res = "start " + match.tool.name;
    var set = match.tool.sets[setId];
    var context = Toolmatch.makeMatchSet(match, set);
    set.set.forEach(function (category, index) {
        var value = noStar(context[category], record[category]);
        var prefix = "";
        if (index === 0) {
            prefix += ' using ';
        } else if (index === set.set.length - 1) {
            prefix += ' and ';
        } else {
            prefix = '; ';
        }
        if (category === "category") {
            res = res + prefix + '"' + value + '"';
        }
        res = res + prefix + category + ' "' + value + '"';
    });
    return res;
}
exports.makeGenericText = makeGenericText;
function execTool(match, records, bExplain) {
    //
    debuglog("records for match " + JSON.stringify(match));
    var matchSetRecord = Toolmatch.findFirstSetRecord(match, records);
    if (!matchSetRecord) {
        return {
            text: "cannot start",
            action: {}
        };
    }
    ;
    var set = match.tool.sets[matchSetRecord.setId];
    var pattern = matchSetRecord.record[set.response];
    var context = Toolmatch.makeMatchSet(match, set);
    var url = Exectemplate.expandTemplate(context, pattern);
    var text = "";
    debuglog("record " + JSON.stringify("matchSetRecord "));
    var patternText = matchSetRecord.record["_text" + set.response];
    if (patternText) {
        text = Exectemplate.expandTemplate(context, patternText);
    } else {
        text = makeGenericText(match, matchSetRecord.setId, matchSetRecord.record);
    }
    return {
        text: text,
        action: { url: url }
    };
}
exports.execTool = execTool;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV4ZWMvZXhlY3NlcnZlci5qcyIsIi4uL3NyYy9leGVjL2V4ZWNzZXJ2ZXIudHMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWJ1ZyIsInJlcXVpcmUiLCJkZWJ1Z2xvZyIsIlRvb2xtYXRjaCIsIkV4ZWN0ZW1wbGF0ZSIsIm5vU3RhciIsImEiLCJiIiwiRXJyb3IiLCJtYWtlR2VuZXJpY1RleHQiLCJtYXRjaCIsInNldElkIiwicmVjb3JkIiwicmVzIiwidG9vbCIsIm5hbWUiLCJzZXQiLCJzZXRzIiwiY29udGV4dCIsIm1ha2VNYXRjaFNldCIsImZvckVhY2giLCJjYXRlZ29yeSIsImluZGV4IiwicHJlZml4IiwibGVuZ3RoIiwiZXhlY1Rvb2wiLCJyZWNvcmRzIiwiYkV4cGxhaW4iLCJKU09OIiwic3RyaW5naWZ5IiwibWF0Y2hTZXRSZWNvcmQiLCJmaW5kRmlyc3RTZXRSZWNvcmQiLCJ0ZXh0IiwiYWN0aW9uIiwicGF0dGVybiIsInJlc3BvbnNlIiwidXJsIiwiZXhwYW5kVGVtcGxhdGUiLCJwYXR0ZXJuVGV4dCJdLCJtYXBwaW5ncyI6IkFBQUE7QUNBQTs7Ozs7Ozs7OztBRFVBQSxPQUFPQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QyxFQUFFQyxPQUFPLElBQVQsRUFBN0M7QUNFQSxJQUFBQyxRQUFBQyxRQUFBLE9BQUEsQ0FBQTtBQUlBLElBQU1DLFdBQVdGLE1BQU0sWUFBTixDQUFqQjtBQVdBLElBQUFHLFlBQUFGLFFBQUEsb0JBQUEsQ0FBQTtBQUVBLElBQUFHLGVBQUFILFFBQUEsZ0JBQUEsQ0FBQTtBQUVBLFNBQUFJLE1BQUEsQ0FBdUJDLENBQXZCLEVBQWtDQyxDQUFsQyxFQUEyQztBQUN6QyxRQUFJQSxNQUFNLEdBQVYsRUFBZTtBQUNiLGVBQU9ELENBQVA7QUFDRDtBQUNELFFBQUlBLE1BQU0sR0FBVixFQUFlO0FBQ2IsZUFBT0MsQ0FBUDtBQUNEO0FBQ0Qs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LEtBQVA7QUFJRDtBQTlCRHRDLFFBQUEyQixRQUFBLEdBQUFBLFFBQUEiLCJmaWxlIjoiZXhlYy9leGVjc2VydmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vKipcbiAqIEZ1bmN0aW9uYWxpdHkgdG8gZXhlY3V0ZSBhIGNlcnRhaW4gcmVzcG9uc2Ugb24gdGhlIHNlcnZlcixcbiAqIGludGVycHJldGluZyBhIGdlbmVyYWwgbW9kZWwgY29udGV4dFxuICpcbiAqXG4gKiB2aWEgYSkgY29tbWFuZGxpbmUgKGUuZy4gYnJvd3NlciBzdGFydHVwKVxuICogQGZpbGVcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2V4ZWNzZXJ2ZXInKTtcbnZhciBUb29sbWF0Y2ggPSByZXF1aXJlKFwiLi4vbWF0Y2gvdG9vbG1hdGNoXCIpO1xudmFyIEV4ZWN0ZW1wbGF0ZSA9IHJlcXVpcmUoXCIuL2V4ZWN0ZW1wbGF0ZVwiKTtcbmZ1bmN0aW9uIG5vU3RhcihhLCBiKSB7XG4gICAgaWYgKGIgPT09ICcqJykge1xuICAgICAgICByZXR1cm4gYTtcbiAgICB9XG4gICAgaWYgKGEgPT09ICcqJykge1xuICAgICAgICByZXR1cm4gYjtcbiAgICB9XG4gICAgaWYgKGEgIT09IGIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbGxlZ2FsIEFyZ3VtZW50IG5vIG1hdGNoICcgKyBhICsgXCIgXCIgKyBiKTtcbiAgICB9XG4gICAgcmV0dXJuIGI7XG59XG5leHBvcnRzLm5vU3RhciA9IG5vU3RhcjtcbmZ1bmN0aW9uIG1ha2VHZW5lcmljVGV4dChtYXRjaCwgc2V0SWQsIHJlY29yZCkge1xuICAgIHZhciByZXMgPSBcInN0YXJ0IFwiICsgbWF0Y2gudG9vbC5uYW1lO1xuICAgIHZhciBzZXQgPSBtYXRjaC50b29sLnNldHNbc2V0SWRdO1xuICAgIHZhciBjb250ZXh0ID0gVG9vbG1hdGNoLm1ha2VNYXRjaFNldChtYXRjaCwgc2V0KTtcbiAgICBzZXQuc2V0LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5LCBpbmRleCkge1xuICAgICAgICB2YXIgdmFsdWUgPSBub1N0YXIoY29udGV4dFtjYXRlZ29yeV0sIHJlY29yZFtjYXRlZ29yeV0pO1xuICAgICAgICB2YXIgcHJlZml4ID0gXCJcIjtcbiAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgICAgICBwcmVmaXggKz0gJyB1c2luZyAnO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGluZGV4ID09PSBzZXQuc2V0Lmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIHByZWZpeCArPSAnIGFuZCAnO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcHJlZml4ID0gJzsgJztcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2F0ZWdvcnkgPT09IFwiY2F0ZWdvcnlcIikge1xuICAgICAgICAgICAgcmVzID0gcmVzICsgcHJlZml4ICsgJ1wiJyArIHZhbHVlICsgJ1wiJztcbiAgICAgICAgfVxuICAgICAgICByZXMgPSByZXMgKyBwcmVmaXggKyBjYXRlZ29yeSArICcgXCInICsgdmFsdWUgKyAnXCInO1xuICAgIH0pO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLm1ha2VHZW5lcmljVGV4dCA9IG1ha2VHZW5lcmljVGV4dDtcbmZ1bmN0aW9uIGV4ZWNUb29sKG1hdGNoLCByZWNvcmRzLCBiRXhwbGFpbikge1xuICAgIC8vXG4gICAgZGVidWdsb2coXCJyZWNvcmRzIGZvciBtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoKSk7XG4gICAgdmFyIG1hdGNoU2V0UmVjb3JkID0gVG9vbG1hdGNoLmZpbmRGaXJzdFNldFJlY29yZChtYXRjaCwgcmVjb3Jkcyk7XG4gICAgaWYgKCFtYXRjaFNldFJlY29yZCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGV4dDogXCJjYW5ub3Qgc3RhcnRcIixcbiAgICAgICAgICAgIGFjdGlvbjoge31cbiAgICAgICAgfTtcbiAgICB9XG4gICAgO1xuICAgIHZhciBzZXQgPSBtYXRjaC50b29sLnNldHNbbWF0Y2hTZXRSZWNvcmQuc2V0SWRdO1xuICAgIHZhciBwYXR0ZXJuID0gbWF0Y2hTZXRSZWNvcmQucmVjb3JkW3NldC5yZXNwb25zZV07XG4gICAgdmFyIGNvbnRleHQgPSBUb29sbWF0Y2gubWFrZU1hdGNoU2V0KG1hdGNoLCBzZXQpO1xuICAgIHZhciB1cmwgPSBFeGVjdGVtcGxhdGUuZXhwYW5kVGVtcGxhdGUoY29udGV4dCwgcGF0dGVybik7XG4gICAgdmFyIHRleHQgPSBcIlwiO1xuICAgIGRlYnVnbG9nKFwicmVjb3JkIFwiICsgSlNPTi5zdHJpbmdpZnkoXCJtYXRjaFNldFJlY29yZCBcIikpO1xuICAgIHZhciBwYXR0ZXJuVGV4dCA9IG1hdGNoU2V0UmVjb3JkLnJlY29yZFtcIl90ZXh0XCIgKyBzZXQucmVzcG9uc2VdO1xuICAgIGlmIChwYXR0ZXJuVGV4dCkge1xuICAgICAgICB0ZXh0ID0gRXhlY3RlbXBsYXRlLmV4cGFuZFRlbXBsYXRlKGNvbnRleHQsIHBhdHRlcm5UZXh0KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHRleHQgPSBtYWtlR2VuZXJpY1RleHQobWF0Y2gsIG1hdGNoU2V0UmVjb3JkLnNldElkLCBtYXRjaFNldFJlY29yZC5yZWNvcmQpO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICB0ZXh0OiB0ZXh0LFxuICAgICAgICBhY3Rpb246IHsgdXJsOiB1cmwgfVxuICAgIH07XG59XG5leHBvcnRzLmV4ZWNUb29sID0gZXhlY1Rvb2w7XG4iLCIvKipcbiAqIEZ1bmN0aW9uYWxpdHkgdG8gZXhlY3V0ZSBhIGNlcnRhaW4gcmVzcG9uc2Ugb24gdGhlIHNlcnZlcixcbiAqIGludGVycHJldGluZyBhIGdlbmVyYWwgbW9kZWwgY29udGV4dFxuICpcbiAqXG4gKiB2aWEgYSkgY29tbWFuZGxpbmUgKGUuZy4gYnJvd3NlciBzdGFydHVwKVxuICogQGZpbGVcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXG5pbXBvcnQgKiBhcyBpbnRmIGZyb20gJ2NvbnN0YW50cyc7XG5cbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuaW1wb3J0ICogIGFzIElGTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XG5cbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ2V4ZWNzZXJ2ZXInKVxuXG5pbXBvcnQgeyBleGVjIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5cbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcbmltcG9ydCAqIGFzIE1hdGNoIGZyb20gJy4uL21hdGNoL21hdGNoJztcblxuXG5pbXBvcnQgKiBhcyBpbnB1dEZpbHRlclJ1bGVzIGZyb20gJy4uL21hdGNoL2lucHV0RmlsdGVyUnVsZXMnO1xuXG5cbmltcG9ydCAqIGFzIFRvb2xtYXRjaCBmcm9tICcuLi9tYXRjaC90b29sbWF0Y2gnO1xuXG5pbXBvcnQgKiBhcyBFeGVjdGVtcGxhdGUgZnJvbSAnLi9leGVjdGVtcGxhdGUnO1xuXG5leHBvcnQgZnVuY3Rpb24gbm9TdGFyKGE6IHN0cmluZywgYjogc3RyaW5nKSB7XG4gIGlmIChiID09PSAnKicpIHtcbiAgICByZXR1cm4gYTtcbiAgfVxuICBpZiAoYSA9PT0gJyonKSB7XG4gICAgcmV0dXJuIGI7XG4gIH1cbiAgaWYgKGEgIT09IGIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0lsbGVnYWwgQXJndW1lbnQgbm8gbWF0Y2ggJyArIGEgKyBcIiBcIiArIGIpO1xuICB9XG4gIHJldHVybiBiO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWFrZUdlbmVyaWNUZXh0KG1hdGNoOiBJTWF0Y2guSVRvb2xNYXRjaCwgc2V0SWQ6IHN0cmluZywgcmVjb3JkOiBJTWF0Y2guSVJlY29yZCk6IHN0cmluZyB7XG4gIHZhciByZXMgPSBcInN0YXJ0IFwiICsgbWF0Y2gudG9vbC5uYW1lO1xuICB2YXIgc2V0ID0gbWF0Y2gudG9vbC5zZXRzW3NldElkXTtcbiAgdmFyIGNvbnRleHQgPSBUb29sbWF0Y2gubWFrZU1hdGNoU2V0KG1hdGNoLCBzZXQpO1xuICBzZXQuc2V0LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5LCBpbmRleCkge1xuICAgIHZhciB2YWx1ZSA9IG5vU3Rhcihjb250ZXh0W2NhdGVnb3J5XSwgcmVjb3JkW2NhdGVnb3J5XSk7XG4gICAgdmFyIHByZWZpeCA9IFwiXCI7XG4gICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICBwcmVmaXggKz0gJyB1c2luZyAnO1xuICAgIH0gZWxzZSBpZiAoaW5kZXggPT09IHNldC5zZXQubGVuZ3RoIC0gMSkge1xuICAgICAgcHJlZml4ICs9ICcgYW5kICc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHByZWZpeCA9ICc7ICc7XG4gICAgfVxuICAgIGlmIChjYXRlZ29yeSA9PT0gXCJjYXRlZ29yeVwiKSB7XG4gICAgICByZXMgPSByZXMgKyBwcmVmaXggKydcIicgKyB2YWx1ZSArICdcIic7XG4gICAgfVxuICAgIHJlcyA9IHJlcyArIHByZWZpeCArIGNhdGVnb3J5ICsgJyBcIicgKyB2YWx1ZSAgKyAnXCInO1xuICB9KTtcbiAgcmV0dXJuIHJlcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4ZWNUb29sKG1hdGNoOiBJTWF0Y2guSVRvb2xNYXRjaCwgcmVjb3JkczogSU1hdGNoLklSZWNvcmRbXSwgYkV4cGxhaW4/OiBib29sZWFuICk6IHtcbiAgdGV4dDogc3RyaW5nLFxuICBhY3Rpb246IGFueVxufSB7XG4gIC8vXG4gIGRlYnVnbG9nKFwicmVjb3JkcyBmb3IgbWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaCkpO1xuICB2YXIgbWF0Y2hTZXRSZWNvcmQgPSBUb29sbWF0Y2guZmluZEZpcnN0U2V0UmVjb3JkKG1hdGNoLCByZWNvcmRzKTtcbiAgaWYoIW1hdGNoU2V0UmVjb3JkKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRleHQgOiBcImNhbm5vdCBzdGFydFwiLFxuICAgICAgYWN0aW9uOiB7fVxuICAgIH1cbiAgfTtcbiAgdmFyIHNldCA9IG1hdGNoLnRvb2wuc2V0c1ttYXRjaFNldFJlY29yZC5zZXRJZF07XG4gIHZhciBwYXR0ZXJuID0gbWF0Y2hTZXRSZWNvcmQucmVjb3JkW3NldC5yZXNwb25zZV07XG5cbiAgdmFyIGNvbnRleHQgPSBUb29sbWF0Y2gubWFrZU1hdGNoU2V0KG1hdGNoLCBzZXQpO1xuICB2YXIgdXJsID0gRXhlY3RlbXBsYXRlLmV4cGFuZFRlbXBsYXRlKGNvbnRleHQsIHBhdHRlcm4pO1xuICB2YXIgdGV4dCA9IFwiXCI7XG4gIGRlYnVnbG9nKFwicmVjb3JkIFwiICtKU09OLnN0cmluZ2lmeShcIm1hdGNoU2V0UmVjb3JkIFwiKSk7XG4gIHZhciBwYXR0ZXJuVGV4dCA9IG1hdGNoU2V0UmVjb3JkLnJlY29yZFtcIl90ZXh0XCIgKyBzZXQucmVzcG9uc2VdO1xuICBpZiAocGF0dGVyblRleHQpIHtcbiAgICB0ZXh0ID0gRXhlY3RlbXBsYXRlLmV4cGFuZFRlbXBsYXRlKGNvbnRleHQsIHBhdHRlcm5UZXh0KTtcbiAgfSBlbHNlIHtcbiAgICB0ZXh0ID0gbWFrZUdlbmVyaWNUZXh0KG1hdGNoLCBtYXRjaFNldFJlY29yZC5zZXRJZCwgbWF0Y2hTZXRSZWNvcmQucmVjb3JkKVxuICB9XG4gIHJldHVybiB7XG4gICAgdGV4dDogdGV4dCxcbiAgICBhY3Rpb246IHsgdXJsOiB1cmwgfVxuICB9XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
