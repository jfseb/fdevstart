"use strict";
/**
 * a logger for dialog conversations
 */
//declare module pg {};

Object.defineProperty(exports, "__esModule", { value: true });
var debug = require("debug");
var process = require("process");
exports.sqlActive = !!process.env.ABOT_LOGDB;
var debuglog = debug('dialoglogger');
;
;
var columns = ["botid", "userid", "message", "response", "action", "intent", "conversationid", "meta", "delta"];
// 0 indicates do not process /truncate, e.g. non string type
var columnLengths = [10, 40, 1024, 1024, 512, 20, 40, 0, 0];
function assureColumnLengthNotExceeded(obj) {
    columns.forEach(function (sCol, iIndex) {
        if (columnLengths[iIndex] && typeof obj[sCol] !== "string") {
            debuglog("Unexpected non-string value " + JSON.stringify(obj[sCol]));
            obj[sCol] = "" + obj[sCol];
        }
        if (obj[sCol] && columnLengths[iIndex] && obj[sCol].length > columnLengths[iIndex]) {
            obj[sCol] = obj[sCol].substring(0, columnLengths[iIndex]);
        }
    });
    return obj;
}
exports.assureColumnLengthNotExceeded = assureColumnLengthNotExceeded;
function logAnswer(answer, callback, ForceSqlActive) {
    "use strict";

    callback = callback || function () {};
    var session = answer.session;
    var sqlIsActive = ForceSqlActive || exports.sqlActive;
    var pg = this.pg;
    debuglog("here user id of message session.message.address " + JSON.stringify(session.message.address.user));
    var oLogEntry = {
        botid: session.message && session.message.address && session.message.address.bot && session.message.address.bot.id || this.name,
        userid: session.message.address && session.message.address.user && session.message.address.user.id || "",
        message: session.message.text,
        response: answer.response,
        action: answer.action,
        intent: answer.intent,
        conversationid: session.message.address && session.message.address.conversation && session.message.address.conversation.id || "",
        meta: answer.result || {},
        delta: Date.now() - Date.parse(session.message.timestamp)
    };
    oLogEntry = assureColumnLengthNotExceeded(oLogEntry);
    debuglog("sqlIsActive" + sqlIsActive);
    if (!sqlIsActive) {
        return;
    }
    pg.connect(this.dburl, function (err, client, pgDone) {
        if (err) {
            // failed to acquire connection
            //logger.emit('error', err);
            debuglog('Error connecting to db' + err);
            callback(err);
        } else {
            var query = "INSERT INTO logconv (" + columns.join(",") + ") " +
            //   (convid, sessionid, user, message, response, meta) ` +
            "VALUES ( " +
            // $1, $2, ...
            columns.map(function (o, iIndex) {
                return "$" + (iIndex + 1);
            }).join(", ") + ")";
            var values = columns.map(function (sCol) {
                return oLogEntry[sCol];
            });
            //  [level, msg, meta instanceof Array ? JSON.stringify(meta) : meta],
            client.query(query, values, function (err, result) {
                pgDone();
                if (err) {
                    // logger.emit('error', err);
                    debuglog('Error inserting record into db ' + err + '\n' + values.join("\n"));
                    callback(err);
                } else {
                    //  logger.emit('logged');
                    callback(null, true);
                }
            });
        }
    });
}
exports.logAnswer = logAnswer;
var loggers = {};
function logger(name, dburl, pg) {
    if (!dburl) {
        throw new Error('need database url');
    }
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            dburl: dburl,
            pg: pg
        };
        alogger.logIt = logAnswer.bind(alogger);
        loggers[name] = alogger;
    }
    if (loggers[name].dburl !== dburl) {
        throw new Error('Flags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzL2RpYWxvZ2xvZ2dlci5qcyIsIi4uL3NyYy91dGlscy9kaWFsb2dsb2dnZXIudHMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWJ1ZyIsInJlcXVpcmUiLCJwcm9jZXNzIiwic3FsQWN0aXZlIiwiZW52IiwiQUJPVF9MT0dEQiIsImRlYnVnbG9nIiwiY29sdW1ucyIsImNvbHVtbkxlbmd0aHMiLCJhc3N1cmVDb2x1bW5MZW5ndGhOb3RFeGNlZWRlZCIsIm9iaiIsImZvckVhY2giLCJzQ29sIiwiaUluZGV4IiwiSlNPTiIsInN0cmluZ2lmeSIsImxlbmd0aCIsInN1YnN0cmluZyIsImxvZ0Fuc3dlciIsImFuc3dlciIsImNhbGxiYWNrIiwiRm9yY2VTcWxBY3RpdmUiLCJzZXNzaW9uIiwic3FsSXNBY3RpdmUiLCJwZyIsIm1lc3NhZ2UiLCJhZGRyZXNzIiwidXNlciIsIm9Mb2dFbnRyeSIsImJvdGlkIiwiYm90IiwiaWQiLCJuYW1lIiwidXNlcmlkIiwidGV4dCIsInJlc3BvbnNlIiwiYWN0aW9uIiwiaW50ZW50IiwiY29udmVyc2F0aW9uaWQiLCJjb252ZXJzYXRpb24iLCJtZXRhIiwicmVzdWx0IiwiZGVsdGEiLCJEYXRlIiwibm93IiwicGFyc2UiLCJ0aW1lc3RhbXAiLCJjb25uZWN0IiwiZGJ1cmwiLCJlcnIiLCJjbGllbnQiLCJwZ0RvbmUiLCJxdWVyeSIsImpvaW4iLCJtYXAiLCJvIiwidmFsdWVzIiwibG9nZ2VycyIsImxvZ2dlciIsIkVycm9yIiwiZXhlYyIsImFsb2dnZXIiLCJsb2dJdCIsImJpbmQiXSwibWFwcGluZ3MiOiJBQUFBO0FDQUE7OztBQUdBOztBREVBQSxPQUFPQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QyxFQUFFQyxPQUFPLElBQVQsRUFBN0M7QUNFQSxJQUFBQyxRQUFBQyxRQUFBLE9BQUEsQ0FBQTtBQUNBLElBQUFDLFVBQUFELFFBQUEsU0FBQSxDQUFBO0FBR1dILFFBQUFLLFNBQUEsR0FBWSxDQUFDLENBQUVELFFBQVFFLEdBQVIsQ0FBWUMsVUFBM0I7QUFFWCxJQUFNQyxXQUFXTixNQUFNLGNBQU4sQ0FBakI7QUFPQztBQWVBO0FBVUQsSUFBTU8sVUFBVSxDQUFDLE9BQUQsRUFBUyxRQUFULEVBQW1CLFNBQW5CLEVBQThCLFVBQTlCLEVBQTBDLFFBQTFDLEVBQW9ELFFBQXBELEVBQThELGdCQUE5RCxFQUFnRixNQUFoRixFQUF3RixPQUF4RixDQUFoQjtBQUNBO0FBQ0EsSUFBTUMsZ0JBQWdCLENBQUMsRUFBRCxFQUFLLEVBQUwsRUFBUyxJQUFULEVBQWUsSUFBZixFQUFxQixHQUFyQixFQUEwQixFQUExQixFQUE4QixFQUE5QixFQUFrQyxDQUFsQyxFQUFvQyxDQUFwQyxDQUF0QjtBQUdBLFNBQUFDLDZCQUFBLENBQThDQyxHQUE5QyxFQUE2RDtBQUMzREgsWUFBUUksT0FBUixDQUFnQixVQUFTQyxJQUFULEVBQWNDLE1BQWQsRUFBb0I7QUFDbEMsWUFBR0wsY0FBY0ssTUFBZCxLQUF5QixPQUFPSCxJQUFJRSxJQUFKLENBQVAsS0FBc0IsUUFBbEQsRUFBNEQ7QUFDMUROLHFCQUFTLGlDQUFpQ1EsS0FBS0MsU0FBTCxDQUFlTCxJQUFJRSxJQUFKLENBQWYsQ0FBMUM7QUFDQUYsZ0JBQUlFLElBQUosSUFBWSxLQUFJRixJQUFJRSxJQUFKLENBQWhCO0FBQ0Q7QUFDRCxZQUFHRixJQUFJRSxJQUFKLEtBQWFKLGNBQWNLLE1BQWQsQ0FBYixJQUFzQ0gsSUFBSUUsSUFBSixFQUFVSSxNQUFWLEdBQW1CUixjQUFjSyxNQUFkLENBQTVELEVBQW1GO0FBQ2pGSCxnQkFBSUUsSUFBSixJQUFZRixJQUFJRSxJQUFKLEVBQVVLLFNBQVYsQ0FBb0IsQ0FBcEIsRUFBc0JULGNBQWNLLE1BQWQsQ0FBdEIsQ0FBWjtBQUNEO0FBQ0YsS0FSRDtBQVNBLFdBQU9ILEdBQVA7QUFDRDtBQVhEWixRQUFBVyw2QkFBQSxHQUFBQSw2QkFBQTtBQWFBLFNBQUFTLFNBQUEsQ0FBMEJDLE1BQTFCLEVBQTJDQyxRQUEzQyxFQUFzRkMsY0FBdEYsRUFBK0c7QUFDN0c7O0FBQ0FELGVBQVdBLFlBQWEsWUFBQSxDQUFhLENBQXJDO0FBQ0EsUUFBSUUsVUFBVUgsT0FBT0csT0FBckI7QUFDQSxRQUFJQyxjQUFjRixrQkFBa0J2QixRQUFBSyxTQUFwQztBQUNBLFFBQUlxQixLQUFLLEtBQUtBLEVBQWQ7QUFDQWxCLGFBQVMscURBQ1RRLEtBQUtDLFNBQUwsQ0FBZU8sUUFBUUcsT0FBUixDQUFnQkMsT0FBaEIsQ0FBd0JDLElBQXZDLENBREE7QUFFQSxRQUFJQyxZQUF3QjtBQUMxQkMsZUFBU1AsUUFBUUcsT0FBUixJQUFtQkgsUUFBUUcsT0FBUixDQUFnQkMsT0FBbkMsSUFBOENKLFFBQVFHLE9BQVIsQ0FBZ0JDLE9BQWhCLENBQXdCSSxHQUF0RSxJQUE2RVIsUUFBUUcsT0FBUixDQUFnQkMsT0FBaEIsQ0FBd0JJLEdBQXhCLENBQTRCQyxFQUExRyxJQUFrSCxLQUFLQyxJQURyRztBQUUxQkMsZ0JBQVFYLFFBQVFHLE9BQVIsQ0FBZ0JDLE9BQWhCLElBQ0xKLFFBQVFHLE9BQVIsQ0FBZ0JDLE9BQWhCLENBQXdCQyxJQURuQixJQUVMTCxRQUFRRyxPQUFSLENBQWdCQyxPQUFoQixDQUF3QkMsSUFBeEIsQ0FBNkJJLEVBRnhCLElBRThCLEVBSlo7QUFLMUJOLGlCQUFTSCxRQUFRRyxPQUFSLENBQWdCUyxJQUxDO0FBTTFCQyxrQkFBV2hCLE9BQU9nQixRQU5RO0FBTzFCQyxnQkFBU2pCLE9BQU9pQixNQVBVO0FBUzFCQyxnQkFBUWxCLE9BQU9rQixNQVRXO0FBVzFCQyx3QkFBZ0JoQixRQUFRRyxPQUFSLENBQWdCQyxPQUFoQixJQUNiSixRQUFRRyxPQUFSLENBQWdCQyxPQUFoQixDQUF3QmEsWUFEWCxJQUViakIsUUFBUUcsT0FBUixDQUFnQkMsT0FBaEIsQ0FBd0JhLFlBQXhCLENBQXFDUixFQUZ4QixJQUU4QixFQWJwQjtBQWUxQlMsY0FBT3JCLE9BQU9zQixNQUFQLElBQWlCLEVBZkU7QUFpQjFCQyxlQUFRQyxLQUFLQyxHQUFMLEtBQWFELEtBQUtFLEtBQUwsQ0FBV3ZCLFFBQVFHLE9BQVIsQ0FBZ0JxQixTQUEzQjtBQWpCSyxLQUE1QjtBQW9CQWxCLGdCQUFZbkIsOEJBQThCbUIsU0FBOUIsQ0FBWjtBQUNBdEIsYUFBUyxnQkFBZ0JpQixXQUF6QjtBQUNBLFFBQUksQ0FBQ0EsV0FBTCxFQUFrQjtBQUNoQjtBQUNEO0FBQ0RDLE9BQUd1QixPQUFILENBQVcsS0FBS0MsS0FBaEIsRUFBdUIsVUFBQ0MsR0FBRCxFQUFNQyxNQUFOLEVBQTBCQyxNQUExQixFQUFnQztBQUNuRCxZQUFJRixHQUFKLEVBQVM7QUFDUDtBQUNBO0FBQ0EzQyxxQkFBUywyQkFBMkIyQyxHQUFwQztBQUNBN0IscUJBQVM2QixHQUFUO0FBQ0QsU0FMRCxNQUtPO0FBQ0wsZ0JBQUlHLFFBQU8sMEJBQTBCN0MsUUFBUThDLElBQVIsQ0FBYSxHQUFiLENBQTFCLEdBQThDLElBQTlDO0FBQ1g7QUFDQSx1QkFGVztBQUdYO0FBQ0M5QyxvQkFBUStDLEdBQVIsQ0FBWSxVQUFTQyxDQUFULEVBQVcxQyxNQUFYLEVBQWlCO0FBQUksdUJBQU8sT0FBT0EsU0FBTyxDQUFkLENBQVA7QUFBMEIsYUFBM0QsRUFBNkR3QyxJQUE3RCxDQUFrRSxJQUFsRSxDQUpVLEdBSWdFLEdBSjNFO0FBTUEsZ0JBQUlHLFNBQVNqRCxRQUFRK0MsR0FBUixDQUFZLFVBQVMxQyxJQUFULEVBQWE7QUFDakMsdUJBQU9nQixVQUFVaEIsSUFBVixDQUFQO0FBQ0QsYUFGUyxDQUFiO0FBR0c7QUFFSHNDLG1CQUFPRSxLQUFQLENBQWFBLEtBQWIsRUFBbUJJLE1BQW5CLEVBRWEsVUFBQ1AsR0FBRCxFQUFNUixNQUFOLEVBQVk7QUFDckJVO0FBQ0Esb0JBQUlGLEdBQUosRUFBUztBQUNSO0FBQ0EzQyw2QkFBUyxvQ0FBb0MyQyxHQUFwQyxHQUEwQyxJQUExQyxHQUNOTyxPQUFPSCxJQUFQLENBQVksSUFBWixDQURIO0FBRUNqQyw2QkFBUzZCLEdBQVQ7QUFDRCxpQkFMRCxNQUtPO0FBQ1A7QUFDRTdCLDZCQUFTLElBQVQsRUFBZSxJQUFmO0FBQ0Q7QUFDSixhQWJEO0FBY0Q7QUFDRixLQWpDSDtBQWtDQztBQW5FSHRCLFFBQUFvQixTQUFBLEdBQUFBLFNBQUE7QUFxRUEsSUFBSXVDLFVBQVUsRUFBZDtBQUVBLFNBQUFDLE1BQUEsQ0FBdUIxQixJQUF2QixFQUFxQ2dCLEtBQXJDLEVBQXFEeEIsRUFBckQsRUFBNEQ7QUFDMUQsUUFBSSxDQUFDd0IsS0FBTCxFQUFZO0FBQ1YsY0FBTSxJQUFJVyxLQUFKLENBQVUsbUJBQVYsQ0FBTjtBQUNEO0FBQ0QsUUFBSSxPQUFPM0IsSUFBUCxLQUFnQixRQUFoQixJQUE0QixDQUFDLDBCQUEwQjRCLElBQTFCLENBQStCNUIsSUFBL0IsQ0FBakMsRUFBdUU7QUFDckUsY0FBTSxJQUFJMkIsS0FBSixDQUFVLDBEQUFWLENBQU47QUFDRDtBQUNELFFBQUksQ0FBQ0YsUUFBUXpCLElBQVIsQ0FBTCxFQUFvQjtBQUNsQixZQUFJNkIsVUFBVTtBQUNaN0Isa0JBQU1BLElBRE07QUFFWmdCLG1CQUFPQSxLQUZLO0FBR1p4QixnQkFBS0E7QUFITyxTQUFkO0FBS0FxQyxnQkFBUUMsS0FBUixHQUFnQjVDLFVBQVU2QyxJQUFWLENBQWVGLE9BQWYsQ0FBaEI7QUFDQUosZ0JBQVF6QixJQUFSLElBQWdCNkIsT0FBaEI7QUFDRDtBQUNELFFBQUlKLFFBQVF6QixJQUFSLEVBQWNnQixLQUFkLEtBQXdCQSxLQUE1QixFQUFtQztBQUNqQyxjQUFNLElBQUlXLEtBQUosQ0FBVSw2QkFBNkIzQixJQUF2QyxDQUFOO0FBQ0Q7QUFDRCxXQUFPeUIsUUFBUXpCLElBQVIsRUFBYzhCLEtBQXJCO0FBQ0Q7QUFwQkRoRSxRQUFBNEQsTUFBQSxHQUFBQSxNQUFBIiwiZmlsZSI6InV0aWxzL2RpYWxvZ2xvZ2dlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuLyoqXG4gKiBhIGxvZ2dlciBmb3IgZGlhbG9nIGNvbnZlcnNhdGlvbnNcbiAqL1xuLy9kZWNsYXJlIG1vZHVsZSBwZyB7fTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKTtcbnZhciBwcm9jZXNzID0gcmVxdWlyZShcInByb2Nlc3NcIik7XG5leHBvcnRzLnNxbEFjdGl2ZSA9ICEhKHByb2Nlc3MuZW52LkFCT1RfTE9HREIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2RpYWxvZ2xvZ2dlcicpO1xuO1xuO1xudmFyIGNvbHVtbnMgPSBbXCJib3RpZFwiLCBcInVzZXJpZFwiLCBcIm1lc3NhZ2VcIiwgXCJyZXNwb25zZVwiLCBcImFjdGlvblwiLCBcImludGVudFwiLCBcImNvbnZlcnNhdGlvbmlkXCIsIFwibWV0YVwiLCBcImRlbHRhXCJdO1xuLy8gMCBpbmRpY2F0ZXMgZG8gbm90IHByb2Nlc3MgL3RydW5jYXRlLCBlLmcuIG5vbiBzdHJpbmcgdHlwZVxudmFyIGNvbHVtbkxlbmd0aHMgPSBbMTAsIDQwLCAxMDI0LCAxMDI0LCA1MTIsIDIwLCA0MCwgMCwgMF07XG5mdW5jdGlvbiBhc3N1cmVDb2x1bW5MZW5ndGhOb3RFeGNlZWRlZChvYmopIHtcbiAgICBjb2x1bW5zLmZvckVhY2goZnVuY3Rpb24gKHNDb2wsIGlJbmRleCkge1xuICAgICAgICBpZiAoY29sdW1uTGVuZ3Roc1tpSW5kZXhdICYmIHR5cGVvZiBvYmpbc0NvbF0gIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiVW5leHBlY3RlZCBub24tc3RyaW5nIHZhbHVlIFwiICsgSlNPTi5zdHJpbmdpZnkob2JqW3NDb2xdKSk7XG4gICAgICAgICAgICBvYmpbc0NvbF0gPSBcIlwiICsgb2JqW3NDb2xdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChvYmpbc0NvbF0gJiYgY29sdW1uTGVuZ3Roc1tpSW5kZXhdICYmIG9ialtzQ29sXS5sZW5ndGggPiBjb2x1bW5MZW5ndGhzW2lJbmRleF0pIHtcbiAgICAgICAgICAgIG9ialtzQ29sXSA9IG9ialtzQ29sXS5zdWJzdHJpbmcoMCwgY29sdW1uTGVuZ3Roc1tpSW5kZXhdKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBvYmo7XG59XG5leHBvcnRzLmFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkID0gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQ7XG5mdW5jdGlvbiBsb2dBbnN3ZXIoYW5zd2VyLCBjYWxsYmFjaywgRm9yY2VTcWxBY3RpdmUpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IChmdW5jdGlvbiAoKSB7IH0pO1xuICAgIHZhciBzZXNzaW9uID0gYW5zd2VyLnNlc3Npb247XG4gICAgdmFyIHNxbElzQWN0aXZlID0gRm9yY2VTcWxBY3RpdmUgfHwgZXhwb3J0cy5zcWxBY3RpdmU7XG4gICAgdmFyIHBnID0gdGhpcy5wZztcbiAgICBkZWJ1Z2xvZyhcImhlcmUgdXNlciBpZCBvZiBtZXNzYWdlIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzIFwiICtcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkoc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlcikpO1xuICAgIHZhciBvTG9nRW50cnkgPSB7XG4gICAgICAgIGJvdGlkOiAoc2Vzc2lvbi5tZXNzYWdlICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmJvdCAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5ib3QuaWQpIHx8IHRoaXMubmFtZSxcbiAgICAgICAgdXNlcmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlclxuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlci5pZCB8fCBcIlwiLFxuICAgICAgICBtZXNzYWdlOiBzZXNzaW9uLm1lc3NhZ2UudGV4dCxcbiAgICAgICAgcmVzcG9uc2U6IGFuc3dlci5yZXNwb25zZSxcbiAgICAgICAgYWN0aW9uOiBhbnN3ZXIuYWN0aW9uLFxuICAgICAgICBpbnRlbnQ6IGFuc3dlci5pbnRlbnQsXG4gICAgICAgIGNvbnZlcnNhdGlvbmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uXG4gICAgICAgICAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5jb252ZXJzYXRpb24uaWQgfHwgXCJcIixcbiAgICAgICAgbWV0YTogYW5zd2VyLnJlc3VsdCB8fCB7fSxcbiAgICAgICAgZGVsdGE6IERhdGUubm93KCkgLSBEYXRlLnBhcnNlKHNlc3Npb24ubWVzc2FnZS50aW1lc3RhbXApLFxuICAgIH07XG4gICAgb0xvZ0VudHJ5ID0gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQob0xvZ0VudHJ5KTtcbiAgICBkZWJ1Z2xvZyhcInNxbElzQWN0aXZlXCIgKyBzcWxJc0FjdGl2ZSk7XG4gICAgaWYgKCFzcWxJc0FjdGl2ZSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHBnLmNvbm5lY3QodGhpcy5kYnVybCwgZnVuY3Rpb24gKGVyciwgY2xpZW50LCBwZ0RvbmUpIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgLy8gZmFpbGVkIHRvIGFjcXVpcmUgY29ubmVjdGlvblxuICAgICAgICAgICAgLy9sb2dnZXIuZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICAgICAgZGVidWdsb2coJ0Vycm9yIGNvbm5lY3RpbmcgdG8gZGInICsgZXJyKTtcbiAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB2YXIgcXVlcnkgPSBcIklOU0VSVCBJTlRPIGxvZ2NvbnYgKFwiICsgY29sdW1ucy5qb2luKFwiLFwiKSArIFwiKSBcIiArXG4gICAgICAgICAgICAgICAgLy8gICAoY29udmlkLCBzZXNzaW9uaWQsIHVzZXIsIG1lc3NhZ2UsIHJlc3BvbnNlLCBtZXRhKSBgICtcbiAgICAgICAgICAgICAgICBcIlZBTFVFUyAoIFwiICtcbiAgICAgICAgICAgICAgICAvLyAkMSwgJDIsIC4uLlxuICAgICAgICAgICAgICAgIGNvbHVtbnMubWFwKGZ1bmN0aW9uIChvLCBpSW5kZXgpIHsgcmV0dXJuIFwiJFwiICsgKGlJbmRleCArIDEpOyB9KS5qb2luKFwiLCBcIikgKyBcIilcIjtcbiAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBjb2x1bW5zLm1hcChmdW5jdGlvbiAoc0NvbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBvTG9nRW50cnlbc0NvbF07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vICBbbGV2ZWwsIG1zZywgbWV0YSBpbnN0YW5jZW9mIEFycmF5ID8gSlNPTi5zdHJpbmdpZnkobWV0YSkgOiBtZXRhXSxcbiAgICAgICAgICAgIGNsaWVudC5xdWVyeShxdWVyeSwgdmFsdWVzLCBmdW5jdGlvbiAoZXJyLCByZXN1bHQpIHtcbiAgICAgICAgICAgICAgICBwZ0RvbmUoKTtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGxvZ2dlci5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgICAgICAgICAgICAgIGRlYnVnbG9nKCdFcnJvciBpbnNlcnRpbmcgcmVjb3JkIGludG8gZGIgJyArIGVyciArICdcXG4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vICBsb2dnZXIuZW1pdCgnbG9nZ2VkJyk7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5leHBvcnRzLmxvZ0Fuc3dlciA9IGxvZ0Fuc3dlcjtcbnZhciBsb2dnZXJzID0ge307XG5mdW5jdGlvbiBsb2dnZXIobmFtZSwgZGJ1cmwsIHBnKSB7XG4gICAgaWYgKCFkYnVybCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25lZWQgZGF0YWJhc2UgdXJsJyk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gXCJzdHJpbmdcIiB8fCAhL15bQS1aYS16XVtBLVphLXowLTlfXSskLy5leGVjKG5hbWUpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIG5hbWUgbXVzdCBiZSBhdCBsZWFzdCB0d28gYWxwaGFudW1lcmljIGNoYXJhY3RlcnMnKTtcbiAgICB9XG4gICAgaWYgKCFsb2dnZXJzW25hbWVdKSB7XG4gICAgICAgIHZhciBhbG9nZ2VyID0ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIGRidXJsOiBkYnVybCxcbiAgICAgICAgICAgIHBnOiBwZ1xuICAgICAgICB9O1xuICAgICAgICBhbG9nZ2VyLmxvZ0l0ID0gbG9nQW5zd2VyLmJpbmQoYWxvZ2dlcik7XG4gICAgICAgIGxvZ2dlcnNbbmFtZV0gPSBhbG9nZ2VyO1xuICAgIH1cbiAgICBpZiAobG9nZ2Vyc1tuYW1lXS5kYnVybCAhPT0gZGJ1cmwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGbGFncyBtaXNtYXRjaCBpbiBsb2dnZXInICsgbmFtZSk7XG4gICAgfVxuICAgIHJldHVybiBsb2dnZXJzW25hbWVdLmxvZ0l0O1xufVxuZXhwb3J0cy5sb2dnZXIgPSBsb2dnZXI7XG4iLCIvKipcbiAqIGEgbG9nZ2VyIGZvciBkaWFsb2cgY29udmVyc2F0aW9uc1xuICovXG4vL2RlY2xhcmUgbW9kdWxlIHBnIHt9O1xuXG5pbXBvcnQgKiBhcyBidWlsZGVyIGZyb20gJ2JvdGJ1aWxkZXInO1xuaW1wb3J0ICogYXMgcGcgZnJvbSAncGcnO1xuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0ICogYXMgcHJvY2VzcyBmcm9tICdwcm9jZXNzJztcblxuXG5leHBvcnQgdmFyIHNxbEFjdGl2ZSA9ICEhKHByb2Nlc3MuZW52LkFCT1RfTE9HREIpO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdkaWFsb2dsb2dnZXInKTtcblxuaW50ZXJmYWNlIElMb2dnZXIge1xuICBuYW1lOiBzdHJpbmcsXG4gIGRidXJsOiBzdHJpbmcsXG4gIGxvZ0l0PzogKGEgOiBJQW5zd2VyLCBjYWxsYmFjayA6IChlcnIgOiBhbnksIHJlcz8gOiBhbnkpID0+IHZvaWQpID0+IHZvaWQsXG4gIHBnIDogYW55XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIElMb2dFbnRyeSB7XG4gIGJvdGlkIDogc3RyaW5nLCAvKiAxMCAqL1xuICB1c2VyaWQgOiBzdHJpbmcsXG4gIG1lc3NhZ2UgOiBzdHJpbmcsXG4gIHJlc3BvbnNlIDogc3RyaW5nLFxuICBhY3Rpb24gOiBzdHJpbmcsXG4gIGludGVudCA6IHN0cmluZyxcbiAgY29udmVyc2F0aW9uaWQgOiBzdHJpbmcsXG4gIC8qKlxuICAgKiBhbiByZXN1bHRcbiAgICoqL1xuICBtZXRhIDogYW55LFxuICBkZWx0YTogbnVtYmVyXG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIElBbnN3ZXIge1xuICBzZXNzaW9uIDogYnVpbGRlci5TZXNzaW9uLFxuICBpbnRlbnQgOiBzdHJpbmcsXG4gIHJlc3BvbnNlIDogc3RyaW5nLFxuICBhY3Rpb24/IDogc3RyaW5nLFxuICByZXN1bHQ/IDogYW55LFxufVxuXG5jb25zdCBjb2x1bW5zID0gW1wiYm90aWRcIixcInVzZXJpZFwiLCBcIm1lc3NhZ2VcIiwgXCJyZXNwb25zZVwiLCBcImFjdGlvblwiLCBcImludGVudFwiLCBcImNvbnZlcnNhdGlvbmlkXCIsIFwibWV0YVwiLCBcImRlbHRhXCJdO1xuLy8gMCBpbmRpY2F0ZXMgZG8gbm90IHByb2Nlc3MgL3RydW5jYXRlLCBlLmcuIG5vbiBzdHJpbmcgdHlwZVxuY29uc3QgY29sdW1uTGVuZ3RocyA9IFsxMCwgNDAsIDEwMjQsIDEwMjQsIDUxMiwgMjAsIDQwLCAwLDAgXTtcblxuXG5leHBvcnQgZnVuY3Rpb24gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQob2JqIDogSUxvZ0VudHJ5KSA6IElMb2dFbnRyeSB7XG4gIGNvbHVtbnMuZm9yRWFjaChmdW5jdGlvbihzQ29sLGlJbmRleCkge1xuICAgIGlmKGNvbHVtbkxlbmd0aHNbaUluZGV4XSAmJiB0eXBlb2Ygb2JqW3NDb2xdICE9PSAgXCJzdHJpbmdcIikge1xuICAgICAgZGVidWdsb2coXCJVbmV4cGVjdGVkIG5vbi1zdHJpbmcgdmFsdWUgXCIgKyBKU09OLnN0cmluZ2lmeShvYmpbc0NvbF0pKTtcbiAgICAgIG9ialtzQ29sXSA9IFwiXCIrIG9ialtzQ29sXTtcbiAgICB9XG4gICAgaWYob2JqW3NDb2xdICYmIGNvbHVtbkxlbmd0aHNbaUluZGV4XSAmJiBvYmpbc0NvbF0ubGVuZ3RoID4gY29sdW1uTGVuZ3Roc1tpSW5kZXhdKSB7XG4gICAgICBvYmpbc0NvbF0gPSBvYmpbc0NvbF0uc3Vic3RyaW5nKDAsY29sdW1uTGVuZ3Roc1tpSW5kZXhdKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gb2JqO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbG9nQW5zd2VyKGFuc3dlcjogSUFuc3dlciwgY2FsbGJhY2sgOiAoZXJyOiBhbnksIHJlcz86IGFueSkgPT4gdm9pZCAsIEZvcmNlU3FsQWN0aXZlPyA6IGJvb2xlYW4pIHtcbiAgXCJ1c2Ugc3RyaWN0XCI7XG4gIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgKGZ1bmN0aW9uKCkge30pO1xuICB2YXIgc2Vzc2lvbiA9IGFuc3dlci5zZXNzaW9uO1xuICB2YXIgc3FsSXNBY3RpdmUgPSBGb3JjZVNxbEFjdGl2ZSB8fCBzcWxBY3RpdmU7XG4gIHZhciBwZyA9IHRoaXMucGc7XG4gIGRlYnVnbG9nKFwiaGVyZSB1c2VyIGlkIG9mIG1lc3NhZ2Ugc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MgXCIgK1xuICBKU09OLnN0cmluZ2lmeShzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyKSk7XG4gIHZhciBvTG9nRW50cnkgOiBJTG9nRW50cnkgPSB7XG4gICAgYm90aWQgOiAoc2Vzc2lvbi5tZXNzYWdlICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmJvdCAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5ib3QuaWQgKSB8fCB0aGlzLm5hbWUsXG4gICAgdXNlcmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXJcbiAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyLmlkIHx8IFwiXCIsXG4gICAgbWVzc2FnZTogc2Vzc2lvbi5tZXNzYWdlLnRleHQsXG4gICAgcmVzcG9uc2UgOiBhbnN3ZXIucmVzcG9uc2UsXG4gICAgYWN0aW9uIDogYW5zd2VyLmFjdGlvbixcblxuICAgIGludGVudDogYW5zd2VyLmludGVudCxcblxuICAgIGNvbnZlcnNhdGlvbmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvblxuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvbi5pZCB8fCBcIlwiLFxuXG4gICAgbWV0YSA6IGFuc3dlci5yZXN1bHQgfHwge30sXG5cbiAgICBkZWx0YSA6IERhdGUubm93KCkgLSBEYXRlLnBhcnNlKHNlc3Npb24ubWVzc2FnZS50aW1lc3RhbXApLFxuICB9O1xuXG4gIG9Mb2dFbnRyeSA9IGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9Mb2dFbnRyeSk7XG4gIGRlYnVnbG9nKFwic3FsSXNBY3RpdmVcIiArIHNxbElzQWN0aXZlKTtcbiAgaWYgKCFzcWxJc0FjdGl2ZSkge1xuICAgIHJldHVybjtcbiAgfVxuICBwZy5jb25uZWN0KHRoaXMuZGJ1cmwsIChlcnIsIGNsaWVudCA6IHBnLkNsaWVudCwgcGdEb25lKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIC8vIGZhaWxlZCB0byBhY3F1aXJlIGNvbm5lY3Rpb25cbiAgICAgICAgLy9sb2dnZXIuZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICBkZWJ1Z2xvZygnRXJyb3IgY29ubmVjdGluZyB0byBkYicgKyBlcnIpO1xuICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIHF1ZXJ5ID1gSU5TRVJUIElOVE8gbG9nY29udiAoYCArIGNvbHVtbnMuam9pbihcIixcIikgKyBcIikgXCIgK1xuICAgICAgICAvLyAgIChjb252aWQsIHNlc3Npb25pZCwgdXNlciwgbWVzc2FnZSwgcmVzcG9uc2UsIG1ldGEpIGAgK1xuICAgICAgICBcIlZBTFVFUyAoIFwiICArXG4gICAgICAgIC8vICQxLCAkMiwgLi4uXG4gICAgICAgICBjb2x1bW5zLm1hcChmdW5jdGlvbihvLGlJbmRleCkgeyByZXR1cm4gXCIkXCIgKyAoaUluZGV4KzEpOyB9KS5qb2luKFwiLCBcIikgKyBcIilcIjtcblxuICAgICAgICB2YXIgdmFsdWVzID0gY29sdW1ucy5tYXAoZnVuY3Rpb24oc0NvbCkge1xuICAgICAgICAgICAgIHJldHVybiBvTG9nRW50cnlbc0NvbF07XG4gICAgICAgICAgIH0pO1xuICAgICAgICAgICAvLyAgW2xldmVsLCBtc2csIG1ldGEgaW5zdGFuY2VvZiBBcnJheSA/IEpTT04uc3RyaW5naWZ5KG1ldGEpIDogbWV0YV0sXG5cbiAgICAgICAgY2xpZW50LnF1ZXJ5KHF1ZXJ5LHZhbHVlcyxcblxuICAgICAgICAgICAgICAgICAgICAgKGVyciwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBwZ0RvbmUoKTtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAvLyBsb2dnZXIuZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICAgICAgIGRlYnVnbG9nKCdFcnJvciBpbnNlcnRpbmcgcmVjb3JkIGludG8gZGIgJyArIGVyciArICdcXG4nICtcbiAgICAgICAgICAgICAgICB2YWx1ZXMuam9pbihcIlxcblwiKSk7XG4gICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gIGxvZ2dlci5lbWl0KCdsb2dnZWQnKTtcbiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbnZhciBsb2dnZXJzID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBJTG9nZ2VyIH07XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2dnZXIobmFtZTogc3RyaW5nLCBkYnVybCA6IHN0cmluZywgcGc6IGFueSkgOiAoYTogSUFuc3dlciwgY2FsbGJhY2s/OiAoZXJyOmFueSwgcmVzPyA6YW55KSA9PiB2b2lkKSA9PiB2b2lkICB7XG4gIGlmICghZGJ1cmwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ25lZWQgZGF0YWJhc2UgdXJsJyk7XG4gIH1cbiAgaWYgKHR5cGVvZiBuYW1lICE9PSBcInN0cmluZ1wiIHx8ICEvXltBLVphLXpdW0EtWmEtejAtOV9dKyQvLmV4ZWMobmFtZSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvZ2dlciBuYW1lIG11c3QgYmUgYXQgbGVhc3QgdHdvIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzJylcbiAgfVxuICBpZiAoIWxvZ2dlcnNbbmFtZV0pIHtcbiAgICB2YXIgYWxvZ2dlciA9IHtcbiAgICAgIG5hbWU6IG5hbWUsXG4gICAgICBkYnVybDogZGJ1cmwsXG4gICAgICBwZyA6IHBnXG4gICAgfSBhcyBJTG9nZ2VyO1xuICAgIGFsb2dnZXIubG9nSXQgPSBsb2dBbnN3ZXIuYmluZChhbG9nZ2VyKTtcbiAgICBsb2dnZXJzW25hbWVdID0gYWxvZ2dlcjtcbiAgfVxuICBpZiAobG9nZ2Vyc1tuYW1lXS5kYnVybCAhPT0gZGJ1cmwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZsYWdzIG1pc21hdGNoIGluIGxvZ2dlcicgKyBuYW1lKTtcbiAgfVxuICByZXR1cm4gbG9nZ2Vyc1tuYW1lXS5sb2dJdDtcbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
