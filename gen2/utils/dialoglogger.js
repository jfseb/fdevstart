"use strict";
/**
 * a logger for dialog conversations
 */
//declare module pg {};

Object.defineProperty(exports, "__esModule", { value: true });
var debug = require("debug");
var process = require("process");
exports.sqlActive = !!process.env.ABOT_LOGDB;
var debuglog = debug('dialoglogger');
;
;
var columns = ["botid", "userid", "message", "response", "action", "intent", "conversationid", "meta", "delta"];
// 0 indicates do not process /truncate, e.g. non string type
var columnLengths = [10, 40, 1024, 1024, 512, 20, 40, 0, 0];
function assureColumnLengthNotExceeded(obj) {
    columns.forEach(function (sCol, iIndex) {
        if (columnLengths[iIndex] && typeof obj[sCol] !== "string") {
            debuglog("Unexpected non-string value " + JSON.stringify(obj[sCol]));
            obj[sCol] = "" + obj[sCol];
        }
        if (obj[sCol] && columnLengths[iIndex] && obj[sCol].length > columnLengths[iIndex]) {
            obj[sCol] = obj[sCol].substring(0, columnLengths[iIndex]);
        }
    });
    return obj;
}
exports.assureColumnLengthNotExceeded = assureColumnLengthNotExceeded;
function logAnswer(answer, callback, ForceSqlActive) {
    "use strict";

    callback = callback || function () {};
    var session = answer.session;
    var sqlIsActive = ForceSqlActive || exports.sqlActive;
    var pg = this.pg;
    debuglog("here user id of message session.message.address " + JSON.stringify(session.message.address.user));
    var oLogEntry = {
        botid: session.message && session.message.address && session.message.address.bot && session.message.address.bot.id || this.name,
        userid: session.message.address && session.message.address.user && session.message.address.user.id || "",
        message: session.message.text,
        response: answer.response,
        action: answer.action,
        intent: answer.intent,
        conversationid: session.message.address && session.message.address.conversation && session.message.address.conversation.id || "",
        meta: answer.result || {},
        delta: Date.now() - Date.parse(session.message.timestamp)
    };
    oLogEntry = assureColumnLengthNotExceeded(oLogEntry);
    debuglog("sqlIsActive" + sqlIsActive);
    if (!sqlIsActive) {
        return;
    }
    pg.connect(this.dburl, function (err, client, pgDone) {
        if (err) {
            // failed to acquire connection
            //logger.emit('error', err);
            debuglog('Error connecting to db' + err);
            callback(err);
        } else {
            var query = "INSERT INTO logconv (" + columns.join(",") + ") " +
            //   (convid, sessionid, user, message, response, meta) ` +
            "VALUES ( " +
            // $1, $2, ...
            columns.map(function (o, iIndex) {
                return "$" + (iIndex + 1);
            }).join(", ") + ")";
            var values = columns.map(function (sCol) {
                return oLogEntry[sCol];
            });
            //  [level, msg, meta instanceof Array ? JSON.stringify(meta) : meta],
            client.query(query, values, function (err, result) {
                pgDone();
                if (err) {
                    // logger.emit('error', err);
                    debuglog('Error inserting record into db ' + err + '\n' + values.join("\n"));
                    callback(err);
                } else {
                    //  logger.emit('logged');
                    callback(null, true);
                }
            });
        }
    });
}
exports.logAnswer = logAnswer;
var loggers = {};
function logger(name, dburl, pg) {
    if (!dburl) {
        throw new Error('need database url');
    }
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            dburl: dburl,
            pg: pg
        };
        alogger.logIt = logAnswer.bind(alogger);
        loggers[name] = alogger;
    }
    if (loggers[name].dburl !== dburl) {
        throw new Error('Flags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzL2RpYWxvZ2xvZ2dlci5qcyIsIi4uL3NyYy91dGlscy9kaWFsb2dsb2dnZXIudHMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWJ1ZyIsInJlcXVpcmUiLCJwcm9jZXNzIiwic3FsQWN0aXZlIiwiZW52IiwiQUJPVF9MT0dEQiIsImRlYnVnbG9nIiwiY29sdW1ucyIsImNvbHVtbkxlbmd0aHMiLCJhc3N1cmVDb2x1bW5MZW5ndGhOb3RFeGNlZWRlZCIsIm9iaiIsImZvckVhY2giLCJzQ29sIiwiaUluZGV4IiwiSlNPTiIsInN0cmluZ2lmeSIsImxlbmd0aCIsInN1YnN0cmluZyIsImxvZ0Fuc3dlciIsImFuc3dlciIsImNhbGxiYWNrIiwiRm9yY2VTcWxBY3RpdmUiLCJzZXNzaW9uIiwic3FsSXNBY3RpdmUiLCJwZyIsIm1lc3NhZ2UiLCJhZGRyZXNzIiwidXNlciIsIm9Mb2dFbnRyeSIsImJvdGlkIiwiYm90IiwiaWQiLCJuYW1lIiwidXNlcmlkIiwidGV4dCIsInJlc3BvbnNlIiwiYWN0aW9uIiwiaW50ZW50IiwiY29udmVyc2F0aW9uaWQiLCJjb252ZXJzYXRpb24iLCJtZXRhIiwicmVzdWx0IiwiZGVsdGEiLCJEYXRlIiwibm93IiwicGFyc2UiLCJ0aW1lc3RhbXAiLCJjb25uZWN0IiwiZGJ1cmwiLCJlcnIiLCJjbGllbnQiLCJwZ0RvbmUiLCJxdWVyeSIsImpvaW4iLCJtYXAiLCJvIiwidmFsdWVzIiwibG9nZ2VycyIsImxvZ2dlciIsIkVycm9yIiwiZXhlYyIsImFsb2dnZXIiLCJsb2dJdCIsImJpbmQiXSwibWFwcGluZ3MiOiJBQUFBO0FDQUE7OztBQUdBOztBREVBQSxPQUFPQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QyxFQUFFQyxPQUFPLElBQVQsRUFBN0M7QUNFQSxJQUFBQyxRQUFBQyxRQUFBLE9BQUEsQ0FBQTtBQUNBLElBQUFDLFVBQUFELFFBQUEs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LEdBQVQ7QUFDRCxpQkFMRCxNQUtPO0FBQ1A7QUFDRTdCLDZCQUFTLElBQVQsRUFBZSxJQUFmO0FBQ0Q7QUFDSixhQWJEO0FBY0Q7QUFDRixLQWpDSDtBQWtDQztBQW5FSHRCLFFBQUFvQixTQUFBLEdBQUFBLFNBQUE7QUFxRUEsSUFBSXVDLFVBQVUsRUFBZDtBQUVBLFNBQUFDLE1BQUEsQ0FBdUIxQixJQUF2QixFQUFxQ2dCLEtBQXJDLEVBQXFEeEIsRUFBckQsRUFBNEQ7QUFDMUQsUUFBSSxDQUFDd0IsS0FBTCxFQUFZO0FBQ1YsY0FBTSxJQUFJVyxLQUFKLENBQVUsbUJBQVYsQ0FBTjtBQUNEO0FBQ0QsUUFBSSxPQUFPM0IsSUFBUCxLQUFnQixRQUFoQixJQUE0QixDQUFDLDBCQUEwQjRCLElBQTFCLENBQStCNUIsSUFBL0IsQ0FBakMsRUFBdUU7QUFDckUsY0FBTSxJQUFJMkIsS0FBSixDQUFVLDBEQUFWLENBQU47QUFDRDtBQUNELFFBQUksQ0FBQ0YsUUFBUXpCLElBQVIsQ0FBTCxFQUFvQjtBQUNsQixZQUFJNkIsVUFBVTtBQUNaN0Isa0JBQU1BLElBRE07QUFFWmdCLG1CQUFPQSxLQUZLO0FBR1p4QixnQkFBS0E7QUFITyxTQUFkO0FBS0FxQyxnQkFBUUMsS0FBUixHQUFnQjVDLFVBQVU2QyxJQUFWLENBQWVGLE9BQWYsQ0FBaEI7QUFDQUosZ0JBQVF6QixJQUFSLElBQWdCNkIsT0FBaEI7QUFDRDtBQUNELFFBQUlKLFFBQVF6QixJQUFSLEVBQWNnQixLQUFkLEtBQXdCQSxLQUE1QixFQUFtQztBQUNqQyxjQUFNLElBQUlXLEtBQUosQ0FBVSw2QkFBNkIzQixJQUF2QyxDQUFOO0FBQ0Q7QUFDRCxXQUFPeUIsUUFBUXpCLElBQVIsRUFBYzhCLEtBQXJCO0FBQ0Q7QUFwQkRoRSxRQUFBNEQsTUFBQSxHQUFBQSxNQUFBIiwiZmlsZSI6InV0aWxzL2RpYWxvZ2xvZ2dlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuLyoqXG4gKiBhIGxvZ2dlciBmb3IgZGlhbG9nIGNvbnZlcnNhdGlvbnNcbiAqL1xuLy9kZWNsYXJlIG1vZHVsZSBwZyB7fTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xuY29uc3QgcHJvY2VzcyA9IHJlcXVpcmUoXCJwcm9jZXNzXCIpO1xuZXhwb3J0cy5zcWxBY3RpdmUgPSAhIShwcm9jZXNzLmVudi5BQk9UX0xPR0RCKTtcbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ2RpYWxvZ2xvZ2dlcicpO1xuO1xuO1xuY29uc3QgY29sdW1ucyA9IFtcImJvdGlkXCIsIFwidXNlcmlkXCIsIFwibWVzc2FnZVwiLCBcInJlc3BvbnNlXCIsIFwiYWN0aW9uXCIsIFwiaW50ZW50XCIsIFwiY29udmVyc2F0aW9uaWRcIiwgXCJtZXRhXCIsIFwiZGVsdGFcIl07XG4vLyAwIGluZGljYXRlcyBkbyBub3QgcHJvY2VzcyAvdHJ1bmNhdGUsIGUuZy4gbm9uIHN0cmluZyB0eXBlXG5jb25zdCBjb2x1bW5MZW5ndGhzID0gWzEwLCA0MCwgMTAyNCwgMTAyNCwgNTEyLCAyMCwgNDAsIDAsIDBdO1xuZnVuY3Rpb24gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQob2JqKSB7XG4gICAgY29sdW1ucy5mb3JFYWNoKGZ1bmN0aW9uIChzQ29sLCBpSW5kZXgpIHtcbiAgICAgICAgaWYgKGNvbHVtbkxlbmd0aHNbaUluZGV4XSAmJiB0eXBlb2Ygb2JqW3NDb2xdICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIlVuZXhwZWN0ZWQgbm9uLXN0cmluZyB2YWx1ZSBcIiArIEpTT04uc3RyaW5naWZ5KG9ialtzQ29sXSkpO1xuICAgICAgICAgICAgb2JqW3NDb2xdID0gXCJcIiArIG9ialtzQ29sXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAob2JqW3NDb2xdICYmIGNvbHVtbkxlbmd0aHNbaUluZGV4XSAmJiBvYmpbc0NvbF0ubGVuZ3RoID4gY29sdW1uTGVuZ3Roc1tpSW5kZXhdKSB7XG4gICAgICAgICAgICBvYmpbc0NvbF0gPSBvYmpbc0NvbF0uc3Vic3RyaW5nKDAsIGNvbHVtbkxlbmd0aHNbaUluZGV4XSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gb2JqO1xufVxuZXhwb3J0cy5hc3N1cmVDb2x1bW5MZW5ndGhOb3RFeGNlZWRlZCA9IGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkO1xuZnVuY3Rpb24gbG9nQW5zd2VyKGFuc3dlciwgY2FsbGJhY2ssIEZvcmNlU3FsQWN0aXZlKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCAoZnVuY3Rpb24gKCkgeyB9KTtcbiAgICB2YXIgc2Vzc2lvbiA9IGFuc3dlci5zZXNzaW9uO1xuICAgIHZhciBzcWxJc0FjdGl2ZSA9IEZvcmNlU3FsQWN0aXZlIHx8IGV4cG9ydHMuc3FsQWN0aXZlO1xuICAgIHZhciBwZyA9IHRoaXMucGc7XG4gICAgZGVidWdsb2coXCJoZXJlIHVzZXIgaWQgb2YgbWVzc2FnZSBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcyBcIiArXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIpKTtcbiAgICB2YXIgb0xvZ0VudHJ5ID0ge1xuICAgICAgICBib3RpZDogKHNlc3Npb24ubWVzc2FnZSAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcyAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5ib3QgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuYm90LmlkKSB8fCB0aGlzLm5hbWUsXG4gICAgICAgIHVzZXJpZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXJcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIuaWQgfHwgXCJcIixcbiAgICAgICAgbWVzc2FnZTogc2Vzc2lvbi5tZXNzYWdlLnRleHQsXG4gICAgICAgIHJlc3BvbnNlOiBhbnN3ZXIucmVzcG9uc2UsXG4gICAgICAgIGFjdGlvbjogYW5zd2VyLmFjdGlvbixcbiAgICAgICAgaW50ZW50OiBhbnN3ZXIuaW50ZW50LFxuICAgICAgICBjb252ZXJzYXRpb25pZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvblxuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uLmlkIHx8IFwiXCIsXG4gICAgICAgIG1ldGE6IGFuc3dlci5yZXN1bHQgfHwge30sXG4gICAgICAgIGRlbHRhOiBEYXRlLm5vdygpIC0gRGF0ZS5wYXJzZShzZXNzaW9uLm1lc3NhZ2UudGltZXN0YW1wKSxcbiAgICB9O1xuICAgIG9Mb2dFbnRyeSA9IGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9Mb2dFbnRyeSk7XG4gICAgZGVidWdsb2coXCJzcWxJc0FjdGl2ZVwiICsgc3FsSXNBY3RpdmUpO1xuICAgIGlmICghc3FsSXNBY3RpdmUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBwZy5jb25uZWN0KHRoaXMuZGJ1cmwsIChlcnIsIGNsaWVudCwgcGdEb25lKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIC8vIGZhaWxlZCB0byBhY3F1aXJlIGNvbm5lY3Rpb25cbiAgICAgICAgICAgIC8vbG9nZ2VyLmVtaXQoJ2Vycm9yJywgZXJyKTtcbiAgICAgICAgICAgIGRlYnVnbG9nKCdFcnJvciBjb25uZWN0aW5nIHRvIGRiJyArIGVycik7XG4gICAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdmFyIHF1ZXJ5ID0gYElOU0VSVCBJTlRPIGxvZ2NvbnYgKGAgKyBjb2x1bW5zLmpvaW4oXCIsXCIpICsgXCIpIFwiICtcbiAgICAgICAgICAgICAgICAvLyAgIChjb252aWQsIHNlc3Npb25pZCwgdXNlciwgbWVzc2FnZSwgcmVzcG9uc2UsIG1ldGEpIGAgK1xuICAgICAgICAgICAgICAgIFwiVkFMVUVTICggXCIgK1xuICAgICAgICAgICAgICAgIC8vICQxLCAkMiwgLi4uXG4gICAgICAgICAgICAgICAgY29sdW1ucy5tYXAoZnVuY3Rpb24gKG8sIGlJbmRleCkgeyByZXR1cm4gXCIkXCIgKyAoaUluZGV4ICsgMSk7IH0pLmpvaW4oXCIsIFwiKSArIFwiKVwiO1xuICAgICAgICAgICAgdmFyIHZhbHVlcyA9IGNvbHVtbnMubWFwKGZ1bmN0aW9uIChzQ29sKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9Mb2dFbnRyeVtzQ29sXTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gIFtsZXZlbCwgbXNnLCBtZXRhIGluc3RhbmNlb2YgQXJyYXkgPyBKU09OLnN0cmluZ2lmeShtZXRhKSA6IG1ldGFdLFxuICAgICAgICAgICAgY2xpZW50LnF1ZXJ5KHF1ZXJ5LCB2YWx1ZXMsIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIHBnRG9uZSgpO1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gbG9nZ2VyLmVtaXQoJ2Vycm9yJywgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgZGVidWdsb2coJ0Vycm9yIGluc2VydGluZyByZWNvcmQgaW50byBkYiAnICsgZXJyICsgJ1xcbicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLmpvaW4oXCJcXG5cIikpO1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gIGxvZ2dlci5lbWl0KCdsb2dnZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cbmV4cG9ydHMubG9nQW5zd2VyID0gbG9nQW5zd2VyO1xudmFyIGxvZ2dlcnMgPSB7fTtcbmZ1bmN0aW9uIGxvZ2dlcihuYW1lLCBkYnVybCwgcGcpIHtcbiAgICBpZiAoIWRidXJsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignbmVlZCBkYXRhYmFzZSB1cmwnKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBuYW1lICE9PSBcInN0cmluZ1wiIHx8ICEvXltBLVphLXpdW0EtWmEtejAtOV9dKyQvLmV4ZWMobmFtZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdMb2dnZXIgbmFtZSBtdXN0IGJlIGF0IGxlYXN0IHR3byBhbHBoYW51bWVyaWMgY2hhcmFjdGVycycpO1xuICAgIH1cbiAgICBpZiAoIWxvZ2dlcnNbbmFtZV0pIHtcbiAgICAgICAgdmFyIGFsb2dnZXIgPSB7XG4gICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgZGJ1cmw6IGRidXJsLFxuICAgICAgICAgICAgcGc6IHBnXG4gICAgICAgIH07XG4gICAgICAgIGFsb2dnZXIubG9nSXQgPSBsb2dBbnN3ZXIuYmluZChhbG9nZ2VyKTtcbiAgICAgICAgbG9nZ2Vyc1tuYW1lXSA9IGFsb2dnZXI7XG4gICAgfVxuICAgIGlmIChsb2dnZXJzW25hbWVdLmRidXJsICE9PSBkYnVybCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZsYWdzIG1pc21hdGNoIGluIGxvZ2dlcicgKyBuYW1lKTtcbiAgICB9XG4gICAgcmV0dXJuIGxvZ2dlcnNbbmFtZV0ubG9nSXQ7XG59XG5leHBvcnRzLmxvZ2dlciA9IGxvZ2dlcjtcbiIsIi8qKlxuICogYSBsb2dnZXIgZm9yIGRpYWxvZyBjb252ZXJzYXRpb25zXG4gKi9cbi8vZGVjbGFyZSBtb2R1bGUgcGcge307XG5cbmltcG9ydCAqIGFzIGJ1aWxkZXIgZnJvbSAnYm90YnVpbGRlcic7XG5pbXBvcnQgKiBhcyBwZyBmcm9tICdwZyc7XG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgKiBhcyBwcm9jZXNzIGZyb20gJ3Byb2Nlc3MnO1xuXG5cbmV4cG9ydCB2YXIgc3FsQWN0aXZlID0gISEocHJvY2Vzcy5lbnYuQUJPVF9MT0dEQik7XG5cbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ2RpYWxvZ2xvZ2dlcicpO1xuXG5pbnRlcmZhY2UgSUxvZ2dlciB7XG4gIG5hbWU6IHN0cmluZyxcbiAgZGJ1cmw6IHN0cmluZyxcbiAgbG9nSXQ/OiAoYSA6IElBbnN3ZXIsIGNhbGxiYWNrIDogKGVyciA6IGFueSwgcmVzPyA6IGFueSkgPT4gdm9pZCkgPT4gdm9pZCxcbiAgcGcgOiBhbnlcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUxvZ0VudHJ5IHtcbiAgYm90aWQgOiBzdHJpbmcsIC8qIDEwICovXG4gIHVzZXJpZCA6IHN0cmluZyxcbiAgbWVzc2FnZSA6IHN0cmluZyxcbiAgcmVzcG9uc2UgOiBzdHJpbmcsXG4gIGFjdGlvbiA6IHN0cmluZyxcbiAgaW50ZW50IDogc3RyaW5nLFxuICBjb252ZXJzYXRpb25pZCA6IHN0cmluZyxcbiAgLyoqXG4gICAqIGFuIHJlc3VsdFxuICAgKiovXG4gIG1ldGEgOiBhbnksXG4gIGRlbHRhOiBudW1iZXJcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUFuc3dlciB7XG4gIHNlc3Npb24gOiBidWlsZGVyLlNlc3Npb24sXG4gIGludGVudCA6IHN0cmluZyxcbiAgcmVzcG9uc2UgOiBzdHJpbmcsXG4gIGFjdGlvbj8gOiBzdHJpbmcsXG4gIHJlc3VsdD8gOiBhbnksXG59XG5cbmNvbnN0IGNvbHVtbnMgPSBbXCJib3RpZFwiLFwidXNlcmlkXCIsIFwibWVzc2FnZVwiLCBcInJlc3BvbnNlXCIsIFwiYWN0aW9uXCIsIFwiaW50ZW50XCIsIFwiY29udmVyc2F0aW9uaWRcIiwgXCJtZXRhXCIsIFwiZGVsdGFcIl07XG4vLyAwIGluZGljYXRlcyBkbyBub3QgcHJvY2VzcyAvdHJ1bmNhdGUsIGUuZy4gbm9uIHN0cmluZyB0eXBlXG5jb25zdCBjb2x1bW5MZW5ndGhzID0gWzEwLCA0MCwgMTAyNCwgMTAyNCwgNTEyLCAyMCwgNDAsIDAsMCBdO1xuXG5cbmV4cG9ydCBmdW5jdGlvbiBhc3N1cmVDb2x1bW5MZW5ndGhOb3RFeGNlZWRlZChvYmogOiBJTG9nRW50cnkpIDogSUxvZ0VudHJ5IHtcbiAgY29sdW1ucy5mb3JFYWNoKGZ1bmN0aW9uKHNDb2wsaUluZGV4KSB7XG4gICAgaWYoY29sdW1uTGVuZ3Roc1tpSW5kZXhdICYmIHR5cGVvZiBvYmpbc0NvbF0gIT09ICBcInN0cmluZ1wiKSB7XG4gICAgICBkZWJ1Z2xvZyhcIlVuZXhwZWN0ZWQgbm9uLXN0cmluZyB2YWx1ZSBcIiArIEpTT04uc3RyaW5naWZ5KG9ialtzQ29sXSkpO1xuICAgICAgb2JqW3NDb2xdID0gXCJcIisgb2JqW3NDb2xdO1xuICAgIH1cbiAgICBpZihvYmpbc0NvbF0gJiYgY29sdW1uTGVuZ3Roc1tpSW5kZXhdICYmIG9ialtzQ29sXS5sZW5ndGggPiBjb2x1bW5MZW5ndGhzW2lJbmRleF0pIHtcbiAgICAgIG9ialtzQ29sXSA9IG9ialtzQ29sXS5zdWJzdHJpbmcoMCxjb2x1bW5MZW5ndGhzW2lJbmRleF0pO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiBvYmo7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2dBbnN3ZXIoYW5zd2VyOiBJQW5zd2VyLCBjYWxsYmFjayA6IChlcnI6IGFueSwgcmVzPzogYW55KSA9PiB2b2lkICwgRm9yY2VTcWxBY3RpdmU/IDogYm9vbGVhbikge1xuICBcInVzZSBzdHJpY3RcIjtcbiAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCAoZnVuY3Rpb24oKSB7fSk7XG4gIHZhciBzZXNzaW9uID0gYW5zd2VyLnNlc3Npb247XG4gIHZhciBzcWxJc0FjdGl2ZSA9IEZvcmNlU3FsQWN0aXZlIHx8IHNxbEFjdGl2ZTtcbiAgdmFyIHBnID0gdGhpcy5wZztcbiAgZGVidWdsb2coXCJoZXJlIHVzZXIgaWQgb2YgbWVzc2FnZSBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcyBcIiArXG4gIEpTT04uc3RyaW5naWZ5KHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIpKTtcbiAgdmFyIG9Mb2dFbnRyeSA6IElMb2dFbnRyeSA9IHtcbiAgICBib3RpZCA6IChzZXNzaW9uLm1lc3NhZ2UgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuYm90ICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmJvdC5pZCApIHx8IHRoaXMubmFtZSxcbiAgICB1c2VyaWQ6IHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzXG4gICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlclxuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIuaWQgfHwgXCJcIixcbiAgICBtZXNzYWdlOiBzZXNzaW9uLm1lc3NhZ2UudGV4dCxcbiAgICByZXNwb25zZSA6IGFuc3dlci5yZXNwb25zZSxcbiAgICBhY3Rpb24gOiBhbnN3ZXIuYWN0aW9uLFxuXG4gICAgaW50ZW50OiBhbnN3ZXIuaW50ZW50LFxuXG4gICAgY29udmVyc2F0aW9uaWQ6IHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzXG4gICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uXG4gICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uLmlkIHx8IFwiXCIsXG5cbiAgICBtZXRhIDogYW5zd2VyLnJlc3VsdCB8fCB7fSxcblxuICAgIGRlbHRhIDogRGF0ZS5ub3coKSAtIERhdGUucGFyc2Uoc2Vzc2lvbi5tZXNzYWdlLnRpbWVzdGFtcCksXG4gIH07XG5cbiAgb0xvZ0VudHJ5ID0gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQob0xvZ0VudHJ5KTtcbiAgZGVidWdsb2coXCJzcWxJc0FjdGl2ZVwiICsgc3FsSXNBY3RpdmUpO1xuICBpZiAoIXNxbElzQWN0aXZlKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIHBnLmNvbm5lY3QodGhpcy5kYnVybCwgKGVyciwgY2xpZW50IDogcGcuQ2xpZW50LCBwZ0RvbmUpID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgLy8gZmFpbGVkIHRvIGFjcXVpcmUgY29ubmVjdGlvblxuICAgICAgICAvL2xvZ2dlci5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgIGRlYnVnbG9nKCdFcnJvciBjb25uZWN0aW5nIHRvIGRiJyArIGVycik7XG4gICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgcXVlcnkgPWBJTlNFUlQgSU5UTyBsb2djb252IChgICsgY29sdW1ucy5qb2luKFwiLFwiKSArIFwiKSBcIiArXG4gICAgICAgIC8vICAgKGNvbnZpZCwgc2Vzc2lvbmlkLCB1c2VyLCBtZXNzYWdlLCByZXNwb25zZSwgbWV0YSkgYCArXG4gICAgICAgIFwiVkFMVUVTICggXCIgICtcbiAgICAgICAgLy8gJDEsICQyLCAuLi5cbiAgICAgICAgIGNvbHVtbnMubWFwKGZ1bmN0aW9uKG8saUluZGV4KSB7IHJldHVybiBcIiRcIiArIChpSW5kZXgrMSk7IH0pLmpvaW4oXCIsIFwiKSArIFwiKVwiO1xuXG4gICAgICAgIHZhciB2YWx1ZXMgPSBjb2x1bW5zLm1hcChmdW5jdGlvbihzQ29sKSB7XG4gICAgICAgICAgICAgcmV0dXJuIG9Mb2dFbnRyeVtzQ29sXTtcbiAgICAgICAgICAgfSk7XG4gICAgICAgICAgIC8vICBbbGV2ZWwsIG1zZywgbWV0YSBpbnN0YW5jZW9mIEFycmF5ID8gSlNPTi5zdHJpbmdpZnkobWV0YSkgOiBtZXRhXSxcblxuICAgICAgICBjbGllbnQucXVlcnkocXVlcnksdmFsdWVzLFxuXG4gICAgICAgICAgICAgICAgICAgICAoZXJyLCByZXN1bHQpID0+IHtcbiAgICAgICAgICAgIHBnRG9uZSgpO1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgIC8vIGxvZ2dlci5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgICAgICAgZGVidWdsb2coJ0Vycm9yIGluc2VydGluZyByZWNvcmQgaW50byBkYiAnICsgZXJyICsgJ1xcbicgK1xuICAgICAgICAgICAgICAgIHZhbHVlcy5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyAgbG9nZ2VyLmVtaXQoJ2xvZ2dlZCcpO1xuICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxudmFyIGxvZ2dlcnMgPSB7fSBhcyB7IFtrZXk6IHN0cmluZ106IElMb2dnZXIgfTtcblxuZXhwb3J0IGZ1bmN0aW9uIGxvZ2dlcihuYW1lOiBzdHJpbmcsIGRidXJsIDogc3RyaW5nLCBwZzogYW55KSA6IChhOiBJQW5zd2VyLCBjYWxsYmFjaz86IChlcnI6YW55LCByZXM/IDphbnkpID0+IHZvaWQpID0+IHZvaWQgIHtcbiAgaWYgKCFkYnVybCkge1xuICAgIHRocm93IG5ldyBFcnJvcignbmVlZCBkYXRhYmFzZSB1cmwnKTtcbiAgfVxuICBpZiAodHlwZW9mIG5hbWUgIT09IFwic3RyaW5nXCIgfHwgIS9eW0EtWmEtel1bQS1aYS16MC05X10rJC8uZXhlYyhuYW1lKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIG5hbWUgbXVzdCBiZSBhdCBsZWFzdCB0d28gYWxwaGFudW1lcmljIGNoYXJhY3RlcnMnKVxuICB9XG4gIGlmICghbG9nZ2Vyc1tuYW1lXSkge1xuICAgIHZhciBhbG9nZ2VyID0ge1xuICAgICAgbmFtZTogbmFtZSxcbiAgICAgIGRidXJsOiBkYnVybCxcbiAgICAgIHBnIDogcGdcbiAgICB9IGFzIElMb2dnZXI7XG4gICAgYWxvZ2dlci5sb2dJdCA9IGxvZ0Fuc3dlci5iaW5kKGFsb2dnZXIpO1xuICAgIGxvZ2dlcnNbbmFtZV0gPSBhbG9nZ2VyO1xuICB9XG4gIGlmIChsb2dnZXJzW25hbWVdLmRidXJsICE9PSBkYnVybCkge1xuICAgIHRocm93IG5ldyBFcnJvcignRmxhZ3MgbWlzbWF0Y2ggaW4gbG9nZ2VyJyArIG5hbWUpO1xuICB9XG4gIHJldHVybiBsb2dnZXJzW25hbWVdLmxvZ0l0O1xufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
