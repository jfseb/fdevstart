"use strict";
/**
 * a simple logger utility
 *
 *
 * There are two types of logs ( append and overwrite, default is append)
 */

Object.defineProperty(exports, "__esModule", { value: true });
// <reference path="../../lib/node-4.d.ts" />
var debug = require("debug");
var debuglog = debug('logger');
;
var perfs = {};
function logPerf(cons, sString) {
    if (!this || !this.enabled) {
        return;
    }
    var label = 'perf' + this.name;
    cons.log('Perf' + this.name);
    if (this.first === 0) {
        this.first = Date.now();
        this.last = this.first;
    } else {
        var t = Date.now();
        cons.log('Perf' + this.name + ' delta: ' + String("      " + (t - this.last)).slice(-6) + ' total: ' + String("      " + (t - this.first)).slice(-6));
        this.last = t;
    }
    if (this.on[sString]) {
        cons.timeEnd(sString);
        delete this.on[sString];
    } else {
        cons.time(sString);
        this.on[sString] = 1;
    }
}
exports.logPerf = logPerf;
function perf(string) {
    perfs[string] = { name: string, last: 0, first: 0, on: {}, enabled: false };
    if (debug('perf' + string).enabled) {
        perfs[string].enabled = true;
    }
    return logPerf.bind(perfs[string], console);
}
exports.perf = perf;
var fs = require("fs");
var loggers = {};
var os = require('os');
function getWritableDir() {
    // return process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'];
    return os.tmpdir();
}
function setupOnce() {
    var home = getWritableDir();
    try {
        fs.mkdirSync(home + '/' + 'fdevstart');
    } catch (e) {}
    try {
        fs.mkdirSync(home + '/fdevstart/logs');
    } catch (e) {}
}
setupOnce();
function getFileName(name) {
    return os.tmpdir() + '/fdevstart/logs/' + name + ".log";
}
exports._test = {
    getFileName: getFileName
};
function logIt(logger, arg) {
    var text;
    if (typeof arg === "string") {
        text = arg;
    } else if (arg instanceof Error) {
        text = "Error:" + arg.message + " " + arg.stack;
    }
    if (!text) {
        throw new Error("Illegal argument to log");
    }
    var filename = getFileName(logger.name);
    var d = new Date();
    var n = d.toUTCString() + "\t" + text;
    debuglog('writing log entry to ' + filename + ' ' + n);
    fs.writeFileSync(filename, n, { encoding: 'utf-8', flag: 'a' });
}
function logger(name, flags) {
    if (flags !== 'a' && flags !== '' && flags !== undefined) {
        throw new Error('only a allowed as flags');
    }
    flags = flags === undefined ? 'a' : flags;
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            flags: flags
        };
        alogger.logIt = logIt.bind(undefined, alogger);
        // reset the file
        if (flags === '') {
            try {
                fs.unlinkSync(getFileName(name));
            } catch (e) {
                debuglog("***ERROR: unable to remove log file " + getFileName(name));
            }
        }
        loggers[name] = alogger;
    }
    if (loggers[name].flags !== flags) {
        throw new Error('FLags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzL2xvZ2dlci5qcyIsIi4uL3NyYy91dGlscy9sb2dnZXIudHMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWJ1ZyIsInJlcXVpcmUiLCJkZWJ1Z2xvZyIsInBlcmZzIiwibG9nUGVyZiIsImNvbnMiLCJzU3RyaW5nIiwiZW5hYmxlZCIsImxhYmVsIiwibmFtZSIsImxvZyIsImZpcnN0IiwiRGF0ZSIsIm5vdyIsImxhc3QiLCJ0IiwiU3RyaW5nIiwic2xpY2UiLCJvbiIsInRpbWVFbmQiLCJ0aW1lIiwicGVyZiIsInN0cmluZyIsImJpbmQiLCJjb25zb2xlIiwiZnMiLCJsb2dnZXJzIiwib3MiLCJnZXRXcml0YWJsZURpciIsInRtcGRpciIsInNldHVwT25jZSIsImhvbWUiLCJta2RpclN5bmMiLCJlIiwiZ2V0RmlsZU5hbWUiLCJfdGVzdCIsImxvZ0l0IiwibG9nZ2VyIiwiYXJnIiwidGV4dCIsIkVycm9yIiwibWVzc2FnZSIsInN0YWNrIiwiZmlsZW5hbWUiLCJkIiwibiIsInRvVVRDU3RyaW5nIiwid3JpdGVGaWxlU3luYyIsImVuY29kaW5nIiwiZmxhZyIsImZsYWdzIiwidW5kZWZpbmVkIiwiZXhlYyIsImFsb2dnZXIiLCJ1bmxpbmtTeW5jIl0sIm1hcHBpbmdzIjoiQUFBQTtBQ0VBOzs7Ozs7O0FES0FBLE9BQU9DLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDLEVBQUVDLE9BQU8sSUFBVCxFQUE3QztBQ0VBO0FBRUEsSUFBQUMsUUFBQUMsUUFBQSxPQUFBLENBQUE7QUFFQSxJQUFNQyxXQUFXRixNQUFNLFFBQU4sQ0FBakI7QUFNQztBQUVELElBQUlHLFFBQVEsRUFBWjtBQUVBLFNBQUFDLE9BQUEsQ0FBd0JDLElBQXhCLEVBQW9DQyxPQUFwQyxFQUFvRDtBQUNsRCxRQUFHLENBQUMsSUFBRCxJQUFTLENBQUMsS0FBS0MsT0FBbEIsRUFBMkI7QUFDekI7QUFDRDtB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VUFBSCxDQUFjcEIsWUFBWXpCLElBQVosQ0FBZDtBQUNELGFBRkQsQ0FFRSxPQUFPd0IsQ0FBUCxFQUFVO0FBQ1YvQix5QkFBUyx5Q0FBeUNnQyxZQUFZekIsSUFBWixDQUFsRDtBQUNEO0FBQ0Y7QUFDRGlCLGdCQUFRakIsSUFBUixJQUFnQjRDLE9BQWhCO0FBQ0Q7QUFDRCxRQUFJM0IsUUFBUWpCLElBQVIsRUFBY3lDLEtBQWQsS0FBd0JBLEtBQTVCLEVBQW1DO0FBQ2pDLGNBQU0sSUFBSVYsS0FBSixDQUFVLDZCQUE2Qi9CLElBQXZDLENBQU47QUFDRDtBQUNELFdBQU9pQixRQUFRakIsSUFBUixFQUFjMkIsS0FBckI7QUFDRDtBQTVCRHRDLFFBQUF1QyxNQUFBLEdBQUFBLE1BQUEiLCJmaWxlIjoidXRpbHMvbG9nZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vKipcbiAqIGEgc2ltcGxlIGxvZ2dlciB1dGlsaXR5XG4gKlxuICpcbiAqIFRoZXJlIGFyZSB0d28gdHlwZXMgb2YgbG9ncyAoIGFwcGVuZCBhbmQgb3ZlcndyaXRlLCBkZWZhdWx0IGlzIGFwcGVuZClcbiAqL1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vbGliL25vZGUtNC5kLnRzXCIgLz5cbnZhciBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdsb2dnZXInKTtcbjtcbnZhciBwZXJmcyA9IHt9O1xuZnVuY3Rpb24gbG9nUGVyZihjb25zLCBzU3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzIHx8ICF0aGlzLmVuYWJsZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgbGFiZWwgPSAncGVyZicgKyB0aGlzLm5hbWU7XG4gICAgY29ucy5sb2coJ1BlcmYnICsgdGhpcy5uYW1lKTtcbiAgICBpZiAodGhpcy5maXJzdCA9PT0gMCkge1xuICAgICAgICB0aGlzLmZpcnN0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgdGhpcy5sYXN0ID0gdGhpcy5maXJzdDtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHZhciB0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgY29ucy5sb2coJ1BlcmYnICsgdGhpcy5uYW1lICtcbiAgICAgICAgICAgICcgZGVsdGE6ICcgKyBTdHJpbmcoXCIgICAgICBcIiArICh0IC0gdGhpcy5sYXN0KSkuc2xpY2UoLTYpXG4gICAgICAgICAgICArICcgdG90YWw6ICcgKyBTdHJpbmcoXCIgICAgICBcIiArICh0IC0gdGhpcy5maXJzdCkpLnNsaWNlKC02KSk7XG4gICAgICAgIHRoaXMubGFzdCA9IHQ7XG4gICAgfVxuICAgIGlmICh0aGlzLm9uW3NTdHJpbmddKSB7XG4gICAgICAgIGNvbnMudGltZUVuZChzU3RyaW5nKTtcbiAgICAgICAgZGVsZXRlIHRoaXMub25bc1N0cmluZ107XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjb25zLnRpbWUoc1N0cmluZyk7XG4gICAgICAgIHRoaXMub25bc1N0cmluZ10gPSAxO1xuICAgIH1cbn1cbmV4cG9ydHMubG9nUGVyZiA9IGxvZ1BlcmY7XG5mdW5jdGlvbiBwZXJmKHN0cmluZykge1xuICAgIHBlcmZzW3N0cmluZ10gPSB7IG5hbWU6IHN0cmluZywgbGFzdDogMCwgZmlyc3Q6IDAsIG9uOiB7fSwgZW5hYmxlZDogZmFsc2UgfTtcbiAgICBpZiAoZGVidWcoJ3BlcmYnICsgc3RyaW5nKS5lbmFibGVkKSB7XG4gICAgICAgIHBlcmZzW3N0cmluZ10uZW5hYmxlZCA9IHRydWU7XG4gICAgfVxuICAgIHJldHVybiBsb2dQZXJmLmJpbmQocGVyZnNbc3RyaW5nXSwgY29uc29sZSk7XG59XG5leHBvcnRzLnBlcmYgPSBwZXJmO1xudmFyIGZzID0gcmVxdWlyZShcImZzXCIpO1xudmFyIGxvZ2dlcnMgPSB7fTtcbnZhciBvcyA9IHJlcXVpcmUoJ29zJyk7XG5mdW5jdGlvbiBnZXRXcml0YWJsZURpcigpIHtcbiAgICAvLyByZXR1cm4gcHJvY2Vzcy5lbnZbKHByb2Nlc3MucGxhdGZvcm0gPT0gJ3dpbjMyJykgPyAnVVNFUlBST0ZJTEUnIDogJ0hPTUUnXTtcbiAgICByZXR1cm4gb3MudG1wZGlyKCk7XG59XG5mdW5jdGlvbiBzZXR1cE9uY2UoKSB7XG4gICAgdmFyIGhvbWUgPSBnZXRXcml0YWJsZURpcigpO1xuICAgIHRyeSB7XG4gICAgICAgIGZzLm1rZGlyU3luYyhob21lICsgJy8nICsgJ2ZkZXZzdGFydCcpO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgICBmcy5ta2RpclN5bmMoaG9tZSArICcvZmRldnN0YXJ0L2xvZ3MnKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICB9XG59XG5zZXR1cE9uY2UoKTtcbmZ1bmN0aW9uIGdldEZpbGVOYW1lKG5hbWUpIHtcbiAgICByZXR1cm4gb3MudG1wZGlyKCkgKyAnL2ZkZXZzdGFydC9sb2dzLycgKyBuYW1lICsgXCIubG9nXCI7XG59XG5leHBvcnRzLl90ZXN0ID0ge1xuICAgIGdldEZpbGVOYW1lOiBnZXRGaWxlTmFtZVxufTtcbmZ1bmN0aW9uIGxvZ0l0KGxvZ2dlciwgYXJnKSB7XG4gICAgdmFyIHRleHQ7XG4gICAgaWYgKHR5cGVvZiBhcmcgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgdGV4dCA9IGFyZztcbiAgICB9XG4gICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgdGV4dCA9IFwiRXJyb3I6XCIgKyBhcmcubWVzc2FnZSArIFwiIFwiICsgYXJnLnN0YWNrO1xuICAgIH1cbiAgICBpZiAoIXRleHQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSWxsZWdhbCBhcmd1bWVudCB0byBsb2dcIik7XG4gICAgfVxuICAgIHZhciBmaWxlbmFtZSA9IGdldEZpbGVOYW1lKGxvZ2dlci5uYW1lKTtcbiAgICB2YXIgZCA9IG5ldyBEYXRlKCk7XG4gICAgdmFyIG4gPSBkLnRvVVRDU3RyaW5nKCkgKyBcIlxcdFwiICsgdGV4dDtcbiAgICBkZWJ1Z2xvZygnd3JpdGluZyBsb2cgZW50cnkgdG8gJyArIGZpbGVuYW1lICsgJyAnICsgbik7XG4gICAgZnMud3JpdGVGaWxlU3luYyhmaWxlbmFtZSwgbiwgeyBlbmNvZGluZzogJ3V0Zi04JywgZmxhZzogJ2EnIH0pO1xufVxuZnVuY3Rpb24gbG9nZ2VyKG5hbWUsIGZsYWdzKSB7XG4gICAgaWYgKGZsYWdzICE9PSAnYScgJiYgZmxhZ3MgIT09ICcnICYmIGZsYWdzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdvbmx5IGEgYWxsb3dlZCBhcyBmbGFncycpO1xuICAgIH1cbiAgICBmbGFncyA9IChmbGFncyA9PT0gdW5kZWZpbmVkKSA/ICdhJyA6IGZsYWdzO1xuICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gXCJzdHJpbmdcIiB8fCAhL15bQS1aYS16XVtBLVphLXowLTlfXSskLy5leGVjKG5hbWUpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIG5hbWUgbXVzdCBiZSBhdCBsZWFzdCB0d28gYWxwaGFudW1lcmljIGNoYXJhY3RlcnMnKTtcbiAgICB9XG4gICAgaWYgKCFsb2dnZXJzW25hbWVdKSB7XG4gICAgICAgIHZhciBhbG9nZ2VyID0ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIGZsYWdzOiBmbGFnc1xuICAgICAgICB9O1xuICAgICAgICBhbG9nZ2VyLmxvZ0l0ID0gbG9nSXQuYmluZCh1bmRlZmluZWQsIGFsb2dnZXIpO1xuICAgICAgICAvLyByZXNldCB0aGUgZmlsZVxuICAgICAgICBpZiAoZmxhZ3MgPT09ICcnKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmMoZ2V0RmlsZU5hbWUobmFtZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIioqKkVSUk9SOiB1bmFibGUgdG8gcmVtb3ZlIGxvZyBmaWxlIFwiICsgZ2V0RmlsZU5hbWUobmFtZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGxvZ2dlcnNbbmFtZV0gPSBhbG9nZ2VyO1xuICAgIH1cbiAgICBpZiAobG9nZ2Vyc1tuYW1lXS5mbGFncyAhPT0gZmxhZ3MpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGTGFncyBtaXNtYXRjaCBpbiBsb2dnZXInICsgbmFtZSk7XG4gICAgfVxuICAgIHJldHVybiBsb2dnZXJzW25hbWVdLmxvZ0l0O1xufVxuZXhwb3J0cy5sb2dnZXIgPSBsb2dnZXI7XG4iLCJcblxuLyoqXG4gKiBhIHNpbXBsZSBsb2dnZXIgdXRpbGl0eVxuICpcbiAqXG4gKiBUaGVyZSBhcmUgdHdvIHR5cGVzIG9mIGxvZ3MgKCBhcHBlbmQgYW5kIG92ZXJ3cml0ZSwgZGVmYXVsdCBpcyBhcHBlbmQpXG4gKi9cblxuLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vbGliL25vZGUtNC5kLnRzXCIgLz5cblxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdsb2dnZXInKTtcblxuaW50ZXJmYWNlIElMb2dnZXIge1xuICBuYW1lOiBzdHJpbmcsXG4gIGZsYWdzOiBzdHJpbmcsXG4gIGxvZ0l0PzogKGFueSkgPT4gdm9pZFxufTtcblxudmFyIHBlcmZzID0ge30gYXMge1trZXkgOiBzdHJpbmddIDogeyBlbmFibGVkIDogYm9vbGVhbiwgbmFtZSA6IHN0cmluZywgbGFzdDogbnVtYmVyLCBmaXJzdCA6IG51bWJlciwgb24gOiB7fX19O1xuXG5leHBvcnQgZnVuY3Rpb24gbG9nUGVyZihjb25zIDogYW55LCBzU3RyaW5nIDogc3RyaW5nKSB7XG4gIGlmKCF0aGlzIHx8ICF0aGlzLmVuYWJsZWQpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgdmFyIGxhYmVsID0gJ3BlcmYnICsgdGhpcy5uYW1lO1xuICBjb25zLmxvZygnUGVyZicgKyB0aGlzLm5hbWUpO1xuICBpZih0aGlzLmZpcnN0ID09PSAwKSB7XG4gICAgICB0aGlzLmZpcnN0ID0gRGF0ZS5ub3coKTtcbiAgICAgIHRoaXMubGFzdCA9IHRoaXMuZmlyc3Q7XG4gIH0gZWxzZSB7XG4gICAgdmFyIHQgPSBEYXRlLm5vdygpO1xuICAgIGNvbnMubG9nKCdQZXJmJyArIHRoaXMubmFtZSArXG4gICAgICcgZGVsdGE6ICcgICsgU3RyaW5nKFwiICAgICAgXCIgKyAodC10aGlzLmxhc3QpKS5zbGljZSgtNilcbiAgICArJyB0b3RhbDogJyAgKyBTdHJpbmcoXCIgICAgICBcIiArICh0LXRoaXMuZmlyc3QpKS5zbGljZSgtNikpO1xuICAgIHRoaXMubGFzdCA9ICB0O1xuICB9XG4gIGlmKHRoaXMub25bc1N0cmluZ10pIHtcbiAgICAgY29ucy50aW1lRW5kKHNTdHJpbmcpXG4gICAgIGRlbGV0ZSB0aGlzLm9uW3NTdHJpbmddO1xuICB9IGVsc2Uge1xuICAgICAgY29ucy50aW1lKHNTdHJpbmcpO1xuICAgICAgdGhpcy5vbltzU3RyaW5nXSA9IDE7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBlcmYoc3RyaW5nKSB7XG4gIHBlcmZzW3N0cmluZ10gPSB7IG5hbWUgOiBzdHJpbmcsIGxhc3QgOiAwLCBmaXJzdDogMCwgb24gOiB7fSwgZW5hYmxlZCA6IGZhbHNlIH07XG4gIGlmIChkZWJ1ZygncGVyZicgKyBzdHJpbmcpLmVuYWJsZWQgKVxuICB7IHBlcmZzW3N0cmluZ10uZW5hYmxlZCA9IHRydWU7XG4gIH1cbiAgcmV0dXJuIGxvZ1BlcmYuYmluZChwZXJmc1tzdHJpbmddLCBjb25zb2xlKTtcbn1cblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuXG52YXIgbG9nZ2VycyA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogSUxvZ2dlciB9O1xuXG52YXIgb3MgPSByZXF1aXJlKCdvcycpO1xuXG5mdW5jdGlvbiBnZXRXcml0YWJsZURpcigpIHtcbiAgLy8gcmV0dXJuIHByb2Nlc3MuZW52Wyhwcm9jZXNzLnBsYXRmb3JtID09ICd3aW4zMicpID8gJ1VTRVJQUk9GSUxFJyA6ICdIT01FJ107XG4gIHJldHVybiBvcy50bXBkaXIoKTtcbn1cblxuXG5mdW5jdGlvbiBzZXR1cE9uY2UoKSB7XG5cbiAgdmFyIGhvbWUgPSBnZXRXcml0YWJsZURpcigpO1xuICB0cnkge1xuICAgIGZzLm1rZGlyU3luYyhob21lICsgJy8nICsgJ2ZkZXZzdGFydCcgKTtcbiAgfSBjYXRjaCAoZSkge1xuXG4gIH1cbiAgdHJ5IHtcbiAgICBmcy5ta2RpclN5bmMoaG9tZSArICcvZmRldnN0YXJ0L2xvZ3MnICk7XG4gIH0gY2F0Y2goZSkge1xuXG4gIH1cbn1cbnNldHVwT25jZSgpO1xuXG5cbmZ1bmN0aW9uIGdldEZpbGVOYW1lKG5hbWU6IHN0cmluZykge1xuICByZXR1cm4gb3MudG1wZGlyKCkgICsgJy9mZGV2c3RhcnQvbG9ncy8nICsgbmFtZSArIFwiLmxvZ1wiO1xufVxuXG5leHBvcnQgY29uc3QgX3Rlc3QgPSB7XG4gIGdldEZpbGVOYW1lOiBnZXRGaWxlTmFtZVxufTtcblxuZnVuY3Rpb24gbG9nSXQobG9nZ2VyOiBJTG9nZ2VyLCBhcmcpIHtcbiAgdmFyIHRleHQ6IHN0cmluZztcbiAgaWYgKHR5cGVvZiBhcmcgPT09IFwic3RyaW5nXCIpIHtcbiAgICB0ZXh0ID0gYXJnO1xuICB9IGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgdGV4dCA9IFwiRXJyb3I6XCIgKyBhcmcubWVzc2FnZSArIFwiIFwiICsgYXJnLnN0YWNrO1xuICB9XG4gIGlmICghdGV4dCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIklsbGVnYWwgYXJndW1lbnQgdG8gbG9nXCIpO1xuICB9XG4gIHZhciBmaWxlbmFtZSA9IGdldEZpbGVOYW1lKGxvZ2dlci5uYW1lKTtcbiAgdmFyIGQgPSBuZXcgRGF0ZSgpO1xuICB2YXIgbiA9IGQudG9VVENTdHJpbmcoKSArIFwiXFx0XCIgKyB0ZXh0O1xuICBkZWJ1Z2xvZygnd3JpdGluZyBsb2cgZW50cnkgdG8gJyArIGZpbGVuYW1lICsgJyAnICsgbik7XG4gIGZzLndyaXRlRmlsZVN5bmMoZmlsZW5hbWUsIG4sIHsgZW5jb2Rpbmc6ICd1dGYtOCcsIGZsYWc6ICdhJyB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxvZ2dlcihuYW1lOiBzdHJpbmcsIGZsYWdzPzogc3RyaW5nKTogKGFueSkgPT4gdm9pZCB7XG4gIGlmIChmbGFncyAhPT0gJ2EnICYmIGZsYWdzICE9PSAnJyAmJiBmbGFncyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdvbmx5IGEgYWxsb3dlZCBhcyBmbGFncycpO1xuICB9XG4gIGZsYWdzID0gKGZsYWdzID09PSB1bmRlZmluZWQgKT8gICdhJyA6IGZsYWdzO1xuICBpZiAodHlwZW9mIG5hbWUgIT09IFwic3RyaW5nXCIgfHwgIS9eW0EtWmEtel1bQS1aYS16MC05X10rJC8uZXhlYyhuYW1lKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIG5hbWUgbXVzdCBiZSBhdCBsZWFzdCB0d28gYWxwaGFudW1lcmljIGNoYXJhY3RlcnMnKVxuICB9XG4gIGlmICghbG9nZ2Vyc1tuYW1lXSkge1xuICAgIHZhciBhbG9nZ2VyID0ge1xuICAgICAgbmFtZTogbmFtZSxcbiAgICAgIGZsYWdzOiBmbGFnc1xuICAgIH0gYXMgSUxvZ2dlcjtcbiAgICBhbG9nZ2VyLmxvZ0l0ID0gbG9nSXQuYmluZCh1bmRlZmluZWQsIGFsb2dnZXIpO1xuICAgIC8vIHJlc2V0IHRoZSBmaWxlXG4gICAgaWYgKGZsYWdzID09PSAnJykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgZnMudW5saW5rU3luYyhnZXRGaWxlTmFtZShuYW1lKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiKioqRVJST1I6IHVuYWJsZSB0byByZW1vdmUgbG9nIGZpbGUgXCIgKyBnZXRGaWxlTmFtZShuYW1lKSk7XG4gICAgICB9XG4gICAgfVxuICAgIGxvZ2dlcnNbbmFtZV0gPSBhbG9nZ2VyO1xuICB9XG4gIGlmIChsb2dnZXJzW25hbWVdLmZsYWdzICE9PSBmbGFncykge1xuICAgIHRocm93IG5ldyBFcnJvcignRkxhZ3MgbWlzbWF0Y2ggaW4gbG9nZ2VyJyArIG5hbWUpO1xuICB9XG4gIHJldHVybiBsb2dnZXJzW25hbWVdLmxvZ0l0O1xufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
