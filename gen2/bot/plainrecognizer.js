"use strict";
/**
 * @copyright (c) 2016 Gerd Forstmann
 * @file plainrecognizer.ts
 *
 * A recognizer parametrized by regex expressions
 */

Object.defineProperty(exports, "__esModule", { value: true });
var debug = require("debug");
var debuglog = debug('plainrecognizer');
var AnyObject = Object;
function recognize(sString, mRules) {
    var res = undefined;
    mRules.every(function (oRule) {
        res = matchRegularExpression(sString, oRule);
        return !res;
    });
    return res;
}
exports.recognize = recognize;
function countParenGroups(s) {
    var res = 0;
    for (var i = 0; i < s.length; ++i) {
        if (s.charAt(i) === '(') {
            ++res;
        }
    }
    return res;
}
exports.countParenGroups = countParenGroups;
/**
 * given a string, e.g.
 * "who is the <category> of <A1>",
 * @param {string} a
 * @returns {IMatch.IRule} a regexp rule
 */
function parseRuleString(a) {
    var s = "^" + a + "$";
    var argMaps = {};
    var m = undefined;
    while (m = /<([^>]+)>([?]?)/.exec(s)) {
        var cat = m[1];
        var greedy = m[2];
        var pos = 1 + countParenGroups(s.substring(0, m.index));
        if (greedy) {
            s = s.replace("<" + cat + ">?", "(.*?)");
        } else {
            s = s.replace("<" + cat + ">", "(.*)");
        }
        if (argMaps[cat]) {
            throw Error("Model error duplicate entry!");
        }
        argMaps[cat] = pos;
    }
    return {
        type: 1,
        regexp: new RegExp(s, "i"),
        argsMap: argMaps
    };
}
exports.parseRuleString = parseRuleString;
/**
 * given a string, e.g.
 * "who is the <category> of <A1>",
 * @param {string} a
 * @returns {IMatch.IRule} a regexp rule
 */
function parseRuleArray(a) {
    var s = "^" + a + "$";
    var r = a[0];
    if (typeof a[0] === "string") {
        r = new RegExp(a[0], "i");
    }
    if (!(r instanceof RegExp)) {
        throw Error("illegal state" + JSON.stringify(a));
    }
    return {
        type: 1,
        regexp: r,
        argsMap: a[1]
    };
}
exports.parseRuleArray = parseRuleArray;
function parseRule(a) {
    if (typeof a === 'string') {
        return parseRuleString(a);
    } else if (Array.isArray(a)) {
        return parseRuleArray(a);
    }
    throw new Error("unknown rule definition");
}
exports.parseRule = parseRule;
function parseRules(oJSON) {
    var res = {};
    Object.keys(oJSON).forEach(function (sKey) {
        res[sKey] = oJSON[sKey].map(function (oRule) {
            return parseRule(oRule);
        });
    });
    return res;
}
exports.parseRules = parseRules;
;
function trimValueAdjusting(value) {
    var res = { deltaStart: 0, value: value };
    var m = value.match(/^\s+/);
    if (m) {
        res.deltaStart = m[0].length;
        value = value.substr(res.deltaStart);
    }
    m = value.match(/\s+$/);
    if (m) {
        value = value.substr(0, value.length - m[0].length);
    }
    res.value = value;
    return res;
}
exports.trimValueAdjusting = trimValueAdjusting;
function extractArgsMap(s, match, argsMap) {
    if (!argsMap) {
        return [];
    }
    var result = [];
    Object.keys(argsMap).forEach(function (sKey) {
        var res = {};
        var index = argsMap[sKey];
        var value = match[index];
        if (typeof value === "string" && value.length > 0) {
            res.type = sKey;
            res.entity = value;
            res.startIndex = s.indexOf(value); // this may not be precise
            var trimAdjust = trimValueAdjusting(value);
            res.startIndex += trimAdjust.deltaStart;
            res.entity = trimAdjust.value;
            res.endIndex = res.startIndex + trimAdjust.value.length;
            //res[sKey] = value
            result.push(res);
        }
    });
    return result;
}
exports.extractArgsMap = extractArgsMap;
function matchRegularExpression(text, oRule) {
    debuglog("regexp is " + oRule.regexp.toString());
    debuglog(" text is " + text);
    var m = oRule.regexp.exec(text);
    if (!m) {
        return undefined;
    }
    var res = {};
    res.entities = extractArgsMap(text, m, oRule.argsMap);
    res.score = 0.9;
    debuglog("match " + JSON.stringify(m));
    debuglog('Found one' + JSON.stringify(res, undefined, 2));
    return res;
}
exports.matchRegularExpression = matchRegularExpression;
function trimTrailingSentenceDelimiters(text) {
    var m = /([!.;, ?]|\s)+$/.exec(text);
    if (m) {
        text = text.substr(0, text.length - m[0].length);
    }
    return text;
}
exports.trimTrailingSentenceDelimiters = trimTrailingSentenceDelimiters;
function normalizeWhitespace(text) {
    text = text.replace(/\s+/g, ' ');
    return text;
}
exports.normalizeWhitespace = normalizeWhitespace;
/**
 * Givena string, replace all "....."  with <word>
 */
function compactQuoted(text) {
    text = text.replace(/"[^"]+"/g, "<word>");
    return text;
}
exports.compactQuoted = compactQuoted;
function countCompactWords(text) {
    text = text.replace(/,/g, ' ');
    text = text.replace(/ \s+/g, ' ');
    return text.split(" ").length;
}
exports.countCompactWords = countCompactWords;
function checkForLength(text) {
    var textStripped = trimTrailingSentenceDelimiters(text);
    if (textStripped.length > 200 || countCompactWords(compactQuoted(text)) > 20) {
        return {
            intent: "TooLong",
            score: 1.0,
            entities: []
        };
    }
    return undefined;
}
exports.checkForLength = checkForLength;
function recognizeText(text, aRules) {
    var res = undefined;
    aRules.every(function (oRule) {
        res = matchRegularExpression(text, oRule);
        return !res;
    });
    return res;
}
exports.recognizeText = recognizeText;
var RegExpRecognizer = function () {
    function RegExpRecognizer(xRules) {
        this.oRules = xRules;
        debuglog("rules " + JSON.stringify(this.oRules));
    }
    ;
    RegExpRecognizer.prototype.recognize = function (context, callback) {
        var u = {};
        var text = context.message.text;
        var that = this;
        var r = checkForLength(text);
        if (r) {
            callback(undefined, r);
            return;
        }
        debuglog("rules " + JSON.stringify(this.oRules));
        var text = trimTrailingSentenceDelimiters(text);
        var results = Object.keys(this.oRules).map(function (sKey) {
            var u = recognizeText(text, that.oRules[sKey]);
            if (u) {
                u.intent = sKey;
            }
            return u ? u : undefined;
        }).filter(function (o) {
            return !!o;
        });
        if (results.length > 1) {
            /* TODO abiguous */
            debuglog("ambiguous result for >" + text + "<" + JSON.stringify(res));
        }
        if (results.length > 0) {
            var res = results[0];
            callback(undefined, res);
            return;
        }
        debuglog('recognizing nothing');
        u.intent = "None";
        u.score = 0.1;
        var e1 = {};
        e1.startIndex = "exit ".length;
        e1.endIndex = context.message.text.length;
        e1.score = 0.1;
        u.entities = [];
        callback(undefined, u);
    };
    return RegExpRecognizer;
}(); // class
exports.RegExpRecognizer = RegExpRecognizer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJvdC9wbGFpbnJlY29nbml6ZXIuanMiLCIuLi9zcmMvYm90L3BsYWlucmVjb2duaXplci50cyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwiQW55T2JqZWN0IiwicmVjb2duaXplIiwic1N0cmluZyIsIm1SdWxlcyIsInJlcyIsInVuZGVmaW5lZCIsImV2ZXJ5Iiwib1J1bGUiLCJtYXRjaFJlZ3VsYXJFeHByZXNzaW9uIiwiY291bnRQYXJlbkdyb3VwcyIsInMiLCJpIiwibGVuZ3RoIiwiY2hhckF0IiwicGFyc2VSdWxlU3RyaW5nIiwiYSIsImFyZ01hcHMiLCJtIiwiZXhlYyIsImNhdCIsImdyZWVkeSIsInBvcyIsInN1YnN0cmluZyIsImluZGV4IiwicmVwbGFjZSIsIkVycm9yIiwidHlwZSIsInJlZ2V4cCIsIlJlZ0V4cCIsImFyZ3NNYXAiLCJwYXJzZVJ1bGVBcnJheSIsInIiLCJKU09OIiwic3RyaW5naWZ5IiwicGFyc2VSdWxlIiwiQXJyYXkiLCJpc0FycmF5IiwicGFyc2VSdWxlcyIsIm9KU09OIiwia2V5cyIsImZvckVhY2giLCJzS2V5IiwibWFwIiwidHJpbVZhbHVlQWRqdXN0aW5nIiwiZGVsdGFTdGFydCIsIm1hdGNoIiwic3Vic3RyIiwiZXh0cmFjdEFyZ3NNYXAiLCJyZXN1bHQiLCJlbnRpdHkiLCJzdGFydEluZGV4IiwiaW5kZXhPZiIsInRyaW1BZGp1c3QiLCJlbmRJbmRleCIsInB1c2giLCJ0ZXh0IiwidG9TdHJpbmciLCJlbnRpdGllcyIsInNjb3JlIiwidHJpbVRyYWlsaW5nU2VudGVuY2VEZWxpbWl0ZXJzIiwibm9ybWFsaXplV2hpdGVzcGFjZSIsImNvbXBhY3RRdW90ZWQiLCJjb3VudENvbXBhY3RXb3JkcyIsInNwbGl0IiwiY2hlY2tGb3JMZW5ndGgiLCJ0ZXh0U3RyaXBwZWQiLCJpbnRlbnQiLCJyZWNvZ25pemVUZXh0IiwiYVJ1bGVzIiwiUmVnRXhwUmVjb2duaXplciIsInhSdWxlcyIsIm9SdWxlcyIsInByb3RvdHlwZSIsImNvbnRleHQiLCJjYWxsYmFjayIsInUiLCJtZXNzYWdlIiwidGhhdCIsInJlc3VsdHMiLCJmaWx0ZXIiLCJvIiwiZTEiXSwibWFwcGluZ3MiOiJBQUFBO0FDQ0E7Ozs7Ozs7QURNQUEsT0FBT0MsY0FBUCxDQUFzQkMsT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkMsRUFBRUMsT0FBTyxJQUFULEVBQTdDO0FDSUEsSUFBQUMsUUFBQUMsUUFBQSxPQUFBLENBQUE7QUFDQSxJQUFNQyxXQUFXRixNQUFNLGlCQUFOLENBQWpCO0FBRUEsSUFBTUcsWUFBWVAsTUFBbEI7QUFFQSxTQUFBUSxTQUFBLENBQTBCQyxPQUExQixFQUFtQ0MsTUFBbkMsRUFBbUU7QUFDakUsUUFBSUMsTUFBTUMsU0FBVjtBQUNBRixXQUFPRyxLQUFQLENBQWEsVUFBVUMsS0FBVixFQUFlO0FBQzFCSCxjQUFNSSx1QkFBdUJOLE9BQXZCLEVBQWdDSyxLQUFoQyxDQUFOO0FBQ0EsZUFBTyxDQUFDSCxHQUFSO0FBQ0QsS0FIRDtBQUlBLFdBQU9BLEdBQVA7QUFDRDtBQVBEVCxRQUFBTSxTQUFBLEdBQUFBLFNBQUE7QUFTQSxTQUFBUSxnQkFBQSxDQUFpQ0MsQ0FBakMsRUFBMEM7QUFDeEMsUUFBSU4sTUFBTSxDQUFWO0FBQ0EsU0FBSyxJQUFJTyxJQUFJLENBQWIsRUFBZ0JBLElBQUlELEVBQUVFLE1BQXRCLEVBQThCLEVBQUVELENBQWhDLEVBQW1DO0FBQ2pDLFlBQUlELEVBQUVHLE1BQUYsQ0FBU0YsQ0FBVCxNQUFnQixHQUFwQixFQUF5QjtBQUN2QixjQUFFUCxHQUFGO0FBQ0Q7QUFDRjtBQUNELFdBQU9BLEdBQVA7QUFDRDtBQVJEVCxRQUFBYyxnQkFBQSxHQUFBQSxnQkFBQTtBQVVBOzs7Ozs7QUFNQSxTQUFBSyxlQUFBLENBQWdDQyxDQUFoQyxFQUF5QztBQUN2QyxRQUFJTCxJQUFJLE1BQU1LLENBQU4sR0FBVSxHQUFsQjtB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XCJ1c2Ugc3RyaWN0XCI7XG4vKipcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqIEBmaWxlIHBsYWlucmVjb2duaXplci50c1xuICpcbiAqIEEgcmVjb2duaXplciBwYXJhbWV0cml6ZWQgYnkgcmVnZXggZXhwcmVzc2lvbnNcbiAqL1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ3BsYWlucmVjb2duaXplcicpO1xudmFyIEFueU9iamVjdCA9IE9iamVjdDtcbmZ1bmN0aW9uIHJlY29nbml6ZShzU3RyaW5nLCBtUnVsZXMpIHtcbiAgICB2YXIgcmVzID0gdW5kZWZpbmVkO1xuICAgIG1SdWxlcy5ldmVyeShmdW5jdGlvbiAob1J1bGUpIHtcbiAgICAgICAgcmVzID0gbWF0Y2hSZWd1bGFyRXhwcmVzc2lvbihzU3RyaW5nLCBvUnVsZSk7XG4gICAgICAgIHJldHVybiAhcmVzO1xuICAgIH0pO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLnJlY29nbml6ZSA9IHJlY29nbml6ZTtcbmZ1bmN0aW9uIGNvdW50UGFyZW5Hcm91cHMocykge1xuICAgIHZhciByZXMgPSAwO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7ICsraSkge1xuICAgICAgICBpZiAocy5jaGFyQXQoaSkgPT09ICcoJykge1xuICAgICAgICAgICAgKytyZXM7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuY291bnRQYXJlbkdyb3VwcyA9IGNvdW50UGFyZW5Hcm91cHM7XG4vKipcbiAqIGdpdmVuIGEgc3RyaW5nLCBlLmcuXG4gKiBcIndobyBpcyB0aGUgPGNhdGVnb3J5PiBvZiA8QTE+XCIsXG4gKiBAcGFyYW0ge3N0cmluZ30gYVxuICogQHJldHVybnMge0lNYXRjaC5JUnVsZX0gYSByZWdleHAgcnVsZVxuICovXG5mdW5jdGlvbiBwYXJzZVJ1bGVTdHJpbmcoYSkge1xuICAgIHZhciBzID0gXCJeXCIgKyBhICsgXCIkXCI7XG4gICAgdmFyIGFyZ01hcHMgPSB7fTtcbiAgICB2YXIgbSA9IHVuZGVmaW5lZDtcbiAgICB3aGlsZSAobSA9IC88KFtePl0rKT4oWz9dPykvLmV4ZWMocykpIHtcbiAgICAgICAgdmFyIGNhdCA9IG1bMV07XG4gICAgICAgIHZhciBncmVlZHkgPSBtWzJdO1xuICAgICAgICB2YXIgcG9zID0gMSArIGNvdW50UGFyZW5Hcm91cHMocy5zdWJzdHJpbmcoMCwgbS5pbmRleCkpO1xuICAgICAgICBpZiAoZ3JlZWR5KSB7XG4gICAgICAgICAgICBzID0gcy5yZXBsYWNlKFwiPFwiICsgY2F0ICsgXCI+P1wiLCBcIiguKj8pXCIpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcyA9IHMucmVwbGFjZShcIjxcIiArIGNhdCArIFwiPlwiLCBcIiguKilcIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFyZ01hcHNbY2F0XSkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoXCJNb2RlbCBlcnJvciBkdXBsaWNhdGUgZW50cnkhXCIpO1xuICAgICAgICB9XG4gICAgICAgIGFyZ01hcHNbY2F0XSA9IHBvcztcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdHlwZTogMSxcbiAgICAgICAgcmVnZXhwOiBuZXcgUmVnRXhwKHMsIFwiaVwiKSxcbiAgICAgICAgYXJnc01hcDogYXJnTWFwc1xuICAgIH07XG59XG5leHBvcnRzLnBhcnNlUnVsZVN0cmluZyA9IHBhcnNlUnVsZVN0cmluZztcbi8qKlxuICogZ2l2ZW4gYSBzdHJpbmcsIGUuZy5cbiAqIFwid2hvIGlzIHRoZSA8Y2F0ZWdvcnk+IG9mIDxBMT5cIixcbiAqIEBwYXJhbSB7c3RyaW5nfSBhXG4gKiBAcmV0dXJucyB7SU1hdGNoLklSdWxlfSBhIHJlZ2V4cCBydWxlXG4gKi9cbmZ1bmN0aW9uIHBhcnNlUnVsZUFycmF5KGEpIHtcbiAgICB2YXIgcyA9IFwiXlwiICsgYSArIFwiJFwiO1xuICAgIHZhciByID0gYVswXTtcbiAgICBpZiAodHlwZW9mIGFbMF0gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgciA9IG5ldyBSZWdFeHAoYVswXSwgXCJpXCIpO1xuICAgIH1cbiAgICBpZiAoIShyIGluc3RhbmNlb2YgUmVnRXhwKSkge1xuICAgICAgICB0aHJvdyBFcnJvcihcImlsbGVnYWwgc3RhdGVcIiArIEpTT04uc3RyaW5naWZ5KGEpKTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdHlwZTogMSxcbiAgICAgICAgcmVnZXhwOiByLFxuICAgICAgICBhcmdzTWFwOiBhWzFdXG4gICAgfTtcbn1cbmV4cG9ydHMucGFyc2VSdWxlQXJyYXkgPSBwYXJzZVJ1bGVBcnJheTtcbmZ1bmN0aW9uIHBhcnNlUnVsZShhKSB7XG4gICAgaWYgKHR5cGVvZiBhID09PSAnc3RyaW5nJykge1xuICAgICAgICByZXR1cm4gcGFyc2VSdWxlU3RyaW5nKGEpO1xuICAgIH1cbiAgICBlbHNlIGlmIChBcnJheS5pc0FycmF5KGEpKSB7XG4gICAgICAgIHJldHVybiBwYXJzZVJ1bGVBcnJheShhKTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKFwidW5rbm93biBydWxlIGRlZmluaXRpb25cIik7XG59XG5leHBvcnRzLnBhcnNlUnVsZSA9IHBhcnNlUnVsZTtcbmZ1bmN0aW9uIHBhcnNlUnVsZXMob0pTT04pIHtcbiAgICB2YXIgcmVzID0ge307XG4gICAgT2JqZWN0LmtleXMob0pTT04pLmZvckVhY2goZnVuY3Rpb24gKHNLZXkpIHtcbiAgICAgICAgcmVzW3NLZXldID0gb0pTT05bc0tleV0ubWFwKGZ1bmN0aW9uIChvUnVsZSkge1xuICAgICAgICAgICAgcmV0dXJuIHBhcnNlUnVsZShvUnVsZSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLnBhcnNlUnVsZXMgPSBwYXJzZVJ1bGVzO1xuO1xuZnVuY3Rpb24gdHJpbVZhbHVlQWRqdXN0aW5nKHZhbHVlKSB7XG4gICAgdmFyIHJlcyA9IHsgZGVsdGFTdGFydDogMCwgdmFsdWU6IHZhbHVlIH07XG4gICAgdmFyIG0gPSB2YWx1ZS5tYXRjaCgvXlxccysvKTtcbiAgICBpZiAobSkge1xuICAgICAgICByZXMuZGVsdGFTdGFydCA9IG1bMF0ubGVuZ3RoO1xuICAgICAgICB2YWx1ZSA9IHZhbHVlLnN1YnN0cihyZXMuZGVsdGFTdGFydCk7XG4gICAgfVxuICAgIG0gPSB2YWx1ZS5tYXRjaCgvXFxzKyQvKTtcbiAgICBpZiAobSkge1xuICAgICAgICB2YWx1ZSA9IHZhbHVlLnN1YnN0cigwLCB2YWx1ZS5sZW5ndGggLSBtWzBdLmxlbmd0aCk7XG4gICAgfVxuICAgIHJlcy52YWx1ZSA9IHZhbHVlO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLnRyaW1WYWx1ZUFkanVzdGluZyA9IHRyaW1WYWx1ZUFkanVzdGluZztcbmZ1bmN0aW9uIGV4dHJhY3RBcmdzTWFwKHMsIG1hdGNoLCBhcmdzTWFwKSB7XG4gICAgaWYgKCFhcmdzTWFwKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgdmFyIHJlc3VsdCA9IFtdO1xuICAgIE9iamVjdC5rZXlzKGFyZ3NNYXApLmZvckVhY2goZnVuY3Rpb24gKHNLZXkpIHtcbiAgICAgICAgdmFyIHJlcyA9IHt9O1xuICAgICAgICB2YXIgaW5kZXggPSBhcmdzTWFwW3NLZXldO1xuICAgICAgICB2YXIgdmFsdWUgPSBtYXRjaFtpbmRleF07XG4gICAgICAgIGlmICgodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSAmJiB2YWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXMudHlwZSA9IHNLZXk7XG4gICAgICAgICAgICByZXMuZW50aXR5ID0gdmFsdWU7XG4gICAgICAgICAgICByZXMuc3RhcnRJbmRleCA9IHMuaW5kZXhPZih2YWx1ZSk7IC8vIHRoaXMgbWF5IG5vdCBiZSBwcmVjaXNlXG4gICAgICAgICAgICB2YXIgdHJpbUFkanVzdCA9IHRyaW1WYWx1ZUFkanVzdGluZyh2YWx1ZSk7XG4gICAgICAgICAgICByZXMuc3RhcnRJbmRleCArPSB0cmltQWRqdXN0LmRlbHRhU3RhcnQ7XG4gICAgICAgICAgICByZXMuZW50aXR5ID0gdHJpbUFkanVzdC52YWx1ZTtcbiAgICAgICAgICAgIHJlcy5lbmRJbmRleCA9IHJlcy5zdGFydEluZGV4ICsgdHJpbUFkanVzdC52YWx1ZS5sZW5ndGg7XG4gICAgICAgICAgICAvL3Jlc1tzS2V5XSA9IHZhbHVlXG4gICAgICAgICAgICByZXN1bHQucHVzaChyZXMpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbmV4cG9ydHMuZXh0cmFjdEFyZ3NNYXAgPSBleHRyYWN0QXJnc01hcDtcbmZ1bmN0aW9uIG1hdGNoUmVndWxhckV4cHJlc3Npb24odGV4dCwgb1J1bGUpIHtcbiAgICBkZWJ1Z2xvZyhcInJlZ2V4cCBpcyBcIiArIG9SdWxlLnJlZ2V4cC50b1N0cmluZygpKTtcbiAgICBkZWJ1Z2xvZyhcIiB0ZXh0IGlzIFwiICsgdGV4dCk7XG4gICAgdmFyIG0gPSBvUnVsZS5yZWdleHAuZXhlYyh0ZXh0KTtcbiAgICBpZiAoIW0pIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgdmFyIHJlcyA9IHt9O1xuICAgIHJlcy5lbnRpdGllcyA9IGV4dHJhY3RBcmdzTWFwKHRleHQsIG0sIG9SdWxlLmFyZ3NNYXApO1xuICAgIHJlcy5zY29yZSA9IDAuOTtcbiAgICBkZWJ1Z2xvZyhcIm1hdGNoIFwiICsgSlNPTi5zdHJpbmdpZnkobSkpO1xuICAgIGRlYnVnbG9nKCdGb3VuZCBvbmUnICsgSlNPTi5zdHJpbmdpZnkocmVzLCB1bmRlZmluZWQsIDIpKTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5tYXRjaFJlZ3VsYXJFeHByZXNzaW9uID0gbWF0Y2hSZWd1bGFyRXhwcmVzc2lvbjtcbmZ1bmN0aW9uIHRyaW1UcmFpbGluZ1NlbnRlbmNlRGVsaW1pdGVycyh0ZXh0KSB7XG4gICAgdmFyIG0gPSAvKFshLjssID9dfFxccykrJC8uZXhlYyh0ZXh0KTtcbiAgICBpZiAobSkge1xuICAgICAgICB0ZXh0ID0gdGV4dC5zdWJzdHIoMCwgdGV4dC5sZW5ndGggLSBtWzBdLmxlbmd0aCk7XG4gICAgfVxuICAgIHJldHVybiB0ZXh0O1xufVxuZXhwb3J0cy50cmltVHJhaWxpbmdTZW50ZW5jZURlbGltaXRlcnMgPSB0cmltVHJhaWxpbmdTZW50ZW5jZURlbGltaXRlcnM7XG5mdW5jdGlvbiBub3JtYWxpemVXaGl0ZXNwYWNlKHRleHQpIHtcbiAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cXHMrL2csICcgJyk7XG4gICAgcmV0dXJuIHRleHQ7XG59XG5leHBvcnRzLm5vcm1hbGl6ZVdoaXRlc3BhY2UgPSBub3JtYWxpemVXaGl0ZXNwYWNlO1xuLyoqXG4gKiBHaXZlbmEgc3RyaW5nLCByZXBsYWNlIGFsbCBcIi4uLi4uXCIgIHdpdGggPHdvcmQ+XG4gKi9cbmZ1bmN0aW9uIGNvbXBhY3RRdW90ZWQodGV4dCkge1xuICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoL1wiW15cIl0rXCIvZywgXCI8d29yZD5cIik7XG4gICAgcmV0dXJuIHRleHQ7XG59XG5leHBvcnRzLmNvbXBhY3RRdW90ZWQgPSBjb21wYWN0UXVvdGVkO1xuZnVuY3Rpb24gY291bnRDb21wYWN0V29yZHModGV4dCkge1xuICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLywvZywgJyAnKTtcbiAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8gXFxzKy9nLCAnICcpO1xuICAgIHJldHVybiB0ZXh0LnNwbGl0KFwiIFwiKS5sZW5ndGg7XG59XG5leHBvcnRzLmNvdW50Q29tcGFjdFdvcmRzID0gY291bnRDb21wYWN0V29yZHM7XG5mdW5jdGlvbiBjaGVja0Zvckxlbmd0aCh0ZXh0KSB7XG4gICAgdmFyIHRleHRTdHJpcHBlZCA9IHRyaW1UcmFpbGluZ1NlbnRlbmNlRGVsaW1pdGVycyh0ZXh0KTtcbiAgICBpZiAoKHRleHRTdHJpcHBlZC5sZW5ndGggPiAyMDApIHx8IChjb3VudENvbXBhY3RXb3Jkcyhjb21wYWN0UXVvdGVkKHRleHQpKSA+IDIwKSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaW50ZW50OiBcIlRvb0xvbmdcIixcbiAgICAgICAgICAgIHNjb3JlOiAxLjAsXG4gICAgICAgICAgICBlbnRpdGllczogW11cbiAgICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cbmV4cG9ydHMuY2hlY2tGb3JMZW5ndGggPSBjaGVja0Zvckxlbmd0aDtcbmZ1bmN0aW9uIHJlY29nbml6ZVRleHQodGV4dCwgYVJ1bGVzKSB7XG4gICAgdmFyIHJlcyA9IHVuZGVmaW5lZDtcbiAgICBhUnVsZXMuZXZlcnkoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgICAgIHJlcyA9IG1hdGNoUmVndWxhckV4cHJlc3Npb24odGV4dCwgb1J1bGUpO1xuICAgICAgICByZXR1cm4gIXJlcztcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5yZWNvZ25pemVUZXh0ID0gcmVjb2duaXplVGV4dDtcbnZhciBSZWdFeHBSZWNvZ25pemVyID0gKGZ1bmN0aW9uICgpIHtcbiAgICBmdW5jdGlvbiBSZWdFeHBSZWNvZ25pemVyKHhSdWxlcykge1xuICAgICAgICB0aGlzLm9SdWxlcyA9IHhSdWxlcztcbiAgICAgICAgZGVidWdsb2coXCJydWxlcyBcIiArIEpTT04uc3RyaW5naWZ5KHRoaXMub1J1bGVzKSk7XG4gICAgfVxuICAgIDtcbiAgICBSZWdFeHBSZWNvZ25pemVyLnByb3RvdHlwZS5yZWNvZ25pemUgPSBmdW5jdGlvbiAoY29udGV4dCwgY2FsbGJhY2spIHtcbiAgICAgICAgdmFyIHUgPSB7fTtcbiAgICAgICAgdmFyIHRleHQgPSBjb250ZXh0Lm1lc3NhZ2UudGV4dDtcbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICB2YXIgciA9IGNoZWNrRm9yTGVuZ3RoKHRleHQpO1xuICAgICAgICBpZiAocikge1xuICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCByKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBkZWJ1Z2xvZyhcInJ1bGVzIFwiICsgSlNPTi5zdHJpbmdpZnkodGhpcy5vUnVsZXMpKTtcbiAgICAgICAgdmFyIHRleHQgPSB0cmltVHJhaWxpbmdTZW50ZW5jZURlbGltaXRlcnModGV4dCk7XG4gICAgICAgIHZhciByZXN1bHRzID0gT2JqZWN0LmtleXModGhpcy5vUnVsZXMpLm1hcChmdW5jdGlvbiAoc0tleSkge1xuICAgICAgICAgICAgdmFyIHUgPSByZWNvZ25pemVUZXh0KHRleHQsIHRoYXQub1J1bGVzW3NLZXldKTtcbiAgICAgICAgICAgIGlmICh1KSB7XG4gICAgICAgICAgICAgICAgdS5pbnRlbnQgPSBzS2V5O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHUgPyB1IDogdW5kZWZpbmVkO1xuICAgICAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKG8pIHsgcmV0dXJuICEhbzsgfSk7XG4gICAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIC8qIFRPRE8gYWJpZ3VvdXMgKi9cbiAgICAgICAgICAgIGRlYnVnbG9nKFwiYW1iaWd1b3VzIHJlc3VsdCBmb3IgPlwiICsgdGV4dCArIFwiPFwiICsgSlNPTi5zdHJpbmdpZnkocmVzKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdmFyIHJlcyA9IHJlc3VsdHNbMF07XG4gICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHJlcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZGVidWdsb2coJ3JlY29nbml6aW5nIG5vdGhpbmcnKTtcbiAgICAgICAgdS5pbnRlbnQgPSBcIk5vbmVcIjtcbiAgICAgICAgdS5zY29yZSA9IDAuMTtcbiAgICAgICAgdmFyIGUxID0ge307XG4gICAgICAgIGUxLnN0YXJ0SW5kZXggPSBcImV4aXQgXCIubGVuZ3RoO1xuICAgICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgZTEuc2NvcmUgPSAwLjE7XG4gICAgICAgIHUuZW50aXRpZXMgPSBbXTtcbiAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgICB9O1xuICAgIHJldHVybiBSZWdFeHBSZWNvZ25pemVyO1xufSgpKTsgLy8gY2xhc3NcbmV4cG9ydHMuUmVnRXhwUmVjb2duaXplciA9IFJlZ0V4cFJlY29nbml6ZXI7XG4iLCJcbi8qKlxuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICogQGZpbGUgcGxhaW5yZWNvZ25pemVyLnRzXG4gKlxuICogQSByZWNvZ25pemVyIHBhcmFtZXRyaXplZCBieSByZWdleCBleHByZXNzaW9uc1xuICovXG5cbmltcG9ydCAqIGFzIGJ1aWxkZXIgZnJvbSAnYm90YnVpbGRlcic7XG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlciBmcm9tICcuLi9tYXRjaC9pbnB1dEZpbHRlcic7XG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdwbGFpbnJlY29nbml6ZXInKTtcblxuY29uc3QgQW55T2JqZWN0ID0gT2JqZWN0IGFzIGFueTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJlY29nbml6ZShzU3RyaW5nLCBtUnVsZXM6IEFycmF5PElNYXRjaC5JbnRlbnRSdWxlPikge1xuICB2YXIgcmVzID0gdW5kZWZpbmVkO1xuICBtUnVsZXMuZXZlcnkoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgcmVzID0gbWF0Y2hSZWd1bGFyRXhwcmVzc2lvbihzU3RyaW5nLCBvUnVsZSk7XG4gICAgcmV0dXJuICFyZXM7XG4gIH0pXG4gIHJldHVybiByZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb3VudFBhcmVuR3JvdXBzKHM6IHN0cmluZykge1xuICB2YXIgcmVzID0gMDtcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgKytpKSB7XG4gICAgaWYgKHMuY2hhckF0KGkpID09PSAnKCcpIHtcbiAgICAgICsrcmVzO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzO1xufVxuXG4vKipcbiAqIGdpdmVuIGEgc3RyaW5nLCBlLmcuXG4gKiBcIndobyBpcyB0aGUgPGNhdGVnb3J5PiBvZiA8QTE+XCIsXG4gKiBAcGFyYW0ge3N0cmluZ30gYVxuICogQHJldHVybnMge0lNYXRjaC5JUnVsZX0gYSByZWdleHAgcnVsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VSdWxlU3RyaW5nKGE6IHN0cmluZyk6IElNYXRjaC5JbnRlbnRSdWxlIHtcbiAgdmFyIHMgPSBcIl5cIiArIGEgKyBcIiRcIjtcbiAgdmFyIGFyZ01hcHMgPSB7fTtcbiAgdmFyIG0gPSB1bmRlZmluZWQ7XG4gIHdoaWxlIChtID0gLzwoW14+XSspPihbP10/KS8uZXhlYyhzKSkge1xuICAgIHZhciBjYXQgPSBtWzFdO1xuICAgIHZhciBncmVlZHkgPSBtWzJdO1xuICAgIHZhciBwb3MgPSAxICsgY291bnRQYXJlbkdyb3VwcyhzLnN1YnN0cmluZygwLCBtLmluZGV4KSk7XG4gICAgaWYoZ3JlZWR5KSB7XG4gICAgICBzID0gcy5yZXBsYWNlKFwiPFwiICsgY2F0ICsgXCI+P1wiLCBcIiguKj8pXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHMgPSBzLnJlcGxhY2UoXCI8XCIgKyBjYXQgKyBcIj5cIiwgXCIoLiopXCIpO1xuICAgICAgfVxuICAgIGlmIChhcmdNYXBzW2NhdF0pIHtcbiAgICAgIHRocm93IEVycm9yKFwiTW9kZWwgZXJyb3IgZHVwbGljYXRlIGVudHJ5IVwiKVxuICAgIH1cbiAgICBhcmdNYXBzW2NhdF0gPSBwb3M7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAxLFxuICAgIHJlZ2V4cDogbmV3IFJlZ0V4cChzLCBcImlcIiksXG4gICAgYXJnc01hcDogYXJnTWFwc1xuICB9O1xufVxuXG5cbi8qKlxuICogZ2l2ZW4gYSBzdHJpbmcsIGUuZy5cbiAqIFwid2hvIGlzIHRoZSA8Y2F0ZWdvcnk+IG9mIDxBMT5cIixcbiAqIEBwYXJhbSB7c3RyaW5nfSBhXG4gKiBAcmV0dXJucyB7SU1hdGNoLklSdWxlfSBhIHJlZ2V4cCBydWxlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVJ1bGVBcnJheShhOiBBcnJheTxhbnk+KTogSU1hdGNoLkludGVudFJ1bGUge1xuICB2YXIgcyA9IFwiXlwiICsgYSArIFwiJFwiO1xuICB2YXIgciA9IGFbMF07XG4gIGlmKHR5cGVvZiBhWzBdID09PSBcInN0cmluZ1wiKSB7XG4gICAgciA9IG5ldyBSZWdFeHAoYVswXSxcImlcIik7XG4gIH1cbiAgaWYgKCEociBpbnN0YW5jZW9mIFJlZ0V4cCkpIHtcbiAgICB0aHJvdyBFcnJvcihcImlsbGVnYWwgc3RhdGVcIiArIEpTT04uc3RyaW5naWZ5KGEpKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIHR5cGU6IDEsXG4gICAgcmVnZXhwOiByLFxuICAgIGFyZ3NNYXA6IGFbMV1cbiAgfTtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VSdWxlKGE6IGFueSk6IElNYXRjaC5JbnRlbnRSdWxlIHtcbiAgaWYgKHR5cGVvZiBhID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBwYXJzZVJ1bGVTdHJpbmcoYSk7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShhKSkge1xuICAgIHJldHVybiBwYXJzZVJ1bGVBcnJheShhKTtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoXCJ1bmtub3duIHJ1bGUgZGVmaW5pdGlvblwiKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlUnVsZXMob0pTT046IHsgW2tleTogc3RyaW5nXTogYW55IH0pOiB7IFtrZXk6IHN0cmluZ106IEFycmF5PElNYXRjaC5JbnRlbnRSdWxlPiB9IHtcbiAgdmFyIHJlcyA9IHt9O1xuICBPYmplY3Qua2V5cyhvSlNPTikuZm9yRWFjaChmdW5jdGlvbiAoc0tleSkge1xuICAgIHJlc1tzS2V5XSA9IG9KU09OW3NLZXldLm1hcChmdW5jdGlvbiAob1J1bGUpIHtcbiAgICAgIHJldHVybiBwYXJzZVJ1bGUob1J1bGUpO1xuICAgIH0pXG4gIH0pO1xuICByZXR1cm4gcmVzO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHRyaW1WYWx1ZUFkanVzdGluZyh2YWx1ZSA6IHN0cmluZykgOiB7IGRlbHRhU3RhcnQgOm51bWJlciwgdmFsdWUgOiBzdHJpbmd9IHtcbiAgdmFyIHJlcyA9IHsgZGVsdGFTdGFydCA6IDAsIHZhbHVlIDogdmFsdWUgfTtcbiAgdmFyIG0gPSB2YWx1ZS5tYXRjaCgvXlxccysvKTtcbiAgaWYobSkge1xuICAgIHJlcy5kZWx0YVN0YXJ0ID0gbVswXS5sZW5ndGg7XG4gICAgdmFsdWUgPSB2YWx1ZS5zdWJzdHIocmVzLmRlbHRhU3RhcnQpO1xuICB9XG4gIG0gPSB2YWx1ZS5tYXRjaCgvXFxzKyQvKTtcbiAgaWYobSkge1xuICAgIHZhbHVlID0gdmFsdWUuc3Vic3RyKDAsIHZhbHVlLmxlbmd0aCAtIG1bMF0ubGVuZ3RoKTtcbiAgfVxuICByZXMudmFsdWUgPSB2YWx1ZTtcbiAgcmV0dXJuIHJlcztcblxufVxuXG5leHBvcnQgZnVuY3Rpb24gZXh0cmFjdEFyZ3NNYXAocyA6IHN0cmluZywgbWF0Y2g6IEFycmF5PHN0cmluZz4sIGFyZ3NNYXA6IHsgW2tleTogc3RyaW5nXTogbnVtYmVyIH0pOiBBcnJheTxidWlsZGVyLklFbnRpdHk+IHtcbiAgaWYgKCFhcmdzTWFwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIHZhciByZXN1bHQgPSBbXTtcbiAgT2JqZWN0LmtleXMoYXJnc01hcCkuZm9yRWFjaChmdW5jdGlvbiAoc0tleSkge1xuICAgIHZhciByZXMgPSB7fSBhcyBidWlsZGVyLklFbnRpdHk7XG4gICAgdmFyIGluZGV4ID0gYXJnc01hcFtzS2V5XTtcbiAgICB2YXIgdmFsdWUgPSBtYXRjaFtpbmRleF1cbiAgICBpZiAoKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikgJiYgdmFsdWUubGVuZ3RoID4gMCkge1xuICAgICAgcmVzLnR5cGUgPSBzS2V5O1xuICAgICAgcmVzLmVudGl0eSA9IHZhbHVlO1xuICAgICAgcmVzLnN0YXJ0SW5kZXggPSBzLmluZGV4T2YodmFsdWUpOyAvLyB0aGlzIG1heSBub3QgYmUgcHJlY2lzZVxuICAgICAgdmFyIHRyaW1BZGp1c3QgPSB0cmltVmFsdWVBZGp1c3RpbmcodmFsdWUpO1xuICAgICAgcmVzLnN0YXJ0SW5kZXggKz0gdHJpbUFkanVzdC5kZWx0YVN0YXJ0O1xuICAgICAgcmVzLmVudGl0eSA9IHRyaW1BZGp1c3QudmFsdWU7XG4gICAgICByZXMuZW5kSW5kZXggPSByZXMuc3RhcnRJbmRleCArIHRyaW1BZGp1c3QudmFsdWUubGVuZ3RoO1xuICAgICAgLy9yZXNbc0tleV0gPSB2YWx1ZVxuICAgICAgcmVzdWx0LnB1c2gocmVzKTtcbiAgICB9XG4gIH1cbiAgKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoUmVndWxhckV4cHJlc3Npb24odGV4dCA6IHN0cmluZywgb1J1bGUgOiBJTWF0Y2guSW50ZW50UnVsZSkgOiBidWlsZGVyLklJbnRlbnRSZWNvZ25pemVyUmVzdWx0IHtcbiAgZGVidWdsb2coXCJyZWdleHAgaXMgXCIgKyBvUnVsZS5yZWdleHAudG9TdHJpbmcoKSk7XG4gIGRlYnVnbG9nKFwiIHRleHQgaXMgXCIgKyB0ZXh0KTtcbiAgdmFyIG0gPSBvUnVsZS5yZWdleHAuZXhlYyh0ZXh0KTtcbiAgaWYgKCFtKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICB2YXIgcmVzID0ge30gYXMgYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdDtcbiAgcmVzLmVudGl0aWVzID0gZXh0cmFjdEFyZ3NNYXAodGV4dCwgbSwgb1J1bGUuYXJnc01hcCk7XG4gIHJlcy5zY29yZSA9IDAuOTtcbiAgZGVidWdsb2coXCJtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KG0pKTtcbiAgZGVidWdsb2coJ0ZvdW5kIG9uZScgKyBKU09OLnN0cmluZ2lmeShyZXMsIHVuZGVmaW5lZCwgMikpO1xuICByZXR1cm4gcmVzO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiB0cmltVHJhaWxpbmdTZW50ZW5jZURlbGltaXRlcnModGV4dCA6IHN0cmluZykgOiBzdHJpbmcge1xuICB2YXIgbSA9IC8oWyEuOywgP118XFxzKSskLy5leGVjKHRleHQpO1xuICBpZiAobSkge1xuICAgIHRleHQgPSB0ZXh0LnN1YnN0cigwLHRleHQubGVuZ3RoLSBtWzBdLmxlbmd0aCk7XG4gIH1cbiAgcmV0dXJuIHRleHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVXaGl0ZXNwYWNlKHRleHQgOiBzdHJpbmcpIDogc3RyaW5nIHtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvXFxzKy9nLCcgJyk7XG4gIHJldHVybiB0ZXh0O1xufVxuXG4vKipcbiAqIEdpdmVuYSBzdHJpbmcsIHJlcGxhY2UgYWxsIFwiLi4uLi5cIiAgd2l0aCA8d29yZD5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNvbXBhY3RRdW90ZWQodGV4dDogc3RyaW5nKSA6IHN0cmluZyB7XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoL1wiW15cIl0rXCIvZywgXCI8d29yZD5cIik7XG4gIHJldHVybiB0ZXh0O1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBjb3VudENvbXBhY3RXb3Jkcyh0ZXh0OiBzdHJpbmcpIDogbnVtYmVyIHtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvLC9nLCAnICcpO1xuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8gXFxzKy9nLCAnICcpO1xuICByZXR1cm4gdGV4dC5zcGxpdChcIiBcIikubGVuZ3RoO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2hlY2tGb3JMZW5ndGgodGV4dCkgOiBidWlsZGVyLklJbnRlbnRSZWNvZ25pemVyUmVzdWx0IHtcbiAgICB2YXIgdGV4dFN0cmlwcGVkID0gdHJpbVRyYWlsaW5nU2VudGVuY2VEZWxpbWl0ZXJzKHRleHQpO1xuICAgIGlmKCh0ZXh0U3RyaXBwZWQubGVuZ3RoID4gMjAwKSB8fCAoY291bnRDb21wYWN0V29yZHMoY29tcGFjdFF1b3RlZCh0ZXh0KSkgPiAyMCkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGludGVudDogXCJUb29Mb25nXCIsXG4gICAgICAgIHNjb3JlIDogMS4wLFxuICAgICAgICBlbnRpdGllcyA6IFtdXG4gICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVjb2duaXplVGV4dCh0ZXh0IDogc3RyaW5nLCBhUnVsZXMgOiBBcnJheTxJTWF0Y2guSW50ZW50UnVsZT4pIDogYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdHtcbiAgICB2YXIgcmVzID0gdW5kZWZpbmVkO1xuICAgIGFSdWxlcy5ldmVyeShmdW5jdGlvbiAob1J1bGUpIHtcbiAgICAgICAgcmVzID0gbWF0Y2hSZWd1bGFyRXhwcmVzc2lvbih0ZXh0LCBvUnVsZSk7XG4gICAgICAgIHJldHVybiAhcmVzO1xuICAgIH0pO1xuICAgIHJldHVybiByZXM7XG59XG5cbmV4cG9ydCBjbGFzcyBSZWdFeHBSZWNvZ25pemVyIGltcGxlbWVudHMgYnVpbGRlci5JSW50ZW50UmVjb2duaXplciB7XG4gIG9SdWxlczogeyBba2V5OiBzdHJpbmddOiBBcnJheTxJTWF0Y2guSW50ZW50UnVsZT4gfTtcblxuICBjb25zdHJ1Y3Rvcih4UnVsZXM6IHsgW2tleTogc3RyaW5nXTogQXJyYXk8SU1hdGNoLkludGVudFJ1bGU+IH0pIHtcbiAgICB0aGlzLm9SdWxlcyA9IHhSdWxlcztcbiAgICBkZWJ1Z2xvZyhcInJ1bGVzIFwiICsgSlNPTi5zdHJpbmdpZnkodGhpcy5vUnVsZXMpKTtcbiAgfTtcblxuICByZWNvZ25pemUoY29udGV4dDogYnVpbGRlci5JUmVjb2duaXplQ29udGV4dCwgY2FsbGJhY2s6IChlcnI6IEVycm9yLCByZXN1bHQ6IGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHQpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB2YXIgdSA9IHt9IGFzIGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHQ7XG4gICAgdmFyIHRleHQgPSBjb250ZXh0Lm1lc3NhZ2UudGV4dDtcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgdmFyIHIgPSBjaGVja0Zvckxlbmd0aCh0ZXh0KTtcbiAgICBpZihyKSB7XG4gICAgICBjYWxsYmFjayh1bmRlZmluZWQscik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGRlYnVnbG9nKFwicnVsZXMgXCIgKyBKU09OLnN0cmluZ2lmeSh0aGlzLm9SdWxlcykpO1xuXG4gICAgdmFyIHRleHQgPSB0cmltVHJhaWxpbmdTZW50ZW5jZURlbGltaXRlcnModGV4dCk7XG5cbiAgICB2YXIgcmVzdWx0cyA9IE9iamVjdC5rZXlzKHRoaXMub1J1bGVzKS5tYXAoZnVuY3Rpb24gKHNLZXkpIHtcbiAgICAgIHZhciB1ID0gcmVjb2duaXplVGV4dCh0ZXh0LCB0aGF0Lm9SdWxlc1tzS2V5XSk7XG4gICAgICBpZiAodSkge1xuICAgICAgICB1LmludGVudCA9IHNLZXk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdSA/ICB1IDogdW5kZWZpbmVkO1xuICAgIH0pLmZpbHRlcihmdW5jdGlvbiAobykgeyByZXR1cm4gISFvOyB9KTtcbiAgICBpZiAocmVzdWx0cy5sZW5ndGggPiAxKSB7XG4gICAgICAvKiBUT0RPIGFiaWd1b3VzICovXG4gICAgICBkZWJ1Z2xvZyhcImFtYmlndW91cyByZXN1bHQgZm9yID5cIiArIHRleHQgKyBcIjxcIiArIEpTT04uc3RyaW5naWZ5KHJlcykpO1xuICAgIH1cbiAgICBpZiAocmVzdWx0cy5sZW5ndGggPiAwKSB7XG4gICAgICB2YXIgcmVzID0gcmVzdWx0c1swXTtcbiAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgcmVzKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZGVidWdsb2coJ3JlY29nbml6aW5nIG5vdGhpbmcnKTtcbiAgICB1LmludGVudCA9IFwiTm9uZVwiO1xuICAgIHUuc2NvcmUgPSAwLjE7XG4gICAgdmFyIGUxID0ge30gYXMgYnVpbGRlci5JRW50aXR5O1xuICAgIGUxLnN0YXJ0SW5kZXggPSBcImV4aXQgXCIubGVuZ3RoO1xuICAgIGUxLmVuZEluZGV4ID0gY29udGV4dC5tZXNzYWdlLnRleHQubGVuZ3RoO1xuICAgIGUxLnNjb3JlID0gMC4xO1xuICAgIHUuZW50aXRpZXMgPSBbXTtcbiAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICB9XG59IC8vIGNsYXNzXG5cblxuXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
