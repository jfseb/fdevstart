/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var abot_erbase_1 = require("abot_erbase");
var debug = require("debug");
var debuglog = debug('analyze');
var logger = require("../utils/logger");
var perf = logger.perf('analyze');
var Toolmatcher = require("./toolmatcher");
function analyzeAll(sString, rules, aTools, words) {
    "use strict";

    if (sString.length === 0) {
        return [];
    } else {
        perf('analyzeString');
        //   InputFilter.resetCnt();
        var matched = abot_erbase_1.InputFilter.analyzeString(sString, rules, words);
        perf('analyzeString');
        //   InputFilter.dumpCnt();
        perf('expand');
        debuglog("After matched " + JSON.stringify(matched));
        var aSentences = abot_erbase_1.InputFilter.expandMatchArr(matched);
        aSentences.sort(abot_erbase_1.Sentence.cmpRankingProduct);
        debuglog("after expand" + aSentences.map(function (oSentence) {
            return abot_erbase_1.Sentence.rankingProduct(oSentence) + ":" + abot_erbase_1.Sentence.dumpNice(oSentence);
        }).join("\n"));
        if (debuglog.enabled) {
            debuglog(" after expand:" + abot_erbase_1.Sentence.dumpNiceArr(aSentencesReinforced, abot_erbase_1.Sentence.rankingProduct));
        }
        perf('expand');
        var aSentencesReinforced = abot_erbase_1.InputFilter.reinForce(aSentences);
        //aSentences.map(function(oSentence) { return InputFilter.reinForce(oSentence); });
        aSentencesReinforced.sort(abot_erbase_1.Sentence.cmpRankingProduct);
        debuglog("after reinforce \n" + aSentencesReinforced.map(function (oSentence) {
            return abot_erbase_1.Sentence.rankingProduct(oSentence) + ":" + abot_erbase_1.Sentence.dumpNice(oSentence);
        }).join("\n"));
        if (debuglog.enabled) {
            debuglog(" after reinforce:" + abot_erbase_1.Sentence.dumpNiceArr(aSentencesReinforced, abot_erbase_1.Sentence.rankingProduct));
        }
        aSentencesReinforced = abot_erbase_1.Sentence.cutoffSentenceAtRatio(aSentencesReinforced);
        perf('matchTools');
        var matchedTools = Toolmatcher.matchTools(aSentencesReinforced, aTools); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        perf('matchTools');
        debuglog(" matchedTools" + JSON.stringify(matchedTools, undefined, 2));
        return matchedTools;
    }
}
exports.analyzeAll = analyzeAll;
/**
 * TODO: rework this to work correctly with sets
 */
function isComplete(match) {
    // TODO -> analyze sets
    return match && match.rank > 0.6 && Object.keys(match.toolmatchresult.missing || {}).length === 0;
}
exports.isComplete = isComplete;
function getPrompt(match) {
    if (!match) {
        return;
    }
    if (match.rank < 0.6) {
        return undefined;
    }
    if (Object.keys(match.toolmatchresult.missing).length) {
        var missing = Object.keys(match.toolmatchresult.missing)[0];
        return {
            category: missing,
            text: 'Please provide a missing "' + missing + '"?'
        };
    }
    return undefined;
}
exports.getPrompt = getPrompt;
function setPrompt(match, prompt, response) {
    if (!match) {
        return;
    }
    if (response.toLowerCase() !== 'cancel' && response.toLowerCase() !== 'abort') {
        var u = {};
        u.category = prompt.category;
        u._ranking = 1.0;
        u.matchedString = response;
        /// TODO test whether this can be valid at all?
        match.toolmatchresult.required[prompt.category] = u;
        delete match.toolmatchresult.missing[prompt.category];
    }
}
exports.setPrompt = setPrompt;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9hbmFseXplLnRzIiwibWF0Y2gvYW5hbHl6ZS5qcyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImFib3RfZXJiYXNlXzEiLCJyZXF1aXJlIiwiZGVidWciLCJkZWJ1Z2xvZyIsImxvZ2dlciIsInBlcmYiLCJUb29sbWF0Y2hlciIsImFuYWx5emVBbGwiLCJzU3RyaW5nIiwicnVsZXMiLCJhVG9vbHMiLCJ3b3JkcyIsImxlbmd0aCIsIm1hdGNoZWQiLCJJbnB1dEZpbHRlciIsImFuYWx5emVTdHJpbmciLCJKU09OIiwic3RyaW5naWZ5IiwiYVNlbnRlbmNlcyIsImV4cGFuZE1hdGNoQXJyIiwic29ydCIsIlNlbnRlbmNlIiwiY21wUmFua2luZ1Byb2R1Y3QiLCJtYXAiLCJvU2VudGVuY2UiLCJyYW5raW5nUHJvZHVjdCIsImR1bXBOaWNlIiwiam9pbiIsImVuYWJsZWQiLCJkdW1wTmljZUFyciIsImFTZW50ZW5jZXNSZWluZm9yY2VkIiwicmVpbkZvcmNlIiwiY3V0b2ZmU2VudGVuY2VBdFJhdGlvIiwibWF0Y2hlZFRvb2xzIiwibWF0Y2hUb29scyIsInVuZGVmaW5lZCIsImlzQ29tcGxldGUiLCJtYXRjaCIsInJhbmsiLCJrZXlzIiwidG9vbG1hdGNocmVzdWx0IiwibWlzc2luZyIsImdldFByb21wdCIsImNhdGVnb3J5IiwidGV4dCIsInNldFByb21wdCIsInByb21wdCIsInJlc3BvbnNlIiwidG9Mb3dlckNhc2UiLCJ1IiwiX3JhbmtpbmciLCJtYXRjaGVkU3RyaW5nIiwicmVxdWlyZWQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFPQTs7QUNBQUEsT0FBT0MsY0FBUCxDQUFzQkMsT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkMsRUFBRUMsT0FBTyxJQUFULEVBQTdDO0FERUEsSUFBQUMsZ0JBQUFDLFFBQUEsYUFBQSxDQUFBO0FBRUEsSUFBQUMsUUFBQUQsUUFBQSxPQUFBLENBQUE7QUFFQSxJQUFNRSxXQUFXRCxNQUFNLFNBQU4sQ0FBakI7QUFJQSxJQUFBRSxTQUFBSCxRQUFBLGlCQUFBLENBQUE7QUFDQSxJQUFJSSxPQUFPRCxPQUFPQyxJQUFQLENBQVksU0FBWixDQUFYO0FBT0EsSUFBQUMsY0FBQUwsUUFBQSxlQUFBLENBQUE7QUFHQSxTQUFBTSxVQUFBLENBQTJCQyxPQUEzQixFQUE0Q0MsS0FBNUMsRUFBc0VDLE1BQXRFLEVBQW1HQyxLQUFuRyxFQUF5RztBQUN2Rzs7QUFDQSxRQUFJSCxRQUFRSSxNQUFSLEtBQW1CLENBQXZCLEVBQTBCO0FBQ3hCLGVBQU8sRUFBUDtBQUNELEtBRkQsTUFFTztBQUNMUCxhQUFLLGVBQUw7QUFDSDtBQUNHLFlBQUlRLFVBQVViLGNBQUFjLFdBQUEsQ0FBWUMsYUFBWixDQUEwQlAsT0FBMUIsRUFBbUNDLEtBQW5DLEVBQTBDRSxLQUExQyxDQUFkO0FBQ0FOLGFBQUssZUFBTDtBQUNIO0FBQ0dBLGFBQUssUUFBTDtBQUNBRixpQkFBUyxtQkFBbUJhLEtBQUtDLFNBQUwsQ0FBZUosT0FBZixDQUE1QjtBQUNBLFlBQUlLLGFBQWFsQixjQUFBYyxXQUFBLENBQVlLLGNBQVosQ0FBMkJOLE9BQTNCLENBQWpCO0FBRUFLLG1CQUFXRSxJQUFYLENBQWdCcEIsY0FBQXFCLFFBQUEsQ0FBU0MsaUJBQXpCO0FBQ0FuQixpQkFBUyxpQkFBaUJlLFdBQVdLLEdBQVgsQ0FBZSxVQUFVQyxTQUFWLEVBQW1CO0FBQzFELG1CQUFPeEIsY0FBQXFCLFFBQUEsQ0FBU0ksY0FBVCxDQUF3QkQsU0FBeEIsSUFBcUMsR0FBckMsR0FBMkN4QixjQUFBcUIsUUFBQSxDQUFTSyxRQUFULENBQWtCRixTQUFsQixDQUFsRDtBQUNELFNBRnlCLEVBRXZCRyxJQUZ1QixDQUVsQixJQUZrQixDQUExQjtBQUdBLFlBQUl4QixTQUFTeUIsT0FBYixFQUFzQjtBQUNwQnpCLHFCQUFTLG1CQUFtQkgsY0FBQXFCLFFBQUEsQ0FBU1EsV0FBVCxDQUFxQkMsb0JBQXJCLEVBQTJDOUIsY0FBQXFCLFFBQUEsQ0FBU0ksY0FBcEQsQ0FBNUI7QUFDRDtBQUNEcEIsYUFBSyxRQUFMO0FBQ0EsWUFBSXlCLHVCQUF1QjlCLGNBQUFjLFdBQUEsQ0FBWWlCLFNBQVosQ0FBc0JiLFVBQXRCLENBQTNCO0FBQ0E7QUFDQVksNkJBQXFCVixJQUFyQixDQUEwQnBCLGNBQUFxQixRQUFBLENBQVNDLGlCQUFuQztBQUNBbkIsaUJBQVMsdUJBQXVCMkIscUJBQXFCUCxHQUFyQixDQUF5QixVQUFVQyxTQUFWLEVBQW1CO0FBQzFFLG1CQUFPeEIsY0FBQXFCLFFBQUEsQ0FBU0ksY0FBVCxDQUF3QkQsU0FBeEIsSUFBcUMsR0FBckMsR0FBMkN4QixjQUFBcUIsUUFBQSxDQUFTSyxRQUFULENBQWtCRixTQUFsQixDQUFsRDtBQUNELFNBRitCLEVBRTdCRyxJQUY2QixDQUV4QixJQUZ3QixDQUFoQztBQUdBLFlBQUl4QixTQUFTeUIsT0FBYixFQUFzQjtBQUNwQnpCLHFCQUFTLHNCQUFzQkgsY0FBQXFCLFFBQUEsQ0FBU1EsV0FBVCxDQUFxQkMsb0JBQXJCLEVBQTJDOUIsY0FBQXFCLFFBQUEsQ0FBU0ksY0FBcEQsQ0FBL0I7QUFDRDtBQUNESywrQkFBdUI5QixjQUFBcUIsUUFBQSxDQUFTVyxxQkFBVCxDQUErQkYsb0JBQS9CLENBQXZCO0FBQ0F6QixhQUFLLFlBQUw7QUFDQSxZQUFJNEIsZUFBZTNCLFlBQVk0QixVQUFaLENBQXVCSixvQkFBdkIsRUFBNkNwQixNQUE3QyxDQUFuQixDQTdCSyxDQTZCb0U7QUFDekVMLGFBQUssWUFBTDtBQUNBRixpQkFBUyxrQkFBa0JhLEtBQUtDLFNBQUwsQ0FBZWdCLFlBQWYsRUFBNkJFLFNBQTdCLEVBQXdDLENBQXhDLENBQTNCO0FBQ0EsZUFBT0YsWUFBUDtBQUNEO0FBQ0Y7QUF0Q0RuQyxRQUFBUyxVQUFBLEdBQUFBLFVBQUE7QUF3Q0E7OztBQUlBLFNBQUE2QixVQUFBLENBQTJCQyxLQUEzQixFQUFxRDtBQUNuRDtBQUNBLFdBQU9BLFNBQVNBLE1BQU1DLElBQU4sR0FBYSxHQUF0QixJQUNMMUMsT0FBTzJDLElBQVAsQ0FBWUYsTUFBTUcsZUFBTixDQUFzQkMsT0FBdEIsSUFBZ0MsRUFBNUMsRUFBZ0Q3QixNQUFoRCxLQUEyRCxDQUQ3RDtBQUVEO0FBSkRkLFFBQUFzQyxVQUFBLEdBQUFBLFVBQUE7QUFNQSxTQUFBTSxTQUFBLENBQTBCTCxLQUExQixFQUFvRDtBQUNsRCxRQUFHLENBQUNBLEtBQUosRUFBVztBQUNQO0FBQ0g7QUFDRCxRQUFJQSxNQUFNQyxJQUFOLEdBQWEsR0FBakIsRUFBdUI7QUFDckIsZUFBT0gsU0FBUDtBQUNEO0FBQ0QsUUFBR3ZDLE9BQU8yQyxJQUFQLENBQVlGLE1BQU1HLGVBQU4sQ0FBc0JDLE9BQWxDLEVBQTJDN0IsTUFBOUMsRUFBdUQ7QUFDckQsWUFBSTZCLFVBQVU3QyxPQUFPMkMsSUFBUCxDQUFZRixNQUFNRyxlQUFOLENBQXNCQyxPQUFsQyxFQUEyQyxDQUEzQyxDQUFkO0FBQ0EsZUFBTztBQUNMRSxzQkFBV0YsT0FETjtBQUVMRyxrQkFBTywrQkFBK0JILE9BQS9CLEdBQXlDO0FBRjNDLFNBQVA7QUFJRDtBQUNELFdBQU9OLFNBQVA7QUFDRDtBQWZEckMsUUFBQTRDLFNBQUEsR0FBQUEsU0FBQTtBQWtCQSxTQUFBRyxTQUFBLENBQTBCUixLQUExQixFQUFxRFMsTUFBckQsRUFDRUMsUUFERixFQUNtQjtBQUNmLFFBQUcsQ0FBQ1YsS0FBSixFQUFXO0FBQ1Q7QUFDRDtBQUNELFFBQUlVLFNBQVNDLFdBQVQsT0FBMkIsUUFBM0IsSUFBdUNELFNBQVNDLFdBQVQsT0FBMkIsT0FBdEUsRUFBK0U7QUFDN0UsWUFBSUMsSUFBSSxFQUFSO0FBQ0FBLFVBQUVOLFFBQUYsR0FBYUcsT0FBT0gsUUFBcEI7QUFDQU0sVUFBRUMsUUFBRixHQUFhLEdBQWI7QUFDQUQsVUFBRUUsYUFBRixHQUFrQkosUUFBbEI7QUFDQTtBQUNBVixjQUFNRyxlQUFOLENBQXNCWSxRQUF0QixDQUErQk4sT0FBT0gsUUFBdEMsSUFBa0RNLENBQWxEO0FBQ0EsZUFBT1osTUFBTUcsZUFBTixDQUFzQkMsT0FBdEIsQ0FBOEJLLE9BQU9ILFFBQXJDLENBQVA7QUFDRjtBQUNIO0FBZEQ3QyxRQUFBK0MsU0FBQSxHQUFBQSxTQUFBIiwiZmlsZSI6Im1hdGNoL2FuYWx5emUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5hbmFseXplXG4gKiBAZmlsZSBhbmFseXplLnRzXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblxuXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7SW5wdXRGaWx0ZXIgYXMgSW5wdXRGaWx0ZXIsIFNlbnRlbmNlIGFzIFNlbnRlbmNlfSBmcm9tICdhYm90X2VyYmFzZSc7XG5cbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygnYW5hbHl6ZScpO1xuXG5cblxuaW1wb3J0ICogYXMgbG9nZ2VyIGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG52YXIgcGVyZiA9IGxvZ2dlci5wZXJmKCdhbmFseXplJyk7XG5cblxuaW1wb3J0ICogYXMgVXRpbHMgZnJvbSAnYWJvdF91dGlscyc7XG5cbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuL2lmbWF0Y2gnO1xuXG5pbXBvcnQgKiBhcyBUb29sbWF0Y2hlciBmcm9tICcuL3Rvb2xtYXRjaGVyJztcblxuXG5leHBvcnQgZnVuY3Rpb24gYW5hbHl6ZUFsbChzU3RyaW5nOiBzdHJpbmcsIHJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcywgYVRvb2xzOiBBcnJheTxJTWF0Y2guSVRvb2w+LCB3b3Jkcz8gKSB7XG4gIFwidXNlIHN0cmljdFwiO1xuICBpZiAoc1N0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH0gZWxzZSB7XG4gICAgcGVyZignYW5hbHl6ZVN0cmluZycpO1xuIC8vICAgSW5wdXRGaWx0ZXIucmVzZXRDbnQoKTtcbiAgICB2YXIgbWF0Y2hlZCA9IElucHV0RmlsdGVyLmFuYWx5emVTdHJpbmcoc1N0cmluZywgcnVsZXMsIHdvcmRzKTtcbiAgICBwZXJmKCdhbmFseXplU3RyaW5nJyk7XG4gLy8gICBJbnB1dEZpbHRlci5kdW1wQ250KCk7XG4gICAgcGVyZignZXhwYW5kJyk7XG4gICAgZGVidWdsb2coXCJBZnRlciBtYXRjaGVkIFwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZCkpO1xuICAgIHZhciBhU2VudGVuY2VzID0gSW5wdXRGaWx0ZXIuZXhwYW5kTWF0Y2hBcnIobWF0Y2hlZCk7XG5cbiAgICBhU2VudGVuY2VzLnNvcnQoU2VudGVuY2UuY21wUmFua2luZ1Byb2R1Y3QpO1xuICAgIGRlYnVnbG9nKFwiYWZ0ZXIgZXhwYW5kXCIgKyBhU2VudGVuY2VzLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgU2VudGVuY2UuZHVtcE5pY2Uob1NlbnRlbmNlKTtcbiAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCIgYWZ0ZXIgZXhwYW5kOlwiICsgU2VudGVuY2UuZHVtcE5pY2VBcnIoYVNlbnRlbmNlc1JlaW5mb3JjZWQsIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KSk7XG4gICAgfVxuICAgIHBlcmYoJ2V4cGFuZCcpO1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IElucHV0RmlsdGVyLnJlaW5Gb3JjZShhU2VudGVuY2VzKTtcbiAgICAvL2FTZW50ZW5jZXMubWFwKGZ1bmN0aW9uKG9TZW50ZW5jZSkgeyByZXR1cm4gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKG9TZW50ZW5jZSk7IH0pO1xuICAgIGFTZW50ZW5jZXNSZWluZm9yY2VkLnNvcnQoU2VudGVuY2UuY21wUmFua2luZ1Byb2R1Y3QpO1xuICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlIFxcblwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBTZW50ZW5jZS5kdW1wTmljZShvU2VudGVuY2UpO1xuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcIiBhZnRlciByZWluZm9yY2U6XCIgKyBTZW50ZW5jZS5kdW1wTmljZUFycihhU2VudGVuY2VzUmVpbmZvcmNlZCwgU2VudGVuY2UucmFua2luZ1Byb2R1Y3QpKTtcbiAgICB9XG4gICAgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBTZW50ZW5jZS5jdXRvZmZTZW50ZW5jZUF0UmF0aW8oYVNlbnRlbmNlc1JlaW5mb3JjZWQpXG4gICAgcGVyZignbWF0Y2hUb29scycpO1xuICAgIHZhciBtYXRjaGVkVG9vbHMgPSBUb29sbWF0Y2hlci5tYXRjaFRvb2xzKGFTZW50ZW5jZXNSZWluZm9yY2VkLCBhVG9vbHMpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBwZXJmKCdtYXRjaFRvb2xzJyk7XG4gICAgZGVidWdsb2coXCIgbWF0Y2hlZFRvb2xzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkVG9vbHMsIHVuZGVmaW5lZCwgMikpO1xuICAgIHJldHVybiBtYXRjaGVkVG9vbHM7XG4gIH1cbn1cblxuLyoqXG4gKiBUT0RPOiByZXdvcmsgdGhpcyB0byB3b3JrIGNvcnJlY3RseSB3aXRoIHNldHNcbiAqL1xuXG5leHBvcnQgZnVuY3Rpb24gaXNDb21wbGV0ZShtYXRjaCA6ICBJTWF0Y2guSVRvb2xNYXRjaCkge1xuICAvLyBUT0RPIC0+IGFuYWx5emUgc2V0c1xuICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2gucmFuayA+IDAuNiAmJlxuICAgIE9iamVjdC5rZXlzKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nIHx8e30pLmxlbmd0aCA9PT0gMFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UHJvbXB0KG1hdGNoIDogIElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gIGlmKCFtYXRjaCkge1xuICAgICAgcmV0dXJuO1xuICB9XG4gIGlmIChtYXRjaC5yYW5rIDwgMC42ICkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgaWYoT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcpLmxlbmd0aCApIHtcbiAgICB2YXIgbWlzc2luZyA9IE9iamVjdC5rZXlzKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nKVswXTtcbiAgICByZXR1cm4ge1xuICAgICAgY2F0ZWdvcnkgOiBtaXNzaW5nLFxuICAgICAgdGV4dCA6ICdQbGVhc2UgcHJvdmlkZSBhIG1pc3NpbmcgXCInICsgbWlzc2luZyArICdcIj8nXG4gICAgfVxuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHNldFByb21wdChtYXRjaCA6IElNYXRjaC5JVG9vbE1hdGNoLCBwcm9tcHQ6IElNYXRjaC5JUHJvbXB0LFxuICByZXNwb25zZSA6IHN0cmluZykge1xuICAgIGlmKCFtYXRjaCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAocmVzcG9uc2UudG9Mb3dlckNhc2UoKSAhPT0gJ2NhbmNlbCcgJiYgcmVzcG9uc2UudG9Mb3dlckNhc2UoKSAhPT0gJ2Fib3J0Jykge1xuICAgICAgdmFyIHUgPSB7fSBhcyBJTWF0Y2guSVdvcmQ7XG4gICAgICB1LmNhdGVnb3J5ID0gcHJvbXB0LmNhdGVnb3J5O1xuICAgICAgdS5fcmFua2luZyA9IDEuMDtcbiAgICAgIHUubWF0Y2hlZFN0cmluZyA9IHJlc3BvbnNlO1xuICAgICAgLy8vIFRPRE8gdGVzdCB3aGV0aGVyIHRoaXMgY2FuIGJlIHZhbGlkIGF0IGFsbD9cbiAgICAgIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtwcm9tcHQuY2F0ZWdvcnldID0gdTtcbiAgICAgIGRlbGV0ZSBtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZ1twcm9tcHQuY2F0ZWdvcnldO1xuICAgfVxufVxuXG5cbiIsIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGFuYWx5emUudHNcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBhYm90X2VyYmFzZV8xID0gcmVxdWlyZShcImFib3RfZXJiYXNlXCIpO1xuY29uc3QgZGVidWcgPSByZXF1aXJlKFwiZGVidWdcIik7XG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdhbmFseXplJyk7XG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwiLi4vdXRpbHMvbG9nZ2VyXCIpO1xudmFyIHBlcmYgPSBsb2dnZXIucGVyZignYW5hbHl6ZScpO1xuY29uc3QgVG9vbG1hdGNoZXIgPSByZXF1aXJlKFwiLi90b29sbWF0Y2hlclwiKTtcbmZ1bmN0aW9uIGFuYWx5emVBbGwoc1N0cmluZywgcnVsZXMsIGFUb29scywgd29yZHMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBpZiAoc1N0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcGVyZignYW5hbHl6ZVN0cmluZycpO1xuICAgICAgICAvLyAgIElucHV0RmlsdGVyLnJlc2V0Q250KCk7XG4gICAgICAgIHZhciBtYXRjaGVkID0gYWJvdF9lcmJhc2VfMS5JbnB1dEZpbHRlci5hbmFseXplU3RyaW5nKHNTdHJpbmcsIHJ1bGVzLCB3b3Jkcyk7XG4gICAgICAgIHBlcmYoJ2FuYWx5emVTdHJpbmcnKTtcbiAgICAgICAgLy8gICBJbnB1dEZpbHRlci5kdW1wQ250KCk7XG4gICAgICAgIHBlcmYoJ2V4cGFuZCcpO1xuICAgICAgICBkZWJ1Z2xvZyhcIkFmdGVyIG1hdGNoZWQgXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkKSk7XG4gICAgICAgIHZhciBhU2VudGVuY2VzID0gYWJvdF9lcmJhc2VfMS5JbnB1dEZpbHRlci5leHBhbmRNYXRjaEFycihtYXRjaGVkKTtcbiAgICAgICAgYVNlbnRlbmNlcy5zb3J0KGFib3RfZXJiYXNlXzEuU2VudGVuY2UuY21wUmFua2luZ1Byb2R1Y3QpO1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIGFib3RfZXJiYXNlXzEuU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgYWJvdF9lcmJhc2VfMS5TZW50ZW5jZS5kdW1wTmljZShvU2VudGVuY2UpO1xuICAgICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIGFmdGVyIGV4cGFuZDpcIiArIGFib3RfZXJiYXNlXzEuU2VudGVuY2UuZHVtcE5pY2VBcnIoYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGFib3RfZXJiYXNlXzEuU2VudGVuY2UucmFua2luZ1Byb2R1Y3QpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmKCdleHBhbmQnKTtcbiAgICAgICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYWJvdF9lcmJhc2VfMS5JbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgICAgIC8vYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24ob1NlbnRlbmNlKSB7IHJldHVybiBJbnB1dEZpbHRlci5yZWluRm9yY2Uob1NlbnRlbmNlKTsgfSk7XG4gICAgICAgIGFTZW50ZW5jZXNSZWluZm9yY2VkLnNvcnQoYWJvdF9lcmJhc2VfMS5TZW50ZW5jZS5jbXBSYW5raW5nUHJvZHVjdCk7XG4gICAgICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlIFxcblwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBhYm90X2VyYmFzZV8xLlNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIGFib3RfZXJiYXNlXzEuU2VudGVuY2UuZHVtcE5pY2Uob1NlbnRlbmNlKTtcbiAgICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiBhZnRlciByZWluZm9yY2U6XCIgKyBhYm90X2VyYmFzZV8xLlNlbnRlbmNlLmR1bXBOaWNlQXJyKGFTZW50ZW5jZXNSZWluZm9yY2VkLCBhYm90X2VyYmFzZV8xLlNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KSk7XG4gICAgICAgIH1cbiAgICAgICAgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhYm90X2VyYmFzZV8xLlNlbnRlbmNlLmN1dG9mZlNlbnRlbmNlQXRSYXRpbyhhU2VudGVuY2VzUmVpbmZvcmNlZCk7XG4gICAgICAgIHBlcmYoJ21hdGNoVG9vbHMnKTtcbiAgICAgICAgdmFyIG1hdGNoZWRUb29scyA9IFRvb2xtYXRjaGVyLm1hdGNoVG9vbHMoYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGFUb29scyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgICAgICBwZXJmKCdtYXRjaFRvb2xzJyk7XG4gICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWRUb29sc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZFRvb2xzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgcmV0dXJuIG1hdGNoZWRUb29scztcbiAgICB9XG59XG5leHBvcnRzLmFuYWx5emVBbGwgPSBhbmFseXplQWxsO1xuLyoqXG4gKiBUT0RPOiByZXdvcmsgdGhpcyB0byB3b3JrIGNvcnJlY3RseSB3aXRoIHNldHNcbiAqL1xuZnVuY3Rpb24gaXNDb21wbGV0ZShtYXRjaCkge1xuICAgIC8vIFRPRE8gLT4gYW5hbHl6ZSBzZXRzXG4gICAgcmV0dXJuIG1hdGNoICYmIG1hdGNoLnJhbmsgPiAwLjYgJiZcbiAgICAgICAgT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcgfHwge30pLmxlbmd0aCA9PT0gMDtcbn1cbmV4cG9ydHMuaXNDb21wbGV0ZSA9IGlzQ29tcGxldGU7XG5mdW5jdGlvbiBnZXRQcm9tcHQobWF0Y2gpIHtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKG1hdGNoLnJhbmsgPCAwLjYpIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgaWYgKE9iamVjdC5rZXlzKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nKS5sZW5ndGgpIHtcbiAgICAgICAgdmFyIG1pc3NpbmcgPSBPYmplY3Qua2V5cyhtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZylbMF07XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjYXRlZ29yeTogbWlzc2luZyxcbiAgICAgICAgICAgIHRleHQ6ICdQbGVhc2UgcHJvdmlkZSBhIG1pc3NpbmcgXCInICsgbWlzc2luZyArICdcIj8nXG4gICAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG59XG5leHBvcnRzLmdldFByb21wdCA9IGdldFByb21wdDtcbmZ1bmN0aW9uIHNldFByb21wdChtYXRjaCwgcHJvbXB0LCByZXNwb25zZSkge1xuICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAocmVzcG9uc2UudG9Mb3dlckNhc2UoKSAhPT0gJ2NhbmNlbCcgJiYgcmVzcG9uc2UudG9Mb3dlckNhc2UoKSAhPT0gJ2Fib3J0Jykge1xuICAgICAgICB2YXIgdSA9IHt9O1xuICAgICAgICB1LmNhdGVnb3J5ID0gcHJvbXB0LmNhdGVnb3J5O1xuICAgICAgICB1Ll9yYW5raW5nID0gMS4wO1xuICAgICAgICB1Lm1hdGNoZWRTdHJpbmcgPSByZXNwb25zZTtcbiAgICAgICAgLy8vIFRPRE8gdGVzdCB3aGV0aGVyIHRoaXMgY2FuIGJlIHZhbGlkIGF0IGFsbD9cbiAgICAgICAgbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3Byb21wdC5jYXRlZ29yeV0gPSB1O1xuICAgICAgICBkZWxldGUgbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmdbcHJvbXB0LmNhdGVnb3J5XTtcbiAgICB9XG59XG5leHBvcnRzLnNldFByb21wdCA9IHNldFByb21wdDtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
