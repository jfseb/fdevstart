/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var debug = require("debug");
var debuglog = debug('listall');
var logger = require("../utils/logger");
var logPerf = logger.perf("perflistall");
var perflog = debug('perf');
//const perflog = logger.perf("perflistall");
var Utils = require("abot_utils");
var fdevsta_monmove_1 = require("fdevsta_monmove");
var Operator = require("./operator");
var WhatIs = require("./whatis");
var abot_erbase_1 = require("abot_erbase");
var fdevsta_monmove_2 = require("fdevsta_monmove");
var sWords = {};
function matchRecordHavingCategory(category, records) {
    debuglog(debuglog.enabled ? JSON.stringify(records, undefined, 2) : "-");
    var relevantRecords = records.filter(function (record) {
        return record[category] !== undefined && record[category] !== null;
    });
    var res = [];
    debuglog("relevant records nr:" + relevantRecords.length);
    return relevantRecords;
}
exports.matchRecordHavingCategory = matchRecordHavingCategory;
function analyzeContextString(contextQueryString, rules) {
    return WhatIs.analyzeContextString(contextQueryString, rules);
}
exports.analyzeContextString = analyzeContextString;
// const result = WhatIs.resolveCategory(cat, a1.entity,
//   theModel.mRules, theModel.tools, theModel.records);
function listAllWithContext(category, contextQueryString, aRules, records, domainCategoryFilter) {
    var res = listAllTupelWithContext([category], contextQueryString, aRules, records, domainCategoryFilter);
    var answers = res.tupelanswers.map(function (o) {
        return {
            sentence: o.sentence,
            record: o.record,
            category: o.categories[0],
            result: o.result[0],
            _ranking: o._ranking
        };
    });
    return {
        sentences: res.sentences,
        errors: res.errors,
        tokens: res.tokens,
        answers: answers
    };
}
exports.listAllWithContext = listAllWithContext;
function listAllWithCategory(category, records) {
    var matchedAnswers = matchRecordHavingCategory(category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
    debuglog(" listAllWithCategory:" + JSON.stringify(matchedAnswers, undefined, 2));
    return matchedAnswers;
}
exports.listAllWithCategory = listAllWithCategory;
function listAllTupelWithContext(categories, contextQueryString, aRules, records, domainCategoryFilter) {
    if (contextQueryString.length === 0) {
        return {
            tupelanswers: [],
            errors: [abot_erbase_1.ErError.makeError_EMPTY_INPUT()],
            tokens: []
        };
    } else {
        logPerf('listAllWithContext');
        perflog("totalListAllWithContext");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("LATWC matching records (s=" + aSentencesReinforced.sentences.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsQuickMultipleCategories(aSentencesReinforced, categories, records, domainCategoryFilter); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filtering topRanked (a=" + matchedAnswers.tupelanswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRankedTupel(matchedAnswers.tupelanswers);
        if (debuglog.enabled) {
            debuglog("LATWC matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllWithContext (a=" + matchedFiltered.length + ")");
        logPerf('listAllWithContext');
        return {
            tupelanswers: matchedFiltered,
            errors: aSentencesReinforced.errors,
            tokens: aSentencesReinforced.tokens
        };
    }
}
exports.listAllTupelWithContext = listAllTupelWithContext;
function filterStringListByOp(operator, fragment, srcarr) {
    var fragmentLC = fdevsta_monmove_1.BreakDown.trimQuotedSpaced(fragment.toLowerCase());
    return srcarr.filter(function (str) {
        return Operator.matches(operator, fragmentLC, str.toLowerCase());
    }).sort();
}
exports.filterStringListByOp = filterStringListByOp;
function compareCaseInsensitive(a, b) {
    var r = a.toLowerCase().localeCompare(b.toLowerCase());
    if (r) {
        return r;
    }
    return -a.localeCompare(b);
}
/**
 * Sort string list case insensitive, then remove duplicates retaining
 * "largest" match
 */
function removeCaseDuplicates(arr) {
    arr.sort(compareCaseInsensitive);
    debuglog('sorted arr' + JSON.stringify(arr));
    return arr.filter(function (s, index) {
        return index === 0 || 0 !== arr[index - 1].toLowerCase().localeCompare(s.toLowerCase());
    });
}
exports.removeCaseDuplicates = removeCaseDuplicates;
;
function getCategoryOpFilterAsDistinctStrings(operator, fragment, category, records, filterDomain) {
    var fragmentLC = fdevsta_monmove_1.BreakDown.trimQuoted(fragment.toLowerCase());
    var res = [];
    var seen = {};
    records.forEach(function (record) {
        if (filterDomain && record['_domain'] !== filterDomain) {
            return;
        }
        if (record[category] && Operator.matches(operator, fragmentLC, record[category].toLowerCase())) {
            if (!seen[record[category]]) {
                seen[record[category]] = true;
                res.push(record[category]);
            }
        }
    });
    return removeCaseDuplicates(res);
}
exports.getCategoryOpFilterAsDistinctStrings = getCategoryOpFilterAsDistinctStrings;
;
function likelyPluralDiff(a, pluralOfa) {
    var aLC = fdevsta_monmove_1.BreakDown.trimQuoted(a.toLowerCase()) || "";
    var pluralOfALC = fdevsta_monmove_1.BreakDown.trimQuoted((pluralOfa || "").toLowerCase()) || "";
    if (aLC === pluralOfALC) {
        return true;
    }
    if (aLC + 's' === pluralOfALC) {
        return true;
    }
    return false;
}
exports.likelyPluralDiff = likelyPluralDiff;
;
function joinSortedQuoted(strings) {
    if (strings.length === 0) {
        return "";
    }
    return '"' + strings.sort().join('"; "') + '"';
}
exports.joinSortedQuoted = joinSortedQuoted;
function joinDistinct(category, records) {
    var res = records.reduce(function (prev, oRecord) {
        prev[oRecord[category]] = 1;
        return prev;
    }, {});
    return joinSortedQuoted(Object.keys(res));
}
exports.joinDistinct = joinDistinct;
function formatDistinctFromWhatIfResult(answers) {
    return joinSortedQuoted(answers.map(function (oAnswer) {
        return oAnswer.result;
    }));
}
exports.formatDistinctFromWhatIfResult = formatDistinctFromWhatIfResult;
function joinResults(results) {
    var res = [];
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            if (res.indexOf(result.result) < 0) {
                res.push(result.result);
            }
            return prev + 1;
        }
    }, 0);
    return res;
}
exports.joinResults = joinResults;
function joinResultsTupel(results) {
    var res = [];
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            var value = Utils.listToQuotedCommaAnd(result.result);
            if (res.indexOf(value) < 0) {
                res.push(value);
            }
            return prev + 1;
        }
    }, 0);
    return res;
}
exports.joinResultsTupel = joinResultsTupel;
function inferDomain(theModel, contextQueryString) {
    // console.log("here the string" + contextQueryString);
    //  console.log("here the rules" + JSON.stringify(theModel.mRules));
    var res = analyzeContextString(contextQueryString, theModel.rules);
    //console.log(JSON.stringify(res,undefined,2));
    // run through the string, search for a category
    if (!res.sentences.length) {
        return undefined;
    }
    var domains = [];
    //console.log(Sentence.dumpNiceArr(res));
    // do we have a domain ?
    res.sentences[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "domain") {
            domains.push(oWordGroup.matchedString);
        }
    });
    if (domains.length === 1) {
        debuglog("got a precise domain " + domains[0]);
        return domains[0];
    }
    if (domains.length > 0) {
        debuglog(debuglog.enabled ? "got more than one domain, confused  " + domains.join("\n") : '-');
        return undefined;
    }
    debuglog("attempting to determine categories");
    // try a category reverse map
    res.sentences[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "category") {
            var sCat = oWordGroup.matchedString;
            var doms = fdevsta_monmove_2.Model.getDomainsForCategory(theModel, sCat);
            doms.forEach(function (sDom) {
                if (domains.indexOf(sDom) < 0) {
                    domains.push(sDom);
                }
            });
        }
    });
    if (domains.length === 1) {
        debuglog("got a precise domain " + domains[0]);
        return domains[0];
    }
    debuglog(debuglog.enabled ? "got more than one domain, confused  " + domains.join("\n") : '-');
    return undefined;
}
exports.inferDomain = inferDomain;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9saXN0YWxsLnRzIiwibWF0Y2gvbGlzdGFsbC5qcyJdLCJuYW1lcyI6WyJkZWJ1ZyIsInJlcXVpcmUiLCJkZWJ1Z2xvZyIsImxvZ2dlciIsImxvZ1BlcmYiLCJwZXJmIiwicGVyZmxvZyIsIlV0aWxzIiwiZmRldnN0YV9tb25tb3ZlXzEiLCJPcGVyYXRvciIsIldoYXRJcyIsImFib3RfZXJiYXNlXzEiLCJmZGV2c3RhX21vbm1vdmVfMiIsInNXb3JkcyIsIm1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkiLCJjYXRlZ29yeSIsInJlY29yZHMiLCJlbmFibGVkIiwiSlNPTiIsInN0cmluZ2lmeSIsInVuZGVmaW5lZCIsInJlbGV2YW50UmVjb3JkcyIsImZpbHRlciIsInJlY29yZCIsInJlcyIsImxlbmd0aCIsImV4cG9ydHMiLCJhbmFseXplQ29udGV4dFN0cmluZyIsImNvbnRleHRRdWVyeVN0cmluZyIsInJ1bGVzIiwibGlzdEFsbFdpdGhDb250ZXh0IiwiYVJ1bGVzIiwiZG9tYWluQ2F0ZWdvcnlGaWx0ZXIiLCJsaXN0QWxsVHVwZWxXaXRoQ29udGV4dCIsImFuc3dlcnMiLCJ0dXBlbGFuc3dlcnMiLCJtYXAiLCJvIiwic2VudGVuY2UiLCJjYXRlZ29yaWVzIiwicmVzdWx0IiwiX3JhbmtpbmciLCJzZW50ZW5jZXMiLCJlcnJvcnMiLCJ0b2tlbnMiLCJsaXN0QWxsV2l0aENhdGVnb3J5IiwibWF0Y2hlZEFuc3dlcnMiLCJFckVycm9yIiwibWFrZUVycm9yX0VNUFRZX0lOUFVUIiwiYVNlbnRlbmNlc1JlaW5mb3JjZWQiLCJtYXRjaFJlY29yZHNRdWlja011bHRpcGxlQ2F0ZWdvcmllcyIsIm1hdGNoZWRGaWx0ZXJlZCIsImZpbHRlck9ubHlUb3BSYW5rZWRUdXBlbCIsImZpbHRlclN0cmluZ0xpc3RCeU9wIiwib3BlcmF0b3IiLCJmcmFnbWVudCIsInNyY2FyciIsImZyYWdtZW50TEMiLCJCcmVha0Rvd24iLCJ0cmltUXVvdGVkU3BhY2VkIiwidG9Mb3dlckNhc2UiLCJzdHIiLCJtYXRjaGVzIiwic29ydCIsImNvbXBhcmVDYXNlSW5zZW5zaXRpdmUiLCJhIiwiYiIsInIiLCJsb2NhbGVDb21wYXJlIiwicmVtb3ZlQ2FzZUR1cGxpY2F0ZXMiLCJhcnIiLCJzIiwiaW5kZXgiLCJnZXRDYXRlZ29yeU9wRmlsdGVyQXNEaXN0aW5jdFN0cmluZ3MiLCJmaWx0ZXJEb21haW4iLCJ0cmltUXVvdGVkIiwic2VlbiIsImZvckVhY2giLCJwdXNoIiwibGlrZWx5UGx1cmFsRGlmZiIsInBsdXJhbE9mYSIsImFMQyIsInBsdXJhbE9mQUxDIiwiam9pblNvcnRlZFF1b3RlZCIsInN0cmluZ3MiLCJqb2luIiwiam9pbkRpc3RpbmN0IiwicmVkdWNlIiwicHJldiIsIm9SZWNvcmQiLCJPYmplY3QiLCJrZXlzIiwiZm9ybWF0RGlzdGluY3RGcm9tV2hhdElmUmVzdWx0Iiwib0Fuc3dlciIsImpvaW5SZXN1bHRzIiwicmVzdWx0cyIsImNudCIsImluZGV4T2YiLCJqb2luUmVzdWx0c1R1cGVsIiwidmFsdWUiLCJsaXN0VG9RdW90ZWRDb21tYUFuZCIsImluZmVyRG9tYWluIiwidGhlTW9kZWwiLCJkb21haW5zIiwib1dvcmRHcm91cCIsIm1hdGNoZWRTdHJpbmciLCJzQ2F0IiwiZG9tcyIsIk1vZGVsIiwiZ2V0RG9tYWluc0ZvckNhdGVnb3J5Iiwic0RvbSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQ01BOztBREtBLElBQUFBLFFBQUFDLFFBQUEsT0FBQSxDQUFBO0FBRUEsSUFBTUMsV0FBV0YsTUFBTSxTQUFOLENBQWpCO0FBQ0EsSUFBQUcsU0FBQUYsUUFBQSxpQkFBQSxDQUFBO0FBQ0EsSUFBSUcsVUFBVUQsT0FBT0UsSUFBUCxDQUFZLGFBQVosQ0FBZDtBQUNBLElBQUlDLFVBQVVOLE1BQU0sTUFBTixDQUFkO0FBQ0E7QUFFQSxJQUFBTyxRQUFBTixRQUFBLFlBQUEsQ0FBQTtBQU1BLElBQUFPLG9CQUFBUCxRQUFBLGlCQUFBLENBQUE7QUFNQSxJQUFBUSxXQUFBUixRQUFBLFlBQUEsQ0FBQTtBQUVBLElBQUFTLFNBQUFULFFBQUEsVUFBQSxDQUFBO0FBRUEsSUFBQVUsZ0JBQUFWLFFBQUEsYUFBQSxDQUFBO0FBRUEsSUFBQVcsb0JBQUFYLFFBQUEsaUJBQUEsQ0FBQTtBQUlBLElBQUlZLFNBQVMsRUFBYjtBQUVBLFNBQUFDLHlCQUFBLENBQTBDQyxRQUExQyxFQUE0REMsT0FBNUQsRUFBMEY7QUFFeEZkLGFBQVNBLFNBQVNlLE9BQVQsR0FBbUJDLEtBQUtDLFNBQUwsQ0FBZUgsT0FBZixFQUF1QkksU0FBdkIsRUFBaUMsQ0FBakMsQ0FBbkIsR0FBeUQsR0FBbEU7QUFDQSxRQUFJQyxrQkFBa0JMLFFBQVFNLE1BQVIsQ0FBZSxVQUFVQyxNQUFWLEVBQWdDO0FBQ25FLGVBQVFBLE9BQU9SLFFBQVAsTUFBcUJLLFNBQXRCLElBQXFDRyxPQUFPUixRQUFQLE1BQXFCLElBQWpFO0FBQ0QsS0FGcUIsQ0FBdEI7QUFHQSxRQUFJUyxNQUFNLEVBQVY7QUFDQXRCLGFBQVMseUJBQXlCbUIsZ0JBQWdCSSxNQUFsRDtBQUNBLFdBQU9KLGVBQVA7QUFDRDtBQVRESyxRQUFBWix5QkFBQSxHQUFBQSx5QkFBQTtBQVlBLFNBQUFhLG9CQUFBLENBQXFDQyxrQkFBckMsRUFBbUVDLEtBQW5FLEVBQTJGO0FBQ3pGLFdBQU9uQixPQUFPaUIsb0JBQVAsQ0FBNEJDLGtCQUE1QixFQUErQ0MsS0FBL0MsQ0FBUDtBQUNEO0FBRkRILFFBQUFDLG9CQUFBLEdBQUFBLG9CQUFBO0FBSUE7QUFDQTtBQUlBLFNBQUFHLGtCQUFBLENBQW1DZixRQUFuQyxFQUFxRGEsa0JBQXJELEVBQ0VHLE1BREYsRUFDNkJmLE9BRDdCLEVBQzZEZ0Isb0JBRDdELEVBQ2dIO0FBQzlHLFFBQUlSLE1BQU1TLHdCQUF3QixDQUFDbEIsUUFBRCxDQUF4QixFQUFvQ2Esa0JBQXBDLEVBQXdERyxNQUF4RCxFQUFnRWYsT0FBaEUsRUFBeUVnQixvQkFBekUsQ0FBVjtBQUVBLFFBQUlFLFVBQVVWLElBQUlXLFlBQUosQ0FBaUJDLEdBQWpCLENBQXFCLFVBQVVDLENBQVYsRUFBVztBQUM1QyxlQUFPO0FBQ0xDLHNCQUFVRCxFQUFFQyxRQURQO0FBRUxmLG9CQUFRYyxFQUFFZCxNQUZMO0FBR0xSLHNCQUFVc0IsRUFBRUUsVUFBRixDQUFhLENBQWIsQ0FITDtBQUlMQyxvQkFBUUgsRUFBRUcsTUFBRixDQUFTLENBQVQsQ0FKSDtBQUtMQyxzQkFBVUosRUFBRUk7QUFMUCxTQUFQO0FBT0QsS0FSYSxDQUFkO0FBVUEsV0FBTztBQUNMQyxtQkFBV2xCLElBQUlrQixTQURWO0FBRUxDLGdCQUFRbkIsSUFBSW1CLE1BRlA7QUFHTEMsZ0JBQVFwQixJQUFJb0IsTUFIUDtBQUlMVixpQkFBU0E7QUFKSixLQUFQO0FBTUQ7QUFwQkRSLFFBQUFJLGtCQUFBLEdBQUFBLGtCQUFBO0FBdUJBLFNBQUFlLG1CQUFBLENBQW9DOUIsUUFBcEMsRUFBc0RDLE9BQXRELEVBQW9GO0FBQ2xGLFFBQUk4QixpQkFBaUJoQywwQkFBMEJDLFFBQTFCLEVBQW9DQyxPQUFwQyxDQUFyQixDQURrRixDQUNmO0FBQ25FZCxhQUFTLDBCQUEwQmdCLEtBQUtDLFNBQUwsQ0FBZTJCLGNBQWYsRUFBK0IxQixTQUEvQixFQUEwQyxDQUExQyxDQUFuQztBQUNBLFdBQU8wQixjQUFQO0FBQ0Q7QUFKRHBCLFFBQUFtQixtQkFBQSxHQUFBQSxtQkFBQTtBQU1BLFNBQUFaLHVCQUFBLENBQXdDTSxVQUF4QyxFQUE4RFgsa0JBQTlELEVBQ0VHLE1BREYsRUFDNkJmLE9BRDdCLEVBQzZEZ0Isb0JBRDdELEVBQ2dIO0FBQzlHLFFBQUlKLG1CQUFtQkgsTUFBbkIsS0FBOEIsQ0FBbEMsRUFBcUM7QUFDbkMsZUFBTztBQUNMVSwwQkFBZSxFQURWO0FBRUxRLG9CQUFTLENBQUNoQyxjQUFBb0MsT0FBQSxDQUFRQyxxQkFBUixFQUFELENBRko7QUFHTEosb0JBQVE7QUFISCxTQUFQO0FBS0QsS0FORCxNQU1PO0FBQ0x4QyxnQkFBUSxvQkFBUjtBQUNBRSxnQkFBUSx5QkFBUjtBQUNBLFlBQUkyQyx1QkFBdUJ0QixxQkFBcUJDLGtCQUFyQixFQUF5Q0csTUFBekMsQ0FBM0I7QUFDQXpCLGdCQUFRLCtCQUErQjJDLHFCQUFxQlAsU0FBckIsQ0FBK0JqQixNQUE5RCxHQUF1RSxNQUEvRTtBQUNBLFlBQUlxQixpQkFBaUJwQyxPQUFPd0MsbUNBQVAsQ0FBMkNELG9CQUEzQyxFQUFpRVYsVUFBakUsRUFBNkV2QixPQUE3RSxFQUFzRmdCLG9CQUF0RixDQUFyQixDQUxLLENBSzZIO0FBQ2xJLFlBQUc5QixTQUFTZSxPQUFaLEVBQW9CO0FBQ2xCZixxQkFBUyxxQkFBcUJnQixLQUFLQyxTQUFMLENBQWUyQixjQUFmLEVBQStCMUIsU0FBL0IsRUFBMEMsQ0FBMUMsQ0FBOUI7QUFDRDtBQUNEZCxnQkFBUSw0QkFBNEJ3QyxlQUFlWCxZQUFmLENBQTRCVixNQUF4RCxHQUFpRSxNQUF6RTtBQUNBLFlBQUkwQixrQkFBa0J6QyxPQUFPMEMsd0JBQVAsQ0FBZ0NOLGVBQWVYLFlBQS9DLENBQXRCO0FBQ0EsWUFBSWpDLFNBQVNlLE9BQWIsRUFBc0I7QUFDcEJmLHFCQUFTLHFDQUFxQ2dCLEtBQUtDLFNBQUwsQ0FBZWdDLGVBQWYsRUFBZ0MvQixTQUFoQyxFQUEyQyxDQUEzQyxDQUE5QztBQUNEO0FBQ0RkLGdCQUFRLGdDQUFnQzZDLGdCQUFnQjFCLE1BQWhELEdBQXlELEdBQWpFO0FBQ0FyQixnQkFBUSxvQkFBUjtBQUNBLGVBQU87QUFDTCtCLDBCQUFlZ0IsZUFEVjtBQUVMUixvQkFBU00scUJBQXFCTixNQUZ6QjtBQUdMQyxvQkFBUUsscUJBQXFCTDtBQUh4QixTQUFQO0FBS0Q7QUFDRjtBQTlCRGxCLFFBQUFPLHVCQUFBLEdBQUFBLHVCQUFBO0FBZ0NBLFNBQUFvQixvQkFBQSxDQUFxQ0MsUUFBckMsRUFBaUVDLFFBQWpFLEVBQXFGQyxNQUFyRixFQUFzRztBQUNwRyxRQUFJQyxhQUFhakQsa0JBQUFrRCxTQUFBLENBQVVDLGdCQUFWLENBQTJCSixTQUFTSyxXQUFULEVBQTNCLENBQWpCO0FBQ0EsV0FBT0osT0FBT2xDLE1BQVAsQ0FBYyxVQUFTdUMsR0FBVCxFQUFZO0FBQy9CLGVBQU9wRCxTQUFTcUQsT0FBVCxDQUFpQlIsUUFBakIsRUFBMkJHLFVBQTNCLEVBQXVDSSxJQUFJRCxXQUFKLEVBQXZDLENBQVA7QUFDRCxLQUZNLEVBRUpHLElBRkksRUFBUDtBQUdEO0FBTERyQyxRQUFBMkIsb0JBQUEsR0FBQUEsb0JBQUE7QUFPQSxTQUFBVyxzQkFBQSxDQUFnQ0MsQ0FBaEMsRUFBMkNDLENBQTNDLEVBQXFEO0FBQ25ELFFBQUlDLElBQUlGLEVBQUVMLFdBQUYsR0FBZ0JRLGFBQWhCLENBQThCRixFQUFFTixXQUFGLEVBQTlCLENBQVI7QUFDQSxRQUFJTyxDQUFKLEVBQU87QUFDTCxlQUFPQSxDQUFQO0FBQ0Q7QUFDRCxXQUFPLENBQUNGLEVBQUVHLGFBQUYsQ0FBZ0JGLENBQWhCLENBQVI7QUFDRDtBQUVEOzs7O0FBSUEsU0FBQUcsb0JBQUEsQ0FBcUNDLEdBQXJDLEVBQW1EO0FBQ2pEQSxRQUFJUCxJQUFKLENBQVNDLHNCQUFUO0FBQ0E5RCxhQUFTLGVBQWVnQixLQUFLQyxTQUFMLENBQWVtRCxHQUFmLENBQXhCO0FBQ0EsV0FBT0EsSUFBSWhELE1BQUosQ0FBVyxVQUFTaUQsQ0FBVCxFQUFZQyxLQUFaLEVBQWlCO0FBQ2pDLGVBQU9BLFVBQVUsQ0FBVixJQUFnQixNQUFNRixJQUFJRSxRQUFPLENBQVgsRUFBZVosV0FBZixHQUE2QlEsYUFBN0IsQ0FBMkNHLEVBQUVYLFdBQUYsRUFBM0MsQ0FBN0I7QUFDRCxLQUZNLENBQVA7QUFHRDtBQU5EbEMsUUFBQTJDLG9CQUFBLEdBQUFBLG9CQUFBO0FBTUM7QUFFRCxTQUFBSSxvQ0FBQSxDQUFxRG5CLFFBQXJELEVBQWlGQyxRQUFqRixFQUNFeEMsUUFERixFQUNxQkMsT0FEckIsRUFDcUQwRCxZQURyRCxFQUMyRTtBQUN2RSxRQUFJakIsYUFBYWpELGtCQUFBa0QsU0FBQSxDQUFVaUIsVUFBVixDQUFxQnBCLFNBQVNLLFdBQVQsRUFBckIsQ0FBakI7QUFDQSxRQUFJcEMsTUFBTSxFQUFWO0FBQ0EsUUFBSW9ELE9BQU8sRUFBWDtBQUNBNUQsWUFBUTZELE9BQVIsQ0FBZ0IsVUFBU3RELE1BQVQsRUFBZTtBQUM3QixZQUFHbUQsZ0JBQWdCbkQsT0FBUSxTQUFSLE1BQXVCbUQsWUFBMUMsRUFBd0Q7QUFDdEQ7QUFDRDtBQUNELFlBQUduRCxPQUFPUixRQUFQLEtBQW9CTixTQUFTcUQsT0FBVCxDQUFpQlIsUUFBakIsRUFBMkJHLFVBQTNCLEVBQXVDbEMsT0FBT1IsUUFBUCxFQUFpQjZDLFdBQWpCLEVBQXZDLENBQXZCLEVBQStGO0FBQzdGLGdCQUFHLENBQUNnQixLQUFLckQsT0FBT1IsUUFBUCxDQUFMLENBQUosRUFBNEI7QUFDMUI2RCxxQkFBS3JELE9BQU9SLFFBQVAsQ0FBTCxJQUF5QixJQUF6QjtBQUNBUyxvQkFBSXNELElBQUosQ0FBU3ZELE9BQU9SLFFBQVAsQ0FBVDtBQUNEO0FBQ0Y7QUFDRixLQVZEO0FBV0EsV0FBT3NELHFCQUFxQjdDLEdBQXJCLENBQVA7QUFDSDtBQWpCREUsUUFBQStDLG9DQUFBLEdBQUFBLG9DQUFBO0FBaUJDO0FBRUQsU0FBQU0sZ0JBQUEsQ0FBaUNkLENBQWpDLEVBQTZDZSxTQUE3QyxFQUErRDtBQUM3RCxRQUFJQyxNQUFNekUsa0JBQUFrRCxTQUFBLENBQVVpQixVQUFWLENBQXFCVixFQUFFTCxXQUFGLEVBQXJCLEtBQTBDLEVBQXBEO0FBQ0EsUUFBSXNCLGNBQWMxRSxrQkFBQWtELFNBQUEsQ0FBVWlCLFVBQVYsQ0FBcUIsQ0FBQ0ssYUFBWSxFQUFiLEVBQWlCcEIsV0FBakIsRUFBckIsS0FBd0QsRUFBMUU7QUFDQSxRQUFJcUIsUUFBUUMsV0FBWixFQUF5QjtBQUN2QixlQUFPLElBQVA7QUFDRDtBQUNELFFBQUlELE1BQUssR0FBTCxLQUFhQyxXQUFqQixFQUE4QjtBQUM1QixlQUFPLElBQVA7QUFDRDtBQUNELFdBQU8sS0FBUDtBQUNEO0FBVkR4RCxRQUFBcUQsZ0JBQUEsR0FBQUEsZ0JBQUE7QUFVQztBQUtELFNBQUFJLGdCQUFBLENBQWlDQyxPQUFqQyxFQUFtRDtBQUNqRCxRQUFJQSxRQUFRM0QsTUFBUixLQUFtQixDQUF2QixFQUEwQjtBQUN4QixlQUFPLEVBQVA7QUFDRDtBQUNELFdBQU8sTUFBTTJELFFBQVFyQixJQUFSLEdBQWVzQixJQUFmLENBQW9CLE1BQXBCLENBQU4sR0FBb0MsR0FBM0M7QUFDRDtBQUxEM0QsUUFBQXlELGdCQUFBLEdBQUFBLGdCQUFBO0FBT0EsU0FBQUcsWUFBQSxDQUE2QnZFLFFBQTdCLEVBQWdEQyxPQUFoRCxFQUErRTtBQUM3RSxRQUFJUSxNQUFNUixRQUFRdUUsTUFBUixDQUFlLFVBQVNDLElBQVQsRUFBZUMsT0FBZixFQUFzQjtBQUM3Q0QsYUFBS0MsUUFBUTFFLFFBQVIsQ0FBTCxJQUEwQixDQUExQjtBQUNBLGVBQU95RSxJQUFQO0FBQ0QsS0FIUyxFQUdSLEVBSFEsQ0FBVjtBQUlBLFdBQU9MLGlCQUFpQk8sT0FBT0MsSUFBUCxDQUFZbkUsR0FBWixDQUFqQixDQUFQO0FBQ0Q7QUFOREUsUUFBQTRELFlBQUEsR0FBQUEsWUFBQTtBQVFBLFNBQUFNLDhCQUFBLENBQWdEMUQsT0FBaEQsRUFBcUY7QUFDbkYsV0FBT2lELGlCQUFpQmpELFFBQVFFLEdBQVIsQ0FBWSxVQUFTeUQsT0FBVCxFQUFnQjtBQUNsRCxlQUFPQSxRQUFRckQsTUFBZjtBQUNELEtBRnVCLENBQWpCLENBQVA7QUFHRDtBQUpEZCxRQUFBa0UsOEJBQUEsR0FBQUEsOEJBQUE7QUFNQSxTQUFBRSxXQUFBLENBQTRCQyxPQUE1QixFQUFnRTtBQUM5RCxRQUFJdkUsTUFBTyxFQUFYO0FBQ0EsUUFBSXdFLE1BQU1ELFFBQVFSLE1BQVIsQ0FBZSxVQUFVQyxJQUFWLEVBQWdCaEQsTUFBaEIsRUFBc0I7QUFDN0MsWUFBSUEsT0FBT0MsUUFBUCxLQUFvQnNELFFBQVEsQ0FBUixFQUFXdEQsUUFBbkMsRUFBNkM7QUFDM0MsZ0JBQUdqQixJQUFJeUUsT0FBSixDQUFZekQsT0FBT0EsTUFBbkIsSUFBNkIsQ0FBaEMsRUFBbUM7QUFDakNoQixvQkFBSXNELElBQUosQ0FBU3RDLE9BQU9BLE1BQWhCO0FBQ0Q7QUFDRCxtQkFBT2dELE9BQU8sQ0FBZDtBQUNEO0FBQ0YsS0FQUyxFQU9QLENBUE8sQ0FBVjtBQVFBLFdBQU9oRSxHQUFQO0FBQ0Q7QUFYREUsUUFBQW9FLFdBQUEsR0FBQUEsV0FBQTtBQWVBLFNBQUFJLGdCQUFBLENBQWlDSCxPQUFqQyxFQUEwRTtBQUN4RSxRQUFJdkUsTUFBTyxFQUFYO0FBQ0EsUUFBSXdFLE1BQU1ELFFBQVFSLE1BQVIsQ0FBZSxVQUFVQyxJQUFWLEVBQWdCaEQsTUFBaEIsRUFBc0I7QUFDN0MsWUFBSUEsT0FBT0MsUUFBUCxLQUFvQnNELFFBQVEsQ0FBUixFQUFXdEQsUUFBbkMsRUFBNkM7QUFDM0MsZ0JBQUkwRCxRQUFRNUYsTUFBTTZGLG9CQUFOLENBQTJCNUQsT0FBT0EsTUFBbEMsQ0FBWjtBQUNBLGdCQUFHaEIsSUFBSXlFLE9BQUosQ0FBWUUsS0FBWixJQUFxQixDQUF4QixFQUEyQjtBQUN6QjNFLG9CQUFJc0QsSUFBSixDQUFTcUIsS0FBVDtBQUNEO0FBQ0QsbUJBQU9YLE9BQU8sQ0FBZDtBQUNEO0FBQ0YsS0FSUyxFQVFQLENBUk8sQ0FBVjtBQVNBLFdBQU9oRSxHQUFQO0FBQ0Q7QUFaREUsUUFBQXdFLGdCQUFBLEdBQUFBLGdCQUFBO0FBY0EsU0FBQUcsV0FBQSxDQUE0QkMsUUFBNUIsRUFBdUQxRSxrQkFBdkQsRUFBaUY7QUFDaEY7QUFDQTtBQUNDLFFBQUlKLE1BQU1HLHFCQUFxQkMsa0JBQXJCLEVBQXlDMEUsU0FBU3pFLEtBQWxELENBQVY7QUFDQTtBQUNBO0FBQ0EsUUFBRyxDQUFDTCxJQUFJa0IsU0FBSixDQUFjakIsTUFBbEIsRUFBMEI7QUFDeEIsZUFBT0wsU0FBUDtBQUNEO0FBQ0QsUUFBSW1GLFVBQVUsRUFBZDtBQUNBO0FBQ0E7QUFDQS9FLFFBQUlrQixTQUFKLENBQWMsQ0FBZCxFQUFpQm1DLE9BQWpCLENBQXlCLFVBQVMyQixVQUFULEVBQW1CO0FBQzFDLFlBQUdBLFdBQVd6RixRQUFYLEtBQXdCLFFBQTNCLEVBQXFDO0FBQ25Dd0Ysb0JBQVF6QixJQUFSLENBQWEwQixXQUFXQyxhQUF4QjtBQUNEO0FBQ0YsS0FKRDtBQUtBLFFBQUdGLFFBQVE5RSxNQUFSLEtBQW1CLENBQXRCLEVBQXlCO0FBQ3ZCdkIsaUJBQVMsMEJBQTBCcUcsUUFBUSxDQUFSLENBQW5DO0FBQ0EsZUFBT0EsUUFBUSxDQUFSLENBQVA7QUFDRDtBQUNELFFBQUdBLFFBQVE5RSxNQUFSLEdBQWlCLENBQXBCLEVBQXdCO0FBQ3RCdkIsaUJBQVNBLFNBQVNlLE9BQVQsR0FBbUIseUNBQXlDc0YsUUFBUWxCLElBQVIsQ0FBYSxJQUFiLENBQTVELEdBQWdGLEdBQXpGO0FBQ0EsZUFBT2pFLFNBQVA7QUFFRDtBQUNEbEIsYUFBUyxvQ0FBVDtBQUNBO0FBQ0FzQixRQUFJa0IsU0FBSixDQUFjLENBQWQsRUFBaUJtQyxPQUFqQixDQUF5QixVQUFTMkIsVUFBVCxFQUFtQjtBQUMxQyxZQUFHQSxXQUFXekYsUUFBWCxLQUF3QixVQUEzQixFQUF1QztBQUNyQyxnQkFBSTJGLE9BQU9GLFdBQVdDLGFBQXRCO0FBQ0EsZ0JBQUlFLE9BQU8vRixrQkFBQWdHLEtBQUEsQ0FBTUMscUJBQU4sQ0FBNEJQLFFBQTVCLEVBQXFDSSxJQUFyQyxDQUFYO0FBQ0FDLGlCQUFLOUIsT0FBTCxDQUFhLFVBQVNpQyxJQUFULEVBQWE7QUFDeEIsb0JBQUdQLFFBQVFOLE9BQVIsQ0FBZ0JhLElBQWhCLElBQXdCLENBQTNCLEVBQThCO0FBQzVCUCw0QkFBUXpCLElBQVIsQ0FBYWdDLElBQWI7QUFDRDtBQUNGLGFBSkQ7QUFLRDtBQUNGLEtBVkQ7QUFXQSxRQUFHUCxRQUFROUUsTUFBUixLQUFtQixDQUF0QixFQUF5QjtBQUN0QnZCLGlCQUFTLDBCQUEwQnFHLFFBQVEsQ0FBUixDQUFuQztBQUNELGVBQU9BLFFBQVEsQ0FBUixDQUFQO0FBQ0Q7QUFDRHJHLGFBQVNBLFNBQVNlLE9BQVQsR0FBb0IseUNBQXlDc0YsUUFBUWxCLElBQVIsQ0FBYSxJQUFiLENBQTdELEdBQWtGLEdBQTNGO0FBQ0EsV0FBT2pFLFNBQVA7QUFDRDtBQTdDRE0sUUFBQTJFLFdBQUEsR0FBQUEsV0FBQTtBQTZDQyIsImZpbGUiOiJtYXRjaC9saXN0YWxsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKlxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYW5hbHl6ZVxuICogQGZpbGUgYW5hbHl6ZS50c1xuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICovXG5cblxuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXIgZnJvbSAnLi9pbnB1dEZpbHRlcic7XG5cbmltcG9ydCAqIGFzIEFsZ29sIGZyb20gJy4vYWxnb2wnO1xuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdsaXN0YWxsJyk7XG5pbXBvcnQgKiBhcyBsb2dnZXIgZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcbnZhciBsb2dQZXJmID0gbG9nZ2VyLnBlcmYoXCJwZXJmbGlzdGFsbFwiKTtcbnZhciBwZXJmbG9nID0gZGVidWcoJ3BlcmYnKTtcbi8vY29uc3QgcGVyZmxvZyA9IGxvZ2dlci5wZXJmKFwicGVyZmxpc3RhbGxcIik7XG5cbmltcG9ydCAqIGFzIFV0aWxzIGZyb20gJ2Fib3RfdXRpbHMnO1xuXG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi9pZm1hdGNoJztcblxuaW1wb3J0ICogYXMgVG9vbG1hdGNoZXIgZnJvbSAnLi90b29sbWF0Y2hlcic7XG5cbmltcG9ydCB7IEJyZWFrRG93biB9IGZyb20gJ2ZkZXZzdGFfbW9ubW92ZSc7XG5cbmltcG9ydCB7IFNlbnRlbmNlIGFzIFNlbnRlbmNlfSBmcm9tICdhYm90X2VyYmFzZSc7XG5cbmltcG9ydCB7IFdvcmQgYXMgV29yZH0gZnJvbSAnYWJvdF9lcmJhc2UnO1xuXG5pbXBvcnQgKiBhcyBPcGVyYXRvciBmcm9tICcuL29wZXJhdG9yJztcblxuaW1wb3J0ICogYXMgV2hhdElzIGZyb20gJy4vd2hhdGlzJztcblxuaW1wb3J0IHsgRXJFcnJvciBhcyBFckVycm9yfSBmcm9tICdhYm90X2VyYmFzZSc7XG5cbmltcG9ydCB7IE1vZGVsIH0gZnJvbSAnZmRldnN0YV9tb25tb3ZlJztcblxuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi9tYXRjaCc7XG5cbnZhciBzV29yZHMgPSB7fTtcblxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkoY2F0ZWdvcnk6IHN0cmluZywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+KVxuICA6IEFycmF5PElNYXRjaC5JUmVjb3JkPiB7XG4gIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBKU09OLnN0cmluZ2lmeShyZWNvcmRzLHVuZGVmaW5lZCwyKSA6IFwiLVwiKTtcbiAgdmFyIHJlbGV2YW50UmVjb3JkcyA9IHJlY29yZHMuZmlsdGVyKGZ1bmN0aW9uIChyZWNvcmQ6IElNYXRjaC5JUmVjb3JkKSB7XG4gICAgcmV0dXJuIChyZWNvcmRbY2F0ZWdvcnldICE9PSB1bmRlZmluZWQpICYmIChyZWNvcmRbY2F0ZWdvcnldICE9PSBudWxsKTtcbiAgfSk7XG4gIHZhciByZXMgPSBbXTtcbiAgZGVidWdsb2coXCJyZWxldmFudCByZWNvcmRzIG5yOlwiICsgcmVsZXZhbnRSZWNvcmRzLmxlbmd0aCk7XG4gIHJldHVybiByZWxldmFudFJlY29yZHM7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZyA6IHN0cmluZywgIHJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcykge1xuICByZXR1cm4gV2hhdElzLmFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZyxydWxlcyk7XG59XG5cbi8vIGNvbnN0IHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksXG4vLyAgIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwudG9vbHMsIHRoZU1vZGVsLnJlY29yZHMpO1xuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RBbGxXaXRoQ29udGV4dChjYXRlZ29yeTogc3RyaW5nLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyxcbiAgYVJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+LCBkb21haW5DYXRlZ29yeUZpbHRlcj86IElNYXRjaC5JRG9tYWluQ2F0ZWdvcnlGaWx0ZXIpOiBJTWF0Y2guSVByb2Nlc3NlZFdoYXRJc0Fuc3dlcnMge1xuICB2YXIgcmVzID0gbGlzdEFsbFR1cGVsV2l0aENvbnRleHQoW2NhdGVnb3J5XSwgY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMsIHJlY29yZHMsIGRvbWFpbkNhdGVnb3J5RmlsdGVyKTtcblxuICB2YXIgYW5zd2VycyA9IHJlcy50dXBlbGFuc3dlcnMubWFwKGZ1bmN0aW9uIChvKTogSU1hdGNoLklXaGF0SXNBbnN3ZXIge1xuICAgIHJldHVybiB7XG4gICAgICBzZW50ZW5jZTogby5zZW50ZW5jZSxcbiAgICAgIHJlY29yZDogby5yZWNvcmQsXG4gICAgICBjYXRlZ29yeTogby5jYXRlZ29yaWVzWzBdLFxuICAgICAgcmVzdWx0OiBvLnJlc3VsdFswXSxcbiAgICAgIF9yYW5raW5nOiBvLl9yYW5raW5nXG4gICAgfTtcbiAgfVxuICApO1xuICByZXR1cm4ge1xuICAgIHNlbnRlbmNlczogcmVzLnNlbnRlbmNlcyxcbiAgICBlcnJvcnM6IHJlcy5lcnJvcnMsXG4gICAgdG9rZW5zOiByZXMudG9rZW5zLFxuICAgIGFuc3dlcnM6IGFuc3dlcnNcbiAgfTtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gbGlzdEFsbFdpdGhDYXRlZ29yeShjYXRlZ29yeTogc3RyaW5nLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4pOiBBcnJheTxJTWF0Y2guSVJlY29yZD4ge1xuICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5LCByZWNvcmRzKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gIGRlYnVnbG9nKFwiIGxpc3RBbGxXaXRoQ2F0ZWdvcnk6XCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gIHJldHVybiBtYXRjaGVkQW5zd2Vycztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RBbGxUdXBlbFdpdGhDb250ZXh0KGNhdGVnb3JpZXM6IHN0cmluZ1tdLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyxcbiAgYVJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+LCBkb21haW5DYXRlZ29yeUZpbHRlcj86IElNYXRjaC5JRG9tYWluQ2F0ZWdvcnlGaWx0ZXIpOiBJTWF0Y2guSVByb2Nlc3NlZFdoYXRJc1R1cGVsQW5zd2VycyB7XG4gIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR1cGVsYW5zd2VycyA6IFtdLFxuICAgICAgZXJyb3JzIDogW0VyRXJyb3IubWFrZUVycm9yX0VNUFRZX0lOUFVUKCldICxcbiAgICAgIHRva2VucyA6W10sXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHRcIik7XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgIHBlcmZsb2coXCJMQVRXQyBtYXRjaGluZyByZWNvcmRzIChzPVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQuc2VudGVuY2VzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzUXVpY2tNdWx0aXBsZUNhdGVnb3JpZXMoYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3JpZXMsIHJlY29yZHMsIGRvbWFpbkNhdGVnb3J5RmlsdGVyKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgaWYoZGVidWdsb2cuZW5hYmxlZCl7XG4gICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcGVyZmxvZyhcImZpbHRlcmluZyB0b3BSYW5rZWQgKGE9XCIgKyBtYXRjaGVkQW5zd2Vycy50dXBlbGFuc3dlcnMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgIHZhciBtYXRjaGVkRmlsdGVyZWQgPSBXaGF0SXMuZmlsdGVyT25seVRvcFJhbmtlZFR1cGVsKG1hdGNoZWRBbnN3ZXJzLnR1cGVsYW5zd2Vycyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgIGRlYnVnbG9nKFwiTEFUV0MgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxXaXRoQ29udGV4dCAoYT1cIiArIG1hdGNoZWRGaWx0ZXJlZC5sZW5ndGggKyBcIilcIik7XG4gICAgbG9nUGVyZignbGlzdEFsbFdpdGhDb250ZXh0Jyk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR1cGVsYW5zd2VycyA6IG1hdGNoZWRGaWx0ZXJlZCwgLy8gPz8/IEFuc3dlcnM7XG4gICAgICBlcnJvcnMgOiBhU2VudGVuY2VzUmVpbmZvcmNlZC5lcnJvcnMsXG4gICAgICB0b2tlbnM6IGFTZW50ZW5jZXNSZWluZm9yY2VkLnRva2Vuc1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZmlsdGVyU3RyaW5nTGlzdEJ5T3Aob3BlcmF0b3I6IElNYXRjaC5JT3BlcmF0b3IsIGZyYWdtZW50IDogc3RyaW5nLCAgc3JjYXJyIDogc3RyaW5nW10gKSA6IHN0cmluZ1tdIHtcbiAgdmFyIGZyYWdtZW50TEMgPSBCcmVha0Rvd24udHJpbVF1b3RlZFNwYWNlZChmcmFnbWVudC50b0xvd2VyQ2FzZSgpKTtcbiAgcmV0dXJuIHNyY2Fyci5maWx0ZXIoZnVuY3Rpb24oc3RyKSB7XG4gICAgcmV0dXJuIE9wZXJhdG9yLm1hdGNoZXMob3BlcmF0b3IsIGZyYWdtZW50TEMsIHN0ci50b0xvd2VyQ2FzZSgpKTtcbiAgfSkuc29ydCgpO1xufVxuXG5mdW5jdGlvbiBjb21wYXJlQ2FzZUluc2Vuc2l0aXZlKGE6IHN0cmluZywgYiA6IHN0cmluZykge1xuICB2YXIgciA9IGEudG9Mb3dlckNhc2UoKS5sb2NhbGVDb21wYXJlKGIudG9Mb3dlckNhc2UoKSk7XG4gIGlmIChyKSB7XG4gICAgcmV0dXJuIHI7XG4gIH1cbiAgcmV0dXJuIC1hLmxvY2FsZUNvbXBhcmUoYik7XG59XG5cbi8qKlxuICogU29ydCBzdHJpbmcgbGlzdCBjYXNlIGluc2Vuc2l0aXZlLCB0aGVuIHJlbW92ZSBkdXBsaWNhdGVzIHJldGFpbmluZ1xuICogXCJsYXJnZXN0XCIgbWF0Y2hcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlbW92ZUNhc2VEdXBsaWNhdGVzKGFyciA6IHN0cmluZ1tdKSA6IHN0cmluZ1tdIHtcbiAgYXJyLnNvcnQoY29tcGFyZUNhc2VJbnNlbnNpdGl2ZSk7XG4gIGRlYnVnbG9nKCdzb3J0ZWQgYXJyJyArIEpTT04uc3RyaW5naWZ5KGFycikpO1xuICByZXR1cm4gYXJyLmZpbHRlcihmdW5jdGlvbihzLCBpbmRleCkge1xuICAgIHJldHVybiBpbmRleCA9PT0gMCB8fCAoMCAhPT0gYXJyW2luZGV4IC0xIF0udG9Mb3dlckNhc2UoKS5sb2NhbGVDb21wYXJlKHMudG9Mb3dlckNhc2UoKSkpO1xuICB9KTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDYXRlZ29yeU9wRmlsdGVyQXNEaXN0aW5jdFN0cmluZ3Mob3BlcmF0b3I6IElNYXRjaC5JT3BlcmF0b3IsIGZyYWdtZW50IDogc3RyaW5nLFxuICBjYXRlZ29yeSA6IHN0cmluZywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+LCBmaWx0ZXJEb21haW4/IDogc3RyaW5nKSA6IHN0cmluZ1tdIHtcbiAgICB2YXIgZnJhZ21lbnRMQyA9IEJyZWFrRG93bi50cmltUXVvdGVkKGZyYWdtZW50LnRvTG93ZXJDYXNlKCkpO1xuICAgIHZhciByZXMgPSBbXTtcbiAgICB2YXIgc2VlbiA9IHt9O1xuICAgIHJlY29yZHMuZm9yRWFjaChmdW5jdGlvbihyZWNvcmQpIHtcbiAgICAgIGlmKGZpbHRlckRvbWFpbiAmJiByZWNvcmQgWydfZG9tYWluJ10gIT09IGZpbHRlckRvbWFpbikge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZihyZWNvcmRbY2F0ZWdvcnldICYmIE9wZXJhdG9yLm1hdGNoZXMob3BlcmF0b3IsIGZyYWdtZW50TEMsIHJlY29yZFtjYXRlZ29yeV0udG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgICAgaWYoIXNlZW5bcmVjb3JkW2NhdGVnb3J5XV0pIHtcbiAgICAgICAgICBzZWVuW3JlY29yZFtjYXRlZ29yeV1dID0gdHJ1ZTtcbiAgICAgICAgICByZXMucHVzaChyZWNvcmRbY2F0ZWdvcnldKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByZW1vdmVDYXNlRHVwbGljYXRlcyhyZXMpO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGxpa2VseVBsdXJhbERpZmYoYSA6IHN0cmluZywgcGx1cmFsT2ZhIDogc3RyaW5nKSA6IGJvb2xlYW4ge1xuICB2YXIgYUxDID0gQnJlYWtEb3duLnRyaW1RdW90ZWQoYS50b0xvd2VyQ2FzZSgpKSAgfHwgXCJcIjtcbiAgdmFyIHBsdXJhbE9mQUxDID0gQnJlYWtEb3duLnRyaW1RdW90ZWQoKHBsdXJhbE9mYSB8fFwiXCIpLnRvTG93ZXJDYXNlKCkpIHx8IFwiXCI7XG4gIGlmIChhTEMgPT09IHBsdXJhbE9mQUxDKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgaWYoIGFMQyArJ3MnID09PSBwbHVyYWxPZkFMQykge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn07XG5cblxuXG5cbmV4cG9ydCBmdW5jdGlvbiBqb2luU29ydGVkUXVvdGVkKHN0cmluZ3MgOiBzdHJpbmdbXSApIDogc3RyaW5nIHtcbiAgaWYgKHN0cmluZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFwiXCI7XG4gIH1cbiAgcmV0dXJuICdcIicgKyBzdHJpbmdzLnNvcnQoKS5qb2luKCdcIjsgXCInKSArICdcIic7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBqb2luRGlzdGluY3QoY2F0ZWdvcnkgOiBzdHJpbmcsIHJlY29yZHMgOiBBcnJheTxJTWF0Y2guSVJlY29yZD4pIDogc3RyaW5nIHtcbiAgdmFyIHJlcyA9IHJlY29yZHMucmVkdWNlKGZ1bmN0aW9uKHByZXYsIG9SZWNvcmQpIHtcbiAgICBwcmV2W29SZWNvcmRbY2F0ZWdvcnldXSA9IDE7XG4gICAgcmV0dXJuIHByZXY7XG4gIH0se30gYXMgYW55KTtcbiAgcmV0dXJuIGpvaW5Tb3J0ZWRRdW90ZWQoT2JqZWN0LmtleXMocmVzKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQoIGFuc3dlcnMgOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4pIDogc3RyaW5nIHtcbiAgcmV0dXJuIGpvaW5Tb3J0ZWRRdW90ZWQoYW5zd2Vycy5tYXAoZnVuY3Rpb24ob0Fuc3dlcikge1xuICAgIHJldHVybiBvQW5zd2VyLnJlc3VsdDtcbiAgfSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gam9pblJlc3VsdHMocmVzdWx0czogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+KTogc3RyaW5nW10ge1xuICB2YXIgcmVzICA9IFtdO1xuICB2YXIgY250ID0gcmVzdWx0cy5yZWR1Y2UoZnVuY3Rpb24gKHByZXYsIHJlc3VsdCkge1xuICAgIGlmIChyZXN1bHQuX3JhbmtpbmcgPT09IHJlc3VsdHNbMF0uX3JhbmtpbmcpIHtcbiAgICAgIGlmKHJlcy5pbmRleE9mKHJlc3VsdC5yZXN1bHQpIDwgMCApe1xuICAgICAgICByZXMucHVzaChyZXN1bHQucmVzdWx0KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBwcmV2ICsgMTtcbiAgICB9XG4gIH0sIDApO1xuICByZXR1cm4gcmVzO1xufVxuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5SZXN1bHRzVHVwZWwocmVzdWx0czogQXJyYXk8SU1hdGNoLklXaGF0SXNUdXBlbEFuc3dlcj4pOiBzdHJpbmdbXSB7XG4gIHZhciByZXMgID0gW107XG4gIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgaWYgKHJlc3VsdC5fcmFua2luZyA9PT0gcmVzdWx0c1swXS5fcmFua2luZykge1xuICAgICAgdmFyIHZhbHVlID0gVXRpbHMubGlzdFRvUXVvdGVkQ29tbWFBbmQocmVzdWx0LnJlc3VsdCk7XG4gICAgICBpZihyZXMuaW5kZXhPZih2YWx1ZSkgPCAwICl7XG4gICAgICAgIHJlcy5wdXNoKHZhbHVlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBwcmV2ICsgMTtcbiAgICB9XG4gIH0sIDApO1xuICByZXR1cm4gcmVzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5mZXJEb21haW4odGhlTW9kZWwgOiBJTWF0Y2guSU1vZGVscywgY29udGV4dFF1ZXJ5U3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcge1xuIC8vIGNvbnNvbGUubG9nKFwiaGVyZSB0aGUgc3RyaW5nXCIgKyBjb250ZXh0UXVlcnlTdHJpbmcpO1xuIC8vICBjb25zb2xlLmxvZyhcImhlcmUgdGhlIHJ1bGVzXCIgKyBKU09OLnN0cmluZ2lmeSh0aGVNb2RlbC5tUnVsZXMpKTtcbiAgdmFyIHJlcyA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgdGhlTW9kZWwucnVsZXMpO1xuICAvL2NvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlcyx1bmRlZmluZWQsMikpO1xuICAvLyBydW4gdGhyb3VnaCB0aGUgc3RyaW5nLCBzZWFyY2ggZm9yIGEgY2F0ZWdvcnlcbiAgaWYoIXJlcy5zZW50ZW5jZXMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICB2YXIgZG9tYWlucyA9IFtdO1xuICAvL2NvbnNvbGUubG9nKFNlbnRlbmNlLmR1bXBOaWNlQXJyKHJlcykpO1xuICAvLyBkbyB3ZSBoYXZlIGEgZG9tYWluID9cbiAgcmVzLnNlbnRlbmNlc1swXS5mb3JFYWNoKGZ1bmN0aW9uKG9Xb3JkR3JvdXApIHtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImRvbWFpblwiKSB7XG4gICAgICBkb21haW5zLnB1c2gob1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nKVxuICAgIH1cbiAgfSk7XG4gIGlmKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgZGVidWdsb2coXCJnb3QgYSBwcmVjaXNlIGRvbWFpbiBcIiArIGRvbWFpbnNbMF0pO1xuICAgIHJldHVybiBkb21haW5zWzBdO1xuICB9XG4gIGlmKGRvbWFpbnMubGVuZ3RoID4gMCApIHtcbiAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkPyAoXCJnb3QgbW9yZSB0aGFuIG9uZSBkb21haW4sIGNvbmZ1c2VkICBcIiArIGRvbWFpbnMuam9pbihcIlxcblwiKSk6Jy0nKTtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIC8vIFRPRE9EXG4gIH1cbiAgZGVidWdsb2coXCJhdHRlbXB0aW5nIHRvIGRldGVybWluZSBjYXRlZ29yaWVzXCIpXG4gIC8vIHRyeSBhIGNhdGVnb3J5IHJldmVyc2UgbWFwXG4gIHJlcy5zZW50ZW5jZXNbMF0uZm9yRWFjaChmdW5jdGlvbihvV29yZEdyb3VwKXtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImNhdGVnb3J5XCIpIHtcbiAgICAgIHZhciBzQ2F0ID0gb1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nO1xuICAgICAgdmFyIGRvbXMgPSBNb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsc0NhdCk7XG4gICAgICBkb21zLmZvckVhY2goZnVuY3Rpb24oc0RvbSkge1xuICAgICAgICBpZihkb21haW5zLmluZGV4T2Yoc0RvbSkgPCAwKSB7XG4gICAgICAgICAgZG9tYWlucy5wdXNoKHNEb20pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuICBpZihkb21haW5zLmxlbmd0aCA9PT0gMSkge1xuICAgICBkZWJ1Z2xvZyhcImdvdCBhIHByZWNpc2UgZG9tYWluIFwiICsgZG9tYWluc1swXSk7XG4gICAgcmV0dXJuIGRvbWFpbnNbMF07XG4gIH1cbiAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcImdvdCBtb3JlIHRoYW4gb25lIGRvbWFpbiwgY29uZnVzZWQgIFwiICsgZG9tYWlucy5qb2luKFwiXFxuXCIpKSA6Jy0nKTtcbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn07IiwiLyoqXG4gKlxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYW5hbHl6ZVxuICogQGZpbGUgYW5hbHl6ZS50c1xuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdsaXN0YWxsJyk7XG52YXIgbG9nZ2VyID0gcmVxdWlyZShcIi4uL3V0aWxzL2xvZ2dlclwiKTtcbnZhciBsb2dQZXJmID0gbG9nZ2VyLnBlcmYoXCJwZXJmbGlzdGFsbFwiKTtcbnZhciBwZXJmbG9nID0gZGVidWcoJ3BlcmYnKTtcbi8vY29uc3QgcGVyZmxvZyA9IGxvZ2dlci5wZXJmKFwicGVyZmxpc3RhbGxcIik7XG52YXIgVXRpbHMgPSByZXF1aXJlKFwiYWJvdF91dGlsc1wiKTtcbnZhciBmZGV2c3RhX21vbm1vdmVfMSA9IHJlcXVpcmUoXCJmZGV2c3RhX21vbm1vdmVcIik7XG52YXIgT3BlcmF0b3IgPSByZXF1aXJlKFwiLi9vcGVyYXRvclwiKTtcbnZhciBXaGF0SXMgPSByZXF1aXJlKFwiLi93aGF0aXNcIik7XG52YXIgYWJvdF9lcmJhc2VfMSA9IHJlcXVpcmUoXCJhYm90X2VyYmFzZVwiKTtcbnZhciBmZGV2c3RhX21vbm1vdmVfMiA9IHJlcXVpcmUoXCJmZGV2c3RhX21vbm1vdmVcIik7XG52YXIgc1dvcmRzID0ge307XG5mdW5jdGlvbiBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5LCByZWNvcmRzKSB7XG4gICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IEpTT04uc3RyaW5naWZ5KHJlY29yZHMsIHVuZGVmaW5lZCwgMikgOiBcIi1cIik7XG4gICAgdmFyIHJlbGV2YW50UmVjb3JkcyA9IHJlY29yZHMuZmlsdGVyKGZ1bmN0aW9uIChyZWNvcmQpIHtcbiAgICAgICAgcmV0dXJuIChyZWNvcmRbY2F0ZWdvcnldICE9PSB1bmRlZmluZWQpICYmIChyZWNvcmRbY2F0ZWdvcnldICE9PSBudWxsKTtcbiAgICB9KTtcbiAgICB2YXIgcmVzID0gW107XG4gICAgZGVidWdsb2coXCJyZWxldmFudCByZWNvcmRzIG5yOlwiICsgcmVsZXZhbnRSZWNvcmRzLmxlbmd0aCk7XG4gICAgcmV0dXJuIHJlbGV2YW50UmVjb3Jkcztcbn1cbmV4cG9ydHMubWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeSA9IG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnk7XG5mdW5jdGlvbiBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHJ1bGVzKSB7XG4gICAgcmV0dXJuIFdoYXRJcy5hbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHJ1bGVzKTtcbn1cbmV4cG9ydHMuYW5hbHl6ZUNvbnRleHRTdHJpbmcgPSBhbmFseXplQ29udGV4dFN0cmluZztcbi8vIGNvbnN0IHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksXG4vLyAgIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwudG9vbHMsIHRoZU1vZGVsLnJlY29yZHMpO1xuZnVuY3Rpb24gbGlzdEFsbFdpdGhDb250ZXh0KGNhdGVnb3J5LCBjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcywgcmVjb3JkcywgZG9tYWluQ2F0ZWdvcnlGaWx0ZXIpIHtcbiAgICB2YXIgcmVzID0gbGlzdEFsbFR1cGVsV2l0aENvbnRleHQoW2NhdGVnb3J5XSwgY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMsIHJlY29yZHMsIGRvbWFpbkNhdGVnb3J5RmlsdGVyKTtcbiAgICB2YXIgYW5zd2VycyA9IHJlcy50dXBlbGFuc3dlcnMubWFwKGZ1bmN0aW9uIChvKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzZW50ZW5jZTogby5zZW50ZW5jZSxcbiAgICAgICAgICAgIHJlY29yZDogby5yZWNvcmQsXG4gICAgICAgICAgICBjYXRlZ29yeTogby5jYXRlZ29yaWVzWzBdLFxuICAgICAgICAgICAgcmVzdWx0OiBvLnJlc3VsdFswXSxcbiAgICAgICAgICAgIF9yYW5raW5nOiBvLl9yYW5raW5nXG4gICAgICAgIH07XG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc2VudGVuY2VzOiByZXMuc2VudGVuY2VzLFxuICAgICAgICBlcnJvcnM6IHJlcy5lcnJvcnMsXG4gICAgICAgIHRva2VuczogcmVzLnRva2VucyxcbiAgICAgICAgYW5zd2VyczogYW5zd2Vyc1xuICAgIH07XG59XG5leHBvcnRzLmxpc3RBbGxXaXRoQ29udGV4dCA9IGxpc3RBbGxXaXRoQ29udGV4dDtcbmZ1bmN0aW9uIGxpc3RBbGxXaXRoQ2F0ZWdvcnkoY2F0ZWdvcnksIHJlY29yZHMpIHtcbiAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5LCByZWNvcmRzKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgZGVidWdsb2coXCIgbGlzdEFsbFdpdGhDYXRlZ29yeTpcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICByZXR1cm4gbWF0Y2hlZEFuc3dlcnM7XG59XG5leHBvcnRzLmxpc3RBbGxXaXRoQ2F0ZWdvcnkgPSBsaXN0QWxsV2l0aENhdGVnb3J5O1xuZnVuY3Rpb24gbGlzdEFsbFR1cGVsV2l0aENvbnRleHQoY2F0ZWdvcmllcywgY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMsIHJlY29yZHMsIGRvbWFpbkNhdGVnb3J5RmlsdGVyKSB7XG4gICAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR1cGVsYW5zd2VyczogW10sXG4gICAgICAgICAgICBlcnJvcnM6IFthYm90X2VyYmFzZV8xLkVyRXJyb3IubWFrZUVycm9yX0VNUFRZX0lOUFVUKCldLFxuICAgICAgICAgICAgdG9rZW5zOiBbXSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgICAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHRcIik7XG4gICAgICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICAgICAgcGVyZmxvZyhcIkxBVFdDIG1hdGNoaW5nIHJlY29yZHMgKHM9XCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5zZW50ZW5jZXMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzUXVpY2tNdWx0aXBsZUNhdGVnb3JpZXMoYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3JpZXMsIHJlY29yZHMsIGRvbWFpbkNhdGVnb3J5RmlsdGVyKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmbG9nKFwiZmlsdGVyaW5nIHRvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLnR1cGVsYW5zd2Vycy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgICAgIHZhciBtYXRjaGVkRmlsdGVyZWQgPSBXaGF0SXMuZmlsdGVyT25seVRvcFJhbmtlZFR1cGVsKG1hdGNoZWRBbnN3ZXJzLnR1cGVsYW5zd2Vycyk7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIkxBVFdDIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkRmlsdGVyZWQsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB9XG4gICAgICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxXaXRoQ29udGV4dCAoYT1cIiArIG1hdGNoZWRGaWx0ZXJlZC5sZW5ndGggKyBcIilcIik7XG4gICAgICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHVwZWxhbnN3ZXJzOiBtYXRjaGVkRmlsdGVyZWQsXG4gICAgICAgICAgICBlcnJvcnM6IGFTZW50ZW5jZXNSZWluZm9yY2VkLmVycm9ycyxcbiAgICAgICAgICAgIHRva2VuczogYVNlbnRlbmNlc1JlaW5mb3JjZWQudG9rZW5zXG4gICAgICAgIH07XG4gICAgfVxufVxuZXhwb3J0cy5saXN0QWxsVHVwZWxXaXRoQ29udGV4dCA9IGxpc3RBbGxUdXBlbFdpdGhDb250ZXh0O1xuZnVuY3Rpb24gZmlsdGVyU3RyaW5nTGlzdEJ5T3Aob3BlcmF0b3IsIGZyYWdtZW50LCBzcmNhcnIpIHtcbiAgICB2YXIgZnJhZ21lbnRMQyA9IGZkZXZzdGFfbW9ubW92ZV8xLkJyZWFrRG93bi50cmltUXVvdGVkU3BhY2VkKGZyYWdtZW50LnRvTG93ZXJDYXNlKCkpO1xuICAgIHJldHVybiBzcmNhcnIuZmlsdGVyKGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgcmV0dXJuIE9wZXJhdG9yLm1hdGNoZXMob3BlcmF0b3IsIGZyYWdtZW50TEMsIHN0ci50b0xvd2VyQ2FzZSgpKTtcbiAgICB9KS5zb3J0KCk7XG59XG5leHBvcnRzLmZpbHRlclN0cmluZ0xpc3RCeU9wID0gZmlsdGVyU3RyaW5nTGlzdEJ5T3A7XG5mdW5jdGlvbiBjb21wYXJlQ2FzZUluc2Vuc2l0aXZlKGEsIGIpIHtcbiAgICB2YXIgciA9IGEudG9Mb3dlckNhc2UoKS5sb2NhbGVDb21wYXJlKGIudG9Mb3dlckNhc2UoKSk7XG4gICAgaWYgKHIpIHtcbiAgICAgICAgcmV0dXJuIHI7XG4gICAgfVxuICAgIHJldHVybiAtYS5sb2NhbGVDb21wYXJlKGIpO1xufVxuLyoqXG4gKiBTb3J0IHN0cmluZyBsaXN0IGNhc2UgaW5zZW5zaXRpdmUsIHRoZW4gcmVtb3ZlIGR1cGxpY2F0ZXMgcmV0YWluaW5nXG4gKiBcImxhcmdlc3RcIiBtYXRjaFxuICovXG5mdW5jdGlvbiByZW1vdmVDYXNlRHVwbGljYXRlcyhhcnIpIHtcbiAgICBhcnIuc29ydChjb21wYXJlQ2FzZUluc2Vuc2l0aXZlKTtcbiAgICBkZWJ1Z2xvZygnc29ydGVkIGFycicgKyBKU09OLnN0cmluZ2lmeShhcnIpKTtcbiAgICByZXR1cm4gYXJyLmZpbHRlcihmdW5jdGlvbiAocywgaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIGluZGV4ID09PSAwIHx8ICgwICE9PSBhcnJbaW5kZXggLSAxXS50b0xvd2VyQ2FzZSgpLmxvY2FsZUNvbXBhcmUocy50b0xvd2VyQ2FzZSgpKSk7XG4gICAgfSk7XG59XG5leHBvcnRzLnJlbW92ZUNhc2VEdXBsaWNhdGVzID0gcmVtb3ZlQ2FzZUR1cGxpY2F0ZXM7XG47XG5mdW5jdGlvbiBnZXRDYXRlZ29yeU9wRmlsdGVyQXNEaXN0aW5jdFN0cmluZ3Mob3BlcmF0b3IsIGZyYWdtZW50LCBjYXRlZ29yeSwgcmVjb3JkcywgZmlsdGVyRG9tYWluKSB7XG4gICAgdmFyIGZyYWdtZW50TEMgPSBmZGV2c3RhX21vbm1vdmVfMS5CcmVha0Rvd24udHJpbVF1b3RlZChmcmFnbWVudC50b0xvd2VyQ2FzZSgpKTtcbiAgICB2YXIgcmVzID0gW107XG4gICAgdmFyIHNlZW4gPSB7fTtcbiAgICByZWNvcmRzLmZvckVhY2goZnVuY3Rpb24gKHJlY29yZCkge1xuICAgICAgICBpZiAoZmlsdGVyRG9tYWluICYmIHJlY29yZFsnX2RvbWFpbiddICE9PSBmaWx0ZXJEb21haW4pIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVjb3JkW2NhdGVnb3J5XSAmJiBPcGVyYXRvci5tYXRjaGVzKG9wZXJhdG9yLCBmcmFnbWVudExDLCByZWNvcmRbY2F0ZWdvcnldLnRvTG93ZXJDYXNlKCkpKSB7XG4gICAgICAgICAgICBpZiAoIXNlZW5bcmVjb3JkW2NhdGVnb3J5XV0pIHtcbiAgICAgICAgICAgICAgICBzZWVuW3JlY29yZFtjYXRlZ29yeV1dID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXMucHVzaChyZWNvcmRbY2F0ZWdvcnldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByZW1vdmVDYXNlRHVwbGljYXRlcyhyZXMpO1xufVxuZXhwb3J0cy5nZXRDYXRlZ29yeU9wRmlsdGVyQXNEaXN0aW5jdFN0cmluZ3MgPSBnZXRDYXRlZ29yeU9wRmlsdGVyQXNEaXN0aW5jdFN0cmluZ3M7XG47XG5mdW5jdGlvbiBsaWtlbHlQbHVyYWxEaWZmKGEsIHBsdXJhbE9mYSkge1xuICAgIHZhciBhTEMgPSBmZGV2c3RhX21vbm1vdmVfMS5CcmVha0Rvd24udHJpbVF1b3RlZChhLnRvTG93ZXJDYXNlKCkpIHx8IFwiXCI7XG4gICAgdmFyIHBsdXJhbE9mQUxDID0gZmRldnN0YV9tb25tb3ZlXzEuQnJlYWtEb3duLnRyaW1RdW90ZWQoKHBsdXJhbE9mYSB8fCBcIlwiKS50b0xvd2VyQ2FzZSgpKSB8fCBcIlwiO1xuICAgIGlmIChhTEMgPT09IHBsdXJhbE9mQUxDKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAoYUxDICsgJ3MnID09PSBwbHVyYWxPZkFMQykge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuZXhwb3J0cy5saWtlbHlQbHVyYWxEaWZmID0gbGlrZWx5UGx1cmFsRGlmZjtcbjtcbmZ1bmN0aW9uIGpvaW5Tb3J0ZWRRdW90ZWQoc3RyaW5ncykge1xuICAgIGlmIChzdHJpbmdzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG4gICAgcmV0dXJuICdcIicgKyBzdHJpbmdzLnNvcnQoKS5qb2luKCdcIjsgXCInKSArICdcIic7XG59XG5leHBvcnRzLmpvaW5Tb3J0ZWRRdW90ZWQgPSBqb2luU29ydGVkUXVvdGVkO1xuZnVuY3Rpb24gam9pbkRpc3RpbmN0KGNhdGVnb3J5LCByZWNvcmRzKSB7XG4gICAgdmFyIHJlcyA9IHJlY29yZHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCBvUmVjb3JkKSB7XG4gICAgICAgIHByZXZbb1JlY29yZFtjYXRlZ29yeV1dID0gMTtcbiAgICAgICAgcmV0dXJuIHByZXY7XG4gICAgfSwge30pO1xuICAgIHJldHVybiBqb2luU29ydGVkUXVvdGVkKE9iamVjdC5rZXlzKHJlcykpO1xufVxuZXhwb3J0cy5qb2luRGlzdGluY3QgPSBqb2luRGlzdGluY3Q7XG5mdW5jdGlvbiBmb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQoYW5zd2Vycykge1xuICAgIHJldHVybiBqb2luU29ydGVkUXVvdGVkKGFuc3dlcnMubWFwKGZ1bmN0aW9uIChvQW5zd2VyKSB7XG4gICAgICAgIHJldHVybiBvQW5zd2VyLnJlc3VsdDtcbiAgICB9KSk7XG59XG5leHBvcnRzLmZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdCA9IGZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdDtcbmZ1bmN0aW9uIGpvaW5SZXN1bHRzKHJlc3VsdHMpIHtcbiAgICB2YXIgcmVzID0gW107XG4gICAgdmFyIGNudCA9IHJlc3VsdHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCByZXN1bHQpIHtcbiAgICAgICAgaWYgKHJlc3VsdC5fcmFua2luZyA9PT0gcmVzdWx0c1swXS5fcmFua2luZykge1xuICAgICAgICAgICAgaWYgKHJlcy5pbmRleE9mKHJlc3VsdC5yZXN1bHQpIDwgMCkge1xuICAgICAgICAgICAgICAgIHJlcy5wdXNoKHJlc3VsdC5yZXN1bHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHByZXYgKyAxO1xuICAgICAgICB9XG4gICAgfSwgMCk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuam9pblJlc3VsdHMgPSBqb2luUmVzdWx0cztcbmZ1bmN0aW9uIGpvaW5SZXN1bHRzVHVwZWwocmVzdWx0cykge1xuICAgIHZhciByZXMgPSBbXTtcbiAgICB2YXIgY250ID0gcmVzdWx0cy5yZWR1Y2UoZnVuY3Rpb24gKHByZXYsIHJlc3VsdCkge1xuICAgICAgICBpZiAocmVzdWx0Ll9yYW5raW5nID09PSByZXN1bHRzWzBdLl9yYW5raW5nKSB7XG4gICAgICAgICAgICB2YXIgdmFsdWUgPSBVdGlscy5saXN0VG9RdW90ZWRDb21tYUFuZChyZXN1bHQucmVzdWx0KTtcbiAgICAgICAgICAgIGlmIChyZXMuaW5kZXhPZih2YWx1ZSkgPCAwKSB7XG4gICAgICAgICAgICAgICAgcmVzLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHByZXYgKyAxO1xuICAgICAgICB9XG4gICAgfSwgMCk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuam9pblJlc3VsdHNUdXBlbCA9IGpvaW5SZXN1bHRzVHVwZWw7XG5mdW5jdGlvbiBpbmZlckRvbWFpbih0aGVNb2RlbCwgY29udGV4dFF1ZXJ5U3RyaW5nKSB7XG4gICAgLy8gY29uc29sZS5sb2coXCJoZXJlIHRoZSBzdHJpbmdcIiArIGNvbnRleHRRdWVyeVN0cmluZyk7XG4gICAgLy8gIGNvbnNvbGUubG9nKFwiaGVyZSB0aGUgcnVsZXNcIiArIEpTT04uc3RyaW5naWZ5KHRoZU1vZGVsLm1SdWxlcykpO1xuICAgIHZhciByZXMgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHRoZU1vZGVsLnJ1bGVzKTtcbiAgICAvL2NvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlcyx1bmRlZmluZWQsMikpO1xuICAgIC8vIHJ1biB0aHJvdWdoIHRoZSBzdHJpbmcsIHNlYXJjaCBmb3IgYSBjYXRlZ29yeVxuICAgIGlmICghcmVzLnNlbnRlbmNlcy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgdmFyIGRvbWFpbnMgPSBbXTtcbiAgICAvL2NvbnNvbGUubG9nKFNlbnRlbmNlLmR1bXBOaWNlQXJyKHJlcykpO1xuICAgIC8vIGRvIHdlIGhhdmUgYSBkb21haW4gP1xuICAgIHJlcy5zZW50ZW5jZXNbMF0uZm9yRWFjaChmdW5jdGlvbiAob1dvcmRHcm91cCkge1xuICAgICAgICBpZiAob1dvcmRHcm91cC5jYXRlZ29yeSA9PT0gXCJkb21haW5cIikge1xuICAgICAgICAgICAgZG9tYWlucy5wdXNoKG9Xb3JkR3JvdXAubWF0Y2hlZFN0cmluZyk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAoZG9tYWlucy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgZGVidWdsb2coXCJnb3QgYSBwcmVjaXNlIGRvbWFpbiBcIiArIGRvbWFpbnNbMF0pO1xuICAgICAgICByZXR1cm4gZG9tYWluc1swXTtcbiAgICB9XG4gICAgaWYgKGRvbWFpbnMubGVuZ3RoID4gMCkge1xuICAgICAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gKFwiZ290IG1vcmUgdGhhbiBvbmUgZG9tYWluLCBjb25mdXNlZCAgXCIgKyBkb21haW5zLmpvaW4oXCJcXG5cIikpIDogJy0nKTtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgZGVidWdsb2coXCJhdHRlbXB0aW5nIHRvIGRldGVybWluZSBjYXRlZ29yaWVzXCIpO1xuICAgIC8vIHRyeSBhIGNhdGVnb3J5IHJldmVyc2UgbWFwXG4gICAgcmVzLnNlbnRlbmNlc1swXS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZEdyb3VwKSB7XG4gICAgICAgIGlmIChvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImNhdGVnb3J5XCIpIHtcbiAgICAgICAgICAgIHZhciBzQ2F0ID0gb1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nO1xuICAgICAgICAgICAgdmFyIGRvbXMgPSBmZGV2c3RhX21vbm1vdmVfMi5Nb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsIHNDYXQpO1xuICAgICAgICAgICAgZG9tcy5mb3JFYWNoKGZ1bmN0aW9uIChzRG9tKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRvbWFpbnMuaW5kZXhPZihzRG9tKSA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgZG9tYWlucy5wdXNoKHNEb20pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgaWYgKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiZ290IGEgcHJlY2lzZSBkb21haW4gXCIgKyBkb21haW5zWzBdKTtcbiAgICAgICAgcmV0dXJuIGRvbWFpbnNbMF07XG4gICAgfVxuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCJnb3QgbW9yZSB0aGFuIG9uZSBkb21haW4sIGNvbmZ1c2VkICBcIiArIGRvbWFpbnMuam9pbihcIlxcblwiKSkgOiAnLScpO1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG59XG5leHBvcnRzLmluZmVyRG9tYWluID0gaW5mZXJEb21haW47XG47XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
