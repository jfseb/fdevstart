"use strict";
/**
 * @file toolmatch
 * @module jfseb.fdevstart.toolmatch
 * @copyright (c) Gerd Forstmann
 *
 * Methods operating on a matched tool,
 *
 * This will unify matching required and optional category words
 * with the requirements of the tool.
 *
 */

Object.defineProperty(exports, "__esModule", { value: true });
// / <reference path="../../lib/node-4.d.ts" />
var debug = require("debug");
var debuglog = debug('toolmatch');
/*
var oToolFLP = {
  'name': 'FLP',
  'requires': { 'systemId': {}, 'client': {} },
  "optional": {
    "fiori intent": {}
  },
  "sets": {
    "intent": {
      "set": [
        "systemId",
        "client",
        "fiori intent"
      ],
      "response": "_urlpattern1"
    },
    "none": {
      "set": [
        "systemId",
        "client"
      ],
      "response": "_urlpattern2"
    }
  }
};
*/
var abot_erbase_1 = require("abot_erbase");
function cmpToolSet(sets, a, b) {
    return -(sets[a].set.length - sets[b].set.length);
}
/**
 * This onyl finds the best matching sets (=longest match)
 * independent of a record
 */
function findMatchingSets(a) {
    var matchingSets = Object.keys(a.tool.sets).filter(function (sSetKey) {
        var oSet = a.tool.sets[sSetKey];
        debuglog('here the set for tool ' + a.tool.name + " " + JSON.stringify(oSet));
        return oSet.set.every(function (category) {
            var word = abot_erbase_1.Sentence.findWordByCategory(a.sentence, category);
            var b = !!(word && word.word !== undefined);
            debuglog("searchign for category " + category + " " + b);
            return b;
        });
    });
    if (matchingSets.length === 0) {
        return []; // undefined;
    }
    var cmpThisToolSet = cmpToolSet.bind(undefined, a.tool.sets);
    matchingSets.sort(cmpThisToolSet);
    debuglog("best sets ordered " + matchingSets.join(","));
    matchingSets = matchingSets.filter(function (sKey) {
        if (!cmpThisToolSet(matchingSets[0], sKey)) {
            return true;
        }
        return false;
    });
    if (matchingSets.length > 1) {
        debuglog("More than one set matches: \"" + matchingSets.join('";"') + "for match:\n" + JSON.stringify(a, undefined, 2));
    }
    return matchingSets.sort();
}
exports.findMatchingSets = findMatchingSets;
function findBestMatchingSet(a) {
    var matchingSets = findMatchingSets(a);
    if (matchingSets && matchingSets.length) {
        return a.tool.sets[matchingSets[0]];
    }
    return undefined;
}
exports.findBestMatchingSet = findBestMatchingSet;
function isMatchingRecord(matchset, setcommand, record) {
    var res = Object.keys(matchset).every(function (category) {
        var value = matchset[category];
        if (value === record[category] || record[category] === '*') {
            return true;
        }
        return false;
    });
    if (!res) {
        return false;
    }
    if (!record[setcommand]) {
        // THROW?
        debuglog("Matching record lacks setcommand" + setcommand + " match:" + JSON.stringify(record) + " match " + JSON.stringify(matchset));
        return false;
    }
    return true;
}
exports.isMatchingRecord = isMatchingRecord;
function makeMatchSet(a, toolset) {
    var res = {};
    toolset.set.forEach(function (category) {
        res[category] = abot_erbase_1.Sentence.findWordByCategory(a.sentence, category).word.matchedString;
    });
    Object.freeze(res);
    return res;
}
exports.makeMatchSet = makeMatchSet;
function findSetRecords(a, setIds, aRecords) {
    var res = [];
    setIds.forEach(function (setId) {
        var set = a.tool.sets[setId];
        var matchset = makeMatchSet(a, set);
        var filteredRecords = aRecords.filter(function (record) {
            return isMatchingRecord(matchset, set.response, record);
        });
        filteredRecords.forEach(function (record) {
            res.push({ setId: setId, record: record });
        });
    });
    // TODO SORT?
    return res;
}
exports.findSetRecords = findSetRecords;
function findFirstSetRecord(toolMatchResult, records) {
    var setIds = findMatchingSets(toolMatchResult);
    var res = findSetRecords(toolMatchResult, setIds, records);
    if (res) {
        return res[0];
    }
    return undefined;
}
exports.findFirstSetRecord = findFirstSetRecord;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hdGNoL3Rvb2xtYXRjaC5qcyIsIi4uL3NyYy9tYXRjaC90b29sbWF0Y2gudHMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWJ1ZyIsInJlcXVpcmUiLCJkZWJ1Z2xvZyIsImFib3RfZXJiYXNlXzEiLCJjbXBUb29sU2V0Iiwic2V0cyIsImEiLCJiIiwic2V0IiwibGVuZ3RoIiwiZmluZE1hdGNoaW5nU2V0cyIsIm1hdGNoaW5nU2V0cyIsImtleXMiLCJ0b29sIiwiZmlsdGVyIiwic1NldEtleSIsIm9TZXQiLCJuYW1lIiwiSlNPTiIsInN0cmluZ2lmeSIsImV2ZXJ5IiwiY2F0ZWdvcnkiLCJ3b3JkIiwiU2VudGVuY2UiLCJmaW5kV29yZEJ5Q2F0ZWdvcnkiLCJzZW50ZW5jZSIsInVuZGVmaW5lZCIsImNtcFRoaXNUb29sU2V0IiwiYmluZCIsInNvcnQiLCJqb2luIiwic0tleSIsImZpbmRCZXN0TWF0Y2hpbmdTZXQiLCJpc01hdGNoaW5nUmVjb3JkIiwibWF0Y2hzZXQiLCJzZXRjb21tYW5kIiwicmVjb3JkIiwicmVzIiwibWFrZU1hdGNoU2V0IiwidG9vbHNldCIsImZvckVhY2giLCJtYXRjaGVkU3RyaW5nIiwiZnJlZXplIiwiZmluZFNldFJlY29yZHMiLCJzZXRJZHMiLCJhUmVjb3JkcyIsInNldElkIiwiZmlsdGVyZWRSZWNvcmRzIiwicmVzcG9uc2UiLCJwdXNoIiwiZmluZEZpcnN0U2V0UmVjb3JkIiwidG9vbE1hdGNoUmVzdWx0IiwicmVjb3JkcyJdLCJtYXBwaW5ncyI6IkFBQUE7QUNBQTs7Ozs7Ozs7Ozs7O0FEWUFBLE9BQU9DLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDLEVBQUVDLE9BQU8sSUFBVCxFQUE3QztBQ0FBO0FBRUEsSUFBQUMsUUFBQUMsUUFBQSxPQUFBLENBQUE7QUFFQSxJQUFNQyxXQUFXRixNQUFNLFdBQU4sQ0FBakI7QUFFQTs7Ozs7Ozs7Ozs7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S0FBVCxFQUFjO0FBQzNCLFlBQUl0QyxNQUFNRixFQUFFTyxJQUFGLENBQU9SLElBQVAsQ0FBWXlDLEtBQVosQ0FBVjtBQUNBLFlBQUlaLFdBQVdJLGFBQWFoQyxDQUFiLEVBQWdCRSxHQUFoQixDQUFmO0FBQ0EsWUFBSXVDLGtCQUFrQkYsU0FBUy9CLE1BQVQsQ0FBZ0IsVUFBU3NCLE1BQVQsRUFBZTtBQUNuRCxtQkFBT0gsaUJBQWlCQyxRQUFqQixFQUEyQjFCLElBQUl3QyxRQUEvQixFQUF5Q1osTUFBekMsQ0FBUDtBQUNELFNBRnFCLENBQXRCO0FBR0FXLHdCQUFnQlAsT0FBaEIsQ0FBd0IsVUFBU0osTUFBVCxFQUFlO0FBQ3JDQyxnQkFBSVksSUFBSixDQUFTLEVBQUVILE9BQVFBLEtBQVYsRUFBaUJWLFFBQVFBLE1BQXpCLEVBQVQ7QUFDRCxTQUZEO0FBR0QsS0FURDtBQVVBO0FBQ0EsV0FBT0MsR0FBUDtBQUNEO0FBZER2QyxRQUFBNkMsY0FBQSxHQUFBQSxjQUFBO0FBZ0JBLFNBQUFPLGtCQUFBLENBQW1DQyxlQUFuQyxFQUF1RUMsT0FBdkUsRUFBZ0c7QUFDOUYsUUFBSVIsU0FBU2xDLGlCQUFpQnlDLGVBQWpCLENBQWI7QUFDQSxRQUFJZCxNQUFNTSxlQUFlUSxlQUFmLEVBQWdDUCxNQUFoQyxFQUF3Q1EsT0FBeEMsQ0FBVjtBQUNBLFFBQUlmLEdBQUosRUFBUztBQUNQLGVBQU9BLElBQUksQ0FBSixDQUFQO0FBQ0Q7QUFDRCxXQUFPWCxTQUFQO0FBQ0Q7QUFQRDVCLFFBQUFvRCxrQkFBQSxHQUFBQSxrQkFBQSIsImZpbGUiOiJtYXRjaC90b29sbWF0Y2guanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbi8qKlxuICogQGZpbGUgdG9vbG1hdGNoXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC50b29sbWF0Y2hcbiAqIEBjb3B5cmlnaHQgKGMpIEdlcmQgRm9yc3RtYW5uXG4gKlxuICogTWV0aG9kcyBvcGVyYXRpbmcgb24gYSBtYXRjaGVkIHRvb2wsXG4gKlxuICogVGhpcyB3aWxsIHVuaWZ5IG1hdGNoaW5nIHJlcXVpcmVkIGFuZCBvcHRpb25hbCBjYXRlZ29yeSB3b3Jkc1xuICogd2l0aCB0aGUgcmVxdWlyZW1lbnRzIG9mIHRoZSB0b29sLlxuICpcbiAqL1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuLy8gLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxuY29uc3QgZGVidWcgPSByZXF1aXJlKFwiZGVidWdcIik7XG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCd0b29sbWF0Y2gnKTtcbi8qXG52YXIgb1Rvb2xGTFAgPSB7XG4gICduYW1lJzogJ0ZMUCcsXG4gICdyZXF1aXJlcyc6IHsgJ3N5c3RlbUlkJzoge30sICdjbGllbnQnOiB7fSB9LFxuICBcIm9wdGlvbmFsXCI6IHtcbiAgICBcImZpb3JpIGludGVudFwiOiB7fVxuICB9LFxuICBcInNldHNcIjoge1xuICAgIFwiaW50ZW50XCI6IHtcbiAgICAgIFwic2V0XCI6IFtcbiAgICAgICAgXCJzeXN0ZW1JZFwiLFxuICAgICAgICBcImNsaWVudFwiLFxuICAgICAgICBcImZpb3JpIGludGVudFwiXG4gICAgICBdLFxuICAgICAgXCJyZXNwb25zZVwiOiBcIl91cmxwYXR0ZXJuMVwiXG4gICAgfSxcbiAgICBcIm5vbmVcIjoge1xuICAgICAgXCJzZXRcIjogW1xuICAgICAgICBcInN5c3RlbUlkXCIsXG4gICAgICAgIFwiY2xpZW50XCJcbiAgICAgIF0sXG4gICAgICBcInJlc3BvbnNlXCI6IFwiX3VybHBhdHRlcm4yXCJcbiAgICB9XG4gIH1cbn07XG4qL1xuY29uc3QgYWJvdF9lcmJhc2VfMSA9IHJlcXVpcmUoXCJhYm90X2VyYmFzZVwiKTtcbmZ1bmN0aW9uIGNtcFRvb2xTZXQoc2V0cywgYSwgYikge1xuICAgIHJldHVybiAtKHNldHNbYV0uc2V0Lmxlbmd0aCAtIHNldHNbYl0uc2V0Lmxlbmd0aCk7XG59XG4vKipcbiAqIFRoaXMgb255bCBmaW5kcyB0aGUgYmVzdCBtYXRjaGluZyBzZXRzICg9bG9uZ2VzdCBtYXRjaClcbiAqIGluZGVwZW5kZW50IG9mIGEgcmVjb3JkXG4gKi9cbmZ1bmN0aW9uIGZpbmRNYXRjaGluZ1NldHMoYSkge1xuICAgIHZhciBtYXRjaGluZ1NldHMgPSBPYmplY3Qua2V5cyhhLnRvb2wuc2V0cykuZmlsdGVyKGZ1bmN0aW9uIChzU2V0S2V5KSB7XG4gICAgICAgIHZhciBvU2V0ID0gYS50b29sLnNldHNbc1NldEtleV07XG4gICAgICAgIGRlYnVnbG9nKCdoZXJlIHRoZSBzZXQgZm9yIHRvb2wgJyArIGEudG9vbC5uYW1lICsgXCIgXCIgKyBKU09OLnN0cmluZ2lmeShvU2V0KSk7XG4gICAgICAgIHJldHVybiBvU2V0LnNldC5ldmVyeShmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgIHZhciB3b3JkID0gYWJvdF9lcmJhc2VfMS5TZW50ZW5jZS5maW5kV29yZEJ5Q2F0ZWdvcnkoYS5zZW50ZW5jZSwgY2F0ZWdvcnkpO1xuICAgICAgICAgICAgdmFyIGIgPSAhISh3b3JkICYmICh3b3JkLndvcmQgIT09IHVuZGVmaW5lZCkpO1xuICAgICAgICAgICAgZGVidWdsb2coXCJzZWFyY2hpZ24gZm9yIGNhdGVnb3J5IFwiICsgY2F0ZWdvcnkgKyBcIiBcIiArIGIpO1xuICAgICAgICAgICAgcmV0dXJuIGI7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIGlmIChtYXRjaGluZ1NldHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBbXTsgLy8gdW5kZWZpbmVkO1xuICAgIH1cbiAgICB2YXIgY21wVGhpc1Rvb2xTZXQgPSBjbXBUb29sU2V0LmJpbmQodW5kZWZpbmVkLCBhLnRvb2wuc2V0cyk7XG4gICAgbWF0Y2hpbmdTZXRzLnNvcnQoY21wVGhpc1Rvb2xTZXQpO1xuICAgIGRlYnVnbG9nKFwiYmVzdCBzZXRzIG9yZGVyZWQgXCIgKyBtYXRjaGluZ1NldHMuam9pbihcIixcIikpO1xuICAgIG1hdGNoaW5nU2V0cyA9IG1hdGNoaW5nU2V0cy5maWx0ZXIoZnVuY3Rpb24gKHNLZXkpIHtcbiAgICAgICAgaWYgKCFjbXBUaGlzVG9vbFNldChtYXRjaGluZ1NldHNbMF0sIHNLZXkpKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG4gICAgaWYgKG1hdGNoaW5nU2V0cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiTW9yZSB0aGFuIG9uZSBzZXQgbWF0Y2hlczogXFxcIlwiICsgbWF0Y2hpbmdTZXRzLmpvaW4oJ1wiO1wiJykgKyBcImZvciBtYXRjaDpcXG5cIiArIEpTT04uc3RyaW5naWZ5KGEsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICByZXR1cm4gbWF0Y2hpbmdTZXRzLnNvcnQoKTtcbn1cbmV4cG9ydHMuZmluZE1hdGNoaW5nU2V0cyA9IGZpbmRNYXRjaGluZ1NldHM7XG5mdW5jdGlvbiBmaW5kQmVzdE1hdGNoaW5nU2V0KGEpIHtcbiAgICB2YXIgbWF0Y2hpbmdTZXRzID0gZmluZE1hdGNoaW5nU2V0cyhhKTtcbiAgICBpZiAobWF0Y2hpbmdTZXRzICYmIG1hdGNoaW5nU2V0cy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGEudG9vbC5zZXRzW21hdGNoaW5nU2V0c1swXV07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG59XG5leHBvcnRzLmZpbmRCZXN0TWF0Y2hpbmdTZXQgPSBmaW5kQmVzdE1hdGNoaW5nU2V0O1xuZnVuY3Rpb24gaXNNYXRjaGluZ1JlY29yZChtYXRjaHNldCwgc2V0Y29tbWFuZCwgcmVjb3JkKSB7XG4gICAgdmFyIHJlcyA9IE9iamVjdC5rZXlzKG1hdGNoc2V0KS5ldmVyeShmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgdmFyIHZhbHVlID0gbWF0Y2hzZXRbY2F0ZWdvcnldO1xuICAgICAgICBpZiAoKHZhbHVlID09PSByZWNvcmRbY2F0ZWdvcnldKSB8fCAocmVjb3JkW2NhdGVnb3J5XSA9PT0gJyonKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0pO1xuICAgIGlmICghcmVzKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKCFyZWNvcmRbc2V0Y29tbWFuZF0pIHtcbiAgICAgICAgLy8gVEhST1c/XG4gICAgICAgIGRlYnVnbG9nKFwiTWF0Y2hpbmcgcmVjb3JkIGxhY2tzIHNldGNvbW1hbmRcIiArIHNldGNvbW1hbmQgKyBcIiBtYXRjaDpcIiArIEpTT04uc3RyaW5naWZ5KHJlY29yZCkgKyBcIiBtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoc2V0KSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG5leHBvcnRzLmlzTWF0Y2hpbmdSZWNvcmQgPSBpc01hdGNoaW5nUmVjb3JkO1xuZnVuY3Rpb24gbWFrZU1hdGNoU2V0KGEsIHRvb2xzZXQpIHtcbiAgICB2YXIgcmVzID0ge307XG4gICAgdG9vbHNldC5zZXQuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgcmVzW2NhdGVnb3J5XSA9IGFib3RfZXJiYXNlXzEuU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KGEuc2VudGVuY2UsIGNhdGVnb3J5KS53b3JkLm1hdGNoZWRTdHJpbmc7XG4gICAgfSk7XG4gICAgT2JqZWN0LmZyZWV6ZShyZXMpO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLm1ha2VNYXRjaFNldCA9IG1ha2VNYXRjaFNldDtcbmZ1bmN0aW9uIGZpbmRTZXRSZWNvcmRzKGEsIHNldElkcywgYVJlY29yZHMpIHtcbiAgICB2YXIgcmVzID0gW107XG4gICAgc2V0SWRzLmZvckVhY2goZnVuY3Rpb24gKHNldElkKSB7XG4gICAgICAgIHZhciBzZXQgPSBhLnRvb2wuc2V0c1tzZXRJZF07XG4gICAgICAgIHZhciBtYXRjaHNldCA9IG1ha2VNYXRjaFNldChhLCBzZXQpO1xuICAgICAgICB2YXIgZmlsdGVyZWRSZWNvcmRzID0gYVJlY29yZHMuZmlsdGVyKGZ1bmN0aW9uIChyZWNvcmQpIHtcbiAgICAgICAgICAgIHJldHVybiBpc01hdGNoaW5nUmVjb3JkKG1hdGNoc2V0LCBzZXQucmVzcG9uc2UsIHJlY29yZCk7XG4gICAgICAgIH0pO1xuICAgICAgICBmaWx0ZXJlZFJlY29yZHMuZm9yRWFjaChmdW5jdGlvbiAocmVjb3JkKSB7XG4gICAgICAgICAgICByZXMucHVzaCh7IHNldElkOiBzZXRJZCwgcmVjb3JkOiByZWNvcmQgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIC8vIFRPRE8gU09SVD9cbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5maW5kU2V0UmVjb3JkcyA9IGZpbmRTZXRSZWNvcmRzO1xuZnVuY3Rpb24gZmluZEZpcnN0U2V0UmVjb3JkKHRvb2xNYXRjaFJlc3VsdCwgcmVjb3Jkcykge1xuICAgIHZhciBzZXRJZHMgPSBmaW5kTWF0Y2hpbmdTZXRzKHRvb2xNYXRjaFJlc3VsdCk7XG4gICAgdmFyIHJlcyA9IGZpbmRTZXRSZWNvcmRzKHRvb2xNYXRjaFJlc3VsdCwgc2V0SWRzLCByZWNvcmRzKTtcbiAgICBpZiAocmVzKSB7XG4gICAgICAgIHJldHVybiByZXNbMF07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG59XG5leHBvcnRzLmZpbmRGaXJzdFNldFJlY29yZCA9IGZpbmRGaXJzdFNldFJlY29yZDtcbiIsIi8qKlxyXG4gKiBAZmlsZSB0b29sbWF0Y2hcclxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQudG9vbG1hdGNoXHJcbiAqIEBjb3B5cmlnaHQgKGMpIEdlcmQgRm9yc3RtYW5uXHJcbiAqXHJcbiAqIE1ldGhvZHMgb3BlcmF0aW5nIG9uIGEgbWF0Y2hlZCB0b29sLFxyXG4gKlxyXG4gKiBUaGlzIHdpbGwgdW5pZnkgbWF0Y2hpbmcgcmVxdWlyZWQgYW5kIG9wdGlvbmFsIGNhdGVnb3J5IHdvcmRzXHJcbiAqIHdpdGggdGhlIHJlcXVpcmVtZW50cyBvZiB0aGUgdG9vbC5cclxuICpcclxuICovXHJcblxyXG4vLyAvIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL2xpYi9ub2RlLTQuZC50c1wiIC8+XHJcblxyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XHJcbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuL2lmbWF0Y2gnO1xyXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCd0b29sbWF0Y2gnKTtcclxuXHJcbi8qXHJcbnZhciBvVG9vbEZMUCA9IHtcclxuICAnbmFtZSc6ICdGTFAnLFxyXG4gICdyZXF1aXJlcyc6IHsgJ3N5c3RlbUlkJzoge30sICdjbGllbnQnOiB7fSB9LFxyXG4gIFwib3B0aW9uYWxcIjoge1xyXG4gICAgXCJmaW9yaSBpbnRlbnRcIjoge31cclxuICB9LFxyXG4gIFwic2V0c1wiOiB7XHJcbiAgICBcImludGVudFwiOiB7XHJcbiAgICAgIFwic2V0XCI6IFtcclxuICAgICAgICBcInN5c3RlbUlkXCIsXHJcbiAgICAgICAgXCJjbGllbnRcIixcclxuICAgICAgICBcImZpb3JpIGludGVudFwiXHJcbiAgICAgIF0sXHJcbiAgICAgIFwicmVzcG9uc2VcIjogXCJfdXJscGF0dGVybjFcIlxyXG4gICAgfSxcclxuICAgIFwibm9uZVwiOiB7XHJcbiAgICAgIFwic2V0XCI6IFtcclxuICAgICAgICBcInN5c3RlbUlkXCIsXHJcbiAgICAgICAgXCJjbGllbnRcIlxyXG4gICAgICBdLFxyXG4gICAgICBcInJlc3BvbnNlXCI6IFwiX3VybHBhdHRlcm4yXCJcclxuICAgIH1cclxuICB9XHJcbn07XHJcbiovXHJcblxyXG5pbXBvcnQgeyBTZW50ZW5jZSBhcyBTZW50ZW5jZX0gZnJvbSAnYWJvdF9lcmJhc2UnO1xyXG5cclxuZnVuY3Rpb24gY21wVG9vbFNldChzZXRzIDogSU1hdGNoLklUb29sU2V0cywgYSA6IHN0cmluZywgYjpzdHJpbmcpIHtcclxuICByZXR1cm4gLShzZXRzW2FdLnNldC5sZW5ndGggLSBzZXRzW2JdLnNldC5sZW5ndGgpO1xyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqIFRoaXMgb255bCBmaW5kcyB0aGUgYmVzdCBtYXRjaGluZyBzZXRzICg9bG9uZ2VzdCBtYXRjaClcclxuICogaW5kZXBlbmRlbnQgb2YgYSByZWNvcmRcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kTWF0Y2hpbmdTZXRzKGEgOiBJTWF0Y2guSVRvb2xNYXRjaCApIDogc3RyaW5nW10ge1xyXG4gIHZhciBtYXRjaGluZ1NldHMgPSBPYmplY3Qua2V5cyhhLnRvb2wuc2V0cykuZmlsdGVyKGZ1bmN0aW9uKHNTZXRLZXkpIHtcclxuICAgIHZhciBvU2V0ID0gYS50b29sLnNldHNbc1NldEtleV07XHJcbiAgICBkZWJ1Z2xvZygnaGVyZSB0aGUgc2V0IGZvciB0b29sICcgKyBhLnRvb2wubmFtZSArIFwiIFwiICsgSlNPTi5zdHJpbmdpZnkob1NldCkpO1xyXG4gICAgcmV0dXJuIG9TZXQuc2V0LmV2ZXJ5KGZ1bmN0aW9uKGNhdGVnb3J5IDogc3RyaW5nKSA6Ym9vbGVhbiB7XHJcbiAgICAgIHZhciB3b3JkID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KGEuc2VudGVuY2UsIGNhdGVnb3J5KTtcclxuICAgICAgdmFyIGIgPSAhISh3b3JkICYmICh3b3JkLndvcmQgIT09IHVuZGVmaW5lZCkpO1xyXG4gICAgICBkZWJ1Z2xvZyhcInNlYXJjaGlnbiBmb3IgY2F0ZWdvcnkgXCIgKyBjYXRlZ29yeSArIFwiIFwiICsgYik7XHJcbiAgICAgIHJldHVybiBiO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbiAgaWYobWF0Y2hpbmdTZXRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgcmV0dXJuIFtdOyAvLyB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIHZhciBjbXBUaGlzVG9vbFNldCA9IGNtcFRvb2xTZXQuYmluZCh1bmRlZmluZWQsIGEudG9vbC5zZXRzKTtcclxuICBtYXRjaGluZ1NldHMuc29ydChjbXBUaGlzVG9vbFNldCk7XHJcbiAgZGVidWdsb2coXCJiZXN0IHNldHMgb3JkZXJlZCBcIiArIG1hdGNoaW5nU2V0cy5qb2luKFwiLFwiKSk7XHJcbiAgbWF0Y2hpbmdTZXRzID0gbWF0Y2hpbmdTZXRzLmZpbHRlcihmdW5jdGlvbihzS2V5KSB7XHJcbiAgICBpZighY21wVGhpc1Rvb2xTZXQobWF0Y2hpbmdTZXRzWzBdLHNLZXkpKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0pO1xyXG4gIGlmIChtYXRjaGluZ1NldHMubGVuZ3RoID4gMSkge1xyXG4gICAgZGVidWdsb2coXCJNb3JlIHRoYW4gb25lIHNldCBtYXRjaGVzOiBcXFwiXCIgKyBtYXRjaGluZ1NldHMuam9pbignXCI7XCInKSArIFwiZm9yIG1hdGNoOlxcblwiICsgSlNPTi5zdHJpbmdpZnkoYSwgdW5kZWZpbmVkLDIpKVxyXG4gIH1cclxuICByZXR1cm4gbWF0Y2hpbmdTZXRzLnNvcnQoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRCZXN0TWF0Y2hpbmdTZXQoYSA6IElNYXRjaC5JVG9vbE1hdGNoKSA6IElNYXRjaC5JVG9vbFNldCB7XHJcbiAgdmFyIG1hdGNoaW5nU2V0cyA9IGZpbmRNYXRjaGluZ1NldHMoYSk7XHJcbiAgaWYobWF0Y2hpbmdTZXRzICYmIG1hdGNoaW5nU2V0cy5sZW5ndGgpIHtcclxuICAgIHJldHVybiBhLnRvb2wuc2V0c1ttYXRjaGluZ1NldHNbMF1dO1xyXG4gIH1cclxuICByZXR1cm4gdW5kZWZpbmVkO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzTWF0Y2hpbmdSZWNvcmQoIG1hdGNoc2V0IDogSU1hdGNoLklNYXRjaFNldCwgc2V0Y29tbWFuZCA6IHN0cmluZywgcmVjb3JkIDogSU1hdGNoLklSZWNvcmQpIHtcclxuXHJcbiAgdmFyIHJlcyA9IE9iamVjdC5rZXlzKG1hdGNoc2V0KS5ldmVyeShmdW5jdGlvbihjYXRlZ29yeSkge1xyXG4gICAgdmFyIHZhbHVlID0gbWF0Y2hzZXRbY2F0ZWdvcnldO1xyXG4gICAgaWYgKCh2YWx1ZSA9PT0gcmVjb3JkW2NhdGVnb3J5XSkgfHwgIChyZWNvcmRbY2F0ZWdvcnldID09PSAnKicpKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0pO1xyXG4gIGlmKCFyZXMpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbiAgaWYoIXJlY29yZFtzZXRjb21tYW5kXSkge1xyXG4gICAgLy8gVEhST1c/XHJcbiAgICBkZWJ1Z2xvZyhcIk1hdGNoaW5nIHJlY29yZCBsYWNrcyBzZXRjb21tYW5kXCIgKyBzZXRjb21tYW5kICsgXCIgbWF0Y2g6XCIgKyBKU09OLnN0cmluZ2lmeShyZWNvcmQpICsgXCIgbWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaHNldCkgKVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gfVxyXG4gIHJldHVybiB0cnVlO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZU1hdGNoU2V0KGEgOiBJTWF0Y2guSVRvb2xNYXRjaCwgdG9vbHNldCA6IElNYXRjaC5JVG9vbFNldCkgOiBJTWF0Y2guSU1hdGNoU2V0IHtcclxuICB2YXIgcmVzID0ge30gYXMgSU1hdGNoLklNYXRjaFNldDtcclxuICB0b29sc2V0LnNldC5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7XHJcbiAgICByZXNbY2F0ZWdvcnldID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KGEuc2VudGVuY2UsIGNhdGVnb3J5KS53b3JkLm1hdGNoZWRTdHJpbmc7XHJcbiAgfSk7XHJcbiAgT2JqZWN0LmZyZWV6ZShyZXMpO1xyXG4gIHJldHVybiByZXM7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZFNldFJlY29yZHMoYSA6IElNYXRjaC5JVG9vbE1hdGNoLCBzZXRJZHMgOiBzdHJpbmdbXSwgYVJlY29yZHMgOiBJTWF0Y2guSVJlY29yZFtdKSA6IElNYXRjaC5JTWF0Y2hlZFNldFJlY29yZHMge1xyXG4gIHZhciByZXMgPSBbXSBhcyBJTWF0Y2guSU1hdGNoZWRTZXRSZWNvcmRbXTtcclxuICBzZXRJZHMuZm9yRWFjaChmdW5jdGlvbihzZXRJZCkge1xyXG4gICAgdmFyIHNldCA9IGEudG9vbC5zZXRzW3NldElkXTtcclxuICAgIHZhciBtYXRjaHNldCA9IG1ha2VNYXRjaFNldChhLCBzZXQpO1xyXG4gICAgdmFyIGZpbHRlcmVkUmVjb3JkcyA9IGFSZWNvcmRzLmZpbHRlcihmdW5jdGlvbihyZWNvcmQpIHtcclxuICAgICAgcmV0dXJuIGlzTWF0Y2hpbmdSZWNvcmQobWF0Y2hzZXQsIHNldC5yZXNwb25zZSwgcmVjb3JkKTtcclxuICAgIH0pXHJcbiAgICBmaWx0ZXJlZFJlY29yZHMuZm9yRWFjaChmdW5jdGlvbihyZWNvcmQpIHtcclxuICAgICAgcmVzLnB1c2goeyBzZXRJZCA6IHNldElkLCByZWNvcmQ6IHJlY29yZH0pO1xyXG4gICAgfSlcclxuICB9KVxyXG4gIC8vIFRPRE8gU09SVD9cclxuICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZEZpcnN0U2V0UmVjb3JkKHRvb2xNYXRjaFJlc3VsdDogSU1hdGNoLklUb29sTWF0Y2gsIHJlY29yZHM6IElNYXRjaC5JUmVjb3JkW10pIDogSU1hdGNoLklNYXRjaGVkU2V0UmVjb3JkIHtcclxuICB2YXIgc2V0SWRzID0gZmluZE1hdGNoaW5nU2V0cyh0b29sTWF0Y2hSZXN1bHQpO1xyXG4gIHZhciByZXMgPSBmaW5kU2V0UmVjb3Jkcyh0b29sTWF0Y2hSZXN1bHQsIHNldElkcywgcmVjb3Jkcyk7XHJcbiAgaWYgKHJlcykge1xyXG4gICAgcmV0dXJuIHJlc1swXTtcclxuICB9XHJcbiAgcmV0dXJuIHVuZGVmaW5lZDtcclxufVxyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
