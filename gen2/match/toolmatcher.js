"use strict";
/**
 * @file toolmatcher
 * @module jfseb.fdevstart.toolmatcher
 * @copyright (c) Gerd Forstmann
 *
 * Match a tool record on a sentence,
 *
 * This will unify matching required and optional category words
 * with the requirements of the tool.
 *
 */

Object.defineProperty(exports, "__esModule", { value: true });
// / <reference path="../../lib/node-4.d.ts" />
var debug = require("debug");
var Utils = require("abot_utils");
var abot_erbase_1 = require("abot_erbase");
var abot_erbase_2 = require("abot_erbase");
var Word = abot_erbase_2.Word.Word;
var Category = abot_erbase_2.Word.Category;
var debuglog = debug('toolmatcher');
function matchTool(oSentence, oTool) {
    var used = {};
    var required = {};
    var optional = {};
    var matched = {};
    var spurious = {};
    var toolmentioned = [];
    Object.keys(oTool.requires || {}).forEach(function (sCategory) {
        var _a = abot_erbase_1.Sentence.findWordByCategory(oSentence, sCategory),
            word = _a.word,
            index = _a.index;
        if (word) {
            matched[word] = "required";
            used[index] = 1;
            required[sCategory] = word;
        }
    });
    Object.keys(oTool.optional || {}).forEach(function (sCategory) {
        var _a = abot_erbase_1.Sentence.findWordByCategory(oSentence, sCategory),
            word = _a.word,
            index = _a.index;
        if (word) {
            matched[word] = "optional";
            used[index] = 1;
            optional[sCategory] = word;
        }
    });
    oSentence.forEach(function (oWord, index) {
        if (!used[index] && !Word.isFiller(oWord) && !Word.isCategory(oWord)) {
            debuglog("have spurious word" + JSON.stringify(oWord));
            if (!used[index] && oWord.category === Category.CAT_TOOL && oWord.matchedString === oTool.name) {
                toolmentioned.push(oWord);
            } else {
                spurious[oWord.matchedString] = 1;
            }
        }
    });
    debuglog('satisfied : ' + Object.keys(oTool.requires).join(";"));
    debuglog('required  : ' + Object.keys(oTool.requires).join(";"));
    var missing = Utils.ArrayUtils.setMinus(Object.keys(oTool.requires), Object.keys(required)).reduce(function (map, sKey) {
        map[sKey] = 1;
        return map;
    }, {});
    return {
        required: required,
        missing: missing,
        optional: optional,
        spurious: spurious,
        toolmentioned: toolmentioned
    };
}
exports.matchTool = matchTool;
var match = require("./match");
var ToolMatch = match.ToolMatch;
function matchTools(aSentences, aTool) {
    //var stream = new streamutils.MatchStream();
    debuglog("matchTools: sentences \n" + aSentences.map(function (oSentence, index) {
        return index < 30 ? "[" + index + "]" + abot_erbase_1.Sentence.rankingProduct(oSentence) + ":" + abot_erbase_1.Sentence.dumpNice(oSentence) : "\n";
    }).join("\n"));
    var result = [];
    aTool.forEach(function (oTool) {
        aSentences.forEach(function (oSentence) {
            var toolmatchresult = matchTool(oSentence, oTool);
            var toolmatch = {
                toolmatchresult: toolmatchresult,
                sentence: oSentence,
                tool: oTool,
                rank: 0
            };
            toolmatch.rank = ToolMatch.rankResult(toolmatch.toolmatchresult);
            if (ToolMatch.isAnyMatch(toolmatch)) {
                result.push(toolmatch);
            }
        });
    });
    result.sort(ToolMatch.compBetterMatch);
    if (debuglog.enabled) {
        debuglog("matchTools: ranked toolmatches\n" + result.map(function (otoolmatch) {
            return abot_erbase_1.Sentence.dumpNice(otoolmatch.sentence) + JSON.stringify(otoolmatch);
        }).join("\n"));
    }
    return result;
}
exports.matchTools = matchTools;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hdGNoL3Rvb2xtYXRjaGVyLmpzIiwiLi4vc3JjL21hdGNoL3Rvb2xtYXRjaGVyLnRzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZGVidWciLCJyZXF1aXJlIiwiVXRpbHMiLCJhYm90X2VyYmFzZV8xIiwiYWJvdF9lcmJhc2VfMiIsIldvcmQiLCJDYXRlZ29yeSIsImRlYnVnbG9nIiwibWF0Y2hUb29sIiwib1NlbnRlbmNlIiwib1Rvb2wiLCJ1c2VkIiwicmVxdWlyZWQiLCJvcHRpb25hbCIsIm1hdGNoZWQiLCJzcHVyaW91cyIsInRvb2xtZW50aW9uZWQiLCJrZXlzIiwicmVxdWlyZXMiLCJmb3JFYWNoIiwic0NhdGVnb3J5IiwiX2EiLCJTZW50ZW5jZSIsImZpbmRXb3JkQnlDYXRlZ29yeSIsIndvcmQiLCJpbmRleCIsIm9Xb3JkIiwiaXNGaWxsZXIiLCJpc0NhdGVnb3J5IiwiSlNPTiIsInN0cmluZ2lmeSIsImNhdGVnb3J5IiwiQ0FUX1RPT0wiLCJtYXRjaGVkU3RyaW5nIiwibmFtZSIsInB1c2giLCJqb2luIiwibWlzc2luZyIsIkFycmF5VXRpbHMiLCJzZXRNaW51cyIsInJlZHVjZSIsIm1hcCIsInNLZXkiLCJtYXRjaCIsIlRvb2xNYXRjaCIsIm1hdGNoVG9vbHMiLCJhU2VudGVuY2VzIiwiYVRvb2wiLCJyYW5raW5nUHJvZHVjdCIsImR1bXBOaWNlIiwicmVzdWx0IiwidG9vbG1hdGNocmVzdWx0IiwidG9vbG1hdGNoIiwic2VudGVuY2UiLCJ0b29sIiwicmFuayIsInJhbmtSZXN1bHQiLCJpc0FueU1hdGNoIiwic29ydCIsImNvbXBCZXR0ZXJNYXRjaCIsImVuYWJsZWQiLCJvdG9vbG1hdGNoIl0sIm1hcHBpbmdzIjoiQUFBQTtBQ0FBOzs7Ozs7Ozs7Ozs7QURZQUEsT0FBT0MsY0FBUCxDQUFzQkMsT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkMsRUFBRUMsT0FBTyxJQUFULEVBQTdDO0FD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Rkk7QUFHZDZDLHNCQUFPNUMsS0FITztBQUlkNkMsc0JBQU87QUFKTyxhQUFoQjtBQU1BSCxzQkFBVUcsSUFBVixHQUFpQlgsVUFBVVksVUFBVixDQUFxQkosVUFBVUQsZUFBL0IsQ0FBakI7QUFDQSxnQkFBSVAsVUFBVWEsVUFBVixDQUFxQkwsU0FBckIsQ0FBSixFQUFxQztBQUNuQ0YsdUJBQU9mLElBQVAsQ0FBWWlCLFNBQVo7QUFDRDtBQUNGLFNBWkQ7QUFhRCxLQWREO0FBZUFGLFdBQU9RLElBQVAsQ0FBWWQsVUFBVWUsZUFBdEI7QUFFQSxRQUFHcEQsU0FBU3FELE9BQVosRUFBcUI7QUFDbkJyRCxpQkFBUyxxQ0FDUDJDLE9BQU9ULEdBQVAsQ0FBVyxVQUFTb0IsVUFBVCxFQUFtQjtBQUM1QixtQkFBTzFELGNBQUFtQixRQUFBLENBQVMyQixRQUFULENBQWtCWSxXQUFXUixRQUE3QixJQUF5Q3hCLEtBQUtDLFNBQUwsQ0FBZStCLFVBQWYsQ0FBaEQ7QUFDRCxTQUZELEVBRUd6QixJQUZILENBRVEsSUFGUixDQURGO0FBS0Q7QUFDRCxXQUFPYyxNQUFQO0FBQ0Q7QUFoQ0RwRCxRQUFBK0MsVUFBQSxHQUFBQSxVQUFBIiwiZmlsZSI6Im1hdGNoL3Rvb2xtYXRjaGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vKipcbiAqIEBmaWxlIHRvb2xtYXRjaGVyXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC50b29sbWF0Y2hlclxuICogQGNvcHlyaWdodCAoYykgR2VyZCBGb3JzdG1hbm5cbiAqXG4gKiBNYXRjaCBhIHRvb2wgcmVjb3JkIG9uIGEgc2VudGVuY2UsXG4gKlxuICogVGhpcyB3aWxsIHVuaWZ5IG1hdGNoaW5nIHJlcXVpcmVkIGFuZCBvcHRpb25hbCBjYXRlZ29yeSB3b3Jkc1xuICogd2l0aCB0aGUgcmVxdWlyZW1lbnRzIG9mIHRoZSB0b29sLlxuICpcbiAqL1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuLy8gLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIFV0aWxzID0gcmVxdWlyZShcImFib3RfdXRpbHNcIik7XG52YXIgYWJvdF9lcmJhc2VfMSA9IHJlcXVpcmUoXCJhYm90X2VyYmFzZVwiKTtcbnZhciBhYm90X2VyYmFzZV8yID0gcmVxdWlyZShcImFib3RfZXJiYXNlXCIpO1xudmFyIFdvcmQgPSBhYm90X2VyYmFzZV8yLldvcmQuV29yZDtcbnZhciBDYXRlZ29yeSA9IGFib3RfZXJiYXNlXzIuV29yZC5DYXRlZ29yeTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCd0b29sbWF0Y2hlcicpO1xuZnVuY3Rpb24gbWF0Y2hUb29sKG9TZW50ZW5jZSwgb1Rvb2wpIHtcbiAgICB2YXIgdXNlZCA9IHt9O1xuICAgIHZhciByZXF1aXJlZCA9IHt9O1xuICAgIHZhciBvcHRpb25hbCA9IHt9O1xuICAgIHZhciBtYXRjaGVkID0ge307XG4gICAgdmFyIHNwdXJpb3VzID0ge307XG4gICAgdmFyIHRvb2xtZW50aW9uZWQgPSBbXTtcbiAgICBPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcyB8fCB7fSkuZm9yRWFjaChmdW5jdGlvbiAoc0NhdGVnb3J5KSB7XG4gICAgICAgIHZhciBfYSA9IGFib3RfZXJiYXNlXzEuU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KG9TZW50ZW5jZSwgc0NhdGVnb3J5KSwgd29yZCA9IF9hLndvcmQsIGluZGV4ID0gX2EuaW5kZXg7XG4gICAgICAgIGlmICh3b3JkKSB7XG4gICAgICAgICAgICBtYXRjaGVkW3dvcmRdID0gXCJyZXF1aXJlZFwiO1xuICAgICAgICAgICAgdXNlZFtpbmRleF0gPSAxO1xuICAgICAgICAgICAgcmVxdWlyZWRbc0NhdGVnb3J5XSA9IHdvcmQ7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBPYmplY3Qua2V5cyhvVG9vbC5vcHRpb25hbCB8fCB7fSkuZm9yRWFjaChmdW5jdGlvbiAoc0NhdGVnb3J5KSB7XG4gICAgICAgIHZhciBfYSA9IGFib3RfZXJiYXNlXzEuU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KG9TZW50ZW5jZSwgc0NhdGVnb3J5KSwgd29yZCA9IF9hLndvcmQsIGluZGV4ID0gX2EuaW5kZXg7XG4gICAgICAgIGlmICh3b3JkKSB7XG4gICAgICAgICAgICBtYXRjaGVkW3dvcmRdID0gXCJvcHRpb25hbFwiO1xuICAgICAgICAgICAgdXNlZFtpbmRleF0gPSAxO1xuICAgICAgICAgICAgb3B0aW9uYWxbc0NhdGVnb3J5XSA9IHdvcmQ7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBvU2VudGVuY2UuZm9yRWFjaChmdW5jdGlvbiAob1dvcmQsIGluZGV4KSB7XG4gICAgICAgIGlmICghdXNlZFtpbmRleF0gJiYgIVdvcmQuaXNGaWxsZXIob1dvcmQpICYmICFXb3JkLmlzQ2F0ZWdvcnkob1dvcmQpKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcImhhdmUgc3B1cmlvdXMgd29yZFwiICsgSlNPTi5zdHJpbmdpZnkob1dvcmQpKTtcbiAgICAgICAgICAgIGlmICghdXNlZFtpbmRleF0gJiYgb1dvcmQuY2F0ZWdvcnkgPT09IENhdGVnb3J5LkNBVF9UT09MICYmIG9Xb3JkLm1hdGNoZWRTdHJpbmcgPT09IG9Ub29sLm5hbWUpIHtcbiAgICAgICAgICAgICAgICB0b29sbWVudGlvbmVkLnB1c2gob1dvcmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgc3B1cmlvdXNbb1dvcmQubWF0Y2hlZFN0cmluZ10gPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG4gICAgZGVidWdsb2coJ3NhdGlzZmllZCA6ICcgKyBPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcykuam9pbihcIjtcIikpO1xuICAgIGRlYnVnbG9nKCdyZXF1aXJlZCAgOiAnICsgT2JqZWN0LmtleXMob1Rvb2wucmVxdWlyZXMpLmpvaW4oXCI7XCIpKTtcbiAgICB2YXIgbWlzc2luZyA9IFV0aWxzLkFycmF5VXRpbHMuc2V0TWludXMoT2JqZWN0LmtleXMob1Rvb2wucmVxdWlyZXMpLCBPYmplY3Qua2V5cyhyZXF1aXJlZCkpLnJlZHVjZShmdW5jdGlvbiAobWFwLCBzS2V5KSB7XG4gICAgICAgIG1hcFtzS2V5XSA9IDE7XG4gICAgICAgIHJldHVybiBtYXA7XG4gICAgfSwge30pO1xuICAgIHJldHVybiB7XG4gICAgICAgIHJlcXVpcmVkOiByZXF1aXJlZCxcbiAgICAgICAgbWlzc2luZzogbWlzc2luZyxcbiAgICAgICAgb3B0aW9uYWw6IG9wdGlvbmFsLFxuICAgICAgICBzcHVyaW91czogc3B1cmlvdXMsXG4gICAgICAgIHRvb2xtZW50aW9uZWQ6IHRvb2xtZW50aW9uZWRcbiAgICB9O1xufVxuZXhwb3J0cy5tYXRjaFRvb2wgPSBtYXRjaFRvb2w7XG52YXIgbWF0Y2ggPSByZXF1aXJlKFwiLi9tYXRjaFwiKTtcbnZhciBUb29sTWF0Y2ggPSBtYXRjaC5Ub29sTWF0Y2g7XG5mdW5jdGlvbiBtYXRjaFRvb2xzKGFTZW50ZW5jZXMsIGFUb29sKSB7XG4gICAgLy92YXIgc3RyZWFtID0gbmV3IHN0cmVhbXV0aWxzLk1hdGNoU3RyZWFtKCk7XG4gICAgZGVidWdsb2coXCJtYXRjaFRvb2xzOiBzZW50ZW5jZXMgXFxuXCIgK1xuICAgICAgICBhU2VudGVuY2VzLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlLCBpbmRleCkge1xuICAgICAgICAgICAgcmV0dXJuIChpbmRleCA8IDMwKSA/IFwiW1wiICsgaW5kZXggKyBcIl1cIiArIGFib3RfZXJiYXNlXzEuU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgYWJvdF9lcmJhc2VfMS5TZW50ZW5jZS5kdW1wTmljZShvU2VudGVuY2UpIDogXCJcXG5cIjtcbiAgICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgdmFyIHJlc3VsdCA9IFtdO1xuICAgIGFUb29sLmZvckVhY2goZnVuY3Rpb24gKG9Ub29sKSB7XG4gICAgICAgIGFTZW50ZW5jZXMuZm9yRWFjaChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICAgICAgICB2YXIgdG9vbG1hdGNocmVzdWx0ID0gbWF0Y2hUb29sKG9TZW50ZW5jZSwgb1Rvb2wpO1xuICAgICAgICAgICAgdmFyIHRvb2xtYXRjaCA9IHtcbiAgICAgICAgICAgICAgICB0b29sbWF0Y2hyZXN1bHQ6IHRvb2xtYXRjaHJlc3VsdCxcbiAgICAgICAgICAgICAgICBzZW50ZW5jZTogb1NlbnRlbmNlLFxuICAgICAgICAgICAgICAgIHRvb2w6IG9Ub29sLFxuICAgICAgICAgICAgICAgIHJhbms6IDBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0b29sbWF0Y2gucmFuayA9IFRvb2xNYXRjaC5yYW5rUmVzdWx0KHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQpO1xuICAgICAgICAgICAgaWYgKFRvb2xNYXRjaC5pc0FueU1hdGNoKHRvb2xtYXRjaCkpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0b29sbWF0Y2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXN1bHQuc29ydChUb29sTWF0Y2guY29tcEJldHRlck1hdGNoKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcIm1hdGNoVG9vbHM6IHJhbmtlZCB0b29sbWF0Y2hlc1xcblwiICtcbiAgICAgICAgICAgIHJlc3VsdC5tYXAoZnVuY3Rpb24gKG90b29sbWF0Y2gpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYWJvdF9lcmJhc2VfMS5TZW50ZW5jZS5kdW1wTmljZShvdG9vbG1hdGNoLnNlbnRlbmNlKSArIEpTT04uc3RyaW5naWZ5KG90b29sbWF0Y2gpO1xuICAgICAgICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG59XG5leHBvcnRzLm1hdGNoVG9vbHMgPSBtYXRjaFRvb2xzO1xuIiwiLyoqXG4gKiBAZmlsZSB0b29sbWF0Y2hlclxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQudG9vbG1hdGNoZXJcbiAqIEBjb3B5cmlnaHQgKGMpIEdlcmQgRm9yc3RtYW5uXG4gKlxuICogTWF0Y2ggYSB0b29sIHJlY29yZCBvbiBhIHNlbnRlbmNlLFxuICpcbiAqIFRoaXMgd2lsbCB1bmlmeSBtYXRjaGluZyByZXF1aXJlZCBhbmQgb3B0aW9uYWwgY2F0ZWdvcnkgd29yZHNcbiAqIHdpdGggdGhlIHJlcXVpcmVtZW50cyBvZiB0aGUgdG9vbC5cbiAqXG4gKi9cblxuLy8gLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxuXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5cbmltcG9ydCB7IElGRXJCYXNlIGFzIElNYXRjaCB9IGZyb20gJ2Fib3RfZXJiYXNlJztcbmltcG9ydCB7IElGTW9kZWwgYXMgSUZNb2RlbCB9IGZyb20gJ2ZkZXZzdGFfbW9ubW92ZSc7XG5cbmltcG9ydCAqIGFzIFV0aWxzIGZyb20gJ2Fib3RfdXRpbHMnO1xuaW1wb3J0IHsgU2VudGVuY2UgYXMgU2VudGVuY2V9IGZyb20gJ2Fib3RfZXJiYXNlJztcblxuaW1wb3J0IHsgV29yZCBhcyBPcHNXb3JkIH0gIGZyb20gJ2Fib3RfZXJiYXNlJztcblxuY29uc3QgV29yZCA9IE9wc1dvcmQuV29yZDtcbmNvbnN0IENhdGVnb3J5ID0gT3BzV29yZC5DYXRlZ29yeTtcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygndG9vbG1hdGNoZXInKTtcblxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoVG9vbChvU2VudGVuY2U6IElNYXRjaC5JU2VudGVuY2UsIG9Ub29sOiBJRk1vZGVsLklUb29sKTogSU1hdGNoLklUb29sTWF0Y2hSZXN1bHQge1xuICB2YXIgdXNlZCA9IHt9IGFzIHsgW2tleTogbnVtYmVyXTogbnVtYmVyIH07XG4gIHZhciByZXF1aXJlZCA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogSU1hdGNoLklXb3JkIH07XG4gIHZhciBvcHRpb25hbCA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogSU1hdGNoLklXb3JkIH07XG4gIHZhciBtYXRjaGVkID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgdmFyIHNwdXJpb3VzID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfTtcbiAgdmFyIHRvb2xtZW50aW9uZWQgPSBbXSBhcyBBcnJheTxJTWF0Y2guSVdvcmQ+O1xuICBPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcyB8fCB7fSkuZm9yRWFjaChmdW5jdGlvbiAoc0NhdGVnb3J5OiBzdHJpbmcpIHtcbiAgICBsZXQgeyB3b3JkLCBpbmRleCB9ID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KG9TZW50ZW5jZSwgc0NhdGVnb3J5KTtcbiAgICBpZiAod29yZCkge1xuICAgICAgbWF0Y2hlZFt3b3JkIGFzIGFueV0gPSBcInJlcXVpcmVkXCI7XG4gICAgICB1c2VkW2luZGV4XSA9IDE7XG4gICAgICByZXF1aXJlZFtzQ2F0ZWdvcnldID0gd29yZDtcbiAgICB9XG4gIH0pO1xuICBPYmplY3Qua2V5cyhvVG9vbC5vcHRpb25hbCB8fCB7fSkuZm9yRWFjaChmdW5jdGlvbiAoc0NhdGVnb3J5OiBzdHJpbmcpIHtcbiAgICB2YXIgeyB3b3JkLCBpbmRleCB9ID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KG9TZW50ZW5jZSwgc0NhdGVnb3J5KTtcbiAgICBpZiAod29yZCkge1xuICAgICAgbWF0Y2hlZFt3b3JkIGFzIGFueV0gPSBcIm9wdGlvbmFsXCI7XG4gICAgICB1c2VkW2luZGV4XSA9IDE7XG4gICAgICBvcHRpb25hbFtzQ2F0ZWdvcnldID0gd29yZDtcbiAgICB9XG4gIH0pO1xuXG4gIG9TZW50ZW5jZS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZCwgaW5kZXgpIHtcbiAgICBpZiAoIXVzZWRbaW5kZXhdICYmICFXb3JkLmlzRmlsbGVyKG9Xb3JkKSAmJiAhV29yZC5pc0NhdGVnb3J5KG9Xb3JkKSkge1xuICAgICAgZGVidWdsb2coXCJoYXZlIHNwdXJpb3VzIHdvcmRcIiArIEpTT04uc3RyaW5naWZ5KG9Xb3JkKSk7XG4gICAgICBpZiAoIXVzZWRbaW5kZXhdICYmIG9Xb3JkLmNhdGVnb3J5ID09PSBDYXRlZ29yeS5DQVRfVE9PTCAmJiBvV29yZC5tYXRjaGVkU3RyaW5nID09PSBvVG9vbC5uYW1lICkge1xuICAgICAgICB0b29sbWVudGlvbmVkLnB1c2gob1dvcmQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3B1cmlvdXNbb1dvcmQubWF0Y2hlZFN0cmluZ10gPSAxO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIGRlYnVnbG9nKCdzYXRpc2ZpZWQgOiAnICsgT2JqZWN0LmtleXMob1Rvb2wucmVxdWlyZXMpLmpvaW4oXCI7XCIpKTtcbiAgZGVidWdsb2coJ3JlcXVpcmVkICA6ICcgKyBPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcykuam9pbihcIjtcIikpO1xuICB2YXIgbWlzc2luZyA9IFV0aWxzLkFycmF5VXRpbHMuc2V0TWludXMoT2JqZWN0LmtleXMob1Rvb2wucmVxdWlyZXMpLCBPYmplY3Qua2V5cyhyZXF1aXJlZCkpLnJlZHVjZShcbiAgICBmdW5jdGlvbiAobWFwLCBzS2V5KSB7XG4gICAgICBtYXBbc0tleV0gPSAxO1xuICAgICAgcmV0dXJuIG1hcDtcbiAgICB9LCB7fSlcblxuICByZXR1cm4ge1xuICAgIHJlcXVpcmVkOiByZXF1aXJlZCxcbiAgICBtaXNzaW5nOiBtaXNzaW5nLFxuICAgIG9wdGlvbmFsOiBvcHRpb25hbCxcbiAgICBzcHVyaW91czogc3B1cmlvdXMsXG4gICAgdG9vbG1lbnRpb25lZCA6IHRvb2xtZW50aW9uZWRcbiAgfVxufVxuXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVRvb2xNYXRjaCB7XG4gIHRvb2xtYXRjaHJlc3VsdDogSU1hdGNoLklUb29sTWF0Y2hSZXN1bHQsXG4gIHNlbnRlbmNlOiBJTWF0Y2guSVNlbnRlbmNlLFxuICB0b29sOiBJRk1vZGVsLklUb29sLFxuICByYW5rOiBudW1iZXJcbn1cblxuaW1wb3J0ICogYXMgbWF0Y2ggZnJvbSAnLi9tYXRjaCc7XG5cbmNvbnN0IFRvb2xNYXRjaCA9IG1hdGNoLlRvb2xNYXRjaDtcblxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoVG9vbHMoYVNlbnRlbmNlczogQXJyYXk8SU1hdGNoLklTZW50ZW5jZT4sIGFUb29sOiBBcnJheTxJRk1vZGVsLklUb29sPik6IElUb29sTWF0Y2hbXSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gIC8vdmFyIHN0cmVhbSA9IG5ldyBzdHJlYW11dGlscy5NYXRjaFN0cmVhbSgpO1xuICBkZWJ1Z2xvZyhcIm1hdGNoVG9vbHM6IHNlbnRlbmNlcyBcXG5cIiArXG4gICAgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSwgaW5kZXgpIHtcbiAgICByZXR1cm4gKGluZGV4IDwgMzApID8gYFske2luZGV4fV1gICsgU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgU2VudGVuY2UuZHVtcE5pY2Uob1NlbnRlbmNlKSA6IFwiXFxuXCI7XG4gICAgfSkuam9pbihcIlxcblwiKSk7XG4gIHZhciByZXN1bHQgPSBbXTtcbiAgYVRvb2wuZm9yRWFjaChmdW5jdGlvbiAob1Rvb2wpIHtcbiAgICBhU2VudGVuY2VzLmZvckVhY2goZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgdmFyIHRvb2xtYXRjaHJlc3VsdCA9IG1hdGNoVG9vbChvU2VudGVuY2UsIG9Ub29sKTtcbiAgICAgIHZhciB0b29sbWF0Y2ggPSB7XG4gICAgICAgIHRvb2xtYXRjaHJlc3VsdDogdG9vbG1hdGNocmVzdWx0LFxuICAgICAgICBzZW50ZW5jZTogb1NlbnRlbmNlLFxuICAgICAgICB0b29sIDogb1Rvb2wsXG4gICAgICAgIHJhbmsgOiAwXG4gICAgICB9IGFzIElUb29sTWF0Y2g7XG4gICAgICB0b29sbWF0Y2gucmFuayA9IFRvb2xNYXRjaC5yYW5rUmVzdWx0KHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQpO1xuICAgICAgaWYgKFRvb2xNYXRjaC5pc0FueU1hdGNoKHRvb2xtYXRjaCkpIHtcbiAgICAgICAgcmVzdWx0LnB1c2godG9vbG1hdGNoKTtcbiAgICAgIH1cbiAgICB9KVxuICB9KTtcbiAgcmVzdWx0LnNvcnQoVG9vbE1hdGNoLmNvbXBCZXR0ZXJNYXRjaCk7XG5cbiAgaWYoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgIGRlYnVnbG9nKFwibWF0Y2hUb29sczogcmFua2VkIHRvb2xtYXRjaGVzXFxuXCIgK1xuICAgICAgcmVzdWx0Lm1hcChmdW5jdGlvbihvdG9vbG1hdGNoKSB7XG4gICAgICAgIHJldHVybiBTZW50ZW5jZS5kdW1wTmljZShvdG9vbG1hdGNoLnNlbnRlbmNlKSArIEpTT04uc3RyaW5naWZ5KG90b29sbWF0Y2gpO1xuICAgICAgfSkuam9pbihcIlxcblwiKVxuICAgICk7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
