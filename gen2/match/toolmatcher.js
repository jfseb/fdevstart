/**
 * @file toolmatcher
 * @module jfseb.fdevstart.toolmatcher
 * @copyright (c) Gerd Forstmann
 *
 * Match a tool record on a sentence,
 *
 * This will unify matching required and optional category words
 * with the requirements of the tool.
 *
 */
"use strict";
// / <reference path="../../lib/node-4.d.ts" />

var debug = require("debug");
var Utils = require("abot_utils");
var abot_erbase_1 = require("abot_erbase");
var abot_erbase_2 = require("abot_erbase");
var Word = abot_erbase_2.Word.Word;
var Category = abot_erbase_2.Word.Category;
var debuglog = debug('toolmatcher');
function matchTool(oSentence, oTool) {
    var used = {};
    var required = {};
    var optional = {};
    var matched = {};
    var spurious = {};
    var toolmentioned = [];
    Object.keys(oTool.requires || {}).forEach(function (sCategory) {
        var _a = abot_erbase_1.Sentence.findWordByCategory(oSentence, sCategory),
            word = _a.word,
            index = _a.index;
        if (word) {
            matched[word] = "required";
            used[index] = 1;
            required[sCategory] = word;
        }
    });
    Object.keys(oTool.optional || {}).forEach(function (sCategory) {
        var _a = abot_erbase_1.Sentence.findWordByCategory(oSentence, sCategory),
            word = _a.word,
            index = _a.index;
        if (word) {
            matched[word] = "optional";
            used[index] = 1;
            optional[sCategory] = word;
        }
    });
    oSentence.forEach(function (oWord, index) {
        if (!used[index] && !Word.isFiller(oWord) && !Word.isCategory(oWord)) {
            debuglog("have spurious word" + JSON.stringify(oWord));
            if (!used[index] && oWord.category === Category.CAT_TOOL && oWord.matchedString === oTool.name) {
                toolmentioned.push(oWord);
            } else {
                spurious[oWord.matchedString] = 1;
            }
        }
    });
    debuglog('satisfied : ' + Object.keys(oTool.requires).join(";"));
    debuglog('required  : ' + Object.keys(oTool.requires).join(";"));
    var missing = Utils.ArrayUtils.setMinus(Object.keys(oTool.requires), Object.keys(required)).reduce(function (map, sKey) {
        map[sKey] = 1;
        return map;
    }, {});
    return {
        required: required,
        missing: missing,
        optional: optional,
        spurious: spurious,
        toolmentioned: toolmentioned
    };
}
exports.matchTool = matchTool;
var match = require("./match");
var ToolMatch = match.ToolMatch;
function matchTools(aSentences, aTool) {
    //var stream = new streamutils.MatchStream();
    debuglog("matchTools: sentences \n" + aSentences.map(function (oSentence, index) {
        return index < 30 ? "[" + index + "]" + abot_erbase_1.Sentence.rankingProduct(oSentence) + ":" + abot_erbase_1.Sentence.dumpNice(oSentence) : "\n";
    }).join("\n"));
    var result = [];
    aTool.forEach(function (oTool) {
        aSentences.forEach(function (oSentence) {
            var toolmatchresult = matchTool(oSentence, oTool);
            var toolmatch = {
                toolmatchresult: toolmatchresult,
                sentence: oSentence,
                tool: oTool,
                rank: 0
            };
            toolmatch.rank = ToolMatch.rankResult(toolmatch.toolmatchresult);
            if (ToolMatch.isAnyMatch(toolmatch)) {
                result.push(toolmatch);
            }
        });
    });
    result.sort(ToolMatch.compBetterMatch);
    if (debuglog.enabled) {
        debuglog("matchTools: ranked toolmatches\n" + result.map(function (otoolmatch) {
            return abot_erbase_1.Sentence.dumpNice(otoolmatch.sentence) + JSON.stringify(otoolmatch);
        }).join("\n"));
    }
    return result;
}
exports.matchTools = matchTools;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC90b29sbWF0Y2hlci50cyIsIm1hdGNoL3Rvb2xtYXRjaGVyLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsIlV0aWxzIiwiYWJvdF9lcmJhc2VfMSIsImFib3RfZXJiYXNlXzIiLCJXb3JkIiwiQ2F0ZWdvcnkiLCJkZWJ1Z2xvZyIsIm1hdGNoVG9vbCIsIm9TZW50ZW5jZSIsIm9Ub29sIiwidXNlZCIsInJlcXVpcmVkIiwib3B0aW9uYWwiLCJtYXRjaGVkIiwic3B1cmlvdXMiLCJ0b29sbWVudGlvbmVkIiwiT2JqZWN0Iiwia2V5cyIsInJlcXVpcmVzIiwiZm9yRWFjaCIsInNDYXRlZ29yeSIsIl9hIiwiU2VudGVuY2UiLCJmaW5kV29yZEJ5Q2F0ZWdvcnkiLCJ3b3JkIiwiaW5kZXgiLCJvV29yZCIsImlzRmlsbGVyIiwiaXNDYXRlZ29yeSIsIkpTT04iLCJzdHJpbmdpZnkiLCJjYXRlZ29yeSIsIkNBVF9UT09MIiwibWF0Y2hlZFN0cmluZyIsIm5hbWUiLCJwdXNoIiwiam9pbiIsIm1pc3NpbmciLCJBcnJheVV0aWxzIiwic2V0TWludXMiLCJyZWR1Y2UiLCJtYXAiLCJzS2V5IiwiZXhwb3J0cyIsIm1hdGNoIiwiVG9vbE1hdGNoIiwibWF0Y2hUb29scyIsImFTZW50ZW5jZXMiLCJhVG9vbCIsInJhbmtpbmdQcm9kdWN0IiwiZHVtcE5pY2UiLCJyZXN1bHQiLCJ0b29sbWF0Y2hyZXN1bHQiLCJ0b29sbWF0Y2giLCJzZW50ZW5jZSIsInRvb2wiLCJyYW5rIiwicmFua1Jlc3VsdCIsImlzQW55TWF0Y2giLCJzb3J0IiwiY29tcEJldHRlck1hdGNoIiwiZW5hYmxlZCIsIm90b29sbWF0Y2giXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7OztBQ1dBO0FEQ0E7O0FBRUEsSUFBQUEsUUFBQUMsUUFBQSxPQUFBLENBQUE7QUFJQSxJQUFBQyxRQUFBRCxRQUFBLFlBQUEsQ0FBQTtBQUNBLElBQUFFLGdCQUFBRixRQUFBLGFBQUEs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LENBQWpCO0FBQ0EsZ0JBQUlQLFVBQVVhLFVBQVYsQ0FBcUJMLFNBQXJCLENBQUosRUFBcUM7QUFDbkNGLHVCQUFPaEIsSUFBUCxDQUFZa0IsU0FBWjtBQUNEO0FBQ0YsU0FaRDtBQWFELEtBZEQ7QUFlQUYsV0FBT1EsSUFBUCxDQUFZZCxVQUFVZSxlQUF0QjtBQUVBLFFBQUd0RCxTQUFTdUQsT0FBWixFQUFxQjtBQUNuQnZELGlCQUFTLHFDQUNQNkMsT0FBT1YsR0FBUCxDQUFXLFVBQVNxQixVQUFULEVBQW1CO0FBQzVCLG1CQUFPNUQsY0FBQW9CLFFBQUEsQ0FBUzRCLFFBQVQsQ0FBa0JZLFdBQVdSLFFBQTdCLElBQXlDekIsS0FBS0MsU0FBTCxDQUFlZ0MsVUFBZixDQUFoRDtBQUNELFNBRkQsRUFFRzFCLElBRkgsQ0FFUSxJQUZSLENBREY7QUFLRDtBQUNELFdBQU9lLE1BQVA7QUFDRDtBQWhDRFIsUUFBQUcsVUFBQSxHQUFBQSxVQUFBIiwiZmlsZSI6Im1hdGNoL3Rvb2xtYXRjaGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEBmaWxlIHRvb2xtYXRjaGVyXHJcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LnRvb2xtYXRjaGVyXHJcbiAqIEBjb3B5cmlnaHQgKGMpIEdlcmQgRm9yc3RtYW5uXHJcbiAqXHJcbiAqIE1hdGNoIGEgdG9vbCByZWNvcmQgb24gYSBzZW50ZW5jZSxcclxuICpcclxuICogVGhpcyB3aWxsIHVuaWZ5IG1hdGNoaW5nIHJlcXVpcmVkIGFuZCBvcHRpb25hbCBjYXRlZ29yeSB3b3Jkc1xyXG4gKiB3aXRoIHRoZSByZXF1aXJlbWVudHMgb2YgdGhlIHRvb2wuXHJcbiAqXHJcbiAqL1xyXG5cclxuLy8gLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxyXG5cclxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xyXG5cclxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XHJcblxyXG5pbXBvcnQgKiBhcyBVdGlscyBmcm9tICdhYm90X3V0aWxzJztcclxuaW1wb3J0IHsgU2VudGVuY2UgYXMgU2VudGVuY2V9IGZyb20gJ2Fib3RfZXJiYXNlJztcclxuXHJcbmltcG9ydCB7IFdvcmQgYXMgT3BzV29yZCB9ICBmcm9tICdhYm90X2VyYmFzZSc7XHJcblxyXG5jb25zdCBXb3JkID0gT3BzV29yZC5Xb3JkO1xyXG5jb25zdCBDYXRlZ29yeSA9IE9wc1dvcmQuQ2F0ZWdvcnk7XHJcblxyXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCd0b29sbWF0Y2hlcicpO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoVG9vbChvU2VudGVuY2U6IElNYXRjaC5JU2VudGVuY2UsIG9Ub29sOiBJTWF0Y2guSVRvb2wpOiBJTWF0Y2guSVRvb2xNYXRjaFJlc3VsdCB7XHJcbiAgdmFyIHVzZWQgPSB7fSBhcyB7IFtrZXk6IG51bWJlcl06IG51bWJlciB9O1xyXG4gIHZhciByZXF1aXJlZCA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogSU1hdGNoLklXb3JkIH07XHJcbiAgdmFyIG9wdGlvbmFsID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBJTWF0Y2guSVdvcmQgfTtcclxuICB2YXIgbWF0Y2hlZCA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XHJcbiAgdmFyIHNwdXJpb3VzID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfTtcclxuICB2YXIgdG9vbG1lbnRpb25lZCA9IFtdIGFzIEFycmF5PElNYXRjaC5JV29yZD47XHJcbiAgT2JqZWN0LmtleXMob1Rvb2wucmVxdWlyZXMgfHwge30pLmZvckVhY2goZnVuY3Rpb24gKHNDYXRlZ29yeTogc3RyaW5nKSB7XHJcbiAgICBsZXQgeyB3b3JkLCBpbmRleCB9ID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KG9TZW50ZW5jZSwgc0NhdGVnb3J5KTtcclxuICAgIGlmICh3b3JkKSB7XHJcbiAgICAgIG1hdGNoZWRbd29yZCBhcyBhbnldID0gXCJyZXF1aXJlZFwiO1xyXG4gICAgICB1c2VkW2luZGV4XSA9IDE7XHJcbiAgICAgIHJlcXVpcmVkW3NDYXRlZ29yeV0gPSB3b3JkO1xyXG4gICAgfVxyXG4gIH0pO1xyXG4gIE9iamVjdC5rZXlzKG9Ub29sLm9wdGlvbmFsIHx8IHt9KS5mb3JFYWNoKGZ1bmN0aW9uIChzQ2F0ZWdvcnk6IHN0cmluZykge1xyXG4gICAgdmFyIHsgd29yZCwgaW5kZXggfSA9IFNlbnRlbmNlLmZpbmRXb3JkQnlDYXRlZ29yeShvU2VudGVuY2UsIHNDYXRlZ29yeSk7XHJcbiAgICBpZiAod29yZCkge1xyXG4gICAgICBtYXRjaGVkW3dvcmQgYXMgYW55XSA9IFwib3B0aW9uYWxcIjtcclxuICAgICAgdXNlZFtpbmRleF0gPSAxO1xyXG4gICAgICBvcHRpb25hbFtzQ2F0ZWdvcnldID0gd29yZDtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgb1NlbnRlbmNlLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkLCBpbmRleCkge1xyXG4gICAgaWYgKCF1c2VkW2luZGV4XSAmJiAhV29yZC5pc0ZpbGxlcihvV29yZCkgJiYgIVdvcmQuaXNDYXRlZ29yeShvV29yZCkpIHtcclxuICAgICAgZGVidWdsb2coXCJoYXZlIHNwdXJpb3VzIHdvcmRcIiArIEpTT04uc3RyaW5naWZ5KG9Xb3JkKSk7XHJcbiAgICAgIGlmICghdXNlZFtpbmRleF0gJiYgb1dvcmQuY2F0ZWdvcnkgPT09IENhdGVnb3J5LkNBVF9UT09MICYmIG9Xb3JkLm1hdGNoZWRTdHJpbmcgPT09IG9Ub29sLm5hbWUgKSB7XHJcbiAgICAgICAgdG9vbG1lbnRpb25lZC5wdXNoKG9Xb3JkKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBzcHVyaW91c1tvV29yZC5tYXRjaGVkU3RyaW5nXSA9IDE7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9KTtcclxuICBkZWJ1Z2xvZygnc2F0aXNmaWVkIDogJyArIE9iamVjdC5rZXlzKG9Ub29sLnJlcXVpcmVzKS5qb2luKFwiO1wiKSk7XHJcbiAgZGVidWdsb2coJ3JlcXVpcmVkICA6ICcgKyBPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcykuam9pbihcIjtcIikpO1xyXG4gIHZhciBtaXNzaW5nID0gVXRpbHMuQXJyYXlVdGlscy5zZXRNaW51cyhPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcyksIE9iamVjdC5rZXlzKHJlcXVpcmVkKSkucmVkdWNlKFxyXG4gICAgZnVuY3Rpb24gKG1hcCwgc0tleSkge1xyXG4gICAgICBtYXBbc0tleV0gPSAxO1xyXG4gICAgICByZXR1cm4gbWFwO1xyXG4gICAgfSwge30pXHJcblxyXG4gIHJldHVybiB7XHJcbiAgICByZXF1aXJlZDogcmVxdWlyZWQsXHJcbiAgICBtaXNzaW5nOiBtaXNzaW5nLFxyXG4gICAgb3B0aW9uYWw6IG9wdGlvbmFsLFxyXG4gICAgc3B1cmlvdXM6IHNwdXJpb3VzLFxyXG4gICAgdG9vbG1lbnRpb25lZCA6IHRvb2xtZW50aW9uZWRcclxuICB9XHJcbn1cclxuXHJcbmltcG9ydCAqIGFzIG1hdGNoIGZyb20gJy4vbWF0Y2gnO1xyXG5cclxuY29uc3QgVG9vbE1hdGNoID0gbWF0Y2guVG9vbE1hdGNoO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoVG9vbHMoYVNlbnRlbmNlczogQXJyYXk8SU1hdGNoLklTZW50ZW5jZT4sIGFUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogSU1hdGNoLklUb29sTWF0Y2hbXSAvKiBvYmplY3RzdHJlYW0qLyB7XHJcbiAgLy92YXIgc3RyZWFtID0gbmV3IHN0cmVhbXV0aWxzLk1hdGNoU3RyZWFtKCk7XHJcbiAgZGVidWdsb2coXCJtYXRjaFRvb2xzOiBzZW50ZW5jZXMgXFxuXCIgK1xyXG4gICAgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSwgaW5kZXgpIHtcclxuICAgIHJldHVybiAoaW5kZXggPCAzMCkgPyBgWyR7aW5kZXh9XWAgKyBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBTZW50ZW5jZS5kdW1wTmljZShvU2VudGVuY2UpIDogXCJcXG5cIjtcclxuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xyXG4gIHZhciByZXN1bHQgPSBbXTtcclxuICBhVG9vbC5mb3JFYWNoKGZ1bmN0aW9uIChvVG9vbCkge1xyXG4gICAgYVNlbnRlbmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcclxuICAgICAgdmFyIHRvb2xtYXRjaHJlc3VsdCA9IG1hdGNoVG9vbChvU2VudGVuY2UsIG9Ub29sKTtcclxuICAgICAgdmFyIHRvb2xtYXRjaCA9IHtcclxuICAgICAgICB0b29sbWF0Y2hyZXN1bHQ6IHRvb2xtYXRjaHJlc3VsdCxcclxuICAgICAgICBzZW50ZW5jZTogb1NlbnRlbmNlLFxyXG4gICAgICAgIHRvb2wgOiBvVG9vbCxcclxuICAgICAgICByYW5rIDogMFxyXG4gICAgICB9IGFzIElNYXRjaC5JVG9vbE1hdGNoO1xyXG4gICAgICB0b29sbWF0Y2gucmFuayA9IFRvb2xNYXRjaC5yYW5rUmVzdWx0KHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQpO1xyXG4gICAgICBpZiAoVG9vbE1hdGNoLmlzQW55TWF0Y2godG9vbG1hdGNoKSkge1xyXG4gICAgICAgIHJlc3VsdC5wdXNoKHRvb2xtYXRjaCk7XHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgfSk7XHJcbiAgcmVzdWx0LnNvcnQoVG9vbE1hdGNoLmNvbXBCZXR0ZXJNYXRjaCk7XHJcblxyXG4gIGlmKGRlYnVnbG9nLmVuYWJsZWQpIHtcclxuICAgIGRlYnVnbG9nKFwibWF0Y2hUb29sczogcmFua2VkIHRvb2xtYXRjaGVzXFxuXCIgK1xyXG4gICAgICByZXN1bHQubWFwKGZ1bmN0aW9uKG90b29sbWF0Y2gpIHtcclxuICAgICAgICByZXR1cm4gU2VudGVuY2UuZHVtcE5pY2Uob3Rvb2xtYXRjaC5zZW50ZW5jZSkgKyBKU09OLnN0cmluZ2lmeShvdG9vbG1hdGNoKTtcclxuICAgICAgfSkuam9pbihcIlxcblwiKVxyXG4gICAgKTtcclxuICB9XHJcbiAgcmV0dXJuIHJlc3VsdDtcclxufSIsIi8qKlxuICogQGZpbGUgdG9vbG1hdGNoZXJcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LnRvb2xtYXRjaGVyXG4gKiBAY29weXJpZ2h0IChjKSBHZXJkIEZvcnN0bWFublxuICpcbiAqIE1hdGNoIGEgdG9vbCByZWNvcmQgb24gYSBzZW50ZW5jZSxcbiAqXG4gKiBUaGlzIHdpbGwgdW5pZnkgbWF0Y2hpbmcgcmVxdWlyZWQgYW5kIG9wdGlvbmFsIGNhdGVnb3J5IHdvcmRzXG4gKiB3aXRoIHRoZSByZXF1aXJlbWVudHMgb2YgdGhlIHRvb2wuXG4gKlxuICovXG5cInVzZSBzdHJpY3RcIjtcbi8vIC8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vbGliL25vZGUtNC5kLnRzXCIgLz5cbnZhciBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKTtcbnZhciBVdGlscyA9IHJlcXVpcmUoXCJhYm90X3V0aWxzXCIpO1xudmFyIGFib3RfZXJiYXNlXzEgPSByZXF1aXJlKFwiYWJvdF9lcmJhc2VcIik7XG52YXIgYWJvdF9lcmJhc2VfMiA9IHJlcXVpcmUoXCJhYm90X2VyYmFzZVwiKTtcbnZhciBXb3JkID0gYWJvdF9lcmJhc2VfMi5Xb3JkLldvcmQ7XG52YXIgQ2F0ZWdvcnkgPSBhYm90X2VyYmFzZV8yLldvcmQuQ2F0ZWdvcnk7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygndG9vbG1hdGNoZXInKTtcbmZ1bmN0aW9uIG1hdGNoVG9vbChvU2VudGVuY2UsIG9Ub29sKSB7XG4gICAgdmFyIHVzZWQgPSB7fTtcbiAgICB2YXIgcmVxdWlyZWQgPSB7fTtcbiAgICB2YXIgb3B0aW9uYWwgPSB7fTtcbiAgICB2YXIgbWF0Y2hlZCA9IHt9O1xuICAgIHZhciBzcHVyaW91cyA9IHt9O1xuICAgIHZhciB0b29sbWVudGlvbmVkID0gW107XG4gICAgT2JqZWN0LmtleXMob1Rvb2wucmVxdWlyZXMgfHwge30pLmZvckVhY2goZnVuY3Rpb24gKHNDYXRlZ29yeSkge1xuICAgICAgICB2YXIgX2EgPSBhYm90X2VyYmFzZV8xLlNlbnRlbmNlLmZpbmRXb3JkQnlDYXRlZ29yeShvU2VudGVuY2UsIHNDYXRlZ29yeSksIHdvcmQgPSBfYS53b3JkLCBpbmRleCA9IF9hLmluZGV4O1xuICAgICAgICBpZiAod29yZCkge1xuICAgICAgICAgICAgbWF0Y2hlZFt3b3JkXSA9IFwicmVxdWlyZWRcIjtcbiAgICAgICAgICAgIHVzZWRbaW5kZXhdID0gMTtcbiAgICAgICAgICAgIHJlcXVpcmVkW3NDYXRlZ29yeV0gPSB3b3JkO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgT2JqZWN0LmtleXMob1Rvb2wub3B0aW9uYWwgfHwge30pLmZvckVhY2goZnVuY3Rpb24gKHNDYXRlZ29yeSkge1xuICAgICAgICB2YXIgX2EgPSBhYm90X2VyYmFzZV8xLlNlbnRlbmNlLmZpbmRXb3JkQnlDYXRlZ29yeShvU2VudGVuY2UsIHNDYXRlZ29yeSksIHdvcmQgPSBfYS53b3JkLCBpbmRleCA9IF9hLmluZGV4O1xuICAgICAgICBpZiAod29yZCkge1xuICAgICAgICAgICAgbWF0Y2hlZFt3b3JkXSA9IFwib3B0aW9uYWxcIjtcbiAgICAgICAgICAgIHVzZWRbaW5kZXhdID0gMTtcbiAgICAgICAgICAgIG9wdGlvbmFsW3NDYXRlZ29yeV0gPSB3b3JkO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgb1NlbnRlbmNlLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkLCBpbmRleCkge1xuICAgICAgICBpZiAoIXVzZWRbaW5kZXhdICYmICFXb3JkLmlzRmlsbGVyKG9Xb3JkKSAmJiAhV29yZC5pc0NhdGVnb3J5KG9Xb3JkKSkge1xuICAgICAgICAgICAgZGVidWdsb2coXCJoYXZlIHNwdXJpb3VzIHdvcmRcIiArIEpTT04uc3RyaW5naWZ5KG9Xb3JkKSk7XG4gICAgICAgICAgICBpZiAoIXVzZWRbaW5kZXhdICYmIG9Xb3JkLmNhdGVnb3J5ID09PSBDYXRlZ29yeS5DQVRfVE9PTCAmJiBvV29yZC5tYXRjaGVkU3RyaW5nID09PSBvVG9vbC5uYW1lKSB7XG4gICAgICAgICAgICAgICAgdG9vbG1lbnRpb25lZC5wdXNoKG9Xb3JkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHNwdXJpb3VzW29Xb3JkLm1hdGNoZWRTdHJpbmddID0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGRlYnVnbG9nKCdzYXRpc2ZpZWQgOiAnICsgT2JqZWN0LmtleXMob1Rvb2wucmVxdWlyZXMpLmpvaW4oXCI7XCIpKTtcbiAgICBkZWJ1Z2xvZygncmVxdWlyZWQgIDogJyArIE9iamVjdC5rZXlzKG9Ub29sLnJlcXVpcmVzKS5qb2luKFwiO1wiKSk7XG4gICAgdmFyIG1pc3NpbmcgPSBVdGlscy5BcnJheVV0aWxzLnNldE1pbnVzKE9iamVjdC5rZXlzKG9Ub29sLnJlcXVpcmVzKSwgT2JqZWN0LmtleXMocmVxdWlyZWQpKS5yZWR1Y2UoZnVuY3Rpb24gKG1hcCwgc0tleSkge1xuICAgICAgICBtYXBbc0tleV0gPSAxO1xuICAgICAgICByZXR1cm4gbWFwO1xuICAgIH0sIHt9KTtcbiAgICByZXR1cm4ge1xuICAgICAgICByZXF1aXJlZDogcmVxdWlyZWQsXG4gICAgICAgIG1pc3Npbmc6IG1pc3NpbmcsXG4gICAgICAgIG9wdGlvbmFsOiBvcHRpb25hbCxcbiAgICAgICAgc3B1cmlvdXM6IHNwdXJpb3VzLFxuICAgICAgICB0b29sbWVudGlvbmVkOiB0b29sbWVudGlvbmVkXG4gICAgfTtcbn1cbmV4cG9ydHMubWF0Y2hUb29sID0gbWF0Y2hUb29sO1xudmFyIG1hdGNoID0gcmVxdWlyZShcIi4vbWF0Y2hcIik7XG52YXIgVG9vbE1hdGNoID0gbWF0Y2guVG9vbE1hdGNoO1xuZnVuY3Rpb24gbWF0Y2hUb29scyhhU2VudGVuY2VzLCBhVG9vbCkge1xuICAgIC8vdmFyIHN0cmVhbSA9IG5ldyBzdHJlYW11dGlscy5NYXRjaFN0cmVhbSgpO1xuICAgIGRlYnVnbG9nKFwibWF0Y2hUb29sczogc2VudGVuY2VzIFxcblwiICtcbiAgICAgICAgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSwgaW5kZXgpIHtcbiAgICAgICAgICAgIHJldHVybiAoaW5kZXggPCAzMCkgPyBcIltcIiArIGluZGV4ICsgXCJdXCIgKyBhYm90X2VyYmFzZV8xLlNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIGFib3RfZXJiYXNlXzEuU2VudGVuY2UuZHVtcE5pY2Uob1NlbnRlbmNlKSA6IFwiXFxuXCI7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIHZhciByZXN1bHQgPSBbXTtcbiAgICBhVG9vbC5mb3JFYWNoKGZ1bmN0aW9uIChvVG9vbCkge1xuICAgICAgICBhU2VudGVuY2VzLmZvckVhY2goZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgdmFyIHRvb2xtYXRjaHJlc3VsdCA9IG1hdGNoVG9vbChvU2VudGVuY2UsIG9Ub29sKTtcbiAgICAgICAgICAgIHZhciB0b29sbWF0Y2ggPSB7XG4gICAgICAgICAgICAgICAgdG9vbG1hdGNocmVzdWx0OiB0b29sbWF0Y2hyZXN1bHQsXG4gICAgICAgICAgICAgICAgc2VudGVuY2U6IG9TZW50ZW5jZSxcbiAgICAgICAgICAgICAgICB0b29sOiBvVG9vbCxcbiAgICAgICAgICAgICAgICByYW5rOiAwXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdG9vbG1hdGNoLnJhbmsgPSBUb29sTWF0Y2gucmFua1Jlc3VsdCh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0KTtcbiAgICAgICAgICAgIGlmIChUb29sTWF0Y2guaXNBbnlNYXRjaCh0b29sbWF0Y2gpKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godG9vbG1hdGNoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmVzdWx0LnNvcnQoVG9vbE1hdGNoLmNvbXBCZXR0ZXJNYXRjaCk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgZGVidWdsb2coXCJtYXRjaFRvb2xzOiByYW5rZWQgdG9vbG1hdGNoZXNcXG5cIiArXG4gICAgICAgICAgICByZXN1bHQubWFwKGZ1bmN0aW9uIChvdG9vbG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFib3RfZXJiYXNlXzEuU2VudGVuY2UuZHVtcE5pY2Uob3Rvb2xtYXRjaC5zZW50ZW5jZSkgKyBKU09OLnN0cmluZ2lmeShvdG9vbG1hdGNoKTtcbiAgICAgICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuZXhwb3J0cy5tYXRjaFRvb2xzID0gbWF0Y2hUb29scztcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
