/**
 *
 * @module jfseb.fdevstart.analyze
 * @file erbase
 * @copyright (c) 2016 Gerd Forstmann
 *
 * Basic domain based entity recognition
 */
"use strict";

var InputFilter = require("./inputFilter");
var debug = require("debug");
var debuglog = debug('erbase');
var debuglogV = debug('erbase');
var perflog = debug('perf');
var fdevsta_monmove_1 = require("fdevsta_monmove");
var ERError = require("./ererror");
var AnyObject = Object;
function mockDebug(o) {
    debuglog = o;
    debuglogV = o;
    perflog = o;
}
exports.mockDebug = mockDebug;
var Utils = require("abot_utils");
var Sentence = require("./sentence");
/**
 * Given a  string, break it down into components,
 * [['A', 'B'], ['A B']]
 *
 * then categorizeWords
 * returning
 *
 * [ [[ { category: 'systemId', word : 'A'},
 *      { category: 'otherthing', word : 'A'}
 *    ],
 *    // result of B
 *    [ { category: 'systemId', word : 'B'},
 *      { category: 'otherthing', word : 'A'}
 *      { category: 'anothertryp', word : 'B'}
 *    ]
 *   ],
 * ]]]
 *
 *
 *
 */
function tokenizeString(sString, rules, words) {
    var cnt = 0;
    var fac = 1;
    var tokens = fdevsta_monmove_1.BreakDown.tokenizeString(sString);
    if (debuglog.enabled) {
        debuglog("here breakdown" + JSON.stringify(tokens));
    }
    //console.log(JSON.stringify(u));
    words = words || {};
    perflog('this many known words: ' + Object.keys(words).length);
    var res = [];
    var cntRec = {};
    var categorizedSentence = [];
    var hasRecombined = false;
    tokens.tokens.forEach(function (token, index) {
        var seenIt = InputFilter.categorizeAWordWithOffsets(token, rules, sString, words, cntRec);
        /* cannot have this, or need to add all fragment words "UI2 Integration"  if(seenIt.length === 0) {
              return false;
            }
        */
        hasRecombined = hasRecombined || !seenIt.every(function (res) {
            return !res.rule.range;
        });
        debuglog(" categorized " + token + "/" + index + " to " + JSON.stringify(seenIt));
        categorizedSentence[index] = seenIt;
        cnt = cnt + seenIt.length;
        fac = fac * seenIt.length;
    });
    // have seen the plain categorization,
    debuglog(" sentences " + tokens.tokens.length + " matches " + cnt + " fac: " + fac);
    if (debuglog.enabled && tokens.tokens.length) {
        debuglog("first match " + JSON.stringify(tokens, undefined, 2));
    }
    debuglog(debuglog.enabled ? " prior RangeRule " + JSON.stringify(categorizedSentence) + " " : '-');
    if (hasRecombined) {
        evaluateRangeRulesToPosition(tokens.tokens, tokens.fusable, categorizedSentence);
    }
    debuglog(debuglog.enabled ? " after RangeRule " + JSON.stringify(categorizedSentence) + " " : '-');
    perflog(" sentences " + tokens.tokens.length + " / " + res.length + " matches " + cnt + " fac: " + fac + " rec : " + JSON.stringify(cntRec, undefined, 2));
    return {
        fusable: tokens.fusable,
        tokens: tokens.tokens,
        categorizedWords: categorizedSentence
    };
}
exports.tokenizeString = tokenizeString;
function isSameRes(present, res) {
    if (!(present.rule.matchedString === res.rule.matchedString && present.rule.category === res.rule.category && present.span === res.span && present.rule.bitindex === res.rule.bitindex)) {
        return 0;
    }
    if (present._ranking < res._ranking) {
        return -1;
    }
    return +1;
}
exports.isSameRes = isSameRes;
function mergeIgnoreOrAppend(result, res) {
    var insertindex = -1;
    var foundNothing = result.every(function (present, index) {
        var r = isSameRes(present, res);
        if (r < 0) {
            //console.log("overwriting worse \n" + JSON.stringify(res) + '\n' + JSON.stringify(present)+ '\n');
            result[index] = res;
            return false;
        } else if (r > 0) {
            //console.log('skipping present');
            return false;
        }
        return true;
    });
    if (foundNothing) {
        //debulog('pushing');
        result.push(res);
    }
}
exports.mergeIgnoreOrAppend = mergeIgnoreOrAppend;
function evaluateRangeRulesToPosition(tokens, fusable, categorizedWords) {
    debuglog(debuglog.enabled ? "evaluateRangeRulesToPosition... " + JSON.stringify(categorizedWords) : '-');
    categorizedWords.forEach(function (wordlist, index) {
        wordlist.forEach(function (word) {
            if (word.rule.range) {
                //console.log(` got targetindex for RangeRules evaluation : ${targetIndex} ${index} ${fusable.join(" ")}`);
                var targetIndex = fdevsta_monmove_1.BreakDown.isCombinableRangeReturnIndex(word.rule.range, fusable, index);
                //console.log(` got targetindex for RangeRules evaluation : ${targetIndex}`);
                if (targetIndex >= 0) {
                    var combinedWord = fdevsta_monmove_1.BreakDown.combineTokens(word.rule.range, index, tokens);
                    debuglog(debuglog.enabled ? " test \"" + combinedWord + "\" against \"" + word.rule.range.rule.lowercaseword + "\" " + JSON.stringify(word.rule.range.rule) : '-');
                    var res = InputFilter.categorizeWordWithOffsetWithRankCutoffSingle(combinedWord, word.rule.range.rule);
                    debuglog(debuglog.enabled ? " got res : " + JSON.stringify(res) : '-');
                    if (res) {
                        res.span = word.rule.range.high - word.rule.range.low + 1;
                        categorizedWords[targetIndex] = categorizedWords[targetIndex].slice(0); // avoid invalidation of seenit
                        debuglog("pushed sth at " + targetIndex);
                        mergeIgnoreOrAppend(categorizedWords[targetIndex], res);
                    }
                }
            }
        });
    });
    // filter all range rules !
    categorizedWords.forEach(function (wordlist, index) {
        categorizedWords[index] = wordlist.filter(function (word) {
            return !word.rule.range;
        });
    });
}
exports.evaluateRangeRulesToPosition = evaluateRangeRulesToPosition;
var clone = Utils.cloneDeep;
function copyVecMembers(u) {
    var i = 0;
    for (i = 0; i < u.length; ++i) {
        u[i] = clone(u[i]);
    }
    return u;
}
// we can replicate the tail or the head,
// we replicate the tail as it is smaller.
// [a,b,c ]
function isSpanVec(vec, index) {
    var effectivelen = vec.reduce(function (prev, mem) {
        return prev += mem.span ? mem.span : 1;
    }, 0);
    return effectivelen > index;
}
exports.isSpanVec = isSpanVec;
/**
 * expand an array [[a1,a2], [b1,b2],[c]]
 * into all combinations
 *
 *  if a1 has a span of three, the variations of the lower layer are skipped
 *
 * with the special property
 */
function expandTokenMatchesToSentences(tokens, tokenMatches) {
    var a = [];
    var wordMatches = [];
    debuglogV(debuglog.enabled ? JSON.stringify(tokenMatches) : '-');
    tokenMatches.forEach(function (aWordMatches, wordIndex) {
        wordMatches[wordIndex] = [];
        aWordMatches.forEach(function (oWordVariant, wordVariantIndex) {
            wordMatches[wordIndex][wordVariantIndex] = oWordVariant;
        });
    });
    debuglog(debuglog.enabled ? JSON.stringify(tokenMatches) : '-');
    var result = {
        errors: [],
        tokens: tokens,
        sentences: []
    };
    var nvecs = [];
    var res = [[]];
    // var nvecs = [];
    var rvec = [];
    for (var tokenIndex = 0; tokenIndex < tokenMatches.length; ++tokenIndex) {
        //vecs is the vector of all so far seen variants up to k length.
        var nextBase = [];
        //independent of existence of matches on level k, we retain all vectors which are covered by a span
        // we skip extending them below
        for (var u = 0; u < res.length; ++u) {
            if (isSpanVec(res[u], tokenIndex)) {
                nextBase.push(res[u]);
            }
        }
        var lenMatches = tokenMatches[tokenIndex].length;
        if (nextBase.length === 0 && lenMatches === 0) {
            // the word at index I cannot be understood
            //if (result.errors.length === 0) {
            result.errors.push(ERError.makeError_NO_KNOWN_WORD(tokenIndex, tokens));
        }
        for (var l = 0; l < lenMatches; ++l) {
            //debuglog("vecs now" + JSON.stringify(vecs));
            var nvecs = []; //vecs.slice(); // copy the vec[i] base vector;
            //debuglog("vecs copied now" + JSON.stringify(nvecs));
            for (var u = 0; u < res.length; ++u) {
                if (!isSpanVec(res[u], tokenIndex)) {
                    // for each so far constructed result (of length k) in res
                    nvecs.push(res[u].slice()); // make a copy of each vector
                    nvecs[nvecs.length - 1] = copyVecMembers(nvecs[nvecs.length - 1]);
                    // debuglog("copied vecs["+ u+"]" + JSON.stringify(vecs[u]));
                    nvecs[nvecs.length - 1].push(clone(tokenMatches[tokenIndex][l])); // push the lth variant
                }
            }
            //   debuglog(" at     " + k + ":" + l + " nextbase >" + JSON.stringify(nextBase))
            //   debuglog(" append " + k + ":" + l + " nvecs    >" + JSON.stringify(nvecs))
            nextBase = nextBase.concat(nvecs);
        } //constru
        //  debuglog("now at " + k + ":" + l + " >" + JSON.stringify(nextBase))
        res = nextBase;
    }
    debuglogV(debuglogV.enabled ? "APPENDING TO RES" + 0 + ":" + l + " >" + JSON.stringify(nextBase) : '-');
    result.sentences = res;
    return result;
}
exports.expandTokenMatchesToSentences = expandTokenMatchesToSentences;
function processString(query, rules, words) {
    words = words || {};
    var tokenStruct = tokenizeString(query, rules, words);
    evaluateRangeRulesToPosition(tokenStruct.tokens, tokenStruct.fusable, tokenStruct.categorizedWords);
    if (debuglog.enabled) {
        debuglog("After matched " + JSON.stringify(tokenStruct.categorizedWords));
    }
    var aSentences = expandTokenMatchesToSentences(tokenStruct.tokens, tokenStruct.categorizedWords);
    if (debuglog.enabled) {
        debuglog("after expand" + aSentences.sentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + Sentence.dumpNice(oSentence); //JSON.stringify(oSentence);
        }).join("\n"));
    }
    aSentences.sentences = InputFilter.reinForce(aSentences.sentences);
    if (debuglog.enabled) {
        debuglog("after reinforce" + aSentences.sentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
    }
    return aSentences;
}
exports.processString = processString;
function simplifySentence(res) {
    return res.map(function (r) {
        return r.map(function (word) {
            return word.string + '=>' + word.matchedString + '/' + word.category + (word.span ? '/' + word.span : '');
        });
    });
}
exports.simplifySentence = simplifySentence;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9lcmJhc2UudHMiLCJtYXRjaC9lcmJhc2UuanMiXSwibmFtZXMiOlsiSW5wdXRGaWx0ZXIiLCJyZXF1aXJlIiwiZGVidWciLCJkZWJ1Z2xvZyIsImRlYnVnbG9nViIsInBlcmZsb2ciLCJmZGV2c3RhX21vbm1vdmVfMSIsIkVSRXJyb3IiLCJBbnlPYmplY3QiLCJPYmplY3QiLCJtb2NrRGVidWciLCJvIiwiZXhwb3J0cyIsIlV0aWxzIiwiU2VudGVuY2UiLCJ0b2tlbml6ZVN0cmluZyIsInNTdHJpbmciLCJydWxlcyIsIndvcmRzIiwiY250IiwiZmFjIiwidG9rZW5zIiwiQnJlYWtEb3duIiwiZW5hYmxlZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJrZXlzIiwibGVuZ3RoIiwicmVzIiwiY250UmVjIiwiY2F0ZWdvcml6ZWRTZW50ZW5jZSIsImhhc1JlY29tYmluZWQiLCJmb3JFYWNoIiwidG9rZW4iLCJpbmRleCIsInNlZW5JdCIsImNhdGVnb3JpemVBV29yZFdpdGhPZmZzZXRzIiwiZXZlcnkiLCJydWxlIiwicmFuZ2UiLCJ1bmRlZmluZWQiLCJldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uIiwiZnVzYWJsZSIsImNhdGVnb3JpemVkV29yZHMiLCJpc1NhbWVSZXMiLCJwcmVzZW50IiwibWF0Y2hlZFN0cmluZyIsImNhdGVnb3J5Iiwic3BhbiIsImJpdGluZGV4IiwiX3JhbmtpbmciLCJtZXJnZUlnbm9yZU9yQXBwZW5kIiwicmVzdWx0IiwiaW5zZXJ0aW5kZXgiLCJmb3VuZE5vdGhpbmciLCJyIiwicHVzaCIsIndvcmRsaXN0Iiwid29yZCIsInRhcmdldEluZGV4IiwiaXNDb21iaW5hYmxlUmFuZ2VSZXR1cm5JbmRleCIsImNvbWJpbmVkV29yZCIsImNvbWJpbmVUb2tlbnMiLCJsb3dlcmNhc2V3b3JkIiwiY2F0ZWdvcml6ZVdvcmRXaXRoT2Zmc2V0V2l0aFJhbmtDdXRvZmZTaW5nbGUiLCJoaWdoIiwibG93Iiwic2xpY2UiLCJmaWx0ZXIiLCJjbG9uZSIsImNsb25lRGVlcCIsImNvcHlWZWNNZW1iZXJzIiwidSIsImkiLCJpc1NwYW5WZWMiLCJ2ZWMiLCJlZmZlY3RpdmVsZW4iLCJyZWR1Y2UiLCJwcmV2IiwibWVtIiwiZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXMiLCJ0b2tlbk1hdGNoZXMiLCJhIiwid29yZE1hdGNoZXMiLCJhV29yZE1hdGNoZXMiLCJ3b3JkSW5kZXgiLCJvV29yZFZhcmlhbnQiLCJ3b3JkVmFyaWFudEluZGV4IiwiZXJyb3JzIiwic2VudGVuY2VzIiwibnZlY3MiLCJydmVjIiwidG9rZW5JbmRleCIsIm5leHRCYXNlIiwibGVuTWF0Y2hlcyIsIm1ha2VFcnJvcl9OT19LTk9XTl9XT1JEIiwibCIsImNvbmNhdCIsInByb2Nlc3NTdHJpbmciLCJxdWVyeSIsInRva2VuU3RydWN0IiwiYVNlbnRlbmNlcyIsIm1hcCIsIm9TZW50ZW5jZSIsInJhbmtpbmdQcm9kdWN0IiwiZHVtcE5pY2UiLCJqb2luIiwicmVpbkZvcmNlIiwic2ltcGxpZnlTZW50ZW5jZSIsInN0cmluZyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7O0FDUUE7O0FERUEsSUFBQUEsY0FBQUMsUUFBQSxlQUFBLENBQUE7QUFFQSxJQUFBQyxRQUFBRCxRQUFBLE9BQUEsQ0FBQTtBQUlBLElBQUlFLFdBQVdELE1BQU0sUUFBTixDQUFmO0FBQ0EsSUFBSUUsWUFBWUYsTUFBTSxRQUFOLENBQWhCO0FBQ0EsSUFBSUcsVUFBVUgsTUFBTSxNQUFOLENBQWQ7QUFFQSxJQUFBSSxvQkFBQUwsUUFBQSxpQkFBQSxDQUFBO0FBRUEsSUFBQU0sVUFBQU4sUUFBQSxXQUFBLENBQUE7QUFFQSxJQUFNTyxZQUFpQkMsTUFBdkI7QUFFQSxTQUFBQyxTQUFBLENBQTBCQyxDQUExQixFQUEyQjtBQUN6QlIsZUFBV1EsQ0FBWDtBQUNBUCxnQkFBWU8sQ0FBWjtBQUNBTixjQUFVTSxDQUFWO0FBQ0Q7QUFKREMsUUFBQUYsU0FBQSxHQUFBQSxTQUFBO0FBT0EsSUFB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cyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGVyYmFzZVxuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICpcbiAqIEJhc2ljIGRvbWFpbiBiYXNlZCBlbnRpdHkgcmVjb2duaXRpb25cbiAqL1xuXG5cbmltcG9ydCAqIGFzIElucHV0RmlsdGVyIGZyb20gJy4vaW5wdXRGaWx0ZXInO1xuXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5cblxuXG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnZXJiYXNlJyk7XG52YXIgZGVidWdsb2dWID0gZGVidWcoJ2VyYmFzZScpO1xudmFyIHBlcmZsb2cgPSBkZWJ1ZygncGVyZicpO1xuXG5pbXBvcnQgeyBCcmVha0Rvd24gYXMgYnJlYWtkb3dufSBmcm9tICdmZGV2c3RhX21vbm1vdmUnO1xuXG5pbXBvcnQgKiBhcyBFUkVycm9yIGZyb20gJy4vZXJlcnJvcic7XG5cbmNvbnN0IEFueU9iamVjdCA9IDxhbnk+T2JqZWN0O1xuXG5leHBvcnQgZnVuY3Rpb24gbW9ja0RlYnVnKG8pIHtcbiAgZGVidWdsb2cgPSBvO1xuICBkZWJ1Z2xvZ1YgPSBvO1xuICBwZXJmbG9nID0gbztcbn1cblxuXG5pbXBvcnQgKiBhcyBVdGlscyBmcm9tICdhYm90X3V0aWxzJztcblxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XG5cbmltcG9ydCAqIGFzIFRvb2xtYXRjaGVyIGZyb20gJy4vdG9vbG1hdGNoZXInO1xuXG5pbXBvcnQgKiBhcyBTZW50ZW5jZSBmcm9tICcuL3NlbnRlbmNlJztcblxuaW1wb3J0ICogYXMgV29yZCBmcm9tICcuL3dvcmQnO1xuXG5pbXBvcnQgKiBhcyBBbGdvbCBmcm9tICcuL2FsZ29sJztcblxuXG5pbXBvcnQgKiBhcyBNYXRjaCBmcm9tICcuL21hdGNoJztcblxuXG5pbnRlcmZhY2UgSVRva2VuaXplZFN0cmluZyB7XG4gIHRva2Vuczogc3RyaW5nW10sXG4gIGNhdGVnb3JpemVkV29yZHM6IElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmdSYW5nZWRbXVtdXG4gIGZ1c2FibGU6IGJvb2xlYW5bXTtcbn1cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cbi8qKlxuICogR2l2ZW4gYSAgc3RyaW5nLCBicmVhayBpdCBkb3duIGludG8gY29tcG9uZW50cyxcbiAqIFtbJ0EnLCAnQiddLCBbJ0EgQiddXVxuICpcbiAqIHRoZW4gY2F0ZWdvcml6ZVdvcmRzXG4gKiByZXR1cm5pbmdcbiAqXG4gKiBbIFtbIHsgY2F0ZWdvcnk6ICdzeXN0ZW1JZCcsIHdvcmQgOiAnQSd9LFxuICogICAgICB7IGNhdGVnb3J5OiAnb3RoZXJ0aGluZycsIHdvcmQgOiAnQSd9XG4gKiAgICBdLFxuICogICAgLy8gcmVzdWx0IG9mIEJcbiAqICAgIFsgeyBjYXRlZ29yeTogJ3N5c3RlbUlkJywgd29yZCA6ICdCJ30sXG4gKiAgICAgIHsgY2F0ZWdvcnk6ICdvdGhlcnRoaW5nJywgd29yZCA6ICdBJ31cbiAqICAgICAgeyBjYXRlZ29yeTogJ2Fub3RoZXJ0cnlwJywgd29yZCA6ICdCJ31cbiAqICAgIF1cbiAqICAgXSxcbiAqIF1dXVxuICpcbiAqXG4gKlxuICovXG5leHBvcnQgZnVuY3Rpb24gdG9rZW5pemVTdHJpbmcoc1N0cmluZzogc3RyaW5nLCBydWxlczogSU1hdGNoLlNwbGl0UnVsZXMsXG4gIHdvcmRzOiB7IFtrZXk6IHN0cmluZ106IEFycmF5PElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmc+IH0pXG4gIDogSVRva2VuaXplZFN0cmluZyB7XG4gIHZhciBjbnQgPSAwO1xuICB2YXIgZmFjID0gMTtcbiAgdmFyIHRva2VucyA9IGJyZWFrZG93bi50b2tlbml6ZVN0cmluZyhzU3RyaW5nKTtcbiAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICBkZWJ1Z2xvZyhcImhlcmUgYnJlYWtkb3duXCIgKyBKU09OLnN0cmluZ2lmeSh0b2tlbnMpKTtcbiAgfVxuICAvL2NvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHUpKTtcbiAgd29yZHMgPSB3b3JkcyB8fCB7fTtcbiAgcGVyZmxvZygndGhpcyBtYW55IGtub3duIHdvcmRzOiAnICsgT2JqZWN0LmtleXMod29yZHMpLmxlbmd0aCk7XG4gIHZhciByZXMgPSBbXSBhcyBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkW11bXTtcbiAgdmFyIGNudFJlYyA9IHt9O1xuICB2YXIgY2F0ZWdvcml6ZWRTZW50ZW5jZSA9IFtdIGFzIElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmdSYW5nZWRbXVtdO1xuICB2YXIgaGFzUmVjb21iaW5lZCA9IGZhbHNlO1xuICB0b2tlbnMudG9rZW5zLmZvckVhY2goZnVuY3Rpb24gKHRva2VuLCBpbmRleCkge1xuICAgIHZhciBzZWVuSXQgPSBJbnB1dEZpbHRlci5jYXRlZ29yaXplQVdvcmRXaXRoT2Zmc2V0cyh0b2tlbiwgcnVsZXMsIHNTdHJpbmcsIHdvcmRzLCBjbnRSZWMpO1xuICAgIC8qIGNhbm5vdCBoYXZlIHRoaXMsIG9yIG5lZWQgdG8gYWRkIGFsbCBmcmFnbWVudCB3b3JkcyBcIlVJMiBJbnRlZ3JhdGlvblwiICBpZihzZWVuSXQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgKi9cbiAgICBoYXNSZWNvbWJpbmVkID0gaGFzUmVjb21iaW5lZCB8fCAhc2Vlbkl0LmV2ZXJ5KHJlcyA9PiAhcmVzLnJ1bGUucmFuZ2UpO1xuICAgIGRlYnVnbG9nKGAgY2F0ZWdvcml6ZWQgJHt0b2tlbn0vJHtpbmRleH0gdG8gYCArIEpTT04uc3RyaW5naWZ5KHNlZW5JdCkpO1xuICAgIGNhdGVnb3JpemVkU2VudGVuY2VbaW5kZXhdID0gc2Vlbkl0O1xuICAgIGNudCA9IGNudCArIHNlZW5JdC5sZW5ndGg7XG4gICAgZmFjID0gZmFjICogc2Vlbkl0Lmxlbmd0aDtcbiAgfSk7XG4gIC8vIGhhdmUgc2VlbiB0aGUgcGxhaW4gY2F0ZWdvcml6YXRpb24sXG4gIGRlYnVnbG9nKFwiIHNlbnRlbmNlcyBcIiArIHRva2Vucy50b2tlbnMubGVuZ3RoICsgXCIgbWF0Y2hlcyBcIiArIGNudCArIFwiIGZhYzogXCIgKyBmYWMpO1xuICBpZiAoZGVidWdsb2cuZW5hYmxlZCAmJiB0b2tlbnMudG9rZW5zLmxlbmd0aCkge1xuICAgIGRlYnVnbG9nKFwiZmlyc3QgbWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeSh0b2tlbnMsIHVuZGVmaW5lZCwgMikpO1xuICB9XG4gIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBgIHByaW9yIFJhbmdlUnVsZSAke0pTT04uc3RyaW5naWZ5KGNhdGVnb3JpemVkU2VudGVuY2UpfSBgIDogJy0nKTtcbiAgaWYgKGhhc1JlY29tYmluZWQpIHtcbiAgICBldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uKHRva2Vucy50b2tlbnMsIHRva2Vucy5mdXNhYmxlLCBjYXRlZ29yaXplZFNlbnRlbmNlKTtcbiAgfVxuICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gYCBhZnRlciBSYW5nZVJ1bGUgJHtKU09OLnN0cmluZ2lmeShjYXRlZ29yaXplZFNlbnRlbmNlKX0gYCA6ICctJyk7XG4gIHBlcmZsb2coXCIgc2VudGVuY2VzIFwiICsgdG9rZW5zLnRva2Vucy5sZW5ndGggKyBcIiAvIFwiICsgcmVzLmxlbmd0aCArIFwiIG1hdGNoZXMgXCIgKyBjbnQgKyBcIiBmYWM6IFwiICsgZmFjICsgXCIgcmVjIDogXCIgKyBKU09OLnN0cmluZ2lmeShjbnRSZWMsIHVuZGVmaW5lZCwgMikpO1xuICByZXR1cm4ge1xuICAgIGZ1c2FibGU6IHRva2Vucy5mdXNhYmxlLFxuICAgIHRva2VuczogdG9rZW5zLnRva2VucyxcbiAgICBjYXRlZ29yaXplZFdvcmRzOiBjYXRlZ29yaXplZFNlbnRlbmNlXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzU2FtZVJlcyhwcmVzZW50OiBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkLCByZXMgOiBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkKSAgOiBudW1iZXIge1xuICBpZighKChwcmVzZW50LnJ1bGUubWF0Y2hlZFN0cmluZyA9PT0gcmVzLnJ1bGUubWF0Y2hlZFN0cmluZylcbiAgICAmJiAocHJlc2VudC5ydWxlLmNhdGVnb3J5ID09PSByZXMucnVsZS5jYXRlZ29yeSlcbiAgICAmJiAocHJlc2VudC5zcGFuID09PSByZXMuc3BhbilcbiAgJiYgKHByZXNlbnQucnVsZS5iaXRpbmRleCA9PT0gcmVzLnJ1bGUuYml0aW5kZXgpKSkge1xuICAgICAgcmV0dXJuIDA7XG4gIH1cbiAgaWYocHJlc2VudC5fcmFua2luZyA8IHJlcy5fcmFua2luZykge1xuICAgIHJldHVybiAtMTtcbiAgfVxuICByZXR1cm4gKzE7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtZXJnZUlnbm9yZU9yQXBwZW5kKHJlc3VsdCA6IElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmdSYW5nZWRbXSwgcmVzIDogSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZCkge1xuICB2YXIgaW5zZXJ0aW5kZXggPSAtMTtcbiAgdmFyIGZvdW5kTm90aGluZyA9IHJlc3VsdC5ldmVyeSggKHByZXNlbnQsaW5kZXgpID0+IHtcbiAgICB2YXIgciA9IGlzU2FtZVJlcyhwcmVzZW50LHJlcyk7XG4gICAgaWYgKHIgPCAwKSB7XG4gICAgICAvL2NvbnNvbGUubG9nKFwib3ZlcndyaXRpbmcgd29yc2UgXFxuXCIgKyBKU09OLnN0cmluZ2lmeShyZXMpICsgJ1xcbicgKyBKU09OLnN0cmluZ2lmeShwcmVzZW50KSsgJ1xcbicpO1xuICAgICAgcmVzdWx0W2luZGV4XSA9IHJlcztcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9IGVsc2UgaWYociA+IDApIHtcbiAgICAgIC8vY29uc29sZS5sb2coJ3NraXBwaW5nIHByZXNlbnQnKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0pO1xuICBpZihmb3VuZE5vdGhpbmcpIHtcbiAgICAvL2RlYnVsb2coJ3B1c2hpbmcnKTtcbiAgICByZXN1bHQucHVzaChyZXMpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uKHRva2Vuczogc3RyaW5nW10sIGZ1c2FibGU6IGJvb2xlYW5bXSwgY2F0ZWdvcml6ZWRXb3JkczogSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZFtdW10pIHtcbiAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcImV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24uLi4gXCIgKyBKU09OLnN0cmluZ2lmeShjYXRlZ29yaXplZFdvcmRzKSkgOiAnLScpO1xuICBjYXRlZ29yaXplZFdvcmRzLmZvckVhY2goZnVuY3Rpb24gKHdvcmRsaXN0LCBpbmRleCkge1xuICAgIHdvcmRsaXN0LmZvckVhY2goZnVuY3Rpb24gKHdvcmQpIHtcbiAgICAgIGlmICh3b3JkLnJ1bGUucmFuZ2UpIHtcbiAgICAgICAgLy9jb25zb2xlLmxvZyhgIGdvdCB0YXJnZXRpbmRleCBmb3IgUmFuZ2VSdWxlcyBldmFsdWF0aW9uIDogJHt0YXJnZXRJbmRleH0gJHtpbmRleH0gJHtmdXNhYmxlLmpvaW4oXCIgXCIpfWApO1xuICAgICAgICB2YXIgdGFyZ2V0SW5kZXggPSBicmVha2Rvd24uaXNDb21iaW5hYmxlUmFuZ2VSZXR1cm5JbmRleCh3b3JkLnJ1bGUucmFuZ2UsIGZ1c2FibGUsIGluZGV4KTtcbiAgICAgICAgLy9jb25zb2xlLmxvZyhgIGdvdCB0YXJnZXRpbmRleCBmb3IgUmFuZ2VSdWxlcyBldmFsdWF0aW9uIDogJHt0YXJnZXRJbmRleH1gKTtcbiAgICAgICAgaWYgKHRhcmdldEluZGV4ID49IDApIHtcbiAgICAgICAgICB2YXIgY29tYmluZWRXb3JkID0gYnJlYWtkb3duLmNvbWJpbmVUb2tlbnMod29yZC5ydWxlLnJhbmdlLCBpbmRleCwgdG9rZW5zKTtcbiAgICAgICAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gKGAgdGVzdCBcIiR7Y29tYmluZWRXb3JkfVwiIGFnYWluc3QgXCIke3dvcmQucnVsZS5yYW5nZS5ydWxlLmxvd2VyY2FzZXdvcmR9XCIgJHtKU09OLnN0cmluZ2lmeSh3b3JkLnJ1bGUucmFuZ2UucnVsZSl9YCkgOiAnLScpO1xuICAgICAgICAgIHZhciByZXMgPSBJbnB1dEZpbHRlci5jYXRlZ29yaXplV29yZFdpdGhPZmZzZXRXaXRoUmFua0N1dG9mZlNpbmdsZShjb21iaW5lZFdvcmQsIHdvcmQucnVsZS5yYW5nZS5ydWxlKTtcbiAgICAgICAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gKFwiIGdvdCByZXMgOiBcIiArIEpTT04uc3RyaW5naWZ5KHJlcykpIDogJy0nKTtcbiAgICAgICAgICBpZiAocmVzKSB7XG4gICAgICAgICAgICByZXMuc3BhbiA9IHdvcmQucnVsZS5yYW5nZS5oaWdoIC0gd29yZC5ydWxlLnJhbmdlLmxvdyArIDE7XG4gICAgICAgICAgICBjYXRlZ29yaXplZFdvcmRzW3RhcmdldEluZGV4XSA9IGNhdGVnb3JpemVkV29yZHNbdGFyZ2V0SW5kZXhdLnNsaWNlKDApOyAvLyBhdm9pZCBpbnZhbGlkYXRpb24gb2Ygc2Vlbml0XG4gICAgICAgICAgICBkZWJ1Z2xvZyhgcHVzaGVkIHN0aCBhdCAke3RhcmdldEluZGV4fWApO1xuICAgICAgICAgICAgbWVyZ2VJZ25vcmVPckFwcGVuZChjYXRlZ29yaXplZFdvcmRzW3RhcmdldEluZGV4XSxyZXMpO1xuICAgLy8gICAgICAgICBjYXRlZ29yaXplZFdvcmRzW3RhcmdldEluZGV4XS5wdXNoKHJlcyk7IC8vIGNoZWNrIHRoYXQgdGhpcyBkb2VzIG5vdCBpbnZhbGlkYXRlIHNlZW5pdCFcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG4gIC8vIGZpbHRlciBhbGwgcmFuZ2UgcnVsZXMgIVxuICBjYXRlZ29yaXplZFdvcmRzLmZvckVhY2goZnVuY3Rpb24gKHdvcmRsaXN0LCBpbmRleCkge1xuICAgIGNhdGVnb3JpemVkV29yZHNbaW5kZXhdID0gd29yZGxpc3QuZmlsdGVyKHdvcmQgPT4gIXdvcmQucnVsZS5yYW5nZSk7XG4gIH0pO1xufVxuXG5cblxuXG5jb25zdCBjbG9uZSA9IFV0aWxzLmNsb25lRGVlcDtcblxuXG5cblxuZnVuY3Rpb24gY29weVZlY01lbWJlcnModSkge1xuICB2YXIgaSA9IDA7XG4gIGZvciAoaSA9IDA7IGkgPCB1Lmxlbmd0aDsgKytpKSB7XG4gICAgdVtpXSA9IGNsb25lKHVbaV0pO1xuICB9XG4gIHJldHVybiB1O1xufVxuXG5cbi8vIHdlIGNhbiByZXBsaWNhdGUgdGhlIHRhaWwgb3IgdGhlIGhlYWQsXG4vLyB3ZSByZXBsaWNhdGUgdGhlIHRhaWwgYXMgaXQgaXMgc21hbGxlci5cbi8vIFthLGIsYyBdXG5cbmV4cG9ydCBmdW5jdGlvbiBpc1NwYW5WZWModmVjOiBBcnJheTxhbnk+LCBpbmRleDogbnVtYmVyKSB7XG4gIHZhciBlZmZlY3RpdmVsZW4gPSB2ZWMucmVkdWNlKChwcmV2LCBtZW0pID0+IHByZXYgKz0gbWVtLnNwYW4gPyBtZW0uc3BhbiA6IDEsIDApO1xuICByZXR1cm4gZWZmZWN0aXZlbGVuID4gaW5kZXg7XG59XG5cbi8qKlxuICogZXhwYW5kIGFuIGFycmF5IFtbYTEsYTJdLCBbYjEsYjJdLFtjXV1cbiAqIGludG8gYWxsIGNvbWJpbmF0aW9uc1xuICpcbiAqICBpZiBhMSBoYXMgYSBzcGFuIG9mIHRocmVlLCB0aGUgdmFyaWF0aW9ucyBvZiB0aGUgbG93ZXIgbGF5ZXIgYXJlIHNraXBwZWRcbiAqXG4gKiB3aXRoIHRoZSBzcGVjaWFsIHByb3BlcnR5XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBleHBhbmRUb2tlbk1hdGNoZXNUb1NlbnRlbmNlcyh0b2tlbnM6IHN0cmluZ1tdLCB0b2tlbk1hdGNoZXM6IEFycmF5PEFycmF5PGFueT4+KTogSU1hdGNoLklQcm9jZXNzZWRTZW50ZW5jZXMge1xuICB2YXIgYSA9IFtdO1xuICB2YXIgd29yZE1hdGNoZXMgPSBbXTtcbiAgZGVidWdsb2dWKGRlYnVnbG9nLmVuYWJsZWQgPyBKU09OLnN0cmluZ2lmeSh0b2tlbk1hdGNoZXMpIDogJy0nKTtcbiAgdG9rZW5NYXRjaGVzLmZvckVhY2goZnVuY3Rpb24gKGFXb3JkTWF0Y2hlcywgd29yZEluZGV4OiBudW1iZXIpIHtcbiAgICB3b3JkTWF0Y2hlc1t3b3JkSW5kZXhdID0gW107XG4gICAgYVdvcmRNYXRjaGVzLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkVmFyaWFudCwgd29yZFZhcmlhbnRJbmRleDogbnVtYmVyKSB7XG4gICAgICB3b3JkTWF0Y2hlc1t3b3JkSW5kZXhdW3dvcmRWYXJpYW50SW5kZXhdID0gb1dvcmRWYXJpYW50O1xuICAgIH0pO1xuICB9KTtcbiAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IEpTT04uc3RyaW5naWZ5KHRva2VuTWF0Y2hlcykgOiAnLScpO1xuICB2YXIgcmVzdWx0ID0ge1xuICAgIGVycm9yczogW10sXG4gICAgdG9rZW5zOiB0b2tlbnMsXG4gICAgc2VudGVuY2VzOiBbXVxuICB9IGFzIElNYXRjaC5JUHJvY2Vzc2VkU2VudGVuY2VzO1xuICB2YXIgbnZlY3MgPSBbXTtcbiAgdmFyIHJlcyA9IFtbXV07XG4gIC8vIHZhciBudmVjcyA9IFtdO1xuICB2YXIgcnZlYyA9IFtdO1xuICBmb3IgKHZhciB0b2tlbkluZGV4ID0gMDsgdG9rZW5JbmRleCA8IHRva2VuTWF0Y2hlcy5sZW5ndGg7ICsrdG9rZW5JbmRleCkgeyAvLyB3b3JkZyBpbmRleCBrXG4gICAgLy92ZWNzIGlzIHRoZSB2ZWN0b3Igb2YgYWxsIHNvIGZhciBzZWVuIHZhcmlhbnRzIHVwIHRvIGsgbGVuZ3RoLlxuICAgIHZhciBuZXh0QmFzZSA9IFtdO1xuICAgIC8vaW5kZXBlbmRlbnQgb2YgZXhpc3RlbmNlIG9mIG1hdGNoZXMgb24gbGV2ZWwgaywgd2UgcmV0YWluIGFsbCB2ZWN0b3JzIHdoaWNoIGFyZSBjb3ZlcmVkIGJ5IGEgc3BhblxuICAgIC8vIHdlIHNraXAgZXh0ZW5kaW5nIHRoZW0gYmVsb3dcbiAgICBmb3IgKHZhciB1ID0gMDsgdSA8IHJlcy5sZW5ndGg7ICsrdSkge1xuICAgICAgaWYgKGlzU3BhblZlYyhyZXNbdV0sIHRva2VuSW5kZXgpKSB7XG4gICAgICAgIG5leHRCYXNlLnB1c2gocmVzW3VdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIGxlbk1hdGNoZXMgPSB0b2tlbk1hdGNoZXNbdG9rZW5JbmRleF0ubGVuZ3RoO1xuICAgIGlmIChuZXh0QmFzZS5sZW5ndGggPT09IDAgJiYgbGVuTWF0Y2hlcyA9PT0gMCkge1xuICAgICAgLy8gdGhlIHdvcmQgYXQgaW5kZXggSSBjYW5ub3QgYmUgdW5kZXJzdG9vZFxuICAgICAgLy9pZiAocmVzdWx0LmVycm9ycy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJlc3VsdC5lcnJvcnMucHVzaChFUkVycm9yLm1ha2VFcnJvcl9OT19LTk9XTl9XT1JEKHRva2VuSW5kZXgsIHRva2VucykpO1xuICAgICAgLy99XG4gICAgfVxuICAgIGZvciAodmFyIGwgPSAwOyBsIDwgbGVuTWF0Y2hlczsgKytsKSB7IC8vIGZvciBlYWNoIHZhcmlhbnQgcHJlc2VudCBhdCBpbmRleCBrXG4gICAgICAvL2RlYnVnbG9nKFwidmVjcyBub3dcIiArIEpTT04uc3RyaW5naWZ5KHZlY3MpKTtcbiAgICAgIHZhciBudmVjcyA9IFtdOyAvL3ZlY3Muc2xpY2UoKTsgLy8gY29weSB0aGUgdmVjW2ldIGJhc2UgdmVjdG9yO1xuICAgICAgLy9kZWJ1Z2xvZyhcInZlY3MgY29waWVkIG5vd1wiICsgSlNPTi5zdHJpbmdpZnkobnZlY3MpKTtcbiAgICAgIGZvciAodmFyIHUgPSAwOyB1IDwgcmVzLmxlbmd0aDsgKyt1KSB7XG4gICAgICAgIGlmICghaXNTcGFuVmVjKHJlc1t1XSwgdG9rZW5JbmRleCkpIHtcbiAgICAgICAgICAvLyBmb3IgZWFjaCBzbyBmYXIgY29uc3RydWN0ZWQgcmVzdWx0IChvZiBsZW5ndGggaykgaW4gcmVzXG4gICAgICAgICAgbnZlY3MucHVzaChyZXNbdV0uc2xpY2UoKSk7IC8vIG1ha2UgYSBjb3B5IG9mIGVhY2ggdmVjdG9yXG4gICAgICAgICAgbnZlY3NbbnZlY3MubGVuZ3RoIC0gMV0gPSBjb3B5VmVjTWVtYmVycyhudmVjc1tudmVjcy5sZW5ndGggLSAxXSk7XG4gICAgICAgICAgLy8gZGVidWdsb2coXCJjb3BpZWQgdmVjc1tcIisgdStcIl1cIiArIEpTT04uc3RyaW5naWZ5KHZlY3NbdV0pKTtcbiAgICAgICAgICBudmVjc1tudmVjcy5sZW5ndGggLSAxXS5wdXNoKFxuICAgICAgICAgICAgY2xvbmUodG9rZW5NYXRjaGVzW3Rva2VuSW5kZXhdW2xdKSk7IC8vIHB1c2ggdGhlIGx0aCB2YXJpYW50XG4gICAgICAgICAgLy8gZGVidWdsb2coXCJub3cgbnZlY3MgXCIgKyBudmVjcy5sZW5ndGggKyBcIiBcIiArIEpTT04uc3RyaW5naWZ5KG52ZWNzKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vICAgZGVidWdsb2coXCIgYXQgICAgIFwiICsgayArIFwiOlwiICsgbCArIFwiIG5leHRiYXNlID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSlcbiAgICAgIC8vICAgZGVidWdsb2coXCIgYXBwZW5kIFwiICsgayArIFwiOlwiICsgbCArIFwiIG52ZWNzICAgID5cIiArIEpTT04uc3RyaW5naWZ5KG52ZWNzKSlcbiAgICAgIG5leHRCYXNlID0gbmV4dEJhc2UuY29uY2F0KG52ZWNzKTtcbiAgICAgIC8vICAgZGVidWdsb2coXCIgIHJlc3VsdCBcIiArIGsgKyBcIjpcIiArIGwgKyBcIiBudmVjcyAgICA+XCIgKyBKU09OLnN0cmluZ2lmeShuZXh0QmFzZSkpXG4gICAgfSAvL2NvbnN0cnVcbiAgICAvLyAgZGVidWdsb2coXCJub3cgYXQgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgPlwiICsgSlNPTi5zdHJpbmdpZnkobmV4dEJhc2UpKVxuICAgIHJlcyA9IG5leHRCYXNlO1xuICB9XG4gIGRlYnVnbG9nVihkZWJ1Z2xvZ1YuZW5hYmxlZCA/IChcIkFQUEVORElORyBUTyBSRVNcIiArIDAgKyBcIjpcIiArIGwgKyBcIiA+XCIgKyBKU09OLnN0cmluZ2lmeShuZXh0QmFzZSkpIDogJy0nKTtcbiAgcmVzdWx0LnNlbnRlbmNlcyA9IHJlcztcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gcHJvY2Vzc1N0cmluZyhxdWVyeTogc3RyaW5nLCBydWxlczogSU1hdGNoLlNwbGl0UnVsZXMsXG4gd29yZHM6IHsgW2tleTogc3RyaW5nXTogQXJyYXk8SU1hdGNoLklDYXRlZ29yaXplZFN0cmluZz4gfVxuKTogIElNYXRjaC5JUHJvY2Vzc2VkU2VudGVuY2VzIHtcbiAgd29yZHMgPSB3b3JkcyB8fCB7fTtcbiAgdmFyIHRva2VuU3RydWN0ID0gdG9rZW5pemVTdHJpbmcocXVlcnksIHJ1bGVzLCB3b3Jkcyk7XG4gIGV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24odG9rZW5TdHJ1Y3QudG9rZW5zLCB0b2tlblN0cnVjdC5mdXNhYmxlLFxuICAgIHRva2VuU3RydWN0LmNhdGVnb3JpemVkV29yZHMpO1xuICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KHRva2VuU3RydWN0LmNhdGVnb3JpemVkV29yZHMpKTtcbiAgfVxuICB2YXIgYVNlbnRlbmNlcyA9IGV4cGFuZFRva2VuTWF0Y2hlc1RvU2VudGVuY2VzKHRva2VuU3RydWN0LnRva2VucywgdG9rZW5TdHJ1Y3QuY2F0ZWdvcml6ZWRXb3Jkcyk7XG4gIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgZGVidWdsb2coXCJhZnRlciBleHBhbmRcIiArIGFTZW50ZW5jZXMuc2VudGVuY2VzLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIFNlbnRlbmNlLmR1bXBOaWNlKG9TZW50ZW5jZSk7IC8vSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgfVxuICBhU2VudGVuY2VzLnNlbnRlbmNlcyA9IElucHV0RmlsdGVyLnJlaW5Gb3JjZShhU2VudGVuY2VzLnNlbnRlbmNlcyk7XG4gIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgZGVidWdsb2coXCJhZnRlciByZWluZm9yY2VcIiArIGFTZW50ZW5jZXMuc2VudGVuY2VzLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgfVxuICByZXR1cm4gYVNlbnRlbmNlcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNpbXBsaWZ5U2VudGVuY2UocmVzKSB7XG4gIHJldHVybiByZXMubWFwKGZ1bmN0aW9uIChyKSB7XG4gICAgcmV0dXJuIHIubWFwKHdvcmQgPT4geyByZXR1cm4gd29yZC5zdHJpbmcgKyAnPT4nICsgd29yZC5tYXRjaGVkU3RyaW5nICsgJy8nICsgd29yZC5jYXRlZ29yeSArICh3b3JkLnNwYW4gPyAnLycgKyB3b3JkLnNwYW4gOiAnJykgfSlcbiAgfSk7XG59XG4iLCIvKipcbiAqXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5hbmFseXplXG4gKiBAZmlsZSBlcmJhc2VcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqXG4gKiBCYXNpYyBkb21haW4gYmFzZWQgZW50aXR5IHJlY29nbml0aW9uXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIElucHV0RmlsdGVyID0gcmVxdWlyZShcIi4vaW5wdXRGaWx0ZXJcIik7XG52YXIgZGVidWcgPSByZXF1aXJlKFwiZGVidWdcIik7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnZXJiYXNlJyk7XG52YXIgZGVidWdsb2dWID0gZGVidWcoJ2VyYmFzZScpO1xudmFyIHBlcmZsb2cgPSBkZWJ1ZygncGVyZicpO1xudmFyIGZkZXZzdGFfbW9ubW92ZV8xID0gcmVxdWlyZShcImZkZXZzdGFfbW9ubW92ZVwiKTtcbnZhciBFUkVycm9yID0gcmVxdWlyZShcIi4vZXJlcnJvclwiKTtcbnZhciBBbnlPYmplY3QgPSBPYmplY3Q7XG5mdW5jdGlvbiBtb2NrRGVidWcobykge1xuICAgIGRlYnVnbG9nID0gbztcbiAgICBkZWJ1Z2xvZ1YgPSBvO1xuICAgIHBlcmZsb2cgPSBvO1xufVxuZXhwb3J0cy5tb2NrRGVidWcgPSBtb2NrRGVidWc7XG52YXIgVXRpbHMgPSByZXF1aXJlKFwiYWJvdF91dGlsc1wiKTtcbnZhciBTZW50ZW5jZSA9IHJlcXVpcmUoXCIuL3NlbnRlbmNlXCIpO1xuLyoqXG4gKiBHaXZlbiBhICBzdHJpbmcsIGJyZWFrIGl0IGRvd24gaW50byBjb21wb25lbnRzLFxuICogW1snQScsICdCJ10sIFsnQSBCJ11dXG4gKlxuICogdGhlbiBjYXRlZ29yaXplV29yZHNcbiAqIHJldHVybmluZ1xuICpcbiAqIFsgW1sgeyBjYXRlZ29yeTogJ3N5c3RlbUlkJywgd29yZCA6ICdBJ30sXG4gKiAgICAgIHsgY2F0ZWdvcnk6ICdvdGhlcnRoaW5nJywgd29yZCA6ICdBJ31cbiAqICAgIF0sXG4gKiAgICAvLyByZXN1bHQgb2YgQlxuICogICAgWyB7IGNhdGVnb3J5OiAnc3lzdGVtSWQnLCB3b3JkIDogJ0InfSxcbiAqICAgICAgeyBjYXRlZ29yeTogJ290aGVydGhpbmcnLCB3b3JkIDogJ0EnfVxuICogICAgICB7IGNhdGVnb3J5OiAnYW5vdGhlcnRyeXAnLCB3b3JkIDogJ0InfVxuICogICAgXVxuICogICBdLFxuICogXV1dXG4gKlxuICpcbiAqXG4gKi9cbmZ1bmN0aW9uIHRva2VuaXplU3RyaW5nKHNTdHJpbmcsIHJ1bGVzLCB3b3Jkcykge1xuICAgIHZhciBjbnQgPSAwO1xuICAgIHZhciBmYWMgPSAxO1xuICAgIHZhciB0b2tlbnMgPSBmZGV2c3RhX21vbm1vdmVfMS5CcmVha0Rvd24udG9rZW5pemVTdHJpbmcoc1N0cmluZyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgZGVidWdsb2coXCJoZXJlIGJyZWFrZG93blwiICsgSlNPTi5zdHJpbmdpZnkodG9rZW5zKSk7XG4gICAgfVxuICAgIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkodSkpO1xuICAgIHdvcmRzID0gd29yZHMgfHwge307XG4gICAgcGVyZmxvZygndGhpcyBtYW55IGtub3duIHdvcmRzOiAnICsgT2JqZWN0LmtleXMod29yZHMpLmxlbmd0aCk7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHZhciBjbnRSZWMgPSB7fTtcbiAgICB2YXIgY2F0ZWdvcml6ZWRTZW50ZW5jZSA9IFtdO1xuICAgIHZhciBoYXNSZWNvbWJpbmVkID0gZmFsc2U7XG4gICAgdG9rZW5zLnRva2Vucy5mb3JFYWNoKGZ1bmN0aW9uICh0b2tlbiwgaW5kZXgpIHtcbiAgICAgICAgdmFyIHNlZW5JdCA9IElucHV0RmlsdGVyLmNhdGVnb3JpemVBV29yZFdpdGhPZmZzZXRzKHRva2VuLCBydWxlcywgc1N0cmluZywgd29yZHMsIGNudFJlYyk7XG4gICAgICAgIC8qIGNhbm5vdCBoYXZlIHRoaXMsIG9yIG5lZWQgdG8gYWRkIGFsbCBmcmFnbWVudCB3b3JkcyBcIlVJMiBJbnRlZ3JhdGlvblwiICBpZihzZWVuSXQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKi9cbiAgICAgICAgaGFzUmVjb21iaW5lZCA9IGhhc1JlY29tYmluZWQgfHwgIXNlZW5JdC5ldmVyeShmdW5jdGlvbiAocmVzKSB7IHJldHVybiAhcmVzLnJ1bGUucmFuZ2U7IH0pO1xuICAgICAgICBkZWJ1Z2xvZyhcIiBjYXRlZ29yaXplZCBcIiArIHRva2VuICsgXCIvXCIgKyBpbmRleCArIFwiIHRvIFwiICsgSlNPTi5zdHJpbmdpZnkoc2Vlbkl0KSk7XG4gICAgICAgIGNhdGVnb3JpemVkU2VudGVuY2VbaW5kZXhdID0gc2Vlbkl0O1xuICAgICAgICBjbnQgPSBjbnQgKyBzZWVuSXQubGVuZ3RoO1xuICAgICAgICBmYWMgPSBmYWMgKiBzZWVuSXQubGVuZ3RoO1xuICAgIH0pO1xuICAgIC8vIGhhdmUgc2VlbiB0aGUgcGxhaW4gY2F0ZWdvcml6YXRpb24sXG4gICAgZGVidWdsb2coXCIgc2VudGVuY2VzIFwiICsgdG9rZW5zLnRva2Vucy5sZW5ndGggKyBcIiBtYXRjaGVzIFwiICsgY250ICsgXCIgZmFjOiBcIiArIGZhYyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQgJiYgdG9rZW5zLnRva2Vucy5sZW5ndGgpIHtcbiAgICAgICAgZGVidWdsb2coXCJmaXJzdCBtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KHRva2VucywgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBcIiBwcmlvciBSYW5nZVJ1bGUgXCIgKyBKU09OLnN0cmluZ2lmeShjYXRlZ29yaXplZFNlbnRlbmNlKSArIFwiIFwiIDogJy0nKTtcbiAgICBpZiAoaGFzUmVjb21iaW5lZCkge1xuICAgICAgICBldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uKHRva2Vucy50b2tlbnMsIHRva2Vucy5mdXNhYmxlLCBjYXRlZ29yaXplZFNlbnRlbmNlKTtcbiAgICB9XG4gICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IFwiIGFmdGVyIFJhbmdlUnVsZSBcIiArIEpTT04uc3RyaW5naWZ5KGNhdGVnb3JpemVkU2VudGVuY2UpICsgXCIgXCIgOiAnLScpO1xuICAgIHBlcmZsb2coXCIgc2VudGVuY2VzIFwiICsgdG9rZW5zLnRva2Vucy5sZW5ndGggKyBcIiAvIFwiICsgcmVzLmxlbmd0aCArIFwiIG1hdGNoZXMgXCIgKyBjbnQgKyBcIiBmYWM6IFwiICsgZmFjICsgXCIgcmVjIDogXCIgKyBKU09OLnN0cmluZ2lmeShjbnRSZWMsIHVuZGVmaW5lZCwgMikpO1xuICAgIHJldHVybiB7XG4gICAgICAgIGZ1c2FibGU6IHRva2Vucy5mdXNhYmxlLFxuICAgICAgICB0b2tlbnM6IHRva2Vucy50b2tlbnMsXG4gICAgICAgIGNhdGVnb3JpemVkV29yZHM6IGNhdGVnb3JpemVkU2VudGVuY2VcbiAgICB9O1xufVxuZXhwb3J0cy50b2tlbml6ZVN0cmluZyA9IHRva2VuaXplU3RyaW5nO1xuZnVuY3Rpb24gaXNTYW1lUmVzKHByZXNlbnQsIHJlcykge1xuICAgIGlmICghKChwcmVzZW50LnJ1bGUubWF0Y2hlZFN0cmluZyA9PT0gcmVzLnJ1bGUubWF0Y2hlZFN0cmluZylcbiAgICAgICAgJiYgKHByZXNlbnQucnVsZS5jYXRlZ29yeSA9PT0gcmVzLnJ1bGUuY2F0ZWdvcnkpXG4gICAgICAgICYmIChwcmVzZW50LnNwYW4gPT09IHJlcy5zcGFuKVxuICAgICAgICAmJiAocHJlc2VudC5ydWxlLmJpdGluZGV4ID09PSByZXMucnVsZS5iaXRpbmRleCkpKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICBpZiAocHJlc2VudC5fcmFua2luZyA8IHJlcy5fcmFua2luZykge1xuICAgICAgICByZXR1cm4gLTE7XG4gICAgfVxuICAgIHJldHVybiArMTtcbn1cbmV4cG9ydHMuaXNTYW1lUmVzID0gaXNTYW1lUmVzO1xuZnVuY3Rpb24gbWVyZ2VJZ25vcmVPckFwcGVuZChyZXN1bHQsIHJlcykge1xuICAgIHZhciBpbnNlcnRpbmRleCA9IC0xO1xuICAgIHZhciBmb3VuZE5vdGhpbmcgPSByZXN1bHQuZXZlcnkoZnVuY3Rpb24gKHByZXNlbnQsIGluZGV4KSB7XG4gICAgICAgIHZhciByID0gaXNTYW1lUmVzKHByZXNlbnQsIHJlcyk7XG4gICAgICAgIGlmIChyIDwgMCkge1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcIm92ZXJ3cml0aW5nIHdvcnNlIFxcblwiICsgSlNPTi5zdHJpbmdpZnkocmVzKSArICdcXG4nICsgSlNPTi5zdHJpbmdpZnkocHJlc2VudCkrICdcXG4nKTtcbiAgICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSByZXM7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAociA+IDApIHtcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ3NraXBwaW5nIHByZXNlbnQnKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgICBpZiAoZm91bmROb3RoaW5nKSB7XG4gICAgICAgIC8vZGVidWxvZygncHVzaGluZycpO1xuICAgICAgICByZXN1bHQucHVzaChyZXMpO1xuICAgIH1cbn1cbmV4cG9ydHMubWVyZ2VJZ25vcmVPckFwcGVuZCA9IG1lcmdlSWdub3JlT3JBcHBlbmQ7XG5mdW5jdGlvbiBldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uKHRva2VucywgZnVzYWJsZSwgY2F0ZWdvcml6ZWRXb3Jkcykge1xuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCJldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uLi4uIFwiICsgSlNPTi5zdHJpbmdpZnkoY2F0ZWdvcml6ZWRXb3JkcykpIDogJy0nKTtcbiAgICBjYXRlZ29yaXplZFdvcmRzLmZvckVhY2goZnVuY3Rpb24gKHdvcmRsaXN0LCBpbmRleCkge1xuICAgICAgICB3b3JkbGlzdC5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkKSB7XG4gICAgICAgICAgICBpZiAod29yZC5ydWxlLnJhbmdlKSB7XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhgIGdvdCB0YXJnZXRpbmRleCBmb3IgUmFuZ2VSdWxlcyBldmFsdWF0aW9uIDogJHt0YXJnZXRJbmRleH0gJHtpbmRleH0gJHtmdXNhYmxlLmpvaW4oXCIgXCIpfWApO1xuICAgICAgICAgICAgICAgIHZhciB0YXJnZXRJbmRleCA9IGZkZXZzdGFfbW9ubW92ZV8xLkJyZWFrRG93bi5pc0NvbWJpbmFibGVSYW5nZVJldHVybkluZGV4KHdvcmQucnVsZS5yYW5nZSwgZnVzYWJsZSwgaW5kZXgpO1xuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coYCBnb3QgdGFyZ2V0aW5kZXggZm9yIFJhbmdlUnVsZXMgZXZhbHVhdGlvbiA6ICR7dGFyZ2V0SW5kZXh9YCk7XG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldEluZGV4ID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkV29yZCA9IGZkZXZzdGFfbW9ubW92ZV8xLkJyZWFrRG93bi5jb21iaW5lVG9rZW5zKHdvcmQucnVsZS5yYW5nZSwgaW5kZXgsIHRva2Vucyk7XG4gICAgICAgICAgICAgICAgICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCIgdGVzdCBcXFwiXCIgKyBjb21iaW5lZFdvcmQgKyBcIlxcXCIgYWdhaW5zdCBcXFwiXCIgKyB3b3JkLnJ1bGUucmFuZ2UucnVsZS5sb3dlcmNhc2V3b3JkICsgXCJcXFwiIFwiICsgSlNPTi5zdHJpbmdpZnkod29yZC5ydWxlLnJhbmdlLnJ1bGUpKSA6ICctJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSBJbnB1dEZpbHRlci5jYXRlZ29yaXplV29yZFdpdGhPZmZzZXRXaXRoUmFua0N1dG9mZlNpbmdsZShjb21iaW5lZFdvcmQsIHdvcmQucnVsZS5yYW5nZS5ydWxlKTtcbiAgICAgICAgICAgICAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcIiBnb3QgcmVzIDogXCIgKyBKU09OLnN0cmluZ2lmeShyZXMpKSA6ICctJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5zcGFuID0gd29yZC5ydWxlLnJhbmdlLmhpZ2ggLSB3b3JkLnJ1bGUucmFuZ2UubG93ICsgMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGVnb3JpemVkV29yZHNbdGFyZ2V0SW5kZXhdID0gY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0uc2xpY2UoMCk7IC8vIGF2b2lkIGludmFsaWRhdGlvbiBvZiBzZWVuaXRcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwicHVzaGVkIHN0aCBhdCBcIiArIHRhcmdldEluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlSWdub3JlT3JBcHBlbmQoY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0sIHJlcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIC8vIGZpbHRlciBhbGwgcmFuZ2UgcnVsZXMgIVxuICAgIGNhdGVnb3JpemVkV29yZHMuZm9yRWFjaChmdW5jdGlvbiAod29yZGxpc3QsIGluZGV4KSB7XG4gICAgICAgIGNhdGVnb3JpemVkV29yZHNbaW5kZXhdID0gd29yZGxpc3QuZmlsdGVyKGZ1bmN0aW9uICh3b3JkKSB7IHJldHVybiAhd29yZC5ydWxlLnJhbmdlOyB9KTtcbiAgICB9KTtcbn1cbmV4cG9ydHMuZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbiA9IGV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb247XG52YXIgY2xvbmUgPSBVdGlscy5jbG9uZURlZXA7XG5mdW5jdGlvbiBjb3B5VmVjTWVtYmVycyh1KSB7XG4gICAgdmFyIGkgPSAwO1xuICAgIGZvciAoaSA9IDA7IGkgPCB1Lmxlbmd0aDsgKytpKSB7XG4gICAgICAgIHVbaV0gPSBjbG9uZSh1W2ldKTtcbiAgICB9XG4gICAgcmV0dXJuIHU7XG59XG4vLyB3ZSBjYW4gcmVwbGljYXRlIHRoZSB0YWlsIG9yIHRoZSBoZWFkLFxuLy8gd2UgcmVwbGljYXRlIHRoZSB0YWlsIGFzIGl0IGlzIHNtYWxsZXIuXG4vLyBbYSxiLGMgXVxuZnVuY3Rpb24gaXNTcGFuVmVjKHZlYywgaW5kZXgpIHtcbiAgICB2YXIgZWZmZWN0aXZlbGVuID0gdmVjLnJlZHVjZShmdW5jdGlvbiAocHJldiwgbWVtKSB7IHJldHVybiBwcmV2ICs9IG1lbS5zcGFuID8gbWVtLnNwYW4gOiAxOyB9LCAwKTtcbiAgICByZXR1cm4gZWZmZWN0aXZlbGVuID4gaW5kZXg7XG59XG5leHBvcnRzLmlzU3BhblZlYyA9IGlzU3BhblZlYztcbi8qKlxuICogZXhwYW5kIGFuIGFycmF5IFtbYTEsYTJdLCBbYjEsYjJdLFtjXV1cbiAqIGludG8gYWxsIGNvbWJpbmF0aW9uc1xuICpcbiAqICBpZiBhMSBoYXMgYSBzcGFuIG9mIHRocmVlLCB0aGUgdmFyaWF0aW9ucyBvZiB0aGUgbG93ZXIgbGF5ZXIgYXJlIHNraXBwZWRcbiAqXG4gKiB3aXRoIHRoZSBzcGVjaWFsIHByb3BlcnR5XG4gKi9cbmZ1bmN0aW9uIGV4cGFuZFRva2VuTWF0Y2hlc1RvU2VudGVuY2VzKHRva2VucywgdG9rZW5NYXRjaGVzKSB7XG4gICAgdmFyIGEgPSBbXTtcbiAgICB2YXIgd29yZE1hdGNoZXMgPSBbXTtcbiAgICBkZWJ1Z2xvZ1YoZGVidWdsb2cuZW5hYmxlZCA/IEpTT04uc3RyaW5naWZ5KHRva2VuTWF0Y2hlcykgOiAnLScpO1xuICAgIHRva2VuTWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChhV29yZE1hdGNoZXMsIHdvcmRJbmRleCkge1xuICAgICAgICB3b3JkTWF0Y2hlc1t3b3JkSW5kZXhdID0gW107XG4gICAgICAgIGFXb3JkTWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZFZhcmlhbnQsIHdvcmRWYXJpYW50SW5kZXgpIHtcbiAgICAgICAgICAgIHdvcmRNYXRjaGVzW3dvcmRJbmRleF1bd29yZFZhcmlhbnRJbmRleF0gPSBvV29yZFZhcmlhbnQ7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBKU09OLnN0cmluZ2lmeSh0b2tlbk1hdGNoZXMpIDogJy0nKTtcbiAgICB2YXIgcmVzdWx0ID0ge1xuICAgICAgICBlcnJvcnM6IFtdLFxuICAgICAgICB0b2tlbnM6IHRva2VucyxcbiAgICAgICAgc2VudGVuY2VzOiBbXVxuICAgIH07XG4gICAgdmFyIG52ZWNzID0gW107XG4gICAgdmFyIHJlcyA9IFtbXV07XG4gICAgLy8gdmFyIG52ZWNzID0gW107XG4gICAgdmFyIHJ2ZWMgPSBbXTtcbiAgICBmb3IgKHZhciB0b2tlbkluZGV4ID0gMDsgdG9rZW5JbmRleCA8IHRva2VuTWF0Y2hlcy5sZW5ndGg7ICsrdG9rZW5JbmRleCkge1xuICAgICAgICAvL3ZlY3MgaXMgdGhlIHZlY3RvciBvZiBhbGwgc28gZmFyIHNlZW4gdmFyaWFudHMgdXAgdG8gayBsZW5ndGguXG4gICAgICAgIHZhciBuZXh0QmFzZSA9IFtdO1xuICAgICAgICAvL2luZGVwZW5kZW50IG9mIGV4aXN0ZW5jZSBvZiBtYXRjaGVzIG9uIGxldmVsIGssIHdlIHJldGFpbiBhbGwgdmVjdG9ycyB3aGljaCBhcmUgY292ZXJlZCBieSBhIHNwYW5cbiAgICAgICAgLy8gd2Ugc2tpcCBleHRlbmRpbmcgdGhlbSBiZWxvd1xuICAgICAgICBmb3IgKHZhciB1ID0gMDsgdSA8IHJlcy5sZW5ndGg7ICsrdSkge1xuICAgICAgICAgICAgaWYgKGlzU3BhblZlYyhyZXNbdV0sIHRva2VuSW5kZXgpKSB7XG4gICAgICAgICAgICAgICAgbmV4dEJhc2UucHVzaChyZXNbdV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciBsZW5NYXRjaGVzID0gdG9rZW5NYXRjaGVzW3Rva2VuSW5kZXhdLmxlbmd0aDtcbiAgICAgICAgaWYgKG5leHRCYXNlLmxlbmd0aCA9PT0gMCAmJiBsZW5NYXRjaGVzID09PSAwKSB7XG4gICAgICAgICAgICAvLyB0aGUgd29yZCBhdCBpbmRleCBJIGNhbm5vdCBiZSB1bmRlcnN0b29kXG4gICAgICAgICAgICAvL2lmIChyZXN1bHQuZXJyb3JzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmVzdWx0LmVycm9ycy5wdXNoKEVSRXJyb3IubWFrZUVycm9yX05PX0tOT1dOX1dPUkQodG9rZW5JbmRleCwgdG9rZW5zKSk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgbCA9IDA7IGwgPCBsZW5NYXRjaGVzOyArK2wpIHtcbiAgICAgICAgICAgIC8vZGVidWdsb2coXCJ2ZWNzIG5vd1wiICsgSlNPTi5zdHJpbmdpZnkodmVjcykpO1xuICAgICAgICAgICAgdmFyIG52ZWNzID0gW107IC8vdmVjcy5zbGljZSgpOyAvLyBjb3B5IHRoZSB2ZWNbaV0gYmFzZSB2ZWN0b3I7XG4gICAgICAgICAgICAvL2RlYnVnbG9nKFwidmVjcyBjb3BpZWQgbm93XCIgKyBKU09OLnN0cmluZ2lmeShudmVjcykpO1xuICAgICAgICAgICAgZm9yICh2YXIgdSA9IDA7IHUgPCByZXMubGVuZ3RoOyArK3UpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWlzU3BhblZlYyhyZXNbdV0sIHRva2VuSW5kZXgpKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGZvciBlYWNoIHNvIGZhciBjb25zdHJ1Y3RlZCByZXN1bHQgKG9mIGxlbmd0aCBrKSBpbiByZXNcbiAgICAgICAgICAgICAgICAgICAgbnZlY3MucHVzaChyZXNbdV0uc2xpY2UoKSk7IC8vIG1ha2UgYSBjb3B5IG9mIGVhY2ggdmVjdG9yXG4gICAgICAgICAgICAgICAgICAgIG52ZWNzW252ZWNzLmxlbmd0aCAtIDFdID0gY29weVZlY01lbWJlcnMobnZlY3NbbnZlY3MubGVuZ3RoIC0gMV0pO1xuICAgICAgICAgICAgICAgICAgICAvLyBkZWJ1Z2xvZyhcImNvcGllZCB2ZWNzW1wiKyB1K1wiXVwiICsgSlNPTi5zdHJpbmdpZnkodmVjc1t1XSkpO1xuICAgICAgICAgICAgICAgICAgICBudmVjc1tudmVjcy5sZW5ndGggLSAxXS5wdXNoKGNsb25lKHRva2VuTWF0Y2hlc1t0b2tlbkluZGV4XVtsXSkpOyAvLyBwdXNoIHRoZSBsdGggdmFyaWFudFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vICAgZGVidWdsb2coXCIgYXQgICAgIFwiICsgayArIFwiOlwiICsgbCArIFwiIG5leHRiYXNlID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSlcbiAgICAgICAgICAgIC8vICAgZGVidWdsb2coXCIgYXBwZW5kIFwiICsgayArIFwiOlwiICsgbCArIFwiIG52ZWNzICAgID5cIiArIEpTT04uc3RyaW5naWZ5KG52ZWNzKSlcbiAgICAgICAgICAgIG5leHRCYXNlID0gbmV4dEJhc2UuY29uY2F0KG52ZWNzKTtcbiAgICAgICAgfSAvL2NvbnN0cnVcbiAgICAgICAgLy8gIGRlYnVnbG9nKFwibm93IGF0IFwiICsgayArIFwiOlwiICsgbCArIFwiID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSlcbiAgICAgICAgcmVzID0gbmV4dEJhc2U7XG4gICAgfVxuICAgIGRlYnVnbG9nVihkZWJ1Z2xvZ1YuZW5hYmxlZCA/IChcIkFQUEVORElORyBUTyBSRVNcIiArIDAgKyBcIjpcIiArIGwgKyBcIiA+XCIgKyBKU09OLnN0cmluZ2lmeShuZXh0QmFzZSkpIDogJy0nKTtcbiAgICByZXN1bHQuc2VudGVuY2VzID0gcmVzO1xuICAgIHJldHVybiByZXN1bHQ7XG59XG5leHBvcnRzLmV4cGFuZFRva2VuTWF0Y2hlc1RvU2VudGVuY2VzID0gZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXM7XG5mdW5jdGlvbiBwcm9jZXNzU3RyaW5nKHF1ZXJ5LCBydWxlcywgd29yZHMpIHtcbiAgICB3b3JkcyA9IHdvcmRzIHx8IHt9O1xuICAgIHZhciB0b2tlblN0cnVjdCA9IHRva2VuaXplU3RyaW5nKHF1ZXJ5LCBydWxlcywgd29yZHMpO1xuICAgIGV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24odG9rZW5TdHJ1Y3QudG9rZW5zLCB0b2tlblN0cnVjdC5mdXNhYmxlLCB0b2tlblN0cnVjdC5jYXRlZ29yaXplZFdvcmRzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcIkFmdGVyIG1hdGNoZWQgXCIgKyBKU09OLnN0cmluZ2lmeSh0b2tlblN0cnVjdC5jYXRlZ29yaXplZFdvcmRzKSk7XG4gICAgfVxuICAgIHZhciBhU2VudGVuY2VzID0gZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXModG9rZW5TdHJ1Y3QudG9rZW5zLCB0b2tlblN0cnVjdC5jYXRlZ29yaXplZFdvcmRzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5zZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBTZW50ZW5jZS5kdW1wTmljZShvU2VudGVuY2UpOyAvL0pTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIH1cbiAgICBhU2VudGVuY2VzLnNlbnRlbmNlcyA9IElucHV0RmlsdGVyLnJlaW5Gb3JjZShhU2VudGVuY2VzLnNlbnRlbmNlcyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgZGVidWdsb2coXCJhZnRlciByZWluZm9yY2VcIiArIGFTZW50ZW5jZXMuc2VudGVuY2VzLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICAgICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgfVxuICAgIHJldHVybiBhU2VudGVuY2VzO1xufVxuZXhwb3J0cy5wcm9jZXNzU3RyaW5nID0gcHJvY2Vzc1N0cmluZztcbmZ1bmN0aW9uIHNpbXBsaWZ5U2VudGVuY2UocmVzKSB7XG4gICAgcmV0dXJuIHJlcy5tYXAoZnVuY3Rpb24gKHIpIHtcbiAgICAgICAgcmV0dXJuIHIubWFwKGZ1bmN0aW9uICh3b3JkKSB7IHJldHVybiB3b3JkLnN0cmluZyArICc9PicgKyB3b3JkLm1hdGNoZWRTdHJpbmcgKyAnLycgKyB3b3JkLmNhdGVnb3J5ICsgKHdvcmQuc3BhbiA/ICcvJyArIHdvcmQuc3BhbiA6ICcnKTsgfSk7XG4gICAgfSk7XG59XG5leHBvcnRzLnNpbXBsaWZ5U2VudGVuY2UgPSBzaW1wbGlmeVNlbnRlbmNlO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
