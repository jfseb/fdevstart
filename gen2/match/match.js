"use strict";
/**
 * @file match
 * @module jfseb.fdevstart.match
 * @copyright (c) Gerd Forstmann
 *
 *
 * Judging function for a match
 */

Object.defineProperty(exports, "__esModule", { value: true });
var debug = require("debug");
var debuglog = debug('match');
function weakenByN(a, n) {
    return 1.0 + (a - 1.0) / n;
}
function calcRankingProduct(oSet) {
    var factor = Object.keys(oSet).reduce(function (prev, sCategory) {
        return prev *= oSet[sCategory]._ranking;
    }, 1.0);
    return factor;
}
exports.calcRankingProduct = calcRankingProduct;
function calcGeometricMeansOfRanking(oSet) {
    var keys = Object.keys(oSet);
    if (!keys.length) {
        return 1.0;
    }
    var factor = calcRankingProduct(oSet);
    return Math.pow(factor, 1 / keys.length);
}
/**
 * Calculate a number to rank a matched tool
 *
 *
 */
function rankToolMatch(a) {
    var missing = Object.keys(a.missing || {}).length;
    var required = Object.keys(a.required || {}).length;
    var optional = Object.keys(a.optional || {}).length;
    var spurious = Object.keys(a.spurious || {}).length;
    var matching = required + optional;
    debuglog(debuglog.enabled ? "caluclating rank of " + JSON.stringify(a) : '-');
    var rankingRequired = calcGeometricMeansOfRanking(a.required);
    var rankingOptional = calcGeometricMeansOfRanking(a.optional);
    // 1.1 for every optional;
    //  0.9 for every spurious
    //  for every required
    var spuriousDeprec = Math.pow(0.9, Object.keys(a.spurious).length);
    // 0.8 for every missing;
    var missingDeprec = Math.pow(0.8, Object.keys(a.missing).length);
    // 1.1 for toolmentiond
    if (a.toolmentioned) {
        res *= 1.1;
    }
    var res = missingDeprec * spuriousDeprec * weakenByN(rankingRequired * rankingOptional, 10);
    //  var res =  matching * 100 - 30 * missing  -  10* spurious + factor;
    debuglog("result is " + res);
    return res;
}
exports.rankToolMatch = rankToolMatch;
;
exports.ToolMatch = {
    rankResult: function rankResult(a) {
        return rankToolMatch(a);
    },
    isAnyMatch: function isAnyMatch(toolmatch) {
        return Object.keys(toolmatch.toolmatchresult.required).length + Object.keys(toolmatch.toolmatchresult.optional).length > 0;
    },
    compBetterMatch: function compBetterMatch(a, b) {
        return rankToolMatch(b.toolmatchresult) - rankToolMatch(a.toolmatchresult);
    },
    isComplete: function isComplete(toolmatch) {
        return Object.keys(toolmatch.toolmatchresult.missing).length === 0;
    },
    dumpNiceTop: function dumpNiceTop(toolmatches, options) {
        var s = '';
        toolmatches.forEach(function (oMatch, index) {
            if (index < options.top) {
                s = s + "Toolmatch[" + index + "]...\n";
                s = s + exports.ToolMatch.dumpNice(oMatch);
            }
        });
        return s;
    },
    dumpNice: function dumpNice(toolmatch) {
        var result = {
            s: "",
            push: function push(s) {
                this.s = this.s + s;
            }
        };
        var s = "**Result for tool: " + toolmatch.tool.name + "\n rank: " + toolmatch.rank + "\n";
        result.push(s);
        Object.keys(toolmatch.tool.requires).forEach(function (sRequires, index) {
            result.push("required: " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.required[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.required[sRequires].matchedString + '"');
            } else {
                result.push("? missing!");
            }
            result.push('\n');
        });
        Object.keys(toolmatch.tool.optional).forEach(function (sRequires, index) {
            result.push("optional : " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.optional[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.optional[sRequires].matchedString + '"');
            } else {
                result.push("?");
            }
            result.push('\n');
        });
        var oSentence = toolmatch.sentence;
        oSentence.forEach(function (oWord, index) {
            var sWord = "[" + index + "] : " + oWord.category + " \"" + oWord.string + "\" => \"" + oWord.matchedString + "\"";
            result.push(sWord + "\n");
        });
        result.push(".\n");
        return result.s;
    },
    dumpWeightsTop: function dumpWeightsTop(toolmatches, options) {
        var s = '';
        toolmatches.forEach(function (oMatch, index) {
            if (index < options.top) {
                s = s + "Toolmatch[" + index + "]...\n";
                s = s + exports.ToolMatch.dumpWeights(oMatch);
            }
        });
        return s;
    },
    dumpWeights: function dumpWeights(toolmatch) {
        var result = {
            s: "",
            push: function push(s) {
                this.s = this.s + s;
            }
        };
        var requires = Object.keys(toolmatch.tool.requires).length;
        var required = Object.keys(toolmatch.toolmatchresult.required).length;
        var spurious = Object.keys(toolmatch.toolmatchresult.spurious).length;
        var s = "**Result for tool: " + toolmatch.tool.name + "\n rank: " + toolmatch.rank + "  (req:" + required + "/" + requires + "   " + spurious + ")\n";
        result.push(s);
        Object.keys(toolmatch.tool.requires).forEach(function (sRequires, index) {
            result.push("required: " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.required[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.required[sRequires].matchedString + '"');
            } else {
                result.push("? missing!");
            }
            result.push('\n');
        });
        Object.keys(toolmatch.tool.optional).forEach(function (sRequires, index) {
            result.push("optional : " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.optional[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.optional[sRequires].matchedString + '"');
            } else {
                result.push("?");
            }
            result.push('\n');
        });
        var oSentence = toolmatch.sentence;
        oSentence.forEach(function (oWord, index) {
            var sWord = "[" + index + "] : " + oWord.category + " \"" + oWord.string + "\" => \"" + oWord.matchedString + "\"  (_r:" + oWord._ranking + "/" + (oWord.reinforce || '') + "/" + (oWord.levenmatch || '') + ")";
            result.push(sWord + "\n");
        });
        result.push(".\n");
        return result.s;
    }
};
exports.Result = {
    getEntity: function getEntity(match, key) {
        if (!match.toolmatchresult) {
            return undefined;
        }
        if (match.toolmatchresult.required[key]) {
            return match.toolmatchresult.required[key];
        }
        if (match.toolmatchresult.optional[key]) {
            return match.toolmatchresult.optional[key];
        }
        return undefined;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hdGNoL21hdGNoLmpzIiwiLi4vc3JjL21hdGNoL21hdGNoLnRzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJ3ZWFrZW5CeU4iLCJhIiwibiIsImNhbGNSYW5raW5nUHJvZHVjdCIsIm9TZXQiLCJmYWN0b3IiLCJrZXlzIiwicmVkdWNlIiwicHJldiIsInNDYXRlZ29yeSIsIl9yYW5raW5nIiwiY2FsY0dlb21ldHJpY01lYW5zT2ZSYW5raW5nIiwibGVuZ3RoIiwiTWF0aCIsInBvdyIsInJhbmtUb29sTWF0Y2giLCJtaXNzaW5nIiwicmVxdWlyZWQiLCJvcHRpb25hbCIsInNwdXJpb3VzIiwibWF0Y2hpbmciLCJlbmFibGVkIiwiSlNPTiIsInN0cmluZ2lmeSIsInJhbmtpbmdSZXF1aXJlZCIsInJhbmtpbmdPcHRpb25hbCIsInNwdXJpb3VzRGVwcmVjIiwibWlzc2luZ0RlcHJlYyIsInRvb2xtZW50aW9uZWQiLCJyZXMiLCJUb29sTWF0Y2giLCJyYW5rUmVzdWx0IiwiaXNBbnlNYXRjaCIsInRvb2xtYXRjaCIsInRvb2xtYXRjaHJlc3VsdCIsImNvbXBCZXR0ZXJNYXRjaCIsImIiLCJpc0NvbXBsZXRlIiwiZHVtcE5pY2VUb3AiLCJ0b29sbWF0Y2hlcyIsIm9wdGlvbnMiLCJzIiwiZm9yRWFjaCIsIm9NYXRjaCIsImluZGV4IiwidG9wIiwiZHVtcE5pY2UiLCJyZXN1bHQiLCJwdXNoIiwidG9vbCIsIm5hbWUiLCJyYW5rIiwicmVxdWlyZXMiLCJzUmVxdWlyZXMiLCJtYXRjaGVkU3RyaW5nIiwib1NlbnRlbmNlIiwic2VudGVuY2UiLCJvV29yZCIsInNXb3JkIiwiY2F0ZWdvcnkiLCJzdHJpbmciLCJkdW1wV2VpZ2h0c1RvcCIsImR1bXBXZWlnaHRzIiwicmVpbmZvcmNlIiwibGV2ZW5tYXRjaCIsIlJlc3VsdCIsImdldEVudGl0eSIsIm1hdGNo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QUFQO0FBQ0Q7QUFDRCxZQUFHRCxNQUFNakMsZUFBTixDQUFzQmhCLFFBQXRCLENBQStCa0QsR0FBL0IsQ0FBSCxFQUF3QztBQUN0QyxtQkFBT0QsTUFBTWpDLGVBQU4sQ0FBc0JoQixRQUF0QixDQUErQmtELEdBQS9CLENBQVA7QUFDRDtBQUNELGVBQU9DLFNBQVA7QUFDRDtBQWJtQixDQUFUIiwiZmlsZSI6Im1hdGNoL21hdGNoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vKipcbiAqIEBmaWxlIG1hdGNoXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5tYXRjaFxuICogQGNvcHlyaWdodCAoYykgR2VyZCBGb3JzdG1hbm5cbiAqXG4gKlxuICogSnVkZ2luZyBmdW5jdGlvbiBmb3IgYSBtYXRjaFxuICovXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG52YXIgZGVidWcgPSByZXF1aXJlKFwiZGVidWdcIik7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbWF0Y2gnKTtcbmZ1bmN0aW9uIHdlYWtlbkJ5TihhLCBuKSB7XG4gICAgcmV0dXJuIDEuMCArIChhIC0gMS4wKSAvIG47XG59XG5mdW5jdGlvbiBjYWxjUmFua2luZ1Byb2R1Y3Qob1NldCkge1xuICAgIHZhciBmYWN0b3IgPSBPYmplY3Qua2V5cyhvU2V0KS5yZWR1Y2UoZnVuY3Rpb24gKHByZXYsIHNDYXRlZ29yeSkge1xuICAgICAgICByZXR1cm4gcHJldiAqPSBvU2V0W3NDYXRlZ29yeV0uX3Jhbmtpbmc7XG4gICAgfSwgMS4wKTtcbiAgICByZXR1cm4gZmFjdG9yO1xufVxuZXhwb3J0cy5jYWxjUmFua2luZ1Byb2R1Y3QgPSBjYWxjUmFua2luZ1Byb2R1Y3Q7XG5mdW5jdGlvbiBjYWxjR2VvbWV0cmljTWVhbnNPZlJhbmtpbmcob1NldCkge1xuICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob1NldCk7XG4gICAgaWYgKCFrZXlzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gMS4wO1xuICAgIH1cbiAgICB2YXIgZmFjdG9yID0gY2FsY1JhbmtpbmdQcm9kdWN0KG9TZXQpO1xuICAgIHJldHVybiBNYXRoLnBvdyhmYWN0b3IsIDEgLyBrZXlzLmxlbmd0aCk7XG59XG4vKipcbiAqIENhbGN1bGF0ZSBhIG51bWJlciB0byByYW5rIGEgbWF0Y2hlZCB0b29sXG4gKlxuICpcbiAqL1xuZnVuY3Rpb24gcmFua1Rvb2xNYXRjaChhKSB7XG4gICAgdmFyIG1pc3NpbmcgPSBPYmplY3Qua2V5cyhhLm1pc3NpbmcgfHwge30pLmxlbmd0aDtcbiAgICB2YXIgcmVxdWlyZWQgPSBPYmplY3Qua2V5cyhhLnJlcXVpcmVkIHx8IHt9KS5sZW5ndGg7XG4gICAgdmFyIG9wdGlvbmFsID0gT2JqZWN0LmtleXMoYS5vcHRpb25hbCB8fCB7fSkubGVuZ3RoO1xuICAgIHZhciBzcHVyaW91cyA9IE9iamVjdC5rZXlzKGEuc3B1cmlvdXMgfHwge30pLmxlbmd0aDtcbiAgICB2YXIgbWF0Y2hpbmcgPSByZXF1aXJlZCArIG9wdGlvbmFsO1xuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCJjYWx1Y2xhdGluZyByYW5rIG9mIFwiICsgSlNPTi5zdHJpbmdpZnkoYSkpIDogJy0nKTtcbiAgICB2YXIgcmFua2luZ1JlcXVpcmVkID0gY2FsY0dlb21ldHJpY01lYW5zT2ZSYW5raW5nKGEucmVxdWlyZWQpO1xuICAgIHZhciByYW5raW5nT3B0aW9uYWwgPSBjYWxjR2VvbWV0cmljTWVhbnNPZlJhbmtpbmcoYS5vcHRpb25hbCk7XG4gICAgLy8gMS4xIGZvciBldmVyeSBvcHRpb25hbDtcbiAgICAvLyAgMC45IGZvciBldmVyeSBzcHVyaW91c1xuICAgIC8vICBmb3IgZXZlcnkgcmVxdWlyZWRcbiAgICB2YXIgc3B1cmlvdXNEZXByZWMgPSBNYXRoLnBvdygwLjksIE9iamVjdC5rZXlzKGEuc3B1cmlvdXMpLmxlbmd0aCk7XG4gICAgLy8gMC44IGZvciBldmVyeSBtaXNzaW5nO1xuICAgIHZhciBtaXNzaW5nRGVwcmVjID0gTWF0aC5wb3coMC44LCBPYmplY3Qua2V5cyhhLm1pc3NpbmcpLmxlbmd0aCk7XG4gICAgLy8gMS4xIGZvciB0b29sbWVudGlvbmRcbiAgICBpZiAoYS50b29sbWVudGlvbmVkKSB7XG4gICAgICAgIHJlcyAqPSAxLjE7XG4gICAgfVxuICAgIHZhciByZXMgPSBtaXNzaW5nRGVwcmVjICogc3B1cmlvdXNEZXByZWMgKiAod2Vha2VuQnlOKHJhbmtpbmdSZXF1aXJlZCAqIHJhbmtpbmdPcHRpb25hbCwgMTApKTtcbiAgICAvLyAgdmFyIHJlcyA9ICBtYXRjaGluZyAqIDEwMCAtIDMwICogbWlzc2luZyAgLSAgMTAqIHNwdXJpb3VzICsgZmFjdG9yO1xuICAgIGRlYnVnbG9nKFwicmVzdWx0IGlzIFwiICsgcmVzKTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5yYW5rVG9vbE1hdGNoID0gcmFua1Rvb2xNYXRjaDtcbjtcbmV4cG9ydHMuVG9vbE1hdGNoID0ge1xuICAgIHJhbmtSZXN1bHQ6IGZ1bmN0aW9uIChhKSB7XG4gICAgICAgIHJldHVybiByYW5rVG9vbE1hdGNoKGEpO1xuICAgIH0sXG4gICAgaXNBbnlNYXRjaDogZnVuY3Rpb24gKHRvb2xtYXRjaCkge1xuICAgICAgICByZXR1cm4gKE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWQpLmxlbmd0aCArXG4gICAgICAgICAgICBPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsKS5sZW5ndGgpID4gMDtcbiAgICB9LFxuICAgIGNvbXBCZXR0ZXJNYXRjaDogZnVuY3Rpb24gKGEsIGIpIHtcbiAgICAgICAgcmV0dXJuIHJhbmtUb29sTWF0Y2goYi50b29sbWF0Y2hyZXN1bHQpIC0gcmFua1Rvb2xNYXRjaChhLnRvb2xtYXRjaHJlc3VsdCk7XG4gICAgfSxcbiAgICBpc0NvbXBsZXRlOiBmdW5jdGlvbiAodG9vbG1hdGNoKSB7XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcpLmxlbmd0aCA9PT0gMDtcbiAgICB9LFxuICAgIGR1bXBOaWNlVG9wOiBmdW5jdGlvbiAodG9vbG1hdGNoZXMsIG9wdGlvbnMpIHtcbiAgICAgICAgdmFyIHMgPSAnJztcbiAgICAgICAgdG9vbG1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbiAob01hdGNoLCBpbmRleCkge1xuICAgICAgICAgICAgaWYgKGluZGV4IDwgb3B0aW9ucy50b3ApIHtcbiAgICAgICAgICAgICAgICBzID0gcyArIFwiVG9vbG1hdGNoW1wiICsgaW5kZXggKyBcIl0uLi5cXG5cIjtcbiAgICAgICAgICAgICAgICBzID0gcyArIGV4cG9ydHMuVG9vbE1hdGNoLmR1bXBOaWNlKG9NYXRjaCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcztcbiAgICB9LFxuICAgIGR1bXBOaWNlOiBmdW5jdGlvbiAodG9vbG1hdGNoKSB7XG4gICAgICAgIHZhciByZXN1bHQgPSB7XG4gICAgICAgICAgICBzOiBcIlwiLFxuICAgICAgICAgICAgcHVzaDogZnVuY3Rpb24gKHMpIHsgdGhpcy5zID0gdGhpcy5zICsgczsgfVxuICAgICAgICB9O1xuICAgICAgICB2YXIgcyA9IFwiKipSZXN1bHQgZm9yIHRvb2w6IFwiICsgdG9vbG1hdGNoLnRvb2wubmFtZSArIFwiXFxuIHJhbms6IFwiICsgdG9vbG1hdGNoLnJhbmsgKyBcIlxcblwiO1xuICAgICAgICByZXN1bHQucHVzaChzKTtcbiAgICAgICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wucmVxdWlyZXMpLmZvckVhY2goZnVuY3Rpb24gKHNSZXF1aXJlcywgaW5kZXgpIHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwicmVxdWlyZWQ6IFwiICsgc1JlcXVpcmVzICsgXCIgLT4gXCIpO1xuICAgICAgICAgICAgaWYgKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbc1JlcXVpcmVzXSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcIicgKyB0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3NSZXF1aXJlc10ubWF0Y2hlZFN0cmluZyArICdcIicpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goXCI/IG1pc3NpbmchXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgICAgICB9KTtcbiAgICAgICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wub3B0aW9uYWwpLmZvckVhY2goZnVuY3Rpb24gKHNSZXF1aXJlcywgaW5kZXgpIHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwib3B0aW9uYWwgOiBcIiArIHNSZXF1aXJlcyArIFwiIC0+IFwiKTtcbiAgICAgICAgICAgIGlmICh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW3NSZXF1aXJlc10pIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnXCInICsgdG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtzUmVxdWlyZXNdLm1hdGNoZWRTdHJpbmcgKyAnXCInKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwiP1wiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHZhciBvU2VudGVuY2UgPSB0b29sbWF0Y2guc2VudGVuY2U7XG4gICAgICAgIG9TZW50ZW5jZS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZCwgaW5kZXgpIHtcbiAgICAgICAgICAgIHZhciBzV29yZCA9IFwiW1wiICsgaW5kZXggKyBcIl0gOiBcIiArIG9Xb3JkLmNhdGVnb3J5ICsgXCIgXFxcIlwiICsgb1dvcmQuc3RyaW5nICsgXCJcXFwiID0+IFxcXCJcIiArIG9Xb3JkLm1hdGNoZWRTdHJpbmcgKyBcIlxcXCJcIjtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHNXb3JkICsgXCJcXG5cIik7XG4gICAgICAgIH0pO1xuICAgICAgICByZXN1bHQucHVzaChcIi5cXG5cIik7XG4gICAgICAgIHJldHVybiByZXN1bHQucztcbiAgICB9LFxuICAgIGR1bXBXZWlnaHRzVG9wOiBmdW5jdGlvbiAodG9vbG1hdGNoZXMsIG9wdGlvbnMpIHtcbiAgICAgICAgdmFyIHMgPSAnJztcbiAgICAgICAgdG9vbG1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbiAob01hdGNoLCBpbmRleCkge1xuICAgICAgICAgICAgaWYgKGluZGV4IDwgb3B0aW9ucy50b3ApIHtcbiAgICAgICAgICAgICAgICBzID0gcyArIFwiVG9vbG1hdGNoW1wiICsgaW5kZXggKyBcIl0uLi5cXG5cIjtcbiAgICAgICAgICAgICAgICBzID0gcyArIGV4cG9ydHMuVG9vbE1hdGNoLmR1bXBXZWlnaHRzKG9NYXRjaCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcztcbiAgICB9LFxuICAgIGR1bXBXZWlnaHRzOiBmdW5jdGlvbiAodG9vbG1hdGNoKSB7XG4gICAgICAgIHZhciByZXN1bHQgPSB7XG4gICAgICAgICAgICBzOiBcIlwiLFxuICAgICAgICAgICAgcHVzaDogZnVuY3Rpb24gKHMpIHsgdGhpcy5zID0gdGhpcy5zICsgczsgfVxuICAgICAgICB9O1xuICAgICAgICB2YXIgcmVxdWlyZXMgPSBPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbC5yZXF1aXJlcykubGVuZ3RoO1xuICAgICAgICB2YXIgcmVxdWlyZWQgPSBPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkKS5sZW5ndGg7XG4gICAgICAgIHZhciBzcHVyaW91cyA9IE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQuc3B1cmlvdXMpLmxlbmd0aDtcbiAgICAgICAgdmFyIHMgPSBcIioqUmVzdWx0IGZvciB0b29sOiBcIiArIHRvb2xtYXRjaC50b29sLm5hbWUgKyBcIlxcbiByYW5rOiBcIiArIHRvb2xtYXRjaC5yYW5rICsgXCIgIChyZXE6XCIgKyByZXF1aXJlZCArIFwiL1wiICsgcmVxdWlyZXMgKyBcIiAgIFwiICsgc3B1cmlvdXMgKyBcIilcXG5cIjtcbiAgICAgICAgcmVzdWx0LnB1c2gocyk7XG4gICAgICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sLnJlcXVpcmVzKS5mb3JFYWNoKGZ1bmN0aW9uIChzUmVxdWlyZXMsIGluZGV4KSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaChcInJlcXVpcmVkOiBcIiArIHNSZXF1aXJlcyArIFwiIC0+IFwiKTtcbiAgICAgICAgICAgIGlmICh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3NSZXF1aXJlc10pIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnXCInICsgdG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtzUmVxdWlyZXNdLm1hdGNoZWRTdHJpbmcgKyAnXCInKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwiPyBtaXNzaW5nIVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sLm9wdGlvbmFsKS5mb3JFYWNoKGZ1bmN0aW9uIChzUmVxdWlyZXMsIGluZGV4KSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaChcIm9wdGlvbmFsIDogXCIgKyBzUmVxdWlyZXMgKyBcIiAtPiBcIik7XG4gICAgICAgICAgICBpZiAodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtzUmVxdWlyZXNdKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1wiJyArIHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWxbc1JlcXVpcmVzXS5tYXRjaGVkU3RyaW5nICsgJ1wiJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChcIj9cIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQucHVzaCgnXFxuJyk7XG4gICAgICAgIH0pO1xuICAgICAgICB2YXIgb1NlbnRlbmNlID0gdG9vbG1hdGNoLnNlbnRlbmNlO1xuICAgICAgICBvU2VudGVuY2UuZm9yRWFjaChmdW5jdGlvbiAob1dvcmQsIGluZGV4KSB7XG4gICAgICAgICAgICB2YXIgc1dvcmQgPSBcIltcIiArIGluZGV4ICsgXCJdIDogXCIgKyBvV29yZC5jYXRlZ29yeSArIFwiIFxcXCJcIiArIG9Xb3JkLnN0cmluZyArIFwiXFxcIiA9PiBcXFwiXCIgKyBvV29yZC5tYXRjaGVkU3RyaW5nICsgXCJcXFwiICAoX3I6XCIgKyBvV29yZC5fcmFua2luZyArIFwiL1wiICsgKG9Xb3JkLnJlaW5mb3JjZSB8fCAnJykgKyBcIi9cIiArIChvV29yZC5sZXZlbm1hdGNoIHx8ICcnKSArIFwiKVwiO1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goc1dvcmQgKyBcIlxcblwiKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJlc3VsdC5wdXNoKFwiLlxcblwiKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdC5zO1xuICAgIH1cbn07XG5leHBvcnRzLlJlc3VsdCA9IHtcbiAgICBnZXRFbnRpdHk6IGZ1bmN0aW9uIChtYXRjaCwga2V5KSB7XG4gICAgICAgIGlmICghbWF0Y2gudG9vbG1hdGNocmVzdWx0KSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRba2V5XSkge1xuICAgICAgICAgICAgcmV0dXJuIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtrZXldO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWxba2V5XSkge1xuICAgICAgICAgICAgcmV0dXJuIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtrZXldO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxufTtcbiIsIi8qKlxuICogQGZpbGUgbWF0Y2hcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0Lm1hdGNoXG4gKiBAY29weXJpZ2h0IChjKSBHZXJkIEZvcnN0bWFublxuICpcbiAqXG4gKiBKdWRnaW5nIGZ1bmN0aW9uIGZvciBhIG1hdGNoXG4gKi9cblxuXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdtYXRjaCcpO1xuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XG5pbXBvcnQgKiBhcyBzdHJlYW0gZnJvbSAnc3RyZWFtJztcblxuXG5mdW5jdGlvbiB3ZWFrZW5CeU4oYSA6IG51bWJlciwgbiA6IG51bWJlcikgOiBudW1iZXIge1xuICByZXR1cm4gMS4wICsgKGEtMS4wKS9uO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FsY1JhbmtpbmdQcm9kdWN0KG9TZXQgOiB7IFtrZXkgOiBzdHJpbmddIDogSU1hdGNoLklXb3JkfSApIDogbnVtYmVyIHtcbiB2YXIgZmFjdG9yID0gT2JqZWN0LmtleXMob1NldCkucmVkdWNlKGZ1bmN0aW9uKHByZXYsIHNDYXRlZ29yeSkge1xuICAgIHJldHVybiBwcmV2ICo9IG9TZXRbc0NhdGVnb3J5XS5fcmFua2luZztcbiAgfSwxLjApO1xuICByZXR1cm4gZmFjdG9yO1xufVxuXG5mdW5jdGlvbiBjYWxjR2VvbWV0cmljTWVhbnNPZlJhbmtpbmcob1NldCA6IHsgW2tleSA6IHN0cmluZ10gOiBJTWF0Y2guSVdvcmR9KSB7XG4gIHZhciBrZXlzID0gT2JqZWN0LmtleXMob1NldCk7XG4gIGlmKCFrZXlzLmxlbmd0aCkge1xuICAgIHJldHVybiAxLjA7XG4gIH1cbiAgdmFyIGZhY3RvciA9IGNhbGNSYW5raW5nUHJvZHVjdChvU2V0KTtcbiAgcmV0dXJuIE1hdGgucG93KGZhY3RvciwgMS9rZXlzLmxlbmd0aCk7XG59XG4vKipcbiAqIENhbGN1bGF0ZSBhIG51bWJlciB0byByYW5rIGEgbWF0Y2hlZCB0b29sXG4gKlxuICpcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJhbmtUb29sTWF0Y2goYTogSU1hdGNoLklUb29sTWF0Y2hSZXN1bHQpIDogbnVtYmVyIHtcbiAgdmFyIG1pc3NpbmcgPSBPYmplY3Qua2V5cyhhLm1pc3NpbmcgfHwge30pLmxlbmd0aDtcbiAgdmFyIHJlcXVpcmVkID0gT2JqZWN0LmtleXMoYS5yZXF1aXJlZCB8fCB7fSkubGVuZ3RoO1xuICB2YXIgb3B0aW9uYWwgPSBPYmplY3Qua2V5cyhhLm9wdGlvbmFsIHx8IHt9KSAubGVuZ3RoO1xuICB2YXIgc3B1cmlvdXMgPSBPYmplY3Qua2V5cyhhLnNwdXJpb3VzIHx8IHt9KS5sZW5ndGg7XG4gIHZhciBtYXRjaGluZyA9IHJlcXVpcmVkICsgb3B0aW9uYWw7XG4gIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQ/IChcImNhbHVjbGF0aW5nIHJhbmsgb2YgXCIgKyBKU09OLnN0cmluZ2lmeShhKSkgOiAnLScpO1xuICB2YXIgcmFua2luZ1JlcXVpcmVkID0gY2FsY0dlb21ldHJpY01lYW5zT2ZSYW5raW5nKGEucmVxdWlyZWQpO1xuICB2YXIgcmFua2luZ09wdGlvbmFsID0gY2FsY0dlb21ldHJpY01lYW5zT2ZSYW5raW5nKGEub3B0aW9uYWwpO1xuXG4gIC8vIDEuMSBmb3IgZXZlcnkgb3B0aW9uYWw7XG5cbiAvLyAgMC45IGZvciBldmVyeSBzcHVyaW91c1xuIC8vICBmb3IgZXZlcnkgcmVxdWlyZWRcbiB2YXIgc3B1cmlvdXNEZXByZWMgPSBNYXRoLnBvdygwLjksIE9iamVjdC5rZXlzKGEuc3B1cmlvdXMpLmxlbmd0aCk7XG4gLy8gMC44IGZvciBldmVyeSBtaXNzaW5nO1xuIHZhciBtaXNzaW5nRGVwcmVjID0gTWF0aC5wb3coMC44LCBPYmplY3Qua2V5cyhhLm1pc3NpbmcpLmxlbmd0aCk7XG5cbiAvLyAxLjEgZm9yIHRvb2xtZW50aW9uZFxuIGlmKGEudG9vbG1lbnRpb25lZCkge1xuICAgcmVzICo9IDEuMTtcbiB9XG5cbiB2YXIgcmVzID0gbWlzc2luZ0RlcHJlYyAqIHNwdXJpb3VzRGVwcmVjICogKHdlYWtlbkJ5TihyYW5raW5nUmVxdWlyZWQqcmFua2luZ09wdGlvbmFsLCAxMCkpXG4vLyAgdmFyIHJlcyA9ICBtYXRjaGluZyAqIDEwMCAtIDMwICogbWlzc2luZyAgLSAgMTAqIHNwdXJpb3VzICsgZmFjdG9yO1xuICBkZWJ1Z2xvZyhcInJlc3VsdCBpcyBcIiArIHJlcyk7XG4gIHJldHVybiByZXM7XG59O1xuXG5leHBvcnQgY29uc3QgVG9vbE1hdGNoID0ge1xuICByYW5rUmVzdWx0OiBmdW5jdGlvbihhOiBJTWF0Y2guSVRvb2xNYXRjaFJlc3VsdCkgOiBudW1iZXIge1xuICAgIHJldHVybiByYW5rVG9vbE1hdGNoKGEpO1xuICB9LFxuICBpc0FueU1hdGNoOiBmdW5jdGlvbih0b29sbWF0Y2ggOiBJTWF0Y2guSVRvb2xNYXRjaCkgOiBib29sZWFuICB7XG4gICAgcmV0dXJuIChPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkKS5sZW5ndGggK1xuICAgICBPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsKS5sZW5ndGgpID4gMDtcbiAgfSxcbiAgY29tcEJldHRlck1hdGNoKGEgOiBJTWF0Y2guSVRvb2xNYXRjaCwgYiA6IElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gICAgcmV0dXJuIHJhbmtUb29sTWF0Y2goYi50b29sbWF0Y2hyZXN1bHQgKSAtIHJhbmtUb29sTWF0Y2goYS50b29sbWF0Y2hyZXN1bHQpO1xuICB9LFxuICBpc0NvbXBsZXRlOiBmdW5jdGlvbih0b29sbWF0Y2g6IElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZykubGVuZ3RoID09PSAwO1xuICB9LFxuXG4gIGR1bXBOaWNlVG9wIDogZnVuY3Rpb24odG9vbG1hdGNoZXMgOiBBcnJheTxJTWF0Y2guSVRvb2xNYXRjaD4sIG9wdGlvbnMgOiBhbnkpIHtcbiAgICB2YXIgcyA9ICcnO1xuICAgIHRvb2xtYXRjaGVzLmZvckVhY2goZnVuY3Rpb24ob01hdGNoLGluZGV4KSB7XG4gICAgICBpZiAoIGluZGV4IDwgb3B0aW9ucy50b3ApIHtcbiAgICAgICAgcyA9IHMgKyBcIlRvb2xtYXRjaFtcIiArIGluZGV4ICsgXCJdLi4uXFxuXCI7XG4gICAgICAgIHMgPSBzICsgVG9vbE1hdGNoLmR1bXBOaWNlKG9NYXRjaCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHM7XG4gIH0sXG5cbiAgZHVtcE5pY2UgOiBmdW5jdGlvbih0b29sbWF0Y2ggOiBJTWF0Y2guSVRvb2xNYXRjaCkge1xuICAgIHZhciByZXN1bHQgPSB7XG4gICAgICBzIDogXCJcIixcbiAgICAgIHB1c2ggOiBmdW5jdGlvbihzKSB7IHRoaXMucyA9IHRoaXMucyArIHM7IH1cbiAgICB9O1xuICAgIHZhciBzID1cbmAqKlJlc3VsdCBmb3IgdG9vbDogJHt0b29sbWF0Y2gudG9vbC5uYW1lfVxuIHJhbms6ICR7dG9vbG1hdGNoLnJhbmt9XG5gO1xuICAgIHJlc3VsdC5wdXNoKHMpO1xuICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sLnJlcXVpcmVzKS5mb3JFYWNoKGZ1bmN0aW9uKHNSZXF1aXJlcyxpbmRleCkge1xuICAgICAgcmVzdWx0LnB1c2goYHJlcXVpcmVkOiAke3NSZXF1aXJlc30gLT4gYCk7XG4gICAgICBpZiAodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtzUmVxdWlyZXNdKSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKCdcIicgKyB0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3NSZXF1aXJlc10ubWF0Y2hlZFN0cmluZyArICdcIicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0LnB1c2goYD8gbWlzc2luZyFgKTtcbiAgICAgIH1cbiAgICAgIHJlc3VsdC5wdXNoKCdcXG4nKTtcbiAgICB9KTtcblxuICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sLm9wdGlvbmFsKS5mb3JFYWNoKGZ1bmN0aW9uKHNSZXF1aXJlcyxpbmRleCkge1xuICAgICAgcmVzdWx0LnB1c2goYG9wdGlvbmFsIDogJHtzUmVxdWlyZXN9IC0+IGApO1xuICAgICAgaWYgKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWxbc1JlcXVpcmVzXSkge1xuICAgICAgICByZXN1bHQucHVzaCgnXCInICsgdG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtzUmVxdWlyZXNdLm1hdGNoZWRTdHJpbmcgKyAnXCInKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQucHVzaChgP2ApO1xuICAgICAgfVxuICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgIH0pO1xuICAgIHZhciBvU2VudGVuY2UgPSB0b29sbWF0Y2guc2VudGVuY2U7XG4gICAgb1NlbnRlbmNlLmZvckVhY2goZnVuY3Rpb24ob1dvcmQsIGluZGV4KSB7XG4gICAgICB2YXIgc1dvcmQgPSBgWyR7aW5kZXh9XSA6ICR7b1dvcmQuY2F0ZWdvcnl9IFwiJHtvV29yZC5zdHJpbmd9XCIgPT4gXCIke29Xb3JkLm1hdGNoZWRTdHJpbmd9XCJgXG4gICAgICByZXN1bHQucHVzaChzV29yZCArIFwiXFxuXCIpO1xuICAgIH0pXG4gICAgcmVzdWx0LnB1c2goXCIuXFxuXCIpO1xuICAgIHJldHVybiByZXN1bHQucztcblxuICB9LFxuXG4gIGR1bXBXZWlnaHRzVG9wIDogZnVuY3Rpb24odG9vbG1hdGNoZXMgOiBBcnJheTxJTWF0Y2guSVRvb2xNYXRjaD4sIG9wdGlvbnMgOiBhbnkpIHtcbiAgICB2YXIgcyA9ICcnO1xuICAgIHRvb2xtYXRjaGVzLmZvckVhY2goZnVuY3Rpb24ob01hdGNoLGluZGV4KSB7XG4gICAgICBpZiAoIGluZGV4IDwgb3B0aW9ucy50b3ApIHtcbiAgICAgICAgcyA9IHMgKyBcIlRvb2xtYXRjaFtcIiArIGluZGV4ICsgXCJdLi4uXFxuXCI7XG4gICAgICAgIHMgPSBzICsgVG9vbE1hdGNoLmR1bXBXZWlnaHRzKG9NYXRjaCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHM7XG4gIH0sXG5cbiAgZHVtcFdlaWdodHMgOiBmdW5jdGlvbih0b29sbWF0Y2ggOiBJTWF0Y2guSVRvb2xNYXRjaCkge1xuICAgIHZhciByZXN1bHQgPSB7XG4gICAgICBzIDogXCJcIixcbiAgICAgIHB1c2ggOiBmdW5jdGlvbihzKSB7IHRoaXMucyA9IHRoaXMucyArIHM7IH1cbiAgICB9O1xuXG4gIHZhciByZXF1aXJlcyA9IE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sLnJlcXVpcmVzKS5sZW5ndGg7XG4gIHZhciByZXF1aXJlZCA9IE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWQpLmxlbmd0aDtcblxuICAgIHZhciBzcHVyaW91cyA9IE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQuc3B1cmlvdXMpLmxlbmd0aDtcbiAgICB2YXIgcyA9XG5gKipSZXN1bHQgZm9yIHRvb2w6ICR7dG9vbG1hdGNoLnRvb2wubmFtZX1cbiByYW5rOiAke3Rvb2xtYXRjaC5yYW5rfSAgKHJlcToke3JlcXVpcmVkfS8ke3JlcXVpcmVzfSAgICR7c3B1cmlvdXN9KVxuYFxuICAgIHJlc3VsdC5wdXNoKHMpO1xuICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sLnJlcXVpcmVzKS5mb3JFYWNoKGZ1bmN0aW9uKHNSZXF1aXJlcyxpbmRleCkge1xuICAgICAgcmVzdWx0LnB1c2goYHJlcXVpcmVkOiAke3NSZXF1aXJlc30gLT4gYCk7XG4gICAgICBpZiAodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtzUmVxdWlyZXNdKSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKCdcIicgKyB0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3NSZXF1aXJlc10ubWF0Y2hlZFN0cmluZyArICdcIicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0LnB1c2goYD8gbWlzc2luZyFgKTtcbiAgICAgIH1cbiAgICAgIHJlc3VsdC5wdXNoKCdcXG4nKTtcbiAgICB9KTtcblxuICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sLm9wdGlvbmFsKS5mb3JFYWNoKGZ1bmN0aW9uKHNSZXF1aXJlcyxpbmRleCkge1xuICAgICAgcmVzdWx0LnB1c2goYG9wdGlvbmFsIDogJHtzUmVxdWlyZXN9IC0+IGApO1xuICAgICAgaWYgKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWxbc1JlcXVpcmVzXSkge1xuICAgICAgICByZXN1bHQucHVzaCgnXCInICsgdG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtzUmVxdWlyZXNdLm1hdGNoZWRTdHJpbmcgKyAnXCInKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQucHVzaChgP2ApO1xuICAgICAgfVxuICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgIH0pO1xuICAgIHZhciBvU2VudGVuY2UgPSB0b29sbWF0Y2guc2VudGVuY2U7XG4gICAgb1NlbnRlbmNlLmZvckVhY2goZnVuY3Rpb24ob1dvcmQsIGluZGV4KSB7XG4gICAgICB2YXIgc1dvcmQgPSBgWyR7aW5kZXh9XSA6ICR7b1dvcmQuY2F0ZWdvcnl9IFwiJHtvV29yZC5zdHJpbmd9XCIgPT4gXCIke29Xb3JkLm1hdGNoZWRTdHJpbmd9XCIgIChfcjoke29Xb3JkLl9yYW5raW5nfS8ke29Xb3JkLnJlaW5mb3JjZSB8fCAnJ30vJHtvV29yZC5sZXZlbm1hdGNoIHx8ICcnfSlgXG4gICAgICByZXN1bHQucHVzaChzV29yZCArIFwiXFxuXCIpO1xuICAgIH0pXG4gICAgcmVzdWx0LnB1c2goXCIuXFxuXCIpO1xuICAgIHJldHVybiByZXN1bHQucztcblxuICB9XG59XG5cblxuZXhwb3J0IGNvbnN0IFJlc3VsdCA9IHtcbiAgZ2V0RW50aXR5OiBmdW5jdGlvbihtYXRjaCA6IElNYXRjaC5JVG9vbE1hdGNoLCBrZXkgOiBzdHJpbmcpIDogSU1hdGNoLklXb3JkIHtcbiAgICBpZighbWF0Y2gudG9vbG1hdGNocmVzdWx0KSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlmKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtrZXldKSB7XG4gICAgICByZXR1cm4gbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW2tleV07XG4gICAgfVxuICAgIGlmKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtrZXldKSB7XG4gICAgICByZXR1cm4gbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW2tleV07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
